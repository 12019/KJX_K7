/*****************************************************************************
*  Copyright Statement:
*  --------------------
*  This software is protected by Copyright and the information contained
*  herein is confidential. The software may not be copied and the information
*  contained herein may not be used or disclosed except with the written
*  permission of MediaTek Inc. (C) 2005
*
*  BY OPENING THIS FILE, BUYER HEREBY UNEQUIVOCALLY ACKNOWLEDGES AND AGREES
*  THAT THE SOFTWARE/FIRMWARE AND ITS DOCUMENTATIONS ("MEDIATEK SOFTWARE")
*  RECEIVED FROM MEDIATEK AND/OR ITS REPRESENTATIVES ARE PROVIDED TO BUYER ON
*  AN "AS-IS" BASIS ONLY. MEDIATEK EXPRESSLY DISCLAIMS ANY AND ALL WARRANTIES,
*  EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE IMPLIED WARRANTIES OF
*  MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE OR NONINFRINGEMENT.
*  NEITHER DOES MEDIATEK PROVIDE ANY WARRANTY WHATSOEVER WITH RESPECT TO THE
*  SOFTWARE OF ANY THIRD PARTY WHICH MAY BE USED BY, INCORPORATED IN, OR
*  SUPPLIED WITH THE MEDIATEK SOFTWARE, AND BUYER AGREES TO LOOK ONLY TO SUCH
*  THIRD PARTY FOR ANY WARRANTY CLAIM RELATING THERETO. MEDIATEK SHALL ALSO
*  NOT BE RESPONSIBLE FOR ANY MEDIATEK SOFTWARE RELEASES MADE TO BUYER'S
*  SPECIFICATION OR TO CONFORM TO A PARTICULAR STANDARD OR OPEN FORUM.
*
*  BUYER'S SOLE AND EXCLUSIVE REMEDY AND MEDIATEK'S ENTIRE AND CUMULATIVE
*  LIABILITY WITH RESPECT TO THE MEDIATEK SOFTWARE RELEASED HEREUNDER WILL BE,
*  AT MEDIATEK'S OPTION, TO REVISE OR REPLACE THE MEDIATEK SOFTWARE AT ISSUE,
*  OR REFUND ANY SOFTWARE LICENSE FEES OR SERVICE CHARGE PAID BY BUYER TO
*  MEDIATEK FOR SUCH MEDIATEK SOFTWARE AT ISSUE. 
*
*  THE TRANSACTION CONTEMPLATED HEREUNDER SHALL BE CONSTRUED IN ACCORDANCE
*  WITH THE LAWS OF THE STATE OF CALIFORNIA, USA, EXCLUDING ITS CONFLICT OF
*  LAWS PRINCIPLES.  ANY DISPUTES, CONTROVERSIES OR CLAIMS ARISING THEREOF AND
*  RELATED THERETO SHALL BE SETTLED BY ARBITRATION IN SAN FRANCISCO, CA, UNDER
*  THE RULES OF THE INTERNATIONAL CHAMBER OF COMMERCE (ICC).
*
*****************************************************************************/

/*******************************************************************************
 * Filename:
 * ---------
 *  vapp_phb_editor.cpp
 *
 * Project:
 * --------
 *  Venus
 *
 * Description:
 * ------------
 *  
 *
 * Author:
 * -------
 * -------
 *
 *============================================================================
 *             HISTORY
 * Below this line, this part is controlled by PVCS VM. DO NOT MODIFY!!
 *------------------------------------------------------------------------------
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 *------------------------------------------------------------------------------
 * Upper this line, this part is controlled by PVCS VM. DO NOT MODIFY!!
 *============================================================================
 ****************************************************************************/
#include "MMI_features.h"

#include "mmi_rp_vapp_contact_def.h"
#include "mmi_rp_srv_venus_component_tool_bar_def.h"
#include "mmi_rp_srv_venus_component_list_menu_def.h"
#include "mmi_rp_file_type_def.h"
#include "mmi_rp_app_cosmos_global_def.h"
#include "FileMgrSrvGProt.h"
#include "mmi_rp_app_usbsrv_def.h"

#include "vapp_phb_editor.h"
#include "vapp_phb_cui.h"
#include "vapp_phb_group.h"
#include "vapp_phb_gprot.h"
#include "vapp_phb_app.h"
#include "vapp_phb_res.h"
#include "vcp_global_popup.h"

#include "vcui_gallery_gprot.h"
#include "vcui_tone_selector_gprot.h"
#include "vapp_fmgr_cui_gprot.h"

#ifdef __cplusplus
extern "C"
{
#endif

#ifdef __MMI_CAMCORDER__
#include "vcui_camco_gprot.h"
#endif

#ifdef __DRM_SUPPORT__
#include "drm_gprot.h"
#endif

#ifdef __cplusplus
}
#endif

#ifdef __MMI_COSMOS_IMAGECLIPPER__
#include "vcui_imgedt_gprot.h"
#endif

#ifdef __cplusplus
extern "C"
{
#endif

#include "FileMgrSrvGprot.h"
#include "ProfilesSrvGprot.h"
#include "SimCtrlSrvGprot.h"
#include "NotificationGprot.h"
#include "GeneralSettingSrvGprot.h"
#include "UsbSrvGprot.h"
#include "App_str.h"

#ifdef __cplusplus
}
#endif

#define VAPP_PHB_BIRTHDAY_LENGTH (15)
#define IMGEDT_PHB_CLIP_MIN_LENGHTH (60)
/***************************************************************************** 
 * Class VappPhbEditorScr
 *****************************************************************************/
VappPhbEditorScr::VappPhbEditorScr(VappPhbSaveContactCui *cui)
{
    VappContactFieldObjList *field = cui->getFieldList();

    // only support replace one field
    // only support replace number & email
    if (cui->getType() == VAPP_PHB_SAVE_CONTACT_DEFAULT &&
        field->getCount() == 1 &&
        (field->getHead()->m_field->getType() == MMI_PHB_CONTACT_FIELD_NUMBER ||
         field->getHead()->m_field->getType() == MMI_PHB_CONTACT_FIELD_EMAIL))
    {
        // set mall screen
        setIsSmallScreen();
    }

    VappPhbEditorScr::m_errorPopupId = GRP_ID_INVALID;
}


void VappPhbEditorScr::onInit()
{
    VfxMainScr::onInit();

    VappPhbSaveContactCui *cui = VFX_OBJ_DYNAMIC_CAST(getApp(), VappPhbSaveContactCui);
    VappContactFieldObjList *field = cui->getFieldList();

    // only support replace one field
    // only support replace number & email
    if (cui->getType() == VAPP_PHB_SAVE_CONTACT_DEFAULT &&
        field->getCount() == 1 &&
        (field->getHead()->m_field->getType() == MMI_PHB_CONTACT_FIELD_NUMBER ||
         field->getHead()->m_field->getType() == MMI_PHB_CONTACT_FIELD_EMAIL))
    {
        // set transparent bg
        setBgColor(VFX_COLOR_TRANSPARENT);
    }

    // reset the cui type to create new if the data isn't number and email
    if (field->getCount() == 1 &&
        (field->getHead()->m_field->getType() != MMI_PHB_CONTACT_FIELD_NUMBER &&
         field->getHead()->m_field->getType() != MMI_PHB_CONTACT_FIELD_EMAIL))
    {
        cui->setType(VAPP_PHB_SAVE_CONTACT_NEW);
    }

    // only support replace one field
    if (field->getCount() > 1)
    {
        cui->setType(VAPP_PHB_SAVE_CONTACT_NEW);
    }
}


void VappPhbEditorScr::onDeinit()
{
    if (VappPhbEditorScr::m_errorPopupId != GRP_ID_INVALID)
    {
        vcp_global_popup_cancel(VappPhbEditorScr::m_errorPopupId);
        VappPhbEditorScr::m_errorPopupId = GRP_ID_INVALID;
    }

    VfxMainScr::onDeinit();
}


void VappPhbEditorScr::on1stReady()
{
    VfxMainScr::on1stReady();

    VappPhbSaveContactCui *cui = VFX_OBJ_DYNAMIC_CAST(getApp(), VappPhbSaveContactCui);

    if (!vapp_phb_ready_balloon())
    {
        cui->onSavedDone(cui->m_id, VFX_FALSE);
        return;
    }

    // register event handler
    ContactTask *task = GET_CONTACT_TASK();
    task->m_signalTask.connect(this, &VappPhbEditorScr::onContactUpdated);

    m_contact = NULL;

    switch (cui->getType())
    {
        // new && replace
        case VAPP_PHB_SAVE_CONTACT_DEFAULT:
        {
            saveContact();
            break;
        }
        // new
        case VAPP_PHB_SAVE_CONTACT_NEW:
        {
            createNewContact();
            break;
        }
        // edit
        case VAPP_PHB_SAVE_CONTACT_EDIT:
        {
            editContact();
            break;
        }
        // replace
        case VAPP_PHB_SAVE_CONTACT_REPLACE:
        {
            replaceContact();
            break;
        }
        default:
        {
            VFX_ASSERT(0);
            break;
        }
    }
}


void VappPhbEditorScr::onEnter(VfxBool isBackward)
{
    VfxMainScr::onEnter(isBackward);

    if (getPageCount() > 0)
    {
        disableSmallScreen();
        setBgColor(VFX_COLOR_RES(CLR_COSMOS_BG_MAIN));
    }
}


void VappPhbEditorScr::onQueryRotateEx(VfxScreenRotateParam &param)
{
}


void VappPhbEditorScr::onContactUpdated(ContactTask* task, mmi_event_struct* evt)
{
    // dispatch the event to sub pages
    processProc(evt);

    // always handle it by main screen
    switch (evt->evt_id)
    {
        case EVT_ID_PHB_READY:
        {
            srv_phb_startup_evt_struct *ready = (srv_phb_startup_evt_struct*) evt;
            if (!ready->phb_ready)
            {
                VappPhbSaveContactCui *cui = VFX_OBJ_DYNAMIC_CAST(getApp(), VappPhbSaveContactCui);
                cui->onSavedDone(cui->m_id, VFX_FALSE);
            //    exit();  // check __MMI_PHB_TCARD_STORAGE_SUPPORT__
            }
            break;
        }
        case EVT_ID_PHB_UPD_CONTACT:
        case EVT_ID_PHB_DEL_CONTACT:
        {
            srv_phb_op_evt_struct *op = (srv_phb_op_evt_struct*) evt;
            if (m_contact && (m_contact->getId() == op->store_index))
            {
                VappPhbSaveContactCui *cui = VFX_OBJ_DYNAMIC_CAST(getApp(), VappPhbSaveContactCui);
                cui->onSavedDone(cui->m_id, VFX_FALSE);
            }
            break;
        }
    }
}


void VappPhbEditorScr::saveContact()
{
    VappPhbSaveContactCui *cui = VFX_OBJ_DYNAMIC_CAST(getApp(), VappPhbSaveContactCui);
    VappContactFieldObjList *field = cui->getFieldList();

    // only support replace one field
    // only support replace number & email
    if (field->getCount() == 1 &&
        (field->getHead()->m_field->getType() == MMI_PHB_CONTACT_FIELD_NUMBER ||
         field->getHead()->m_field->getType() == MMI_PHB_CONTACT_FIELD_EMAIL))
    {
        VcpCommandPopup *option;
        VFX_OBJ_CREATE(option, VcpCommandPopup, this);

        VappContactFieldObjList::FieldNode *node = field->getHead();
        if (node->m_field->getType() == MMI_PHB_CONTACT_FIELD_NUMBER)
        {
            //option->setText(VFX_WSTR_RES(VAPP_PHB_STR_SAVE_A_NUMBER));
            VappContactNumber *number = (VappContactNumber *)node->m_field;
            option->setText(number->getString());
        }
        else if (node->m_field->getType() == MMI_PHB_CONTACT_FIELD_EMAIL)
        {
            //option->setText(VFX_WSTR_RES(VAPP_PHB_STR_SAVE_A_EMAIL));
            VappContactEmail *email = (VappContactEmail *)node->m_field;
            option->setText(email->getString());
        }

        /*option->addItem(VAPP_PHB_SAVE_CONTACT_NEW, VFX_WSTR_RES(VAPP_PHB_STR_CREATE_NEW_CONTACT), VCP_POPUP_BUTTON_TYPE_NORMAL);
        option->addItem(VAPP_PHB_SAVE_CONTACT_REPLACE, VFX_WSTR_RES(VAPP_PHB_STR_ADD_TO_EXISTING_CONTACT), VCP_POPUP_BUTTON_TYPE_NORMAL);
        option->addItem(VAPP_PHB_SAVE_CONTACT_TOTAL, VFX_WSTR_RES(STR_GLOBAL_CANCEL), VCP_POPUP_BUTTON_TYPE_CANCEL);*/
        option->addItem(VAPP_PHB_SAVE_CONTACT_NEW, (VfxResId)VAPP_PHB_STR_CREATE_NEW_CONTACT, VCP_POPUP_BUTTON_TYPE_NORMAL);
        option->addItem(VAPP_PHB_SAVE_CONTACT_REPLACE, (VfxResId)VAPP_PHB_STR_ADD_TO_EXISTING_CONTACT, VCP_POPUP_BUTTON_TYPE_NORMAL);
        option->addItem(VAPP_PHB_SAVE_CONTACT_TOTAL, (VfxResId)STR_GLOBAL_CANCEL, VCP_POPUP_BUTTON_TYPE_CANCEL);
        
        option->m_signalButtonClicked.connect(this, &VappPhbEditorScr::onButtonClick);

        option->show(VFX_TRUE);
    }
    // otherwise trig new contact
    else
    {
        createNewContact();
    }
}


void VappPhbEditorScr::createNewContact()
{
    VappPhbSaveContactCui *cui = VFX_OBJ_DYNAMIC_CAST(getApp(), VappPhbSaveContactCui);

    if (!vapp_phb_ready_balloon())
    {
        cui->onSavedDone(cui->m_id, VFX_FALSE);
        return;
    }

    // check image format
    VappContactFieldObjList *field = cui->getFieldList();

    if (field->getCount() == 1 &&
        field->getHead()->m_field->getType() == MMI_PHB_CONTACT_FIELD_IMAGE)
    {
    #ifdef __MMI_COSMOS_IMAGECLIPPER__
        VappContactRes &image = *((VappContactRes*) field->getHead()->m_field);
        if (cui_vapp_imgclip_is_file_support(image.getPath().getBuf()) != CUI_IMGEDT_OK)
        {
            mmi_frm_nmgr_balloon(MMI_SCENARIO_ID_DEFAULT, MMI_EVENT_INFO_BALLOON, MMI_NMGR_BALLOON_TYPE_FAILURE,
                VFX_WSTR_RES(STR_GLOBAL_INVALID_FORMAT));
            cui->onSavedDone(cui->m_id, VFX_FALSE);
            return;
        }
    #endif /* __MMI_COSMOS_IMAGECLIPPER__ */
    }

    // create contact instance
    // always add to phone storage
    VFX_OBJ_CREATE(m_contact, Contact, this);

    // set input data
    setData(cui->getFieldList());

    VappPhbEditorPage *page;
    VFX_OBJ_CREATE_EX(page, VappPhbEditorPage, this, (m_contact));

    setBgColor(VFX_COLOR_RES(CLR_COSMOS_BG_MAIN));
    pushPage(VFX_ID_NULL, page);
}


void VappPhbEditorScr::editContact()
{
    VappPhbSaveContactCui *cui = VFX_OBJ_DYNAMIC_CAST(getApp(), VappPhbSaveContactCui);
    VFX_ASSERT(ContactEntry::isValid(cui->m_id));

    // create contact instance
    VFX_OBJ_CREATE_EX(m_contact, Contact, this, (cui->m_id));

    // set input data
    setData(cui->getFieldList());

    VappPhbEditorPage *page;
    VFX_OBJ_CREATE_EX(page, VappPhbEditorPage, this, (m_contact));

    setBgColor(VFX_COLOR_RES(CLR_COSMOS_BG_MAIN));
    pushPage(VFX_ID_NULL, page);
}


void VappPhbEditorScr::replaceContact()
{
    mmi_id cui_id = vcui_phb_list_create(getApp()->getGroupId());

    // reflect the proc function to mainScr
    vfxSetCuiCallerScr(cui_id, this);

    vcui_phb_list_set_req_type(cui_id, VAPP_PHB_LIST_GROUP_SINGLE_SELECTOR);
    vcui_phb_list_set_title_str(cui_id, STR_ID_VAPP_PHB_SELECT_A_CONTACT);
    vcui_phb_list_set_storage(cui_id, ContactStorage::getMask());
    vcui_phb_list_run(cui_id);
}

VfxWString VappPhbEditorScr::m_text;
mmi_id VappPhbEditorScr::m_errorPopupId;


MMI_BOOL VappPhbEditorScr::onNmgrNotified(mmi_scenario_id scenarioId, void *userData)
{
    VappPhbEditorScr::m_errorPopupId = vcp_global_popup_show_confirm_one_button_str(
        GRP_ID_ROOT,
        VCP_POPUP_TYPE_FAILURE,
        VappPhbEditorScr::m_text,
        VFX_WSTR_RES(STR_GLOBAL_OK),
        VCP_POPUP_BUTTON_TYPE_NORMAL,
        NULL,
        NULL
        );

    return MMI_TRUE;
}


mmi_ret VappPhbEditorScr::onProc(mmi_event_struct *evt)
{
    if (evt->evt_id == EVT_ID_CUI_PHB_LIST_RESULT)
    {
        VappPhbSaveContactCui *cui = VFX_OBJ_DYNAMIC_CAST(getApp(), VappPhbSaveContactCui);

        vcui_phb_list_result_event_struct *result = (vcui_phb_list_result_event_struct*) evt;
        if (result->result && result->select_count == 1)
        {
            cui->m_id = vcui_phb_list_get_contact_id(((mmi_group_event_struct*) evt)->sender_id);
            ContactEntry entry(cui->m_id);

            VappContactFieldObjList *field = cui->getFieldList();
            VappContactFieldObjList::FieldNode *node = field->getHead();

            switch (node->m_field->getType())
            {
                case MMI_PHB_CONTACT_FIELD_NUMBER:
                    if (entry.getNumberCount() >= srv_phb_get_support_field_count(entry.getStorage(), MMI_PHB_CONTACT_FIELD_ID_NUMBER))
                    {
                        // popup error
                        m_text.loadFromRes(VAPP_PHB_STR_NO_MORE_NUMBER);
                        m_text += VFX_WSTR_RES(VAPP_PHB_STR_COLON);
                        m_text += VfxWString().format("%d", entry.getNumberCount());

                        mmi_frm_nmgr_notify_by_app(
                            MMI_SCENARIO_ID_DEFAULT,
                            MMI_EVENT_FAILURE,
                            (mmi_noti_scrn_func_ptr) &VappPhbEditorScr::onNmgrNotified,
                            NULL);

                        cui->m_id = MMI_PHB_INVALID_CONTACT_ID;
                    }
                    else
                    {
                        editContact();
                        vcui_phb_list_close(((mmi_group_event_struct*) evt)->sender_id);
                    }
                    break;

                case MMI_PHB_CONTACT_FIELD_EMAIL:
                    if (entry.getEmailCount() >= srv_phb_get_support_field_count(entry.getStorage(), MMI_PHB_CONTACT_FIELD_ID_EMAIL))
                    {
                        // popup error
                        m_text.loadFromRes(VAPP_PHB_STR_NO_MORE_EMAIL);
                        m_text += VFX_WSTR_RES(VAPP_PHB_STR_COLON);
                        m_text += VfxWString().format("%d", entry.getEmailCount());

                        mmi_frm_nmgr_notify_by_app(
                            MMI_SCENARIO_ID_DEFAULT,
                            MMI_EVENT_FAILURE,
                            (mmi_noti_scrn_func_ptr) &VappPhbEditorScr::onNmgrNotified,
                            NULL);

                        cui->m_id = MMI_PHB_INVALID_CONTACT_ID;
                    }
                    else
                    {
                        editContact();
                        vcui_phb_list_close(((mmi_group_event_struct*) evt)->sender_id);
                    }
                    break;
            }
        }
        else
        {
            cui->onSavedDone(cui->m_id, VFX_FALSE);
            vcui_phb_list_close(((mmi_group_event_struct*) evt)->sender_id);
        }
        return MMI_RET_OK;
    }

    return VfxMainScr::onProc(evt);
}


void VappPhbEditorScr::onButtonClick(VfxObject* obj, VfxId id)
{
    switch (id)
    {
        case VAPP_PHB_SAVE_CONTACT_NEW:
        {
            createNewContact();
            break;
        }
        case VAPP_PHB_SAVE_CONTACT_REPLACE:
        {
            replaceContact();
            break;
        }
        default:
        {
            VappPhbSaveContactCui *cui = VFX_OBJ_DYNAMIC_CAST(getApp(), VappPhbSaveContactCui);
            cui->onSavedDone(cui->m_id, VFX_FALSE);
            exit();
            break;
        }
    }
}


void VappPhbEditorScr::setData(VappContactFieldObjList *list)
{
    VappContactFieldObjList::FieldNode *node = list->getHead();

    // set data to the contact instance
    while (node)
    {
        switch (node->m_field->getType())
        {
            case MMI_PHB_CONTACT_FIELD_NAME:
            {
                m_contact->setName(*((VappContactName*) node->m_field));
                break;
            }
            case MMI_PHB_CONTACT_FIELD_NUMBER:
            {
                m_contact->setNumber(*((VappContactNumber*) node->m_field), 0xff);
                break;
            }
            case MMI_PHB_CONTACT_FIELD_EMAIL:
            {
                m_contact->setEmail(*((VappContactEmail*) node->m_field), 0xff);
                break;
            }
            case MMI_PHB_CONTACT_FIELD_IMAGE:
            {
                m_contact->setImage(*((VappContactRes*) node->m_field));
                break;
            }
        }

        node = node->m_next;
    }
}


/***************************************************************************** 
 * Class VappPhbEditorPage
 *****************************************************************************/
VappPhbEditorPage::VappPhbEditorPage(Contact *contact):
    m_action(VAPP_PHB_CONTACT_EDIT),
    m_form(NULL),
    m_contact(contact),
    m_field(NULL),
    m_numCount(0),
    m_emailCount(0),
    m_save(NULL),
    m_delete(NULL),
    m_activeEditor(NULL)
{
    VFX_ASSERT(contact != NULL);

    m_id = contact->getId();
    if (m_id == MMI_PHB_INVALID_CONTACT_ID)
    {
        m_action = VAPP_PHB_CONTACT_ADD;
    }
    else
    {
        m_action = VAPP_PHB_CONTACT_EDIT;
    }
    m_autoAdd = VFX_FALSE;
    m_autoAddEmail = VFX_FALSE;
    //m_buffer = NULL;
}


void VappPhbEditorPage::onInit()
{
    VfxPage::onInit();

    // create title bar
    VcpTitleBar* titleBar;
    VFX_OBJ_CREATE(titleBar, VcpTitleBar, this);
    setTopBar(titleBar);

    // create tool bar
    VFX_OBJ_CREATE(m_toolbar, VcpToolBar, this);
    m_toolbar->addItem(VAPP_PHB_CONTACT_CMD_SAVE, (VfxResId)STR_GLOBAL_SAVE, VCP_IMG_TOOL_BAR_COMMON_ITEM_SAVE);
    m_toolbar->addItem(VAPP_PHB_CONTACT_CMD_CANCEL, (VfxResId)STR_GLOBAL_CANCEL, VCP_IMG_TOOL_BAR_COMMON_ITEM_CANCEL);
    m_toolbar->m_signalButtonTap.connect(this, &VappPhbEditorPage::onToolBarClick);
    setBottomBar(m_toolbar);

    // create contact object
    if (m_action == VAPP_PHB_CONTACT_ADD)
    {
        titleBar->setTitle(VAPP_PHB_STR_ADD_NEW_CONTACT);
    }
    else
    {
        titleBar->setTitle(VAPP_PHB_STR_EDIT_CONTACT);
    }
    // create form
    createForm();
}


void VappPhbEditorPage::onEntered()
{
    VfxPage::onEntered();

    getMainScr()->disableSmallScreen();
    setBgColor(VFX_COLOR_RES(CLR_COSMOS_BG_MAIN));

    vcui_phb_contact_save_result_event_struct evt;
    VappPhbSaveContactCui *cui = VFX_OBJ_DYNAMIC_CAST(getApp(), VappPhbSaveContactCui);

    MMI_FRM_INIT_GROUP_EVENT(&evt, EVT_ID_CUI_PHB_SAVE_ENTERED, cui->getGroupId());
    evt.result = 0;
    evt.id = cui->getId();

    cui->postToCaller((mmi_group_event_struct *)&evt);
}


void VappPhbEditorPage::onDeinit()
{
    VfxPage::onDeinit();
}

mmi_ret VappPhbEditorPage::listener(mmi_event_struct *evt)
{
    VappPhbEditorPage *self = NULL;

    self = (VappPhbEditorPage *)VfxObject::handleToObject((VfxObjHandle) evt->user_data);
    if (self)
    {
        return self->onProc(evt);
    }

    return MMI_RET_OK;
}


void VappPhbEditorPage::createForm()
{
    // create form
    VFX_OBJ_CREATE(m_form, VcpForm, this);
    m_form->setSize(getSize());
    m_form->setAlignParent(
        VFX_FRAME_ALIGNER_MODE_SIDE,
        VFX_FRAME_ALIGNER_MODE_SIDE,
        VFX_FRAME_ALIGNER_MODE_SIDE,
        VFX_FRAME_ALIGNER_MODE_SIDE);

    // create item field vector
    VFX_OBJ_CREATE(m_field, VappPhbFieldItem, m_form);

    createName();

#ifdef __MMI_PHB_USIM_SUPPORT__
    createNickname();
#endif

    m_numCount = 0;
    createNumber();

    m_emailCount = 0;
    createEmail();

#ifdef __MMI_PHB_INFO_FIELD__
    createAddress();
#endif
#if defined (__MMI_PHB_BIRTHDAY_FIELD__) || defined (__MMI_PHB_OPTIONAL_FIELD_ADDITIONAL__) || defined (__MMI_PHB_INFO_FIELD__)
{
    createOtherInfo();
}
#endif
    createSetting();
}


void VappPhbEditorPage::createName()
{
    VappContactFieldItem item;
    VappContactName& name = m_contact->getName();

    // contact in phone
    if (m_contact->getStorage() == PHB_STORAGE_NVRAM
    #ifdef __MMI_PHB_TCARD_STORAGE_SUPPORT__
        || m_contact->getStorage() == PHB_STORAGE_TCARD
    #endif
        )
    {
        VappPhbEditorNameFormItem *itemName;
        VFX_OBJ_CREATE(itemName, VappPhbEditorNameFormItem, m_form);

        item.m_itemId = m_field->getNewItemId();
        item.m_itemType = PB_CONTACT_ITEM_NAME;
        item.m_obj = itemName;
        m_field->setItem(item);

    #ifdef __MMI_PHB_LAST_NAME_FIELD__
        if (name.getString().isEmpty())
        {
            if (m_action == VAPP_PHB_CONTACT_ADD)
            {
                itemName->setName(VFX_WSTR_RES(VAPP_PHB_STR_ADD_NAME));
            }
            else
            {
                itemName->setName(VFX_WSTR_RES(VAPP_PHB_STR_UNNAMED));
            }
        }
        else
    #endif /* __MMI_PHB_LAST_NAME_FIELD__ */
        {
            itemName->setName(name.getString());
        }

        VappContactRes& img = m_contact->getImage();
        if (img.getPath().isEmpty())
        {
            itemName->setImage(VfxImageSrc());
        }
        else if (srv_fmgr_fs_path_exist(img.getPath()) >= 0)
        {
            if(vapp_phb_query_head_portrait_need_thumbnail((CHAR*)img.getPath().getBuf()))
            {
                itemName->m_image->setImageContentPlacement(VFX_FRAME_CONTENT_PLACEMENT_TYPE_CENTER);
            }
            VappPhbSaveContactCui *cui = VFX_OBJ_DYNAMIC_CAST(getApp(),VappPhbSaveContactCui);
            if (!cui->getFromPhb())
            {   
               itemName->setImage(VfxImageSrc(img.getPath()));
            }
            else
            {
                itemName->setImage(VfxImageSrc(img.getPath()));
            } 
        }
        else
        {
            itemName->setImage(VfxImageSrc());
        }

        m_form->addItem(itemName, item.m_itemId);

    #ifdef __MMI_PHB_LAST_NAME_FIELD__
        itemName->m_nameTaped.connect(this, &VappPhbEditorPage::onNameTaped);
    #endif
    
        VappPhbPhotoCp *image = itemName->getImageBtn();
        image->m_signalClicked.connect(this, &VappPhbEditorPage::onImageClick);
    }
    // contact in SIM
    else
    {
        VcpFormItemTextInput *text;
        VcpTextEditor *editor;

        VFX_OBJ_CREATE(text, VcpFormItemTextInput, m_form);

        item.m_itemId = m_field->getNewItemId();
        item.m_itemType = PB_CONTACT_ITEM_NAME;
        item.m_obj = text;
        m_field->setItem(item);

        //text->setLabelPosition(VCPFORM_TOP_LEFT);
        m_form->addCaption(VAPP_PHB_STR_NAME);
        editor = text->getTextBox();
        VfxU32 length = srv_phb_get_alpha_field_length(m_contact->getStorage(), MMI_PHB_CONTACT_FIELD_ID_NAME);
        length = (length > MMI_PHB_NAME_FIELD_LENGTH) ? MMI_PHB_NAME_FIELD_LENGTH : length;
        editor->setText(
                    name.getGivenBuf(),
                    length,
                    VFX_TRUE,
                 #ifdef __PHB_0x81_SUPPORT__
                    VCP_TEXT_ENCODING_0X81,
                 #else
                    VCP_TEXT_ENCODING_GSM,
                 #endif
                    NULL);

        editor->setIME(IMM_INPUT_TYPE_SENTENCE, IME_DISABLE_NEW_LINE_SYMBOL);
        editor->m_signalActivated.connect(this, &VappPhbEditorPage::onEditorActived);

        m_form->addItem(text, item.m_itemId);
    }
}


#ifdef __MMI_PHB_USIM_SUPPORT__
void VappPhbEditorPage::createNickname()
{
    VappContactFieldItem item;
    VappContactNickname& nickname = m_contact->getNickname();

    // contact in phone
    if (m_contact->getStorage() != PHB_STORAGE_NVRAM &&
    #ifdef __MMI_PHB_TCARD_STORAGE_SUPPORT__
        m_contact->getStorage() != PHB_STORAGE_TCARD &&
    #endif
        (MMI_PHB_CONTACT_FIELD_NICK & m_contact->getAbility()))
    {
        VcpFormItemTextInput *text;
        VcpTextEditor *editor;

        VFX_OBJ_CREATE(text, VcpFormItemTextInput, m_form);

        item.m_itemId = m_field->getNewItemId();
        item.m_itemType = PB_CONTACT_ITEM_NICKNAME;
        item.m_obj = text;
        m_field->setItem(item);

        //text->setLabelPosition(VCPFORM_TOP_LEFT);
        m_form->addCaption(VAPP_PHB_STR_NICKNAME);

        editor = text->getTextBox();
        if (m_action == VAPP_PHB_CONTACT_ADD || srv_phb_get_storage(m_id) != m_contact->getStorage() ||
            (srv_phb_get_storage(m_id) == m_contact->getStorage() && nickname.isEmpty()))
        {
        #ifdef __MMI_PHB_USIM_SUPPORT__
            if (srv_phb_get_usim_field_total(m_contact->getStorage(), 0, PHB_SNE) ==
                srv_phb_get_usim_field_used(m_contact->getStorage(), 0, PHB_SNE))
            {
                VfxWString textInfo = VFX_WSTR_RES(STR_ID_VAPP_PHB_MAX_NUM_REACH);
                VfxS32 maxLen = textInfo.getLength();
                editor->setIsDisabled(VFX_TRUE);
                editor->setText(textInfo, maxLen, VFX_TRUE);
                editor->m_signalActivated.connect(this, &VappPhbEditorPage::onEditorActived);

                m_form->addItem(text, item.m_itemId);
                return;
            }
        #endif /* __MMI_PHB_USIM_SUPPORT__ */
        }

        VfxU32 length = srv_phb_get_alpha_field_length(m_contact->getStorage(), MMI_PHB_CONTACT_FIELD_ID_NICK);
        length = (length > MMI_PHB_NAME_FIELD_LENGTH) ? MMI_PHB_NAME_FIELD_LENGTH : length;
        editor->setText(
                    nickname.getBuf(),
                    length,
                    VFX_TRUE,
                 #ifdef __PHB_0x81_SUPPORT__
                    VCP_TEXT_ENCODING_0X81,
                 #else
                    VCP_TEXT_ENCODING_GSM,
                 #endif
                    NULL);

        editor->setIME(IMM_INPUT_TYPE_SENTENCE, IME_DISABLE_NEW_LINE_SYMBOL);
        editor->m_signalActivated.connect(this, &VappPhbEditorPage::onEditorActived);

        m_form->addItem(text, item.m_itemId);
    }
}
#endif /* __MMI_PHB_USIM_SUPPORT__ */


void VappPhbEditorPage::createNumber()
{
    // create exist number
    // not support number
    if (m_contact->getNumberMaxCount() == 0)
    {
        return;
    }

    // only one number supported
    if (m_contact->getNumberMaxCount() == 1)
    {
        VcpFormItemTextInput *text;
        VcpTextEditor *editor;
        VappContactFieldItem item;

        if (m_contact->getNumberCount() == 0)
        {
            VappContactNumber tempNumber(
                            VFX_WSTR_EMPTY,
                            VFX_WSTR_RES(VAPP_PHB_STR_MOBILE),
                            MMI_PHB_CONTACT_FIELD_NUMBER,
                            MMI_PHB_NUM_TYPE_MOBILE,
                            MMI_PHB_SUB_ID_NEW,
                            VFX_FALSE);

            m_contact->setNumber(tempNumber, m_numCount);
        }

        VappContactNumber& number = m_contact->getNumber(0);

        VFX_OBJ_CREATE(text, VcpFormItemTextInput, m_form);

        item.m_itemId = m_field->getNewItemId();
        item.m_itemType = PB_CONTACT_ITEM_NUMBER;
        item.m_obj = text;
        m_field->setItem(item);

        //text->setLabelPosition(VCPFORM_TOP_LEFT);
        //text->setLabelText(VFX_WSTR_RES(VAPP_PHB_STR_NUMBER));
        m_form->addCaption(VFX_WSTR_RES(VAPP_PHB_STR_NUMBER));

        editor = text->getTextBox();
        editor->setText(number.getBuf(), MMI_PHB_NUMBER_LENGTH, VFX_TRUE);
        editor->setIME(IMM_INPUT_TYPE_PHONE_NUMBER, IME_PLUS_CHAR_HANDLING);
        editor->m_signalActivated.connect(this, &VappPhbEditorPage::onEditorActived);

        m_form->addItem(text, item.m_itemId);
    }
    // support more than one number
    else
    {
        // create number caption
        m_form->addCaption(VFX_WSTR_RES(VAPP_PHB_STR_NUMBER));

        VfxU32 numCount = m_contact->getNumberCount();
        if (numCount > m_contact->getNumberMaxCount())
        {
            numCount = m_contact->getNumberMaxCount();
        }

        for (VfxU32 i = 0; i < numCount; i++)
        {
            // get number instance
            VappContactNumber& number = m_contact->getNumber(i);

            VcpFormItemRemovableTextEntry *addNum = NULL;
            VFX_OBJ_CREATE(addNum, VcpFormItemRemovableTextEntry, m_form);

            VappContactFieldItem item;
            item.m_itemId = m_field->getNewItemId();
            item.m_itemType = PB_CONTACT_ITEM_NUMBER;
            item.m_fieldId = i;
            if (!m_contact->getLabelSupport())
            {
                number.setSubType(MMI_PHB_NUM_TYPE_MOBILE);
            }
            item.m_fieldType = number.getSubType();
            item.m_obj = addNum;
            m_field->setItem(item);

            addNum->setMode(VFX_FALSE);
            if (m_contact->getStorage() == PHB_STORAGE_NVRAM
            /* myler check */
            #ifdef __MMI_PHB_TCARD_STORAGE_SUPPORT__
                || m_contact->getStorage() == PHB_STORAGE_TCARD
            #endif
                )
            {
                addNum->getLeftButton()->setText(number.getLabel());
                addNum->getLeftButton()->setId(item.m_itemId);
            }
            else
            {
                addNum->setHasLeftButton(VFX_FALSE);
            }

            VcpTextEditor *editor;
            editor = addNum->getTextBox();
            if (i > 0 && m_contact->getStorage() != PHB_STORAGE_NVRAM &&
            #ifdef __MMI_PHB_TCARD_STORAGE_SUPPORT__
                m_contact->getStorage() != PHB_STORAGE_TCARD &&
            #endif
                (m_action == VAPP_PHB_CONTACT_ADD || srv_phb_get_storage(m_id) != m_contact->getStorage() ||
                (srv_phb_get_storage(m_id) == m_contact->getStorage() && number.isEmpty())))
            {
            #ifdef __MMI_PHB_USIM_SUPPORT__
                if (srv_phb_get_usim_field_total(m_contact->getStorage(), i - 1, PHB_ANR) ==
                    srv_phb_get_usim_field_used(m_contact->getStorage(), i - 1, PHB_ANR))
                {
                    VfxWString textInfo = VFX_WSTR_RES(STR_ID_VAPP_PHB_MAX_NUM_REACH);
                    VfxS32 maxLen = textInfo.getLength();
                    editor->setIsDisabled(VFX_TRUE);
                    editor->setText(textInfo, maxLen, VFX_TRUE);
                    editor->m_signalActivated.connect(this, &VappPhbEditorPage::onEditorActived);

                    addNum->m_signalAddRemoveClick.connect(this, &VappPhbEditorPage::onNumberClick);
                    m_form->addItem(addNum, item.m_itemId);
                    return;
                }
            #endif /* __MMI_PHB_USIM_SUPPORT__ */
            }

            editor->setIME(IMM_INPUT_TYPE_PHONE_NUMBER,  IME_PLUS_CHAR_HANDLING);
            editor->setText(number.getBuf(), MMI_PHB_NUMBER_LENGTH, VFX_TRUE);
            editor->m_signalActivated.connect(this, &VappPhbEditorPage::onEditorActived);

            if (m_contact->getStorage() == PHB_STORAGE_NVRAM
            #ifdef __MMI_PHB_TCARD_STORAGE_SUPPORT__
                || m_contact->getStorage() == PHB_STORAGE_TCARD
            #endif
                )
            {
                addNum->getLeftButton()->m_signalClicked.connect(this, &VappPhbEditorPage::onLabelClick);
            }
            addNum->m_signalAddRemoveClick.connect(this, &VappPhbEditorPage::onNumberClick);
            m_form->addItem(addNum, item.m_itemId);

            // number count
            m_numCount++;
        }

        createNewNumber();
    }
}


void VappPhbEditorPage::createNewNumber()
{
    VappContactFieldItem item;
    VfxId id;

    // create new number item
    item.m_itemId = m_field->getNewItemId();
    id = item.m_itemId;
    item.m_itemType = PB_CONTACT_ITEM_NUMBER_NEW;

    VcpFormItemRemovableTextEntry *addNum;
    VFX_OBJ_CREATE(addNum, VcpFormItemRemovableTextEntry, m_form);

    addNum->setMode(VFX_TRUE);
    if (m_contact->getStorage() == PHB_STORAGE_NVRAM
        /* myler check */
    #ifdef __MMI_PHB_TCARD_STORAGE_SUPPORT__
        || m_contact->getStorage() == PHB_STORAGE_TCARD
    #endif
        )
    {
        addNum->getLeftButton()->setText(VAPP_PHB_STR_MOBILE);
    }
    else
    {
        addNum->setHasLeftButton(VFX_FALSE);
    }
    addNum->m_signalAddRemoveClick.connect(this, &VappPhbEditorPage::onNumberClick);
    m_form->addItem(addNum, item.m_itemId);

    item.m_obj = addNum;
    m_field->setItem(item);

    if (m_contact->getNumberCount() >= m_contact->getNumberMaxCount())
    {
        addNum->setIsHidden(VFX_TRUE);
        return;
    }
    // add
    if (m_autoAdd)
    {
        return;
    }
    if (m_numCount < m_contact->getNumberMaxCount())
    {
        VappContactNumber tempNumber(
                        VFX_WSTR_EMPTY,
                        VFX_WSTR_RES(VAPP_PHB_STR_MOBILE),
                        MMI_PHB_CONTACT_FIELD_NUMBER,
                        MMI_PHB_NUM_TYPE_MOBILE,
                        MMI_PHB_SUB_ID_NEW,
                        VFX_FALSE);

        m_contact->setNumber(tempNumber, m_numCount);
        VappContactNumber& number = m_contact->getNumber(m_numCount);

        VcpFormItemRemovableTextEntry *addNum = NULL;
        VFX_OBJ_CREATE(addNum, VcpFormItemRemovableTextEntry, m_form);

        VappContactFieldItem item;
        item.m_itemId = m_field->getNewItemId();
        item.m_itemType = PB_CONTACT_ITEM_NUMBER;
        item.m_fieldId = m_numCount;
        item.m_fieldType = number.getSubType();
        item.m_obj = addNum;

        VappContactFieldItem tempItem = m_field->getItemByItemType(PB_CONTACT_ITEM_NUMBER_NEW);
        m_field->insertItem(item, tempItem.m_itemId);

        addNum->setMode(VFX_FALSE);
        if (m_contact->getStorage() == PHB_STORAGE_NVRAM
        #ifdef __MMI_PHB_TCARD_STORAGE_SUPPORT__
            || m_contact->getStorage() == PHB_STORAGE_TCARD
        #endif
            )
        {
            addNum->getLeftButton()->setText(number.getLabel());
            addNum->getLeftButton()->setId(item.m_itemId);
        }
        else
        {
            addNum->setHasLeftButton(VFX_FALSE);
        }

        VcpTextEditor *editor;
        editor = addNum->getTextBox();
        editor->setIME(IMM_INPUT_TYPE_PHONE_NUMBER, IME_PLUS_CHAR_HANDLING);
        editor->setText(number.getBuf(), MMI_PHB_NUMBER_LENGTH, VFX_TRUE);
        editor->m_signalActivated.connect(this, &VappPhbEditorPage::onEditorActived);

        if (m_contact->getStorage() == PHB_STORAGE_NVRAM
        #ifdef __MMI_PHB_TCARD_STORAGE_SUPPORT__
            || m_contact->getStorage() == PHB_STORAGE_TCARD
        #endif
            )
        {
            addNum->getLeftButton()->m_signalClicked.connect(this, &VappPhbEditorPage::onLabelClick);
        }
        addNum->m_signalAddRemoveClick.connect(this, &VappPhbEditorPage::onNumberClick);
        m_form->insertItem(addNum, id, item.m_itemId);

        m_numCount++;

        if (m_numCount == m_contact->getNumberMaxCount())
        {
            VcpFormItemRemovableTextEntry *newItem = (VcpFormItemRemovableTextEntry*) m_field->getObj(PB_CONTACT_ITEM_NUMBER_NEW);
            newItem->setIsHidden(VFX_TRUE);
        }
        m_autoAdd = VFX_TRUE;
    }
}


void VappPhbEditorPage::createEmail()
{
    // create exist email item
    // not support email
    if (m_contact->getEmailMaxCount() == 0)
    {
        return;
    }

    // only support one email
    if (m_contact->getEmailMaxCount() == 1)
    {
        VcpFormItemTextInput *text;
        VcpTextEditor *editor;
        VappContactFieldItem item;

        if (m_contact->getEmailCount() == 0)
        {
            VappContactEmail tempEmail(
                            VFX_WSTR_EMPTY,
                            (m_contact->getStorage() != PHB_STORAGE_NVRAM) ? VFX_WSTR_RES(VAPP_PHB_STR_EMAIL) : VFX_WSTR_RES(VAPP_PHB_STR_WORK),
                            MMI_PHB_CONTACT_FIELD_EMAIL,
                            (m_contact->getStorage() != PHB_STORAGE_NVRAM) ? MMI_PHB_EMAIL_TYPE_NONE : MMI_PHB_EMAIL_TYPE_OFFICE,
                            MMI_PHB_SUB_ID_NEW,
                            VFX_FALSE);

            m_contact->setEmail(tempEmail, m_emailCount);
        }

        VappContactEmail& email = m_contact->getEmail(0);

        if (email.getSubType() != MMI_PHB_EMAIL_TYPE_NONE)
        {
            email.setLabel(VAPP_PHB_STR_EMAIL);
        }
        email.setSubType(MMI_PHB_EMAIL_TYPE_NONE);

        VFX_OBJ_CREATE(text, VcpFormItemTextInput, m_form);

        item.m_itemId = m_field->getNewItemId();
        item.m_itemType = PB_CONTACT_ITEM_EMAIL;
        item.m_obj = text;
        m_field->setItem(item);

        //text->setLabelPosition(VCPFORM_TOP_LEFT);
        m_form->addCaption(VAPP_PHB_STR_EMAIL);

        editor = text->getTextBox();
        if (m_contact->getStorage() != PHB_STORAGE_NVRAM &&
        #ifdef __MMI_PHB_TCARD_STORAGE_SUPPORT__
            m_contact->getStorage() != PHB_STORAGE_TCARD &&
        #endif
            (m_action == VAPP_PHB_CONTACT_ADD || srv_phb_get_storage(m_id) != m_contact->getStorage() ||
            (srv_phb_get_storage(m_id) == m_contact->getStorage() && email.isEmpty())))
        {
        #ifdef __MMI_PHB_USIM_SUPPORT__
            if (srv_phb_get_usim_field_total(m_contact->getStorage(), 0, PHB_EMAIL) ==
                srv_phb_get_usim_field_used(m_contact->getStorage(), 0, PHB_EMAIL))
            {
                VfxWString textInfo = VFX_WSTR_RES(STR_ID_VAPP_PHB_MAX_NUM_REACH);
                VfxS32 maxLen = textInfo.getLength();
                editor->setIsDisabled(VFX_TRUE);
                editor->setText(textInfo, maxLen, VFX_TRUE);
                editor->m_signalActivated.connect(this, &VappPhbEditorPage::onEditorActived);

                m_form->addItem(text, item.m_itemId);
                return;
            }
        #endif /* __MMI_PHB_USIM_SUPPORT__ */
        }

        VfxU32 length = srv_phb_get_alpha_field_length(m_contact->getStorage(), MMI_PHB_CONTACT_FIELD_ID_EMAIL);
        length = (length > MMI_PHB_EMAIL_LENGTH) ? MMI_PHB_EMAIL_LENGTH : length;
        editor->setText(email.getBuf(), length, VFX_TRUE);
        editor->setIME(IMM_INPUT_TYPE_EMAIL, IME_DISABLE_NEW_LINE_SYMBOL);
        editor->m_signalActivated.connect(this, &VappPhbEditorPage::onEditorActived);

        m_form->addItem(text, item.m_itemId);
    }
    // support many email
    else
    {
        // create email caption
        m_form->addCaption(VAPP_PHB_STR_EMAIL);

        VfxU32 emailCount = m_contact->getEmailCount();
        for (VfxU32 i = 0; i < emailCount; i++)
        {
            // get email instance
            VappContactEmail& email = m_contact->getEmail(i);
        #ifdef __MMI_PHB_USIM_SUPPORT__
            if (email.getSubType() == MMI_PHB_EMAIL_TYPE_NONE)
            {
                email.setSubType(MMI_PHB_EMAIL_TYPE_OFFICE);
                email.setLabel(VAPP_PHB_STR_WORK);
            }
        #endif /* __MMI_PHB_USIM_SUPPORT__ */

            VappContactFieldItem item;
            VcpFormItemRemovableTextEntry *addEmail = NULL;
            VFX_OBJ_CREATE(addEmail, VcpFormItemRemovableTextEntry, m_form);

            item.m_itemId = m_field->getNewItemId();
            item.m_itemType = PB_CONTACT_ITEM_EMAIL;
            item.m_fieldId = i;
            item.m_fieldType = email.getSubType();
            item.m_obj = addEmail;
            m_field->setItem(item);

            addEmail->getLeftButton()->setText(email.getLabel());
            addEmail->getLeftButton()->setId(item.m_itemId);
            addEmail->setMode(VFX_FALSE);

            VcpTextEditor *editor;
            editor = addEmail->getTextBox();
            editor->setIME(IMM_INPUT_TYPE_EMAIL, IME_DISABLE_NEW_LINE_SYMBOL);
            VfxU32 length = srv_phb_get_alpha_field_length(m_contact->getStorage(), MMI_PHB_CONTACT_FIELD_ID_EMAIL);
            length = (length > MMI_PHB_EMAIL_LENGTH) ? MMI_PHB_EMAIL_LENGTH : length;
            editor->setText(email.getBuf(), length, VFX_TRUE);
            editor->m_signalActivated.connect(this, &VappPhbEditorPage::onEditorActived);

            addEmail->getLeftButton()->m_signalClicked.connect(this, &VappPhbEditorPage::onLabelClick);
            addEmail->m_signalAddRemoveClick.connect(this, &VappPhbEditorPage::onEmailClick);
            m_form->addItem(addEmail, item.m_itemId);

            // email count
            m_emailCount++;
        }

        // create new email
        createNewEmail();
    }
}


void VappPhbEditorPage::createNewEmail()
{
    VappContactFieldItem item;
    VfxId id;

    // create new number item
    item.m_itemId = m_field->getNewItemId();
    id = item.m_itemId;
    item.m_itemType = PB_CONTACT_ITEM_EMAIL_NEW;

    VcpFormItemRemovableTextEntry *addEmail;
    VFX_OBJ_CREATE(addEmail, VcpFormItemRemovableTextEntry, m_form);

    addEmail->setMode(VFX_TRUE);
    addEmail->getLeftButton()->setText(VAPP_PHB_STR_WORK);
    addEmail->m_signalAddRemoveClick.connect(this, &VappPhbEditorPage::onEmailClick);
    m_form->addItem(addEmail, item.m_itemId);

    item.m_obj = addEmail;
    m_field->setItem(item);

    if (m_contact->getEmailCount() == m_contact->getEmailMaxCount())
    {
        addEmail->setIsHidden(VFX_TRUE);
    }
    // myler add
    if (m_autoAddEmail)
    {
        return;
    }
    if (m_emailCount < m_contact->getEmailMaxCount())
    {
        VappContactEmail tempEmail(
                        VFX_WSTR_EMPTY,
                        (m_contact->getStorage() != PHB_STORAGE_NVRAM) ? VFX_WSTR_RES(VAPP_PHB_STR_EMAIL) : VFX_WSTR_RES(VAPP_PHB_STR_WORK),
                        MMI_PHB_CONTACT_FIELD_EMAIL,
                        (m_contact->getStorage() != PHB_STORAGE_NVRAM) ? MMI_PHB_EMAIL_TYPE_NONE : MMI_PHB_EMAIL_TYPE_OFFICE,
                        MMI_PHB_SUB_ID_NEW,
                        VFX_FALSE);

        m_contact->setEmail(tempEmail, m_emailCount);
        VappContactEmail& email = m_contact->getEmail(m_emailCount);

        VappContactFieldItem item;
        VcpFormItemRemovableTextEntry *addEmail = NULL;
        VFX_OBJ_CREATE(addEmail, VcpFormItemRemovableTextEntry, m_form);

        item.m_itemId = m_field->getNewItemId();
        item.m_itemType = PB_CONTACT_ITEM_EMAIL;
        item.m_fieldId = m_emailCount;
        item.m_fieldType = email.getSubType();
        item.m_obj = addEmail;

        VappContactFieldItem tempItem = m_field->getItemByItemType(PB_CONTACT_ITEM_EMAIL_NEW);
        m_field->insertItem(item, tempItem.m_itemId);

        addEmail->getLeftButton()->setText(email.getLabel());
        addEmail->getLeftButton()->setId(item.m_itemId);
        addEmail->setMode(VFX_FALSE);

        VcpTextEditor *editor;
        editor = addEmail->getTextBox();
        editor->setIME(IMM_INPUT_TYPE_EMAIL, IME_DISABLE_NEW_LINE_SYMBOL);
        VfxU32 length = srv_phb_get_alpha_field_length(m_contact->getStorage(), MMI_PHB_CONTACT_FIELD_ID_EMAIL);
        length = (length > MMI_PHB_EMAIL_LENGTH) ? MMI_PHB_EMAIL_LENGTH : length;
        editor->setText(email.getBuf(), length, VFX_TRUE);
        editor->m_signalActivated.connect(this, &VappPhbEditorPage::onEditorActived);

        addEmail->getLeftButton()->m_signalClicked.connect(this, &VappPhbEditorPage::onLabelClick);
        addEmail->m_signalAddRemoveClick.connect(this, &VappPhbEditorPage::onEmailClick);
        m_form->insertItem(addEmail, id, item.m_itemId);

        m_emailCount++;

        if (m_emailCount == m_contact->getEmailMaxCount())
        {
            VcpFormItemRemovableTextEntry *newItem = (VcpFormItemRemovableTextEntry*) m_field->getObj(PB_CONTACT_ITEM_EMAIL_NEW);
            newItem->setIsHidden(VFX_TRUE);
        }
        m_autoAddEmail = VFX_TRUE;
    }
}


#ifdef __MMI_PHB_INFO_FIELD__
void VappPhbEditorPage::createAddress()
{
    if (MMI_PHB_CONTACT_FIELD_ADDRESS & m_contact->getAbility())
    {
        VappContactFieldItem item;
        VappContactAddress& address = m_contact->getAddress();

        // create add address caption
        m_form->addCaption(VAPP_PHB_STR_ADDRESS);

        VappPhbEditorAddressFormItem *addressItem;
        VFX_OBJ_CREATE(addressItem, VappPhbEditorAddressFormItem, m_form);

        VfxWString label = address.getString();
        if (label.isEmpty())
        {
            label.loadFromRes(VAPP_PHB_STR_ADD_ADDRESS);
        }
        addressItem->setLabel(label);

        item.m_itemId = m_field->getNewItemId();
        item.m_itemType = PB_CONTACT_ITEM_ADDRESS;
        item.m_obj = addressItem;
        m_field->setItem(item);

        m_form->addItem(addressItem, item.m_itemId);

        addressItem->m_addressTaped.connect(this, &VappPhbEditorPage::onAddressTaped);
    }
}
#endif /* __MMI_PHB_INFO_FIELD__ */


#if defined (__MMI_PHB_BIRTHDAY_FIELD__) || defined (__MMI_PHB_OPTIONAL_FIELD_ADDITIONAL__) || defined (__MMI_PHB_INFO_FIELD__)

void VappPhbEditorPage::createOtherInfo()
{
    if (m_contact->getStorage() == PHB_STORAGE_NVRAM 
    #ifdef __MMI_PHB_TCARD_STORAGE_SUPPORT__
        || m_contact->getStorage() == PHB_STORAGE_TCARD
    #endif
        )
    {
        VappContactFieldItem item;

        if (
    #ifdef __MMI_PHB_BIRTHDAY_FIELD__
            MMI_PHB_CONTACT_FIELD_BDAY & m_contact->getAbility()||
    #endif
            MMI_PHB_CONTACT_FIELD_TITLE & m_contact->getAbility() ||
            MMI_PHB_CONTACT_FIELD_COMPANY & m_contact->getAbility() ||
            MMI_PHB_CONTACT_FIELD_NOTE & m_contact->getAbility())
        {
            // create Other information caption
            m_form->addCaption(VFX_WSTR_RES(VAPP_PHB_STR_OTHER_INFO));
        }
    #ifdef __MMI_PHB_BIRTHDAY_FIELD__
        if (MMI_PHB_CONTACT_FIELD_BDAY & m_contact->getAbility())
        {
            // create Birthday
            VappContactBday& bday = m_contact->getBday();

            VcpFormItemTextInput *birthday;
            VFX_OBJ_CREATE(birthday, VcpFormItemTextInput, m_form);

            item.m_itemId = m_field->getNewItemId();
            item.m_itemType = PB_CONTACT_ITEM_BDAY;
            item.m_obj = birthday;
            m_field->setItem(item);

            birthday->setLabelPosition(VCPFORM_LEFT);
            birthday->setLabelText(VFX_WSTR_RES(VAPP_PHB_STR_BDAY));
            VcpTextEditor *editor = birthday->getTextBox();
            editor->setText(bday.getString(), VAPP_PHB_BIRTHDAY_LENGTH);
            editor->setIME(IMM_INPUT_TYPE_NONE);
            editor->m_signalActivated.connect(this, &VappPhbEditorPage::onEditorActived);
            editor->m_signalActivated.connect(this, &VappPhbEditorPage::onBirthDayClick);

            m_form->addItem(birthday, item.m_itemId);
        }
    #endif /* __MMI_PHB_BIRTHDAY_FIELD__ */
    
    #ifdef __MMI_PHB_INFO_FIELD__
        if (MMI_PHB_CONTACT_FIELD_TITLE & m_contact->getAbility())
        {
            // create Title
            VappContactTitle& title = m_contact->getTitle();

            VcpFormItemTextInput *titleItem;
            VFX_OBJ_CREATE(titleItem, VcpFormItemTextInput, m_form);

            item.m_itemId = m_field->getNewItemId();
            item.m_itemType = PB_CONTACT_ITEM_TITLE;
            item.m_obj = titleItem;
            m_field->setItem(item);

            titleItem->setLabelPosition(VCPFORM_LEFT);
            titleItem->setLabelText(VAPP_PHB_STR_TITLE);
            VcpTextEditor *editor = titleItem->getTextBox();
            editor->setText(title.getBuf(), MMI_PHB_TITLE_LENGTH, VFX_TRUE);
            editor->m_signalActivated.connect(this, &VappPhbEditorPage::onEditorActived);

            m_form->addItem(titleItem, item.m_itemId);
        }
    #endif /* __MMI_PHB_INFO_FIELD__ */

    #ifdef __MMI_PHB_OPTIONAL_FIELD_ADDITIONAL__
        if (MMI_PHB_CONTACT_FIELD_COMPANY & m_contact->getAbility())
        {
            // create Company
            VappContactCompany& company = m_contact->getCompany();

            VcpFormItemTextInput *companyItem;
            VFX_OBJ_CREATE(companyItem, VcpFormItemTextInput, m_form);

            item.m_itemId = m_field->getNewItemId();
            item.m_itemType = PB_CONTACT_ITEM_COMPANY;
            item.m_obj = companyItem;
            m_field->setItem(item);

            companyItem->setLabelPosition(VCPFORM_LEFT);
            companyItem->setLabelText(VAPP_PHB_STR_COMPANY);
            VcpTextEditor *editor = companyItem->getTextBox();
            editor->setText(company.getBuf(), MMI_PHB_COMPANY_LENGTH, VFX_TRUE);
            editor->m_signalActivated.connect(this, &VappPhbEditorPage::onEditorActived);

            m_form->addItem(companyItem, item.m_itemId);
        }
    #endif /* __MMI_PHB_OPTIONAL_FIELD_ADDITIONAL__ */

    #ifdef __MMI_PHB_INFO_FIELD__
        if (MMI_PHB_CONTACT_FIELD_NOTE & m_contact->getAbility())
        {
            // create Note
            VappContactNote& note = m_contact->getNote();

            VcpFormItemTextInput *noteItem;
            VFX_OBJ_CREATE(noteItem, VcpFormItemTextInput, m_form);

            item.m_itemId = m_field->getNewItemId();
            item.m_itemType = PB_CONTACT_ITEM_NOTE;
            item.m_obj = noteItem;
            m_field->setItem(item);

            noteItem->setLabelPosition(VCPFORM_LEFT);
            noteItem->setLabelText(VAPP_PHB_STR_NOTE);
            VcpTextEditor *editor = noteItem->getTextBox();
            editor->setText(note.getBuf(), MMI_PHB_NOTE_LENGTH, VFX_TRUE);
            editor->m_signalActivated.connect(this, &VappPhbEditorPage::onEditorActived);

            m_form->addItem(noteItem, item.m_itemId);
        }
    #endif /* __MMI_PHB_INFO_FIELD__ */
    }
}
#endif

void VappPhbEditorPage::createSetting()
{
    VappContactFieldItem item;
    VcpFormItemBigArrowButton *moreBtn;
    VcpArrowButton *btn;

    // create Contact settings caption
    m_form->addCaption(VAPP_PHB_STR_CONTACT_SETTING);

    if (m_contact->getStorage() == PHB_STORAGE_NVRAM
    #ifdef __MMI_PHB_USIM_SUPPORT__
        || UsimGroup::isSupport(m_contact->getStorage())
    #endif
    #ifdef __MMI_PHB_TCARD_STORAGE_SUPPORT__
        || m_contact->getStorage() == PHB_STORAGE_TCARD
    #endif
        )
    {
#ifdef __MMI_PHB_CALLER_GROUP__ 
        // create group button
        VFX_OBJ_CREATE(moreBtn, VcpFormItemBigArrowButton, m_form);

        item.m_itemId = m_field->getNewItemId();
        item.m_itemType = PB_CONTACT_ITEM_GROUP;
        item.m_obj = moreBtn;
        m_field->setItem(item);

        moreBtn->setButtonText(VFX_WSTR_RES(VAPP_PHB_STR_GROUP));
        VfxWString hintText = m_contact->getGroupName();
        if (hintText.isEmpty())
        {
            hintText = VFX_WSTR_RES(VAPP_PHB_STR_NO_GROUP);
        }
        moreBtn->setHintText(hintText);
        VcpArrowButton *groupBtn = moreBtn->getButton();
        groupBtn->m_signalClicked.connect(this, &VappPhbEditorPage::onGroupClick);

        m_form->addItem(moreBtn, item.m_itemId);
#endif
    }

    if (m_contact->getStorage() == PHB_STORAGE_NVRAM
    #ifdef __MMI_PHB_TCARD_STORAGE_SUPPORT__
        || m_contact->getStorage() == PHB_STORAGE_TCARD
    #endif
        )
    {
        // create ringtone button
        VFX_OBJ_CREATE(moreBtn, VcpFormItemBigArrowButton, m_form);
        VappContactRes& ring = m_contact->getRingTone();

        item.m_itemId = m_field->getNewItemId();
        item.m_itemType = PB_CONTACT_ITEM_RINGTONE;
        item.m_obj = moreBtn;
        m_field->setItem(item);

        moreBtn->setButtonText(VAPP_PHB_STR_RING);
        moreBtn->setHintText(ring.getString());
        VcpArrowButton *ringBtn = moreBtn->getButton();
        ringBtn->m_signalClicked.connect(this, &VappPhbEditorPage::onRingClick);

        m_form->addItem(moreBtn, item.m_itemId);
    }

    // create storage button
    VFX_OBJ_CREATE(moreBtn, VcpFormItemBigArrowButton, m_form);

    item.m_itemId = m_field->getNewItemId();
    item.m_itemType = PB_CONTACT_ITEM_STORAGE;
    item.m_obj = moreBtn;
    m_field->setItem(item);

    moreBtn->setButtonText(VAPP_PHB_STR_STORAGE);
    moreBtn->setHintText(ContactStorage::getName(m_contact->getStorage()));
    btn = moreBtn->getButton();
    btn->m_signalClicked.connect(this, &VappPhbEditorPage::onStorageClick);

    m_form->addItem(moreBtn, item.m_itemId);
}


void VappPhbEditorPage::updateName()
{
    VappPhbEditorNameFormItem *name = (VappPhbEditorNameFormItem*) m_field->getObj(PB_CONTACT_ITEM_NAME);

#ifdef __MMI_PHB_LAST_NAME_FIELD__
    VfxWString tempName = m_contact->getName().getString();
    if (tempName.isEmpty())
    {
        if (m_action == VAPP_PHB_CONTACT_ADD)
        {
            tempName = VFX_WSTR_RES(VAPP_PHB_STR_ADD_NAME);
        }
        else
        {
            tempName = VFX_WSTR_RES(VAPP_PHB_STR_UNNAMED);
        }
    }

    name->setName(tempName);
#endif /* __MMI_PHB_LAST_NAME_FIELD__ */

    VappContactRes& img = m_contact->getImage();
    if (img.getPath().isEmpty())
    {
        name->setImage(VfxImageSrc());
    }
    else if (srv_fmgr_fs_path_exist(img.getPath())>= 0)
    {
        //kal_prompt_trace(MOD_MMI, "path is not empty and has pic ");
        if(vapp_phb_query_head_portrait_need_thumbnail((CHAR*)img.getPath().getBuf()))
        {
            name->m_image->setImageContentPlacement(VFX_FRAME_CONTENT_PLACEMENT_TYPE_CENTER);
        }

        name->setImage(VfxImageSrc(img.getPath()));
    }
    else
    {
        //kal_prompt_trace(MOD_MMI, "path is not empty, but the path is not ");
        name->setImage(VfxImageSrc());
    }
}


#ifdef __MMI_PHB_INFO_FIELD__
void VappPhbEditorPage::updateAddress()
{
    VfxWString label = m_contact->getAddress().getString();
    if (label.isEmpty())
    {
        label.loadFromRes(VAPP_PHB_STR_ADD_ADDRESS);
    }

    VappPhbEditorAddressFormItem *frame = (VappPhbEditorAddressFormItem*) m_field->getObj(PB_CONTACT_ITEM_ADDRESS);
    frame->setLabel(label);
}
#endif /* __MMI_PHB_INFO_FIELD__ */


#ifdef  __MMI_PHB_CALLER_GROUP__ 
void VappPhbEditorPage::updateGroup()
{
    VfxWString hintText = m_contact->getGroupName();
    if (hintText.isEmpty())
    {
        hintText.loadFromRes(VAPP_PHB_STR_NO_GROUP);
    }

    VcpFormItemBigArrowButton *groupBtn = (VcpFormItemBigArrowButton*) m_field->getObj(PB_CONTACT_ITEM_GROUP);
    groupBtn->setHintText(hintText);
}

#endif /* __MMI_PHB_CALLER_GROUP__ */


void VappPhbEditorPage::save()
{
#ifndef __MMI_PHB_LAST_NAME_FIELD__
    if (m_contact->getStorage() == PHB_STORAGE_NVRAM
    #ifdef __MMI_PHB_TCARD_STORAGE_SUPPORT__
        || m_contact->getStorage() == PHB_STORAGE_TCARD
    #endif
       )
    {
        VappPhbEditorNameFormItem *name = (VappPhbEditorNameFormItem*) m_field->getObj(PB_CONTACT_ITEM_NAME);
        m_contact->getName().setGiven(name->getEditor()->getText());
    }
#endif /* __MMI_PHB_LAST_NAME_FIELD__ */

    // check empty name, number, email
    if (m_contact->getName().isEmpty())
    {
        VfxBool isEmptyContact = VFX_TRUE;

        // check number
        VfxU32 count = m_contact->getNumberCount();
        for (VfxU32 i = 0; i < count && i < m_contact->getNumberMaxCount(); i++)
        {
            VappContactNumber& num = m_contact->getNumber(i);
            if (!num.isEmpty())
            {
                isEmptyContact = VFX_FALSE;
                break;
            }
        }

        // check email
        if (isEmptyContact && m_contact->getStorage() == PHB_STORAGE_NVRAM)
        {
            count = m_contact->getEmailCount();
            for (VfxU32 i = 0; i < count && i < m_contact->getEmailMaxCount(); i++)
            {
                VappContactEmail& email = m_contact->getEmail(i);
                if (!email.isEmpty())
                {
                    isEmptyContact = VFX_FALSE;
                    break;
                }
            }
        }

        // popup error
        if (isEmptyContact)
        {
            VcpInfoBalloon *balloon = VFX_OBJ_GET_INSTANCE(VcpInfoBalloon);
            balloon->addItem(VCP_INFO_BALLOON_TYPE_FAILURE, VFX_WSTR_RES(STR_ID_VAPP_PHB_NAME_WARNING));
            return;
        }
    }

    // check data valid
    VfxBool valid = VFX_TRUE;
    VfxId id = 0;
    for (VfxU32 i = 0; i < m_field->getItemCount(); i++)
    {
        VappContactFieldItem item = m_field->getItemByIndex(i);
        switch (item.m_itemType)
        {
            case PB_CONTACT_ITEM_NUMBER:
            {
                if (m_contact->getNumberMaxCount() == 1)
                {
                    VcpFormItemTextInput *text = (VcpFormItemTextInput*)item.m_obj;
                    if (!checkValidNumber(text->getTextBox()->getText(), m_contact->getStorage()))
                    {
                        if (valid)
                        {
                            id = item.m_itemId;
                            valid = VFX_FALSE;
                        }
                        text->setWarningText(STR_GLOBAL_INVALID_NUMBER);
                    }
                    else
                    {
                        text->setWarningText(VFX_WSTR_EMPTY);
                    }
                }
                else
                {
                    VcpFormItemRemovableTextEntry *text = (VcpFormItemRemovableTextEntry*) item.m_obj;
                    if (!checkValidNumber(text->getTextBox()->getText(), m_contact->getStorage()))
                    {
                        if (valid)
                        {
                            id = item.m_itemId;
                            valid = VFX_FALSE;
                        }
                        text->setWarningText(STR_GLOBAL_INVALID_NUMBER);
                    }
                    else
                    {
                        text->setWarningText(VFX_WSTR_EMPTY);
                    }
                }
                break;
            }
            case PB_CONTACT_ITEM_EMAIL:
            {
                if (m_contact->getEmailMaxCount() == 1)
                {
                    VappContactEmail& email = m_contact->getEmail(0);
                 #ifdef __MMI_PHB_USIM_SUPPORT__
                    if ((m_contact->getStorage() != PHB_STORAGE_NVRAM &&
                    #ifdef __MMI_PHB_TCARD_STORAGE_SUPPORT__
                        m_contact->getStorage() != PHB_STORAGE_TCARD &&
                    #endif
                        (m_action == VAPP_PHB_CONTACT_ADD || srv_phb_get_storage(m_id) != m_contact->getStorage() ||
                        (srv_phb_get_storage(m_id) == m_contact->getStorage() && email.isEmpty()))) &&
                        srv_phb_get_usim_field_total(m_contact->getStorage(), 0, PHB_EMAIL) ==
                        srv_phb_get_usim_field_used(m_contact->getStorage(), 0, PHB_EMAIL))
                    {
                        VcpFormItemTextInput *text = (VcpFormItemTextInput*)item.m_obj;
                        text->setWarningText(VFX_WSTR_EMPTY);
                    }
                    else
                 #endif /* __MMI_PHB_USIM_SUPPORT__ */
                    {
                        VcpFormItemTextInput *text = (VcpFormItemTextInput*)item.m_obj;
                        VfxWChar *value = text->getTextBox()->getText();
                        if (mmi_wcslen(value) > 0 && !applib_is_valid_email_address_unicode(value))
                        {
                            if (valid)
                            {
                                id = item.m_itemId;
                                valid = VFX_FALSE;
                            }
                            text->setWarningText(STR_GLOBAL_INVALID_EMAIL_ADDRESS);
                        }
                        else
                        {
                            text->setWarningText(VFX_WSTR_EMPTY);
                        }
                    }
                }
                else
                {
                    VcpFormItemRemovableTextEntry *text = (VcpFormItemRemovableTextEntry*) item.m_obj;
                    VfxWChar *value = text->getTextBox()->getText();
                    if (mmi_wcslen(value) > 0 && !applib_is_valid_email_address_unicode(value))
                    {
                        if (valid)
                        {
                            id = item.m_itemId;
                            valid = VFX_FALSE;
                        }
                        text->setWarningText(STR_GLOBAL_INVALID_EMAIL_ADDRESS);
                    }
                    else
                    {
                        text->setWarningText(VFX_WSTR_EMPTY);
                    }
                }
                break;
            }
            
        }
    }

    if (!valid)
    {
        m_form->scrollItemToView(id, VCPFORM_SCROLL_TOP, VFX_TRUE);
        return;
    }

    // check storage status
    switch (ContactStorage::getStatus(m_contact->getStorage()))
    {
        case STORAGE_NOT_ACCESSABLE:
        {
            VcpInfoBalloon *balloon = VFX_OBJ_GET_INSTANCE(VcpInfoBalloon);
            VfxWString errorStr = ContactStorage::getName(m_contact->getStorage());
            errorStr += VFX_WSTR_RES(STR_ID_VAPP_PHB_STORAGE_IS_UNAVAILABLE);
            balloon->addItem(VCP_INFO_BALLOON_TYPE_FAILURE, errorStr);
            return;
        }
        case STORAGE_FULL:
        {
            if (m_action == VAPP_PHB_CONTACT_ADD || ContactStorage::getStorage(m_contact->getId()) != m_contact->getStorage())
            {
                VcpInfoBalloon *balloon = VFX_OBJ_GET_INSTANCE(VcpInfoBalloon);
                VfxWString errorStr = ContactStorage::getName(m_contact->getStorage());
                errorStr += VFX_WSTR_RES(STR_ID_VAPP_PHB_STORAGE_IS_FULL);
                balloon->addItem(VCP_INFO_BALLOON_TYPE_FAILURE, errorStr);
                return;
            }
        }
    }

    m_toolbar->setIsUnhittable(VFX_TRUE);

    // run the save operation
    if (m_action == VAPP_PHB_CONTACT_ADD)
    {
        VFX_OBJ_CREATE_EX(m_save, ContactAdd, this, (m_contact));

        if (m_save->prepare(CONTACT_SAVE, CONTACT_WANT) == CONTACT_RUN)
        {
            // show progress bar
            VFX_OBJ_CREATE(m_progress, VcpIndicatorPopup, this);
            m_progress->setInfoType(VCP_INDICATOR_POPUP_STYLE_ACTIVITY);
            m_progress->setText(STR_GLOBAL_SAVING);

            m_progress->show(VFX_TRUE);

            // save the contact
            m_save->m_signalOP.connect(this, &VappPhbEditorPage::onSaveDone);
            m_save->run();
        }
        else
        {
            finishOP();
        }
    }
    // run the edit operation
    else
    {
        // edit an exist contact
        if (ContactStorage::getStorage(m_contact->getId()) == m_contact->getStorage())
        {
            VFX_OBJ_CREATE_EX(m_save, ContactEdit, this, (m_contact));

            if (m_save->prepare(CONTACT_SAVE, CONTACT_WANT) == CONTACT_RUN)
            {
                // show progress bar
                VFX_OBJ_CREATE(m_progress, VcpIndicatorPopup, this);
                m_progress->setInfoType(VCP_INDICATOR_POPUP_STYLE_ACTIVITY);
                m_progress->setText(STR_GLOBAL_SAVING);

                m_progress->show(VFX_TRUE);

                // save the contact
                m_save->m_signalOP.connect(this, &VappPhbEditorPage::onSaveDone);
                m_save->run();
            }
            else
            {
                finishOP();
            }
        }
        // has changed the contact storage
        else
        {
            VFX_OBJ_CREATE_EX(m_save, ContactAdd, this, (m_contact));

            if (m_save->prepare(CONTACT_SAVE, CONTACT_WANT) == CONTACT_RUN)
            {
                // show progress bar
                VFX_OBJ_CREATE(m_progress, VcpIndicatorPopup, this);
                m_progress->setInfoType(VCP_INDICATOR_POPUP_STYLE_ACTIVITY);
                m_progress->setText(STR_GLOBAL_SAVING);

                m_progress->show(VFX_TRUE);

                // save the contact
                m_save->m_signalOP.connect(this, &VappPhbEditorPage::onSaveDoneAndDelete);
                m_save->run();
            }
            else
            {
                finishOP();
            }
        }
    }
}


void VappPhbEditorPage::onToolBarClick(VfxObject* obj, VfxId id)
{
    switch (id)
    {
        case VAPP_PHB_CONTACT_CMD_SAVE:
        {
            save();
            break;
        }
        case VAPP_PHB_CONTACT_CMD_CANCEL:
        {
            VappPhbSaveContactCui *cui = VFX_OBJ_DYNAMIC_CAST(getApp(), VappPhbSaveContactCui);
            cui->onSavedDone(MMI_PHB_INVALID_CONTACT_ID, VFX_FALSE);
        #ifdef __MMI_PHB_TCARD_STORAGE_SUPPORT__
          //  getMainScr()->popPage(); // myler tcard for cui scr close
        #endif
            break;
        }
    }
}


void VappPhbEditorPage::onImageClick(VfxObject* obj, VfxId id)
{
    // pre handler
    onEditorPreActive();

#ifdef __LOW_COST_SUPPORT_COMMON__
    VappPhbSaveContactCui *cui = VFX_OBJ_DYNAMIC_CAST(getApp(), VappPhbSaveContactCui);
    if (!cui->getFromPhb())
    {
        VcpInfoBalloon *balloon = VFX_OBJ_GET_INSTANCE(VcpInfoBalloon);
        balloon->addItem(VCP_INFO_BALLOON_TYPE_INFO, VFX_WSTR_RES(STR_ID_VAPP_PHB_SLIM_EDIT_PHOTO_POPUP));
        return;
    }
#endif /* __LOW_COST_SUPPORT_COMMON__ */

    if (!vapp_phb_usb_app_is_available())
    {
        return;
    }

    VcpCommandPopup *option;
    VFX_OBJ_CREATE(option, VcpCommandPopup, this);

    option->setText(STR_ID_VAPP_PHB_SET_PHOTO);

    option->addItem(VAPP_PHB_IMAGE_CMD_FILE, (VfxResId)STR_ID_VAPP_PHB_SELECT_FROM_GALLERY, VCP_POPUP_BUTTON_TYPE_NORMAL);

#ifndef __LOW_COST_SUPPORT_COMMON__
#ifdef __MMI_CAMCORDER__
    option->addItem(VAPP_PHB_IMAGE_CMD_CAMERA, VFX_WSTR_RES(STR_ID_VAPP_PHB_TAKE_A_PHOTO), VCP_POPUP_BUTTON_TYPE_NORMAL);
#if defined(__MMI_VIDEO_TELEPHONY__) && defined(__OP01__)
    if (srv_ucm_query_call_count(SRV_UCM_CALL_STATE_ALL, SRV_UCM_VIDEO_CALL_TYPE, NULL))
    {
        option->disableItem(VAPP_PHB_IMAGE_CMD_CAMERA);
    }
#endif /* defined(__MMI_VIDEO_TELEPHONY__) && defined(__OP01__) */
#endif /* __MMI_CAMCORDER__ */
#endif /* __LOW_COST_SUPPORT_COMMON__ */

    if (!m_contact->getImage().getImageSrc().isEmpty() && srv_fmgr_fs_path_exist((WCHAR*)(m_contact->getImage().getPath().getBuf())) >= 0)
    {
        option->addItem(VAPP_PHB_IMAGE_CMD_REMOVE, (VfxResId)STR_ID_VAPP_PHB_REMOVE_PHOTO, VCP_POPUP_BUTTON_TYPE_NORMAL);
    }

    option->addItem(VAPP_PHB_IMAGE_CMD_TYPE_TOTAL, (VfxResId)STR_GLOBAL_CANCEL, VCP_POPUP_BUTTON_TYPE_CANCEL);

    option->m_signalButtonClicked.connect(this, &VappPhbEditorPage::onImageFromClick);

    option->show(VFX_TRUE);
}


void VappPhbEditorPage::onImageFromClick(VfxObject* obj, VfxId id)
{
    switch (id)
    {
        case VAPP_PHB_IMAGE_CMD_FILE:
        {
            FMGR_FILTER filter;
            FMGR_FILTER_INIT(&filter);
        #if defined(__GDI_MEMORY_PROFILE_2__)   /* Able to select jpeg file if supported */
            FMGR_FILTER_SET(&filter, FMGR_TYPE_JPG);
            FMGR_FILTER_SET(&filter, FMGR_TYPE_JPEG);
        #endif 
            FMGR_FILTER_SET(&filter, FMGR_TYPE_GIF);
            FMGR_FILTER_SET(&filter, FMGR_TYPE_BMP);
            FMGR_FILTER_SET(&filter, FMGR_TYPE_WBMP);
            FMGR_FILTER_SET(&filter, FMGR_TYPE_WBM);
        #if defined(GDI_USING_PNG)
            FMGR_FILTER_SET(&filter, FMGR_TYPE_PNG);
        #endif 
        #if defined(__DRM_V02__)
            FMGR_FILTER_SET(&filter, FMGR_TYPE_ODF);
        #endif /* defined(__DRM_V02__) */
            FMGR_FILTER_SET(&filter, FMGR_TYPE_FOLDER);

            mmi_id cui_id = vcui_gallery_image_picker_create(getApp()->getGroupId(), MMI_FALSE, &filter);
            if (cui_id != GRP_ID_INVALID)
            {
                vfxSetCuiCallerScr(cui_id, getMainScr());
                vcui_gallery_picker_set_auto_close(cui_id, MMI_FALSE);
                vcui_gallery_run(cui_id);
            }
            break;
        }
    #ifndef __LOW_COST_SUPPORT_COMMON__
    #ifdef __MMI_CAMCORDER__
        case VAPP_PHB_IMAGE_CMD_CAMERA:
        {
            vcui_camco_err_code_enum errCode = vcui_standard_camera_launchable_check();
            if (errCode == VCUI_CAMCO_ERR_NONE)
            {
                vcui_camco_param_struct param;
                vcui_standard_camera_struct_init(&param);

                mmi_id cui_id = vcui_standard_camera_create(getApp()->getGroupId(), &param);
                if (cui_id != GRP_ID_INVALID)
                {
                    vfxSetCuiCallerScr(cui_id, getMainScr());
                    vcui_standard_camera_run(cui_id);
                }
            }
            else
            {
                mmi_frm_nmgr_balloon(MMI_SCENARIO_ID_DEFAULT, MMI_EVENT_INFO_BALLOON, MMI_NMGR_BALLOON_TYPE_FAILURE,
                    (WCHAR*)VFX_WSTR_RES(vcui_standard_camera_get_err_string(errCode)).getBuf());
            }
            break;
        }
    #endif /* __MMI_CAMCORDER__ */
    #endif /* __LOW_COST_SUPPORT_COMMON__ */
        case VAPP_PHB_IMAGE_CMD_REMOVE:
        {
            m_contact->setImage(VappContactRes());

            VappPhbEditorNameFormItem *itemName = (VappPhbEditorNameFormItem*)(m_field->getObj(PB_CONTACT_ITEM_NAME));
            itemName->setImage(VfxImageSrc());
            break;
        }
    }
}


void VappPhbEditorPage::onRingClick(VfxObject* obj, VfxId id)
{
    // pre handler
    onEditorPreActive();

    MMI_ID cui_id = vcui_tone_selector_create(getApp()->getGroupId());
    if (cui_id != GRP_ID_INVALID)
    {
        vfxSetCuiCallerScr(cui_id, getMainScr());

        vcui_tone_selector_set_title_id(cui_id, STR_ID_VAPP_PHB_SELECT_RINGTONE, 0);

        VappContactRes& ring = m_contact->getRingTone();
        if (ring.getPath().isEmpty() && ring.getResId() != 0)
        {
            vcui_tone_selector_set_hightlight_tone(cui_id, ring.getResId());
        }

        VfxU16 filter;
        VCUI_TONE_SELECTOR_FILTER_INIT(filter);
        VCUI_TONE_SELECTOR_FILTER_SET(filter, (VCUI_TONE_SELECTOR_FILTER_RING | VCUI_TONE_SELECTOR_FILTER_FILE));

        vcui_tone_selector_set_filter(cui_id, filter);

        vcui_tone_selector_run(cui_id);
    }
}


void VappPhbEditorPage::onLabelSelected(VfxU32 type, VfxWString label, VfxU32 userData)
{
    VappContactFieldItem& item = m_field->getItem(userData);
    item.m_fieldType = type;

    // update label
    VcpFormItemRemovableTextEntry *obj = (VcpFormItemRemovableTextEntry*) item.m_obj;
    obj->getLeftButton()->setText(label);

    // update contact obj
    if (item.m_itemType == PB_CONTACT_ITEM_NUMBER)
    {
        m_contact->getNumber(item.m_fieldId).setSubType(type);
        m_contact->getNumber(item.m_fieldId).setLabel(label);
    }
    else
    {
        m_contact->getEmail(item.m_fieldId).setSubType(type);
        m_contact->getEmail(item.m_fieldId).setLabel(label);
    }
}


void VappPhbEditorPage::onLabelClick(VfxObject* obj, VfxId id)
{
    // pre handler
    onEditorPreActive();

    VappContactFieldItem item = m_field->getItem(id);

    mmi_phb_contact_field_id_enum field;
    if (item.m_itemType == PB_CONTACT_ITEM_NUMBER)
    {
        field = MMI_PHB_CONTACT_FIELD_ID_NUMBER;
    }
    else
    {
        field = MMI_PHB_CONTACT_FIELD_ID_EMAIL;
    }

    VappPhbTypeSelectorPage *page;
    VFX_OBJ_CREATE_EX(
        page,
        VappPhbTypeSelectorPage,
        getMainScr(),
        (item.m_fieldType, field, m_contact->getStorage(), id));

    page->m_typeSelected.connect(this, &VappPhbEditorPage::onLabelSelected);

    getMainScr()->pushPageHandler(VFX_ID_NULL, page);
}


#ifdef __MMI_PHB_LAST_NAME_FIELD__
void VappPhbEditorPage::onNameTaped()
{
    // pre handler
    onEditorPreActive();

    VappPhbEditorNamePage *page;
    VFX_OBJ_CREATE_EX(page, VappPhbEditorNamePage, getMainScr(), (m_contact));

    page->m_nameChanged.connect(this, &VappPhbEditorPage::onContentChanged);

    getMainScr()->pushPage(VFX_ID_NULL, page);
}
#endif /* __MMI_PHB_LAST_NAME_FIELD__ */


void VappPhbEditorPage::onNumberClick(VcpFormItemRemovableTextEntry* obj, VfxId id, VfxBool addRemove)
{
    // pre handler
    onEditorPreActive();

    // add new number
    if (addRemove)
    {
        if (m_numCount < m_contact->getNumberMaxCount())
        {
            VappContactNumber tempNumber(
                            VFX_WSTR_EMPTY,
                            VFX_WSTR_RES(VAPP_PHB_STR_MOBILE),
                            MMI_PHB_CONTACT_FIELD_NUMBER,
                            MMI_PHB_NUM_TYPE_MOBILE,
                            MMI_PHB_SUB_ID_NEW,
                            VFX_FALSE);

            m_contact->setNumber(tempNumber, m_numCount);
            VappContactNumber& number = m_contact->getNumber(m_numCount);

            VcpFormItemRemovableTextEntry *addNum = NULL;
            VFX_OBJ_CREATE(addNum, VcpFormItemRemovableTextEntry, m_form);

            VappContactFieldItem item;
            item.m_itemId = m_field->getNewItemId();
            item.m_itemType = PB_CONTACT_ITEM_NUMBER;
            item.m_fieldId = m_numCount;
            item.m_fieldType = number.getSubType();
            item.m_obj = addNum;

            VappContactFieldItem tempItem = m_field->getItemByItemType(PB_CONTACT_ITEM_NUMBER_NEW);
            m_field->insertItem(item, tempItem.m_itemId);

            addNum->setMode(VFX_FALSE);
            if (m_contact->getStorage() == PHB_STORAGE_NVRAM
            #ifdef __MMI_PHB_TCARD_STORAGE_SUPPORT__
                || m_contact->getStorage() == PHB_STORAGE_TCARD
            #endif
                )
            {
                addNum->getLeftButton()->setText(number.getLabel());
                addNum->getLeftButton()->setId(item.m_itemId);
            }
            else
            {
                addNum->setHasLeftButton(VFX_FALSE);
            }

            VcpTextEditor *editor;
            editor = addNum->getTextBox();
            editor->setIME(IMM_INPUT_TYPE_PHONE_NUMBER, IME_PLUS_CHAR_HANDLING);
            editor->setText(number.getBuf(), MMI_PHB_NUMBER_LENGTH, VFX_TRUE);
            editor->m_signalActivated.connect(this, &VappPhbEditorPage::onEditorActived);

            if (m_contact->getStorage() == PHB_STORAGE_NVRAM
            #ifdef __MMI_PHB_TCARD_STORAGE_SUPPORT__
                || m_contact->getStorage() == PHB_STORAGE_TCARD
            #endif
                )
            {
                addNum->getLeftButton()->m_signalClicked.connect(this, &VappPhbEditorPage::onLabelClick);
            }
            addNum->m_signalAddRemoveClick.connect(this, &VappPhbEditorPage::onNumberClick);
            m_form->insertItem(addNum, id, item.m_itemId);

            m_numCount++;

            if (m_numCount == m_contact->getNumberMaxCount())
            {
                VcpFormItemRemovableTextEntry *newItem = (VcpFormItemRemovableTextEntry*) m_field->getObj(PB_CONTACT_ITEM_NUMBER_NEW);
                newItem->setIsHidden(VFX_TRUE);
            }
        }
        // should remove add number item
    }
    // remove exist number
    else
    {
        VappContactFieldItem item = m_field->getItem(id);
        m_contact->removeNumber(item.m_fieldId);

        VfxU32 itemId = item.m_itemId;
        while (1)
        {
            VappContactFieldItem &tempItem = m_field->getNextItem(itemId);
            if (tempItem.m_itemType == PB_CONTACT_ITEM_NUMBER_NEW)
            {
                break;
            }
            else
            {
                itemId = tempItem.m_itemId;
                tempItem.m_fieldId--;
            }
        }

        m_form->removeItem(id);
        m_field->removeItem(id);

        m_numCount--;

        VcpFormItemRemovableTextEntry *newItem = (VcpFormItemRemovableTextEntry*) m_field->getObj(PB_CONTACT_ITEM_NUMBER_NEW);
        newItem->setIsHidden(VFX_FALSE);
    }
}


void VappPhbEditorPage::onEmailClick(VcpFormItemRemovableTextEntry* obj, VfxId id, VfxBool addRemove)
{
    // pre handler
    onEditorPreActive();

    // add new number
    if (addRemove)
    {
        if (m_emailCount < m_contact->getEmailMaxCount())
        {
            VappContactEmail tempEmail(
                            VFX_WSTR_EMPTY,
                            (m_contact->getStorage() != PHB_STORAGE_NVRAM) ? VFX_WSTR_RES(VAPP_PHB_STR_EMAIL) : VFX_WSTR_RES(VAPP_PHB_STR_WORK),
                            MMI_PHB_CONTACT_FIELD_EMAIL,
                            (m_contact->getStorage() != PHB_STORAGE_NVRAM) ? MMI_PHB_EMAIL_TYPE_NONE : MMI_PHB_EMAIL_TYPE_OFFICE,
                            MMI_PHB_SUB_ID_NEW,
                            VFX_FALSE);

            m_contact->setEmail(tempEmail, m_emailCount);
            VappContactEmail& email = m_contact->getEmail(m_emailCount);

            VappContactFieldItem item;
            VcpFormItemRemovableTextEntry *addEmail = NULL;
            VFX_OBJ_CREATE(addEmail, VcpFormItemRemovableTextEntry, m_form);

            item.m_itemId = m_field->getNewItemId();
            item.m_itemType = PB_CONTACT_ITEM_EMAIL;
            item.m_fieldId = m_emailCount;
            item.m_fieldType = email.getSubType();
            item.m_obj = addEmail;

            VappContactFieldItem tempItem = m_field->getItemByItemType(PB_CONTACT_ITEM_EMAIL_NEW);
            m_field->insertItem(item, tempItem.m_itemId);

            addEmail->getLeftButton()->setText(email.getLabel());
            addEmail->getLeftButton()->setId(item.m_itemId);
            addEmail->setMode(VFX_FALSE);

            VcpTextEditor *editor;
            editor = addEmail->getTextBox();
            editor->setIME(IMM_INPUT_TYPE_EMAIL, IME_DISABLE_NEW_LINE_SYMBOL);
            VfxU32 length = srv_phb_get_alpha_field_length(m_contact->getStorage(), MMI_PHB_CONTACT_FIELD_ID_EMAIL);
            length = (length > MMI_PHB_EMAIL_LENGTH) ? MMI_PHB_EMAIL_LENGTH : length;
            editor->setText(email.getBuf(), length, VFX_TRUE);
            editor->m_signalActivated.connect(this, &VappPhbEditorPage::onEditorActived);

            addEmail->getLeftButton()->m_signalClicked.connect(this, &VappPhbEditorPage::onLabelClick);
            addEmail->m_signalAddRemoveClick.connect(this, &VappPhbEditorPage::onEmailClick);
            m_form->insertItem(addEmail, id, item.m_itemId);

            m_emailCount++;

            if (m_emailCount == m_contact->getEmailMaxCount())
            {
                VcpFormItemRemovableTextEntry *newItem = (VcpFormItemRemovableTextEntry*) m_field->getObj(PB_CONTACT_ITEM_EMAIL_NEW);
                newItem->setIsHidden(VFX_TRUE);
            }
        }
        // should remove add number item
    }
    // remove exist number
    else
    {
        VappContactFieldItem item = m_field->getItem(id);
        m_contact->removeEmail(item.m_fieldId);

        VfxU32 itemId = item.m_itemId;
        while (1)
        {
            VappContactFieldItem &tempItem = m_field->getNextItem(itemId);
            if (tempItem.m_itemType == PB_CONTACT_ITEM_EMAIL_NEW)
            {
                break;
            }
            else
            {
                itemId = tempItem.m_itemId;
                tempItem.m_fieldId--;
            }
        }

        m_form->removeItem(id);
        m_field->removeItem(id);

        m_emailCount--;

        VcpFormItemRemovableTextEntry *newItem = (VcpFormItemRemovableTextEntry*) m_field->getObj(PB_CONTACT_ITEM_EMAIL_NEW);
        newItem->setIsHidden(VFX_FALSE);
    }
}

#ifdef __MMI_PHB_BIRTHDAY_FIELD__

void VappPhbEditorPage::onBirthDayChanged()
{
    VcpFormItemTextInput *birthday = (VcpFormItemTextInput*) m_field->getObj(PB_CONTACT_ITEM_BDAY);
    VcpTextEditor *editor = birthday->getTextBox();
    editor->setText(m_contact->getBday().getString(), VAPP_PHB_BIRTHDAY_LENGTH);
    editor->deactivate();
}
#endif /* __MMI_PHB_BIRTHDAY_FIELD__ */



#ifdef __MMI_PHB_BIRTHDAY_FIELD__
void VappPhbEditorPage::onBirthDayClick(VcpTextEditor *editor, VfxBool active)
{
    // pre handler
    onEditorPreActive();

    if (active)
    {
        VcpFormItemTextInput *birthday = (VcpFormItemTextInput*) m_field->getObj(PB_CONTACT_ITEM_BDAY);
        VcpTextEditor *editor = birthday->getTextBox();
        editor->deactivate();

        VappPhbEditorBdayPage *page;
        VFX_OBJ_CREATE_EX(page, VappPhbEditorBdayPage, this, (&(m_contact->getBday())));

        page->m_signalBirthDayChanged.connect(this, &VappPhbEditorPage::onBirthDayChanged);

        getMainScr()->pushPage(VFX_ID_NULL, page);
    }
}
#endif /* __MMI_PHB_BIRTHDAY_FIELD__ */

#ifdef __MMI_PHB_INFO_FIELD__
void VappPhbEditorPage::onAddressTaped()
{
    // pre handler
    onEditorPreActive();

    VappPhbEditorAddressPage* page;
    VFX_OBJ_CREATE_EX(page, VappPhbEditorAddressPage, getMainScr(), (m_contact));

    page->m_addressChanged.connect(this, &VappPhbEditorPage::onContentChanged);

    getMainScr()->pushPage(VFX_ID_NULL, page);
}
#endif /* __MMI_PHB_INFO_FIELD__ */


void VappPhbEditorPage::onStorageChanged(phb_storage_enum storage)
{
#ifdef __MMI_PHB_USIM_SUPPORT__
    if (UsimGroup::isSupport(m_contact->getStorage()))
    {
        m_contact->setGroupId(MMI_PHB_INVALID_GROUP_ID);
        updateGroup();
    }
#endif /* __MMI_PHB_USIM_SUPPORT__ */

#ifndef __MMI_PHB_LAST_NAME_FIELD__
    if (m_contact->getStorage() == PHB_STORAGE_NVRAM
    #ifdef __MMI_PHB_TCARD_STORAGE_SUPPORT__
        || m_contact->getStorage() == PHB_STORAGE_TCARD
    #endif
        )
    {
        VappPhbEditorNameFormItem *name = (VappPhbEditorNameFormItem*) m_field->getObj(PB_CONTACT_ITEM_NAME);
        m_contact->getName().setGiven(name->getEditor()->getText());
    }
#endif /* __MMI_PHB_LAST_NAME_FIELD__ */

    m_contact->setStorage(storage);

    VFX_OBJ_CLOSE(m_form);
    createForm();
}


void VappPhbEditorPage::onStorageClick(VfxObject* obj, VfxId id)
{
    // pre handler
    onEditorPreActive();

    VappPhbEditorSelectStoragePage* page;
    VFX_OBJ_CREATE_EX(page, VappPhbEditorSelectStoragePage, this, (m_contact->getStorage()));

    page->m_storageChanged.connect(this, &VappPhbEditorPage::onStorageChanged);

    getMainScr()->pushPage(VFX_ID_NULL, page);
}

#ifdef  __MMI_PHB_CALLER_GROUP__

void VappPhbEditorPage::onGroupChanged(VfxObject* obj, VfxU8 groupId)
{
    m_contact->setGroupId(groupId);
    updateGroup();
}
#endif /* __MMI_PHB_CALLER_GROUP__ */


#ifdef __MMI_PHB_CALLER_GROUP__
void VappPhbEditorPage::onGroupClick(VfxObject* obj, VfxId id)
{
    // pre handler
    onEditorPreActive();

    VappPhbGroupSelectorPage *page;
    VFX_OBJ_CREATE_EX(page, VappPhbGroupSelectorPage, getMainScr(), (m_contact->getStorage(), m_contact->getGroupId()));

    page->m_signalGroupSelected.connect(this, &VappPhbEditorPage::onGroupChanged);

    getMainScr()->pushPage(VFX_ID_NULL, page);
}
#endif /* __MMI_PHB_CALLER_GROUP__ */


void VappPhbEditorPage::onContentChanged(VfxU32 fieldType, VfxU32 fieldId)
{
    switch (fieldType)
    {
        case MMI_PHB_CONTACT_FIELD_NAME:
        {
            updateName();
            break;
        }
    #ifdef __MMI_PHB_INFO_FIELD__
        case MMI_PHB_CONTACT_FIELD_ADDRESS:
        {
            updateAddress();
            break;
        }
    #endif /* __MMI_PHB_INFO_FIELD__ */
    }
}


void VappPhbEditorPage::onEditorActived(VcpTextEditor *editor, VfxBool isActived)
{
    if (isActived)
    {
        m_activeEditor = editor;
    }
}


void VappPhbEditorPage::onEditorPreActive()
{
    if (m_activeEditor)
    {
        m_activeEditor->deactivate();
        m_activeEditor = NULL;
    }
}


void VappPhbEditorPage::finishOP()
{
    if (m_progress)
    {
        m_progress->exit(VFX_TRUE);
    }

    //VfxObject* self = this;
    //VFX_OBJ_CLOSE(self);
}


void VappPhbEditorPage::onSaveDone(ContactOP* op, CONTACT_STATE state, srv_phb_async_op_cb_struct* evt)
{
    srv_phb_add_cb_struct *cb = (srv_phb_add_cb_struct*) evt;
    VappPhbSaveContactCui *cui = VFX_OBJ_DYNAMIC_CAST(getApp(), VappPhbSaveContactCui);
    cui->onSavedDone(cb->id, (cb->result >= 0) ? VFX_TRUE : VFX_FALSE);

    m_save->complete();

    finishOP();

    vapp_phb_op_error_balloon(cb->result);

    MMI_PRINT(MOD_MMI_COMMON_APP, MMI_COMMON_TRC_G4_PHB, "[VAPP_CONTACT_EDIT]onSaveDone--type: %d, id: %d, result: %d\n", cb->type, cb->id, cb->result);
}


void VappPhbEditorPage::onSaveDoneAndDelete(ContactOP* op, CONTACT_STATE state, srv_phb_async_op_cb_struct* evt)
{
    srv_phb_add_cb_struct *cb = (srv_phb_add_cb_struct*) evt;
    if (cb->result >= 0)
    {
        m_save->complete();

        //finishOP(); /* Will be called when delete done */

        vapp_phb_op_error_balloon(cb->result);

        // after save done handler
        VFX_OBJ_CREATE_EX(m_delete, ContactDelete, this, (m_id));

        // delete the contact
        m_delete->m_signalOP.connect(this, &VappPhbEditorPage::onDeleteDone);
        m_delete->run();
    }
    else
    {
        VappPhbSaveContactCui *cui = VFX_OBJ_DYNAMIC_CAST(getApp(), VappPhbSaveContactCui);
        cui->onSavedDone(cb->id, (cb->result >= 0) ? VFX_TRUE : VFX_FALSE);

        m_save->complete();

        finishOP();

        vapp_phb_op_error_balloon(cb->result);
    }
}


void VappPhbEditorPage::onDeleteDone(ContactOP* op, CONTACT_STATE state, srv_phb_async_op_cb_struct* result)
{
    srv_phb_delete_cb_struct *cb = (srv_phb_delete_cb_struct*) result;
    VappPhbSaveContactCui *cui = VFX_OBJ_DYNAMIC_CAST(getApp(), VappPhbSaveContactCui);
    cui->onSavedDone(cb->id, (cb->result >= 0) ? VFX_TRUE : VFX_FALSE);

    m_delete->complete();

    finishOP();
}


void VappPhbEditorPage::onQueryRotateEx(VfxScreenRotateParam &param)
{
}


mmi_ret VappPhbEditorPage::onProc(mmi_event_struct *evt)
{
    switch (evt->evt_id)
    {
    #ifdef __MMI_PHB_CUSTOM_FIELD_TYPE__
        case EVT_ID_PHB_FIELD_TYPE_CHNAGED_IND:
        {
            srv_phb_field_type_changed_ind_struct *args = (srv_phb_field_type_changed_ind_struct*) evt;
            if (args->is_delete && args->result)
            {
                if (args->field_type == MMI_PHB_CONTACT_FIELD_ID_NUMBER)
                {
                    VfxU32 count = m_contact->getNumberCount();
                    for (VfxU32 i = 0; i < count && i < m_contact->getNumberMaxCount(); i++)
                    {
                        VappContactNumber& num = m_contact->getNumber(i);
                        if (num.getSubType() == args->field_sub_type)
                        {
                            num.setSubType(MMI_PHB_NUM_TYPE_MOBILE);
                            num.setLabel(VAPP_PHB_STR_MOBILE);
                        }
                    }

                    VappContactFieldItem item = m_field->getItemByItemType(PB_CONTACT_ITEM_NUMBER_NEW);
                    VfxU32 itemId = item.m_itemId;

                    for (VfxU32 i = 0; i < count; i++)
                    {
                        item = m_field->getPrevItem(itemId);
                        itemId = item.m_itemId;

                        if (item.m_fieldType == args->field_sub_type)
                        {
                            VcpFormItemRemovableTextEntry *numItem = (VcpFormItemRemovableTextEntry*) item.m_obj;
                            numItem->getLeftButton()->setText(VAPP_PHB_STR_MOBILE);

                            VappContactFieldItem& tempItem = m_field->getItem(itemId);
                            tempItem.m_fieldType = MMI_PHB_NUM_TYPE_MOBILE;
                        }
                    }
                }
                else if (args->field_type == MMI_PHB_CONTACT_FIELD_ID_EMAIL)
                {
                    VfxU32 count = m_contact->getEmailCount();
                    for (VfxU32 i = 0; i < count && i < m_contact->getEmailMaxCount(); i++)
                    {
                        VappContactEmail& email = m_contact->getEmail(i);
                        if (email.getSubType() == args->field_sub_type)
                        {
                            email.setSubType(MMI_PHB_EMAIL_TYPE_OFFICE);
                            email.setLabel(VAPP_PHB_STR_WORK);
                        }
                    }

                    VappContactFieldItem item = m_field->getItemByItemType(PB_CONTACT_ITEM_EMAIL_NEW);
                    VfxU32 itemId = item.m_itemId;

                    for (VfxU32 i = 0; i < count; i++)
                    {
                        item = m_field->getPrevItem(itemId);
                        itemId = item.m_itemId;

                        if (item.m_fieldType == args->field_sub_type)
                        {
                            VcpFormItemRemovableTextEntry *numItem = (VcpFormItemRemovableTextEntry*) item.m_obj;
                            numItem->getLeftButton()->setText(VAPP_PHB_STR_WORK);

                            VappContactFieldItem& tempItem = m_field->getItem(itemId);
                            tempItem.m_fieldType = MMI_PHB_EMAIL_TYPE_OFFICE;
                        }
                    }
                }
            }
            break;
        }
    #endif /* __MMI_PHB_CUSTOM_FIELD_TYPE__ */

        case EVT_ID_VCUI_GALLERY_PICKER_RESULT_READY:
        {
            vcui_gallery_evt_struct *result = (vcui_gallery_evt_struct*) evt;
            if (result->result == VCUI_GALLERY_RESULT_OK)
            {
                VappPhbResSelectorObj *userData;
                VFX_OBJ_CREATE(userData, VappPhbResSelectorObj, this);

                userData->result = VFX_FALSE;
                userData->selector_cui_id = ((mmi_group_event_struct*) evt)->sender_id;

                VfxU32 size = sizeof(WCHAR) * (SRV_FMGR_PATH_MAX_LEN + 1);
                vcui_gallery_media_state_enum state =
                    vcui_gallery_picker_get_single_path(((mmi_group_event_struct*) evt)->sender_id, userData->img_path, &size);
                vcui_gallery_close(((mmi_group_event_struct*) evt)->sender_id);
                memcpy(img_path, userData->img_path, SRV_FMGR_PATH_MAX_LEN + 1);

    #ifdef __MMI_COSMOS_IMAGECLIPPER__
                if (cui_vapp_imgclip_is_file_support(userData->img_path) == CUI_IMGEDT_OK)
                {
                    cui_imgclip_launch_struct param;
                    param.scr_file_path = (U8*) userData->img_path;
                    param.user_data = (U32)userData;

                    mmi_id cui_id = cui_vapp_imgclip_create(getApp()->getGroupId(), &param);
                    if (cui_id != GRP_ID_INVALID)
                    {
                        vfxSetCuiCallerScr(cui_id, getMainScr());

                        userData->img_cliper_cui_id = cui_id;

                        cui_vapp_imgclip_set_size_limit(cui_id, VAPP_PHB_IMG_SIZE_WIDTH, VAPP_PHB_IMG_SIZE_HEIGHT);
                        cui_vapp_imgclip_set_ratio_fixed(cui_id, MMI_TRUE);
                        cui_vapp_imgclip_set_ratio(cui_id, 1, 1);
                        cui_vapp_imgclip_save_pbm_file(cui_id, MMI_TRUE);

                        cui_vapp_imgclip_run(cui_id);
                    }
                    else
                    {
                        VFX_OBJ_CLOSE(userData);
                        vcui_gallery_close(((mmi_group_event_struct*) evt)->sender_id);
                    }
                }
                else
                {
                    mmi_frm_nmgr_balloon(MMI_SCENARIO_ID_DEFAULT, MMI_EVENT_INFO_BALLOON, MMI_NMGR_BALLOON_TYPE_FAILURE,
                        (WCHAR*)VFX_WSTR_RES(STR_GLOBAL_INVALID_FORMAT).getBuf());
                    VFX_OBJ_CLOSE(userData);
                }
    #else /* __MMI_COSMOS_IMAGECLIPPER__ */
                const filetypes_file_type_enum fileType = (filetypes_file_type_enum)srv_fmgr_types_find_type_by_filepath((WCHAR*)userData->img_path);
                if (vapp_phb_query_head_portrait_type(fileType))
                {
                #if 0
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
                #else
                    decodeToThumbnail(getBounds(), userData->img_path);
                #endif
                }
                else
                {
                    mmi_frm_nmgr_balloon(MMI_SCENARIO_ID_DEFAULT, MMI_EVENT_INFO_BALLOON, MMI_NMGR_BALLOON_TYPE_FAILURE,
                        (WCHAR*)VFX_WSTR_RES(STR_GLOBAL_INVALID_FORMAT).getBuf());
                    VFX_OBJ_CLOSE(userData);
                }
            #endif /* __MMI_COSMOS_IMAGECLIPPER__ */
            }
            break;
        }

        case EVT_ID_VCUI_GALLERY_CLOSE_GID:
        {
            vcui_gallery_close(((mmi_group_event_struct*) evt)->sender_id);
            break;
        }

    #ifndef __LOW_COST_SUPPORT_COMMON__
    #ifdef __MMI_CAMCORDER__
        case VCUI_CAMCO_EVENT_RESULT_SUCCESS:
        {
            vcui_camco_event_struct *cam = (vcui_camco_event_struct*)evt;
            if (cam->errCode == VCUI_CAMCO_ERR_NONE)
            {
                VappPhbResSelectorObj *userData;
                VFX_OBJ_CREATE(userData, VappPhbResSelectorObj, this);

                mmi_ucs2cpy((CHAR*)userData->img_path, (CHAR *) cam->filePath);

                userData->result = VFX_FALSE;
                userData->selector_cui_id = ((mmi_group_event_struct*) evt)->sender_id;

            #ifdef __MMI_COSMOS_IMAGECLIPPER__
                if (cui_vapp_imgclip_is_file_support(userData->img_path) == CUI_IMGEDT_OK)
                {
                    cui_imgclip_launch_struct param;
                    param.scr_file_path = (U8*) userData->img_path;
                    param.user_data = (U32)userData;

                    mmi_id cui_id = cui_vapp_imgclip_create(getApp()->getGroupId(), &param);
                    if (cui_id != GRP_ID_INVALID)
                    {
                        vfxSetCuiCallerScr(cui_id, getMainScr());

                        userData->img_cliper_cui_id = cui_id;

                        cui_vapp_imgclip_set_size_limit(cui_id, VAPP_PHB_IMG_SIZE_WIDTH, VAPP_PHB_IMG_SIZE_HEIGHT);
                        cui_vapp_imgclip_set_ratio_fixed(cui_id, MMI_TRUE);
                        cui_vapp_imgclip_set_ratio(cui_id, 1, 1);
                        cui_vapp_imgclip_save_pbm_file(cui_id, MMI_TRUE);

                        cui_vapp_imgclip_run(cui_id);
                        vcui_standard_camera_close(((mmi_group_event_struct*) evt)->sender_id);
                    }
                    else
                    {
                        VFX_OBJ_CLOSE(userData);
                        vcui_standard_camera_close(((mmi_group_event_struct*) evt)->sender_id);
                    }
                }
                else
            #endif /* __MMI_COSMOS_IMAGECLIPPER__ */
                {
                    VappContactRes& img = m_contact->getImage();
                    img.setPath(userData->img_path);
                    img.setResId(0);

                    updateName();

                    VFX_OBJ_CLOSE(userData);
                    vcui_standard_camera_close(((mmi_group_event_struct*) evt)->sender_id);
                }
            }
            else
            {
                mmi_frm_nmgr_balloon(MMI_SCENARIO_ID_DEFAULT, MMI_EVENT_INFO_BALLOON, MMI_NMGR_BALLOON_TYPE_FAILURE,
                    (WCHAR*)VFX_WSTR_RES(vcui_standard_camera_get_err_string(cam->errCode)).getBuf());
                vcui_standard_camera_close(((mmi_group_event_struct*) evt)->sender_id);
            }
            break;
        }
        case VCUI_CAMCO_EVENT_RESULT_FAILED:
        {
            vcui_camco_event_struct *cam = (vcui_camco_event_struct*) evt;
            if (cam->errCode != VCUI_CAMCO_ERR_NONE)
            {
                mmi_frm_nmgr_balloon(MMI_SCENARIO_ID_DEFAULT, MMI_EVENT_INFO_BALLOON, MMI_NMGR_BALLOON_TYPE_FAILURE,
                    (WCHAR*)VFX_WSTR_RES(vcui_standard_camera_get_err_string(cam->errCode)).getBuf());
            }
            vcui_standard_camera_close(((mmi_group_event_struct*) evt)->sender_id);
            break;
        }
    #endif /* __MMI_CAMCORDER__ */
    #endif /* __LOW_COST_SUPPORT_COMMON__ */

    #ifdef __MMI_COSMOS_IMAGECLIPPER__
        case EVT_ID_CUI_IMGCLIP_SAVE_NEW:
        case EVT_ID_CUI_IMGCLIP_SAVE_OVERWRITE:
        {
            cui_imgclip_event_struct *param = (cui_imgclip_event_struct*) evt;
            VappPhbResSelectorObj *userData = NULL;

            cui_vapp_imgclip_get_user_data(((mmi_group_event_struct*) evt)->sender_id, (U32*)(&userData));

            if (param->result == 0)
            {
                cui_vapp_imgclip_get_dest_path(((mmi_group_event_struct*) evt)->sender_id, (CHAR*) userData->img_path);

                VappContactRes& img = m_contact->getImage();
                img.setPath(userData->img_path);
                img.setResId(0);

                FS_SetAttributes(userData->img_path, FS_ATTR_HIDDEN);

                updateName();

                userData->result = VFX_TRUE;
            }
            return MMI_RET_OK;
        }
        case EVT_ID_CUI_IMGCLIP_CLOSE_REQUEST:
        {
            VappPhbResSelectorObj *userData = NULL;

            cui_vapp_imgclip_get_user_data(((mmi_group_event_struct*) evt)->sender_id, (U32*)(&userData));

            MMI_ID selector_cui_id = userData->selector_cui_id;
            VfxBool result = userData->result;

            VFX_OBJ_CLOSE(userData);
            cui_vapp_imgclip_close(((mmi_group_event_struct*) evt)->sender_id);

            if (result)
            {
                vcui_gallery_close(selector_cui_id);
            }
            return MMI_RET_OK;
        }
    #endif /* __MMI_COSMOS_IMAGECLIPPER__ */
        case EVT_ID_VCUI_TONE_SELECTOR_RESULT:
        {
            vcui_tone_selector_evt_struct *result = (vcui_tone_selector_evt_struct*) evt;
            VappContactRes& ring = m_contact->getRingTone();

            if (!result->is_default_sound)
            {
                VfxWChar* path = (VfxWChar*) mmi_frm_temp_alloc(sizeof(VfxWChar) * (SRV_FMGR_PATH_MAX_LEN + 1));

                vcui_tone_selector_get_selected_filepath(
                    ((mmi_group_event_struct*) evt)->sender_id, NULL, path, sizeof(VfxWChar) * (SRV_FMGR_PATH_MAX_LEN + 1));
                 ring.setPath(path);
                 ring.setResId(0);

                 mmi_frm_temp_free(path);
            }
            else
            {
                ring.setPath(VFX_WSTR_EMPTY);
                ring.setResId(result->selected_tone);
            }

            VcpFormItemBigArrowButton* item = (VcpFormItemBigArrowButton*) m_field->getObj(PB_CONTACT_ITEM_RINGTONE);
            item->setHintText(ring.getString());
            break;
            }
        case EVT_ID_VCUI_TONE_SELECTOR_CLOSE_REQUEST:
            vcui_tone_selector_close(((mmi_group_event_struct*) evt)->sender_id);
            break;
        case EVT_ID_SRV_FMGR_NOTIFICATION_DEV_PLUG_IN:
        case EVT_ID_SRV_FMGR_NOTIFICATION_DEV_PLUG_OUT:
    #ifdef __MMI_USB_SUPPORT__
        case EVT_ID_USB_EXIT_MS_MODE:
    #endif
    //kal_prompt_trace(MOD_MMI, " VappPhbEditorPage::onProc() evt_id = %d", evt->evt_id);
        {
            updateName();
            break;
        }
    #ifdef __MMI_USB_SUPPORT__
        case EVT_ID_USB_ENTER_MS_MODE:
    #endif
        {
            VappPhbEditorNameFormItem *name = (VappPhbEditorNameFormItem*) m_field->getObj(PB_CONTACT_ITEM_NAME);
            name->setImage(VfxImageSrc());
            break;
        }
            
    }

    return VfxPage::onProc(evt);
}


#if 0
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
#endif


#if 1
void VappPhbEditorPage::decodeToThumbnail(const VfxRect& layerRect, WCHAR * previousFileName)
{
   // WCHAR *previousFileName = img_path;
    if(mmi_wcscmp(previousFileName, (const WCHAR *) L""))
    {
        S32 image_width;
        S32 image_height;
        S32 result;
        S32 resized_offset_x;
        S32 resized_offset_y;
        S32 resized_width;
        S32 resized_height;
        mmi_id m_appId = getApp()->getGroupId();
        void * thumb_buffer = NULL;
        gdi_handle handleT;
        thumb_buffer = applib_asm_alloc_nc_r(getApp()->getGroupId(), GDI_LCD_WIDTH*GDI_LCD_HEIGHT*2);

        gdi_layer_create_cf_using_outside_memory(
                                                GDI_COLOR_FORMAT_16,
                                                0,
                                                0,
                                                ICON_SIZE,//layerRect.getWidth(),
                                                ICON_SIZE,//layerRect.getHeight(),
                                                &handleT,
                                                (U8*)thumb_buffer,
                                                GDI_LCD_WIDTH*GDI_LCD_HEIGHT*2);

        gdi_layer_push_and_set_active(handleT);

        result = gdi_image_get_dimension_file(
                                             (CHAR *)previousFileName,
                                             &image_width,
                                             &image_height);

        if (result >= 0)
        {
            if (image_width <= ICON_SIZE && image_height <= ICON_SIZE)
            {
                resized_width = image_width;
                resized_height = image_height;  
            }
            else
            {
                gdi_util_fit_box(
                                GDI_UTIL_MODE_SHORT_SIDE_FIT,//GDI_UTIL_MODE_NO_RESIZE_OR_SHORT_SIDE_FIT,
                                ICON_SIZE,//layerRect.getWidth(),
                                ICON_SIZE,//layerRect.getHeight(),
                                image_width,
                                image_height,
                                &resized_offset_x,
                                &resized_offset_y,
                                &resized_width,
                                &resized_height);

                gdi_image_draw_resized_file(
                                            resized_offset_x,
                                            resized_offset_y,
                                            resized_width,
                                            resized_height,
                                            (S8*)previousFileName);
                if(resized_width > ICON_SIZE)
                    {
                        resized_width = ICON_SIZE;
                        resized_offset_x = 0;
                    }
                
                if(resized_height > ICON_SIZE)
                    {
                        resized_height = ICON_SIZE;
                        resized_offset_y = 0;
                    }
                 
            }
           m_newPath = createNewPicName(); 
           result = gdi_image_encode_file_to_jpeg((S8*)previousFileName, 
           (S8*)m_newPath.getBuf(), resized_width, resized_height, (U8*)thumb_buffer, GDI_LCD_WIDTH*GDI_LCD_HEIGHT*2);
        }
        else
        {
          gdi_layer_pop_and_restore_active();
          gdi_layer_free(handleT);
          return;
        }
        gdi_layer_pop_and_restore_active();
        gdi_layer_free(handleT);
        if(thumb_buffer != NULL)
        {
            applib_asm_free_r(getApp()->getGroupId(), thumb_buffer);
            thumb_buffer = NULL;
        }

        VappContactRes& img = m_contact->getImage();
        img.setPath(VFX_WSTR_MEM(m_newPath));
        img.setResId(0);
        FS_SetAttributes(m_newPath, FS_ATTR_HIDDEN);
        updateName(); 
    }
}
#endif


/*VfxImageBuffer VappPhbEditorPage::UpdateImage(VfxWString filePath)
{
    S32 image_width;
    S32 image_height;
    S32 result;
    S32 resized_offset_x;
    S32 resized_offset_y;
    S32 resized_width;
    S32 resized_height;
    mmi_id m_appId = getApp()->getGroupId();
    gdi_handle handleT;
    gdi_layer_create_cf_using_outside_memory(
                                            GDI_COLOR_FORMAT_16,
                                            0,
                                            0,
                                            ICON_SIZE,
                                            ICON_SIZE,
                                            &handleT,
                                            (U8*)m_buffer,
                                            ICON_SIZE * ICON_SIZE * 2);

    gdi_layer_push_and_set_active(handleT);

    result = gdi_image_get_dimension_file(
                                        (S8*)filePath.getBuf(),
                                        &image_width,
                                        &image_height);

    if (result >= 0)
    {
        gdi_util_fit_box(
                        GDI_UTIL_MODE_SHORT_SIDE_FIT,//GDI_UTIL_MODE_NO_RESIZE_OR_SHORT_SIDE_FIT,
                        ICON_SIZE,
                        ICON_SIZE,
                        image_width,
                        image_height,
                        &resized_offset_x,
                        &resized_offset_y,
                        &resized_width,
                        &resized_height);

        gdi_image_draw_resized_file(
                                    resized_offset_x,
                                    resized_offset_y,
                                    resized_width,
                                    resized_height,
                                    (S8*)filePath.getBuf());
    }
    gdi_layer_pop_and_restore_active();
    gdi_layer_free(handleT);

    VfxImageBuffer imageBuf;
    imageBuf.ptr = (VfxU8*)m_buffer;
    imageBuf.pitchBytes = ICON_SIZE*2;
    imageBuf.width = ICON_SIZE;
    imageBuf.height = ICON_SIZE;
    imageBuf.colorFormat = VRT_COLOR_TYPE_RGB565;
    return imageBuf;
}
*/


#if 0 
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
#endif

VfxWString VappPhbEditorPage:: createNewPicName()
{
    VfxWChar* pFullPath = img_path;
    VfxWChar* pOldName = getFileNamePos(pFullPath);
    VfxWChar* pExt = getFileExtName(pOldName);
  
    VfxS32 fullpath_len = vfx_sys_wcslen(pFullPath);
    VfxS32 old_name_len = vfx_sys_wcslen(pOldName);
    VfxS32 ext_len = vfx_sys_wcslen(pExt);    

    if ((app_ucs2_unconditional_strcmp((kal_int8*)pExt, (kal_int8*)L".jpg")) &&
        (app_ucs2_unconditional_strcmp((kal_int8*)pExt, (kal_int8*)L".jpeg")))
    {
        //ext_len = 4;
        vfx_sys_wcsncpy((VfxWChar*)pExt, (VfxWChar*)L".jpg", 4);
    }

   if(app_ucs2_unconditional_strcmp((kal_int8*)pExt, (kal_int8*)L".bmp"))
    {
        m_isBmp = VFX_TRUE;
    }
  
    VfxS32 new_path_len = fullpath_len + 2;
  
    VfxWChar *pNewFullPath;
    VFX_ALLOC_MEM(pNewFullPath, (new_path_len + 1)*2, this);
    vfx_sys_wcscpy(pNewFullPath, pFullPath);
    pNewFullPath[fullpath_len - ext_len] = 0;
    mmi_ucs2cat((CHAR*)pNewFullPath, (CHAR*)L"_1");
    mmi_ucs2cat((CHAR*)pNewFullPath, (CHAR*)pExt);
      
    VfxWString strNewPath = VFX_WSTR_MEM(pNewFullPath);
    VFX_FREE_MEM(pNewFullPath);
   // vfxPostInvoke(this , &VappPhbEditorPage::imgEditDone, NULL);
    return strNewPath;
}

  
VfxWChar *VappPhbEditorPage::getFileNamePos(const VfxWChar *fullpath)
{
    VfxWChar* pName = (VfxWChar*)fullpath;
    VfxWChar* pTmp = (kal_uint16*)mmi_ucs2chr((const CHAR*)(pName+1), L':');

    if (NULL != pTmp)
    {
        pName = pTmp+1;
    }
    else
    {
        pTmp = pName;
    }    
    while((pTmp = (kal_uint16*)mmi_ucs2chr((const CHAR*)(pTmp+1), L'\\')) 
         != NULL )
    {
        pName = pTmp+1;
    }
    return pName;
  }


VfxWChar *VappPhbEditorPage::getFileExtName(const VfxWChar *fullpath)
{
    VfxWChar* pTmp = (VfxWChar*)fullpath;
    VfxWChar* pExt = pTmp;
    while((pTmp = (kal_uint16*)mmi_ucs2chr((const CHAR*)pTmp, L'.')) != NULL )
    {
        pExt = pTmp;
        pTmp++;
    }   
    
    return pExt;
}


void VappPhbEditorPage::onBack()
{
    VappPhbSaveContactCui *cui = VFX_OBJ_DYNAMIC_CAST(getApp(), VappPhbSaveContactCui);
    cui->onSavedDone(cui->m_id, VFX_FALSE);
}


#ifdef __MMI_PHB_LAST_NAME_FIELD__
/***************************************************************************** 
 * Class VappPhbEditorNamePage
 *****************************************************************************/
void VappPhbEditorNamePage::onInit()
{
    VfxPage::onInit();

    // create title bar
    VcpTitleBar* titleBar;
    VFX_OBJ_CREATE(titleBar, VcpTitleBar, this);
    titleBar->setTitle(VFX_WSTR_RES(VAPP_PHB_STR_ADD_NAME));
    setTopBar(titleBar);

    // create tool bar
    VcpToolBar* toolbar; 
    VFX_OBJ_CREATE(toolbar,VcpToolBar, this);
    toolbar->addItem(VAPP_PHB_CONTACT_CMD_DONE, VFX_WSTR_RES(STR_GLOBAL_DONE), VCP_IMG_TOOL_BAR_COMMON_ITEM_OK);
    toolbar->addItem(VAPP_PHB_CONTACT_CMD_CANCEL, VFX_WSTR_RES(STR_GLOBAL_CANCEL), VCP_IMG_TOOL_BAR_COMMON_ITEM_CANCEL);
    toolbar->m_signalButtonTap.connect(this, &VappPhbEditorNamePage::onToolBarClick);
    setBottomBar(toolbar);

    // create form
    VFX_OBJ_CREATE(m_form, VcpForm, this);
    m_form->setSize(getSize());
    m_form->setAlignParent(
        VFX_FRAME_ALIGNER_MODE_SIDE,
        VFX_FRAME_ALIGNER_MODE_SIDE,
        VFX_FRAME_ALIGNER_MODE_SIDE,
        VFX_FRAME_ALIGNER_MODE_SIDE);

    // create field stack
    VFX_OBJ_CREATE(m_field, VappPhbFieldItem, m_form);
    VappContactFieldItem field;

    VcpFunctionBar *functionBar;
    VFX_OBJ_CREATE(functionBar, VcpFunctionBar, m_form);

    functionBar->addItem(VAPP_PHB_CONTACT_CMD_PREV, VFX_WSTR_RES(STR_GLOBAL_PREV));
    functionBar->addItem(VAPP_PHB_CONTACT_CMD_NEXT, VFX_WSTR_RES(STR_GLOBAL_NEXT));
    functionBar->addItem(VAPP_PHB_CONTACT_CMD_DONE, VFX_WSTR_RES(STR_GLOBAL_DONE));
    functionBar->setItemSpecial(VAPP_PHB_CONTACT_CMD_DONE);
    functionBar->m_signalButtonTap.connect(this, &VappPhbEditorNamePage::onFuncBarTapped);

    VcpTextEditor *editor;
    VcpFormItemTextInput *item;
    VappContactName& name = m_contact->getName();

    VFX_OBJ_CREATE(item, VcpFormItemTextInput, m_form);

    field.m_itemId = PB_EDIT_NAME_FIRST_NAME;
    field.m_itemType = PB_EDIT_NAME_FIRST_NAME;
    field.m_obj = item;
    m_field->setItem(field);

#ifdef __MMI_PHB_LAST_NAME_FIELD__
    item->setLabelText(VFX_WSTR_RES(VAPP_PHB_STR_FIRST_NAME));
#else
    item->setLabelText(VFX_WSTR_RES(VAPP_PHB_STR_NAME));
#endif /*__MMI_PHB_LAST_NAME_FIELD__*/
    editor = item->getTextBox();
    editor->setId(field.m_itemId);
    editor->setText(name.getGivenBuf(), MMI_PHB_NAME_FIELD_LENGTH);
    editor->setIME(IMM_INPUT_TYPE_SENTENCE, IME_DISABLE_NEW_LINE_SYMBOL);
    editor->setFunctionBar(functionBar, VFX_TRUE);
    editor->m_signalActivated.connect(this, &VappPhbEditorNamePage::onEditorActived);

    m_form->addItem(item, field.m_itemId);

#ifdef __MMI_PHB_LAST_NAME_FIELD__
    VFX_OBJ_CREATE(item, VcpFormItemTextInput, m_form);

    field.m_itemId = PB_EDIT_NAME_LAST_NAME;
    field.m_itemType = PB_EDIT_NAME_LAST_NAME;
    field.m_obj = item;
    m_field->setItem(field);

    item->setLabelText(VFX_WSTR_RES(VAPP_PHB_STR_LAST_NAME));
    editor = item->getTextBox();
    editor->setId(field.m_itemId);
    editor->setText(name.getFamilyBuf(), MMI_PHB_NAME_FIELD_LENGTH);
    editor->setIME(IMM_INPUT_TYPE_SENTENCE, IME_DISABLE_NEW_LINE_SYMBOL);
    editor->setFunctionBar(functionBar, VFX_TRUE);
    editor->m_signalActivated.connect(this, &VappPhbEditorNamePage::onEditorActived);

    m_form->addItem(item, field.m_itemId);
#endif /* __MMI_PHB_LAST_NAME_FIELD__ */
}


void VappPhbEditorNamePage::onQueryRotateEx(VfxScreenRotateParam &param)
{
}


void VappPhbEditorNamePage::nameDone()
{
    VcpFormItemTextInput *item;
    VcpTextEditor *editor;
#ifdef __MMI_PHB_LAST_NAME_FIELD__
    VfxWChar *buf1, *buf2;
#else
    VfxWChar *buf2;
#endif

    // get familyName
#ifdef __MMI_PHB_LAST_NAME_FIELD__
    item = (VcpFormItemTextInput*) m_form->getItem(PB_EDIT_NAME_LAST_NAME);
    editor = item->getTextBox();
    buf1 = editor->getText();
#endif /* __MMI_PHB_LAST_NAME_FIELD__ */

    // get giveName
    item = (VcpFormItemTextInput*) m_form->getItem(PB_EDIT_NAME_FIRST_NAME);
    editor = item->getTextBox();
    buf2 = editor->getText();

#ifdef __MMI_PHB_LAST_NAME_FIELD__
    m_contact->getName().setFamily(buf1);
#endif
    m_contact->getName().setGiven(buf2);

    m_nameChanged.postEmit(MMI_PHB_CONTACT_FIELD_NAME, 0);
    getMainScr()->popPage();
}


void VappPhbEditorNamePage::onEditorActived(VcpTextEditor *editor, VfxBool isActived)
{
    if (isActived)
    {
        m_currItemId = editor->getId();
        VcpFunctionBar *functionBar = (VcpFunctionBar*) editor->getFunctionBar();

        if (m_field->getPrevItem(m_currItemId).isValid())
        {
            functionBar->setDisableItem(VAPP_PHB_CONTACT_CMD_PREV, VFX_FALSE);
        }
        else
        {
            functionBar->setDisableItem(VAPP_PHB_CONTACT_CMD_PREV, VFX_TRUE);
        }

        if (m_field->getNextItem(m_currItemId).isValid())
        {
            functionBar->setDisableItem(VAPP_PHB_CONTACT_CMD_NEXT, VFX_FALSE);
        }
        else
        {
            functionBar->setDisableItem(VAPP_PHB_CONTACT_CMD_NEXT, VFX_TRUE);
        }
    }
}


void VappPhbEditorNamePage::onFuncBarTapped(VfxObject *obj, VfxId id)
{
    switch (id)
    {
        case VAPP_PHB_CONTACT_CMD_PREV:
        {
            VcpFormItemTextInput* item = (VcpFormItemTextInput*)m_field->getPrevItem(m_currItemId).m_obj;
            VcpTextEditor *editor = item->getTextBox();
            editor->activate();
            m_form->scrollItemToView(item->getId(), VCPFORM_SCROLL_BOTTOM, VFX_TRUE);
            break;
        }
        case VAPP_PHB_CONTACT_CMD_NEXT:
        {
            VcpFormItemTextInput* item = (VcpFormItemTextInput*)m_field->getNextItem(m_currItemId).m_obj;
            VcpTextEditor *editor = item->getTextBox();
            editor->activate();
            m_form->scrollItemToView(item->getId(), VCPFORM_SCROLL_BOTTOM, VFX_TRUE);
            break;
        }
        case VAPP_PHB_CONTACT_CMD_DONE:
        {
            nameDone();
            break;
        }
    }
}


void VappPhbEditorNamePage::onToolBarClick(VfxObject *obj, VfxId id)
{
    switch (id)
    {
        case VAPP_PHB_CONTACT_CMD_DONE:
        {
            nameDone();
            break;
        }
        case VAPP_PHB_CONTACT_CMD_CANCEL:
        {
            getMainScr()->popPage();
            break;
        }
    }
}
#endif /* __MMI_PHB_LAST_NAME_FIELD__ */


/***************************************************************************** 
 * Class VappPhbTypeSelectorPage
 *****************************************************************************/
VappPhbTypeSelectorPage::VappPhbTypeSelectorPage(
                            VfxU8 typeId,
                            mmi_phb_contact_field_id_enum fieldId,
                            phb_storage_enum storage,
                            VfxU32 userData):
    m_type(typeId),
    m_field(fieldId),
    m_storage(storage),
    m_typeObj(NULL),    
    m_list(NULL),
    m_userData(userData)
{
}


void VappPhbTypeSelectorPage::onPageInit(VfxPageEx * page)
{
    VfxPageHandler::onPageInit(page);

    // create type object
    VFX_OBJ_CREATE_EX(m_typeObj, ContactFieldType, this, (m_field, m_storage));
    
    // create title bar
    VcpTitleBar* titleBar;
    VFX_OBJ_CREATE(titleBar, VcpTitleBar, page);
    if (m_field == MMI_PHB_CONTACT_FIELD_ID_NUMBER)
    {
        titleBar->setTitle(VAPP_PHB_STR_SELECT_NUM_TYPE);
    }
    else
    {
        titleBar->setTitle(VAPP_PHB_STR_SELECT_EMAIL_TYPE);
    }
    page->setTopBar(titleBar);

    VFX_OBJ_CREATE(m_list, VcpGroupListMenu, page);
    m_list->setSize(page->getSize());
    m_list->setAlignParent(
        VFX_FRAME_ALIGNER_MODE_SIDE,
        VFX_FRAME_ALIGNER_MODE_SIDE,
        VFX_FRAME_ALIGNER_MODE_SIDE,
        VFX_FRAME_ALIGNER_MODE_SIDE);

    m_list->setCellStyle(VCP_LIST_MENU_CELL_STYLE_SINGLE_TEXT);
    m_list->setMenuMode(VCP_LIST_MENU_MODE_HEAD_SINGLE_CHECK_MARK);
    m_list->setMenuControlMode(VCP_LIST_MENU_CONTROL_MODE_CMD_BUTTON);
    m_list->setContentProvider(this);

    m_list->m_signalItemTapped.connect(this, &VappPhbTypeSelectorPage::onItemTaped);
#ifdef __MMI_PHB_CUSTOM_FIELD_TYPE__
    m_list->m_signalCmdButtonClicked.connect(this,&VappPhbTypeSelectorPage::onDeleteClicked);
#endif
}


void VappPhbTypeSelectorPage::onPageEntered(VfxPageEx * page)
{
    m_list->resetAllItems(VFX_TRUE);
}

void VappPhbTypeSelectorPage::onPageRotate(VfxPageEx * page, const VfxScreenRotateParam & param)
{
}


void VappPhbTypeSelectorPage::onItemTaped(VcpGroupListMenu* list, VcpMenuPos pos)
{
    VfxU32 type;

    if (pos.group == 0)
    {
        type = m_typeObj->getDefaultType(pos.pos);
        m_typeSelected.postEmit(type, m_typeObj->getLabel(type), m_userData);
    }
#ifdef __MMI_PHB_CUSTOM_FIELD_TYPE__
    else
    {
        if ((VfxU32)(pos.pos) >= m_typeObj->getCustomTypeCount())
        {
            VappPhbEditorCustomTypePage *page;
            VFX_OBJ_CREATE_EX(page, VappPhbEditorCustomTypePage, this, (m_typeObj));

            page->m_signalNewType.connect(this, &VappPhbTypeSelectorPage::onAddNewType);

            getPage()->getMainScr()->pushPage(VFX_ID_NULL, page);
            return;
        }
        else
        {
            type = m_typeObj->getCustomType(pos.pos);
            m_typeSelected.postEmit(type, m_typeObj->getLabel(type), m_userData);
        }
    }
#endif /* __MMI_PHB_CUSTOM_FIELD_TYPE__ */

    getPage()->getMainScr()->popPage();
}


#ifdef __MMI_PHB_CUSTOM_FIELD_TYPE__
void VappPhbTypeSelectorPage::onAddNewType(VfxU8 type)
{
    m_list->resetAllItems(VFX_TRUE);
}


void VappPhbTypeSelectorPage::onDeleteClicked(VcpGroupListMenu *list, VcpMenuPos pos)
{
    if (pos.group > 0 && (VfxU32)(pos.pos) < m_typeObj->getCustomTypeCount())
    {
        m_index = pos.pos;

        VcpConfirmPopup *confirm;
        VFX_OBJ_CREATE(confirm, VcpConfirmPopup, this);

        confirm->setText(STR_ID_VAPP_PHB_DELETE_THE_TYPE);
        confirm->setInfoType(VCP_POPUP_TYPE_WARNING);
        confirm->setButtonSet(VCP_CONFIRM_BUTTON_SET_USER_DEFINE);
        confirm->setCustomButton(
                    STR_GLOBAL_DELETE,
                    STR_GLOBAL_CANCEL,
                    VCP_POPUP_BUTTON_TYPE_WARNING,
                    VCP_POPUP_BUTTON_TYPE_CANCEL);

        confirm->m_signalButtonClicked.connect(this, &VappPhbTypeSelectorPage::onDelete);

        confirm->show(VFX_TRUE);
    }
}


void VappPhbTypeSelectorPage::onDelete(VfxObject* obj, VfxId id)
{
    if (id == VCP_CONFIRM_POPUP_BUTTON_USER_1)
    {
        VfxU32 type = m_typeObj->getCustomType(m_index);
        m_typeObj->deleteType(type);

        if (type == m_type)
        {
            if (m_field == MMI_PHB_CONTACT_FIELD_ID_NUMBER)
            {
                m_type = MMI_PHB_NUM_TYPE_MOBILE;
            }
            else if (m_field == MMI_PHB_CONTACT_FIELD_ID_EMAIL)
            {
                m_type = MMI_PHB_EMAIL_TYPE_OFFICE;
            }
        }

        m_list->resetAllItems(VFX_TRUE);
    }
}
#endif /* __MMI_PHB_CUSTOM_FIELD_TYPE__ */


VfxBool VappPhbTypeSelectorPage::getItemText(
    VcpMenuPos pos,                  // [IN] the position of item
    VcpListMenuFieldEnum fieldType,  // [IN] the type of the field in the cell
    VfxWString &text,                // [OUT] the text resource
    VcpListMenuTextColorEnum &color  // [OUT] the text color
    )
{
    if (fieldType == VCP_LIST_MENU_FIELD_TEXT)
    {
        VfxU32 type;

        if (pos.group == 0)
        {
            type = m_typeObj->getDefaultType(pos.pos);
            text = m_typeObj->getLabel(type);
        }
    #ifdef __MMI_PHB_CUSTOM_FIELD_TYPE__
        else
        {
            if ((VfxU32)(pos.pos) >= m_typeObj->getCustomTypeCount())
            {
                if (m_field == MMI_PHB_CONTACT_FIELD_ID_NUMBER)
                {
                    text.loadFromRes(STR_ID_VAPP_PHB_ADD_NUMBER_TYPE);
                }
                else
                {
                    text.loadFromRes(STR_ID_VAPP_PHB_ADD_EMAIL_TYPE);
                }
                return VFX_TRUE;
            }
            type = m_typeObj->getCustomType(pos.pos);
            text = m_typeObj->getLabel(type);
        }
    #endif /* __MMI_PHB_CUSTOM_FIELD_TYPE__ */

        return VFX_TRUE;
    }
#ifdef __MMI_PHB_CUSTOM_FIELD_TYPE__
    else if (fieldType == VCP_LIST_MENU_FIELD_GROUP_HEADER_TEXT)
    {
        if (m_field == MMI_PHB_CONTACT_FIELD_ID_NUMBER)
        {
            if (pos.group == 0)
            {
                text.loadFromRes(VAPP_PHB_STR_DEFAULT_NUM_TYPE);
            }
            else
            {
                text.loadFromRes(VAPP_PHB_STR_CUSTOM_NUM_TYPE);
            }
        }
        else
        {
            if (pos.group == 0)
            {
                text.loadFromRes(VAPP_PHB_STR_DEFAULT_EMAIL_TYPE);
            }
            else
            {
                text.loadFromRes(VAPP_PHB_STR_CUSTOM_EMAIL_TYPE);
            }
        }

        return VFX_TRUE;
    }
#endif /* __MMI_PHB_CUSTOM_FIELD_TYPE__ */

    return VFX_FALSE;
}


#ifdef __MMI_PHB_CUSTOM_FIELD_TYPE__
VfxBool VappPhbTypeSelectorPage::getItemImage(
    VcpMenuPos pos,                  // [IN] the position of item
    VcpListMenuFieldEnum fieldType,  // [IN] the type of the field in the cell
    VfxImageSrc &image               // [OUT] the image resource
    )
{
    switch (fieldType)
    {
        case VCP_LIST_MENU_FIELD_CMD_BUT_IMG_NORMAL:
        case VCP_LIST_MENU_FIELD_CMD_BUT_IMG_DISABLED:
        case VCP_LIST_MENU_FIELD_CMD_BUT_IMG_HIGHLIGHT:
        case VCP_LIST_MENU_FIELD_CMD_BUT_IMG_PRESSED:
        case VCP_LIST_MENU_FIELD_DISCLOSURE_IMG:
        {
            if (pos.group > 0)
            {
                if ((VfxU32)(pos.pos) >= m_typeObj->getCustomTypeCount())
                {
                    image.setResId(VCP_IMG_LIST_MENU_DEFAULT_DISCLOSURE);
                }
                else
                {
                    image.setResId(IMG_ID_VAPP_PHB_LIST_DELETE_CMD);
                }
                return VFX_TRUE;
            }
        }
    }

    return VFX_FALSE;
}


VcpListMenuCellBaseControl *VappPhbTypeSelectorPage::getItemCustomControl(
    VcpMenuPos pos,                                  // [IN] position of the item
    VcpListMenuCellControlLocationTypeEnum location, // [IN] Control location
    VfxFrame *parentFrame                            // [IN] parent frame of the custom content frame
    )
{
    if (pos.group > 0 && location == VCP_LIST_MENU_CELL_CONTROL_LOCATION_TYPE_TAIL)
    {
        if ((VfxU32)(pos.pos) >= m_typeObj->getCustomTypeCount())
        {
            VfxImageSrc image;
            image.setResId(VCP_IMG_LIST_MENU_DEFAULT_DISCLOSURE);

            VcpListMenuDisclosure* disclosure = NULL;
            VFX_OBJ_CREATE_EX(disclosure, VcpListMenuDisclosure, parentFrame,(image));
            return disclosure;
        }
    }

    return NULL;
}
#endif /* __MMI_PHB_CUSTOM_FIELD_TYPE__ */


VfxU32 VappPhbTypeSelectorPage::getCount(VfxU32 group) const
{
    if (group == 0)
    {
        return m_typeObj->getDefaultTypeCount();
    }
#ifdef __MMI_PHB_CUSTOM_FIELD_TYPE__
    else
    {
        VfxU32 count = m_typeObj->getCustomTypeCount();
        if (count < m_typeObj->getTotalCustomTypeCount())
        {
            // ++ for create new customer type
            count++;
        }
        return count;
    }
#else /* __MMI_PHB_CUSTOM_FIELD_TYPE__ */
    return 0;
#endif /* __MMI_PHB_CUSTOM_FIELD_TYPE__ */
}


VfxU32 VappPhbTypeSelectorPage::getGroupCount() const
{
    VfxU32 count = 1;
    if (m_typeObj->getTotalCustomTypeCount() > 0)
    {
        count = 2;
    }

    return count;
}


VfxBool VappPhbTypeSelectorPage::hasGroupHeader(VfxS32 group) const
{
    if (m_typeObj->getTotalCustomTypeCount() > 0)
    {
        return VFX_TRUE;
    }
    else
    {
        return VFX_FALSE;
    }
}


VcpListMenuItemStateEnum VappPhbTypeSelectorPage::getItemState(
    VcpMenuPos pos   // [IN] position of the item
    ) const
{
    if (pos.group == 0)
    {
        if (m_type == m_typeObj->getDefaultType(pos.pos))
        {
            return VCP_LIST_MENU_ITEM_STATE_SELECTED;
        }
    }
#ifdef __MMI_PHB_CUSTOM_FIELD_TYPE__
    else
    {
        if ((VfxU32)(pos.pos) >= m_typeObj->getCustomTypeCount())
        {
            return VCP_LIST_MENU_ITEM_STATE_UNSELECTED;
        }
        else if (m_type == m_typeObj->getCustomType(pos.pos))
        {
            return VCP_LIST_MENU_ITEM_STATE_SELECTED;
        }
    }
#endif /* __MMI_PHB_CUSTOM_FIELD_TYPE__ */

    return VCP_LIST_MENU_ITEM_STATE_UNSELECTED;
}


#ifdef __MMI_PHB_CUSTOM_FIELD_TYPE__
VfxBool VappPhbTypeSelectorPage::getItemStateValidation(
    VcpMenuPos pos,                // [IN] the position of item
    VcpListMenuItemStateEnum state // [IN] the state to be checked
    ) const
{
    if (pos.group > 0)
    {
        if ((VfxU32)(pos.pos) >= m_typeObj->getCustomTypeCount() && state == VCP_LIST_MENU_ITEM_STATE_SELECTED)
        {
            return VFX_FALSE;
        }
    }

    return VFX_TRUE;
}
#endif /* __MMI_PHB_CUSTOM_FIELD_TYPE__ */


#ifdef __MMI_PHB_CUSTOM_FIELD_TYPE__
/***************************************************************************** 
 * Class VappPhbEditorCustomTypePage
 *****************************************************************************/
void VappPhbEditorCustomTypePage::onInit()
{
    VfxPage::onInit();

    // create title bar
    VcpTitleBar* titleBar;
    VFX_OBJ_CREATE(titleBar, VcpTitleBar, this);
    if (m_type->getFieldType() == MMI_PHB_CONTACT_FIELD_ID_NUMBER)
    {
        titleBar->setTitle(STR_ID_VAPP_PHB_ADD_NUMBER_TYPE);
    }
    else
    {
        titleBar->setTitle(STR_ID_VAPP_PHB_ADD_EMAIL_TYPE);
    }
    setTopBar(titleBar);

    // create tool bar
    VcpToolBar* toolbar; 
    VFX_OBJ_CREATE(toolbar,VcpToolBar,this);
    toolbar->addItem(VAPP_PHB_CONTACT_CMD_DONE, (VfxResId)(STR_GLOBAL_SAVE), VCP_IMG_TOOL_BAR_COMMON_ITEM_SAVE);
    toolbar->addItem(VAPP_PHB_CONTACT_CMD_CANCEL, (VfxResId)(STR_GLOBAL_CANCEL), VCP_IMG_TOOL_BAR_COMMON_ITEM_CANCEL);
    toolbar->m_signalButtonTap.connect(this, &VappPhbEditorCustomTypePage::onToolBarClick);
    setBottomBar(toolbar);

    // create form
    VFX_OBJ_CREATE(m_form, VcpForm, this);
    m_form->setSize(getSize());
    m_form->setAlignParent(
        VFX_FRAME_ALIGNER_MODE_SIDE,
        VFX_FRAME_ALIGNER_MODE_SIDE,
        VFX_FRAME_ALIGNER_MODE_SIDE,
        VFX_FRAME_ALIGNER_MODE_SIDE);

    // create function bar
    VcpFunctionBar *fBar;
    VFX_OBJ_CREATE(fBar, VcpFunctionBar, m_form);
    fBar->addItem((VfxResId)(STR_GLOBAL_SAVE), (VfxId)VAPP_PHB_CONTACT_CMD_SAVE);
    fBar->setItemSpecial(VAPP_PHB_CONTACT_CMD_SAVE);
    fBar->m_signalButtonTap.connect(this, &VappPhbEditorCustomTypePage::onFuncBarTapped);

    VcpFormItemTextInput *text;
    VFX_OBJ_CREATE(text, VcpFormItemTextInput, m_form);
    text->setLabelPosition(VCPFORM_TOP_LEFT);
    text->setLabelText(STR_ID_VAPP_PHB_TYPE_NAME);
    VcpTextEditor *editor = text->getTextBox();
    editor->setFunctionBar(fBar, VFX_TRUE);
    editor->setText(VFX_WSTR_EMPTY, VAPP_PHB_CUSTOM_LABEL_LENGTH);
    m_form->addItem(text, VAPP_PHB_EDITOR_CUSTOM_TYPE);
}


void VappPhbEditorCustomTypePage::onQueryRotateEx(VfxScreenRotateParam &param)
{
}


void VappPhbEditorCustomTypePage::onFuncBarTapped(VfxObject* obj, VfxId id)
{
    switch (id)
    {
        case VAPP_PHB_CONTACT_CMD_SAVE:
        {
            onSave();
            break;
        }
    }
}


void VappPhbEditorCustomTypePage::onToolBarClick(VfxObject* obj, VfxId id)
{
    switch (id)
    {
        case VAPP_PHB_CONTACT_CMD_DONE:
        {
            onSave();
            break;
        }
        case VAPP_PHB_CONTACT_CMD_CANCEL:
        {
            getMainScr()->popPage();
            break;
        }
    }
}


void VappPhbEditorCustomTypePage::onSave()
{
    VcpFormItemTextInput *text = (VcpFormItemTextInput*) m_form->getItem(VAPP_PHB_EDITOR_CUSTOM_TYPE);

    VcpTextEditor *editor = text->getTextBox();
    VfxWChar* buf = editor->getText();
    if (buf && buf[0] != 0)
    {
        VfxS32 type = m_type->addType(buf);
        if (type > 0)
        {
            VfxU8 newType = (VfxU8)type;
            m_signalNewType.postEmit(newType);
            getMainScr()->popPage();
        }
        else
        {
            mmi_frm_nmgr_balloon(MMI_SCENARIO_ID_DEFAULT, MMI_EVENT_INFO_BALLOON, MMI_NMGR_BALLOON_TYPE_FAILURE,
                (WCHAR*)VFX_WSTR_RES(STR_ID_VAPP_PHB_DUPLICATE_TYPE).getBuf());
        }
    }
    else
    {
        if (m_type->getFieldType() == MMI_PHB_CONTACT_FIELD_ID_NUMBER)
        {
            text->setWarningText(STR_ID_VAPP_PHB_NUMBER_TYPE_WARNING);
        }
        else
        {
            text->setWarningText(STR_ID_VAPP_PHB_EMAIL_TYPE_WARNING);
        }
        m_form->scrollItemToView(text->getId(), VCPFORM_SCROLL_BOTTOM, VFX_TRUE);
    }
}
#endif /* __MMI_PHB_CUSTOM_FIELD_TYPE__ */


#ifdef __MMI_PHB_INFO_FIELD__
/***************************************************************************** 
 * Class VappPhbEditorAddressPage
 *****************************************************************************/
VappPhbEditorAddressPage::VappPhbEditorAddressPage(Contact *contact):
    m_contact(contact),
    m_form(NULL),
    m_field(NULL){}


void VappPhbEditorAddressPage::onInit()
{
    VfxPage::onInit();

    // create title bar
    VcpTitleBar* titleBar;
    VFX_OBJ_CREATE(titleBar, VcpTitleBar, this);
    titleBar->setTitle(VFX_WSTR_RES(VAPP_PHB_STR_ADD_ADDRESS));
    setTopBar(titleBar);

    // create tool bar
    VcpToolBar* toolbar; 
    VFX_OBJ_CREATE(toolbar,VcpToolBar,this);
    toolbar->addItem(VAPP_PHB_CONTACT_CMD_DONE, VFX_WSTR_RES(STR_GLOBAL_DONE), VCP_IMG_TOOL_BAR_COMMON_ITEM_OK);
    toolbar->addItem(VAPP_PHB_CONTACT_CMD_CANCEL, VFX_WSTR_RES(STR_GLOBAL_CANCEL), VCP_IMG_TOOL_BAR_COMMON_ITEM_CANCEL);
    toolbar->m_signalButtonTap.connect(this, &VappPhbEditorAddressPage::onToolBarClick);
    setBottomBar(toolbar);

    // create form
    VFX_OBJ_CREATE(m_form, VcpForm, this);
    m_form->setSize(getSize());
    m_form->setAlignParent(
        VFX_FRAME_ALIGNER_MODE_SIDE,
        VFX_FRAME_ALIGNER_MODE_SIDE,
        VFX_FRAME_ALIGNER_MODE_SIDE,
        VFX_FRAME_ALIGNER_MODE_SIDE);

    // create field stack
    VFX_OBJ_CREATE(m_field, VappPhbFieldItem, m_form);
    VappContactFieldItem field;

    // create function bar
    VcpFunctionBar *fBar;
    VFX_OBJ_CREATE(fBar, VcpFunctionBar, m_form);
    fBar->addItem(VAPP_PHB_CONTACT_CMD_PREV, VFX_WSTR_RES(STR_GLOBAL_PREV));
    fBar->addItem(VAPP_PHB_CONTACT_CMD_NEXT, VFX_WSTR_RES(STR_GLOBAL_NEXT));
    fBar->addItem(VAPP_PHB_CONTACT_CMD_DONE, VFX_WSTR_RES(STR_GLOBAL_DONE));
    fBar->setItemSpecial(VAPP_PHB_CONTACT_CMD_DONE);
    fBar->m_signalButtonTap.connect(this, &VappPhbEditorAddressPage::onFuncBarTapped);

    VcpFormItemTextInput *text;
    VcpTextEditor *editor;
    VappContactAddress &address = m_contact->getAddress();

    VFX_OBJ_CREATE(text, VcpFormItemTextInput, m_form);

    field.m_itemId = PB_EDITOR_ADDRESS_POBOX;
    field.m_itemType = PB_EDITOR_ADDRESS_POBOX;
    field.m_obj = text;
    m_field->setItem(field);

    text->setLabelPosition(VCPFORM_TOP_LEFT);
    text->setLabelText(VFX_WSTR_RES(VAPP_PHB_STR_POBOX));
    editor = text->getTextBox();
    editor->setId(PB_EDITOR_ADDRESS_POBOX);
    editor->setFunctionBar(fBar, VFX_TRUE);
    editor->setText(address.getPoboxBuf(), MMI_PHB_ADDRESS_LENGTH);
    editor->setIME(IMM_INPUT_TYPE_SENTENCE, IME_DISABLE_NEW_LINE_SYMBOL);
    editor->m_signalActivated.connect(this, &VappPhbEditorAddressPage::onEditorActived);
    m_form->addItem(text, PB_EDITOR_ADDRESS_POBOX);

    VFX_OBJ_CREATE(text, VcpFormItemTextInput, m_form);

    field.m_itemId = PB_EDITOR_ADDRESS_EXTENSION;
    field.m_itemType = PB_EDITOR_ADDRESS_EXTENSION;
    field.m_obj = text;
    m_field->setItem(field);

    text->setLabelPosition(VCPFORM_TOP_LEFT);
    text->setLabelText(VFX_WSTR_RES(VAPP_PHB_STR_EXTENSION));
    editor = text->getTextBox();
    editor->setId(PB_EDITOR_ADDRESS_EXTENSION);
    editor->setFunctionBar(fBar, VFX_TRUE);
    editor->setText(address.getExtensionBuf(), MMI_PHB_ADDRESS_LENGTH);
    editor->setIME(IMM_INPUT_TYPE_SENTENCE, IME_DISABLE_NEW_LINE_SYMBOL);
    editor->m_signalActivated.connect(this, &VappPhbEditorAddressPage::onEditorActived);
    m_form->addItem(text, PB_EDITOR_ADDRESS_EXTENSION);

    VFX_OBJ_CREATE(text, VcpFormItemTextInput, m_form);

    field.m_itemId = PB_EDITOR_ADDRESS_STREET;
    field.m_itemType = PB_EDITOR_ADDRESS_STREET;
    field.m_obj = text;
    m_field->setItem(field);

    text->setLabelPosition(VCPFORM_TOP_LEFT);
    text->setLabelText(VFX_WSTR_RES(VAPP_PHB_STR_STREET));
    editor = text->getTextBox();
    editor->setId(PB_EDITOR_ADDRESS_STREET);
    editor->setFunctionBar(fBar, VFX_TRUE);
    editor->setText(address.getStreetBuf(), MMI_PHB_ADDRESS_LENGTH);
    editor->setIME(IMM_INPUT_TYPE_SENTENCE, IME_DISABLE_NEW_LINE_SYMBOL);
    editor->m_signalActivated.connect(this, &VappPhbEditorAddressPage::onEditorActived);
    m_form->addItem(text, PB_EDITOR_ADDRESS_STREET);

    VFX_OBJ_CREATE(text, VcpFormItemTextInput, m_form);

    field.m_itemId = PB_EDITOR_ADDRESS_CITY;
    field.m_itemType = PB_EDITOR_ADDRESS_CITY;
    field.m_obj = text;
    m_field->setItem(field);

    text->setLabelPosition(VCPFORM_TOP_LEFT);
    text->setLabelText(VFX_WSTR_RES(VAPP_PHB_STR_CITY));
    editor = text->getTextBox();
    editor->setId(PB_EDITOR_ADDRESS_CITY);
    editor->setFunctionBar(fBar, VFX_TRUE);
    editor->setText(address.getCityBuf(), MMI_PHB_ADDRESS_LENGTH);
    editor->setIME(IMM_INPUT_TYPE_SENTENCE, IME_DISABLE_NEW_LINE_SYMBOL);
    editor->m_signalActivated.connect(this, &VappPhbEditorAddressPage::onEditorActived);
    m_form->addItem(text, PB_EDITOR_ADDRESS_CITY);

    VFX_OBJ_CREATE(text, VcpFormItemTextInput, m_form);

    field.m_itemId = PB_EDITOR_ADDRESS_STATE;
    field.m_itemType = PB_EDITOR_ADDRESS_STATE;
    field.m_obj = text;
    m_field->setItem(field);

    text->setLabelPosition(VCPFORM_TOP_LEFT);
    text->setLabelText(VFX_WSTR_RES(VAPP_PHB_STR_STATE)); 
    editor = text->getTextBox();
    editor->setFunctionBar(fBar, VFX_TRUE);
    editor->setId(PB_EDITOR_ADDRESS_STATE);
    editor->setText(address.getStateBuf(), MMI_PHB_ADDRESS_LENGTH);
    editor->setIME(IMM_INPUT_TYPE_SENTENCE, IME_DISABLE_NEW_LINE_SYMBOL);
    editor->m_signalActivated.connect(this, &VappPhbEditorAddressPage::onEditorActived);
    m_form->addItem(text, PB_EDITOR_ADDRESS_STATE);

    VFX_OBJ_CREATE(text, VcpFormItemTextInput, m_form);

    field.m_itemId = PB_EDITOR_ADDRESS_POSTALCODE;
    field.m_itemType = PB_EDITOR_ADDRESS_POSTALCODE;
    field.m_obj = text;
    m_field->setItem(field);

    text->setLabelPosition(VCPFORM_TOP_LEFT);
    text->setLabelText(VFX_WSTR_RES(VAPP_PHB_STR_POSTALCODE));
    editor = text->getTextBox();
    editor->setId(PB_EDITOR_ADDRESS_POSTALCODE); 
    editor->setFunctionBar(fBar, VFX_TRUE);
    editor->setText(address.getPostalcodeBuf(), MMI_PHB_ADDRESS_LENGTH);
    editor->setIME(IMM_INPUT_TYPE_NUMERIC, IME_DISABLE_NEW_LINE_SYMBOL);
    editor->m_signalActivated.connect(this, &VappPhbEditorAddressPage::onEditorActived);
    m_form->addItem(text, PB_EDITOR_ADDRESS_POSTALCODE);

    VFX_OBJ_CREATE(text, VcpFormItemTextInput, m_form);

    field.m_itemId = PB_EDITOR_ADDRESS_COUNTRY;
    field.m_itemType = PB_EDITOR_ADDRESS_COUNTRY;
    field.m_obj = text;
    m_field->setItem(field);

    text->setLabelPosition(VCPFORM_TOP_LEFT);
    text->setLabelText(VFX_WSTR_RES(VAPP_PHB_STR_COUNTRY));
    editor = text->getTextBox();
    editor->setId(PB_EDITOR_ADDRESS_COUNTRY);
    editor->setFunctionBar(fBar, VFX_TRUE);
    editor->setText(address.getCountryBuf(), MMI_PHB_ADDRESS_LENGTH);
    editor->setIME(IMM_INPUT_TYPE_SENTENCE, IME_DISABLE_NEW_LINE_SYMBOL);
    editor->m_signalActivated.connect(this, &VappPhbEditorAddressPage::onEditorActived);
    m_form->addItem(text, PB_EDITOR_ADDRESS_COUNTRY);
}


void VappPhbEditorAddressPage::onQueryRotateEx(VfxScreenRotateParam &param)
{
}


void VappPhbEditorAddressPage::onEditorActived(VcpTextEditor *editor, VfxBool isActived)
{
    if (isActived)
    {
        m_currItemId = editor->getId();
        VcpFunctionBar *functionBar = (VcpFunctionBar*) editor->getFunctionBar();

        if (m_field->getPrevItem(m_currItemId).isValid())
        {
            functionBar->setDisableItem(VAPP_PHB_CONTACT_CMD_PREV, VFX_FALSE);
        }
        else
        {
            functionBar->setDisableItem(VAPP_PHB_CONTACT_CMD_PREV, VFX_TRUE);
        }

        if (m_field->getNextItem(m_currItemId).isValid())
        {
            functionBar->setDisableItem(VAPP_PHB_CONTACT_CMD_NEXT, VFX_FALSE);
        }
        else
        {
            functionBar->setDisableItem(VAPP_PHB_CONTACT_CMD_NEXT, VFX_TRUE);
        }
    }
}


void VappPhbEditorAddressPage::onFuncBarTapped(VfxObject* obj, VfxId id)
{
    switch (id)
    {
        case VAPP_PHB_CONTACT_CMD_DONE:
        {
            onSave();
            break;
        }
        case VAPP_PHB_CONTACT_CMD_PREV:
        {
            VcpFormItemTextInput* item = (VcpFormItemTextInput*)m_field->getPrevItem(m_currItemId).m_obj;
            VcpTextEditor *editor = item->getTextBox();
            editor->activate();
            m_form->scrollItemToView(item->getId(), VCPFORM_SCROLL_BOTTOM, VFX_TRUE);
            break;
        }
        case VAPP_PHB_CONTACT_CMD_NEXT:
        {
            VcpFormItemTextInput* item = (VcpFormItemTextInput*)m_field->getNextItem(m_currItemId).m_obj;
            VcpTextEditor *editor = item->getTextBox();
            editor->activate();
            m_form->scrollItemToView(item->getId(), VCPFORM_SCROLL_BOTTOM, VFX_TRUE);
            break;
        }
    }
}


void VappPhbEditorAddressPage::onToolBarClick(VfxObject* obj, VfxId id)
{
    switch(id)
    {
        case VAPP_PHB_CONTACT_CMD_DONE:
        {
            onSave();
            break;
        }
        case VAPP_PHB_CONTACT_CMD_CANCEL:
        {
            getMainScr()->popPage();
            break;
        }
    }
}


void VappPhbEditorAddressPage::onSave()
{
    VcpFormItemTextInput *text;
    VcpTextEditor *editor;
    VfxWChar *buf1, *buf2, *buf3, *buf4, *buf5, *buf6, *buf7;
    VappContactAddress &address = m_contact->getAddress();

    text = (VcpFormItemTextInput*) m_form->getItem(PB_EDITOR_ADDRESS_POBOX);
    editor = text->getTextBox();
    buf1 = editor->getText();

    text = (VcpFormItemTextInput*) m_form->getItem(PB_EDITOR_ADDRESS_EXTENSION);
    editor = text->getTextBox();
    buf2 = editor->getText();

    text = (VcpFormItemTextInput*) m_form->getItem(PB_EDITOR_ADDRESS_STREET);
    editor = text->getTextBox();
    buf3 = editor->getText();

    text = (VcpFormItemTextInput*) m_form->getItem(PB_EDITOR_ADDRESS_CITY);
    editor = text->getTextBox();
    buf4 = editor->getText();

    text = (VcpFormItemTextInput*) m_form->getItem(PB_EDITOR_ADDRESS_STATE);
    editor = text->getTextBox();
    buf5 = editor->getText();

    text = (VcpFormItemTextInput*) m_form->getItem(PB_EDITOR_ADDRESS_POSTALCODE);
    editor = text->getTextBox();
    buf6 = editor->getText();

    text = (VcpFormItemTextInput*) m_form->getItem(PB_EDITOR_ADDRESS_COUNTRY);
    editor = text->getTextBox();
    buf7 = editor->getText();

    address.setPobox(buf1);
    address.setExtension(buf2);
    address.setStreet(buf3);
    address.setCity(buf4);
    address.setState(buf5);
    address.setPostalcode(buf6);
    address.setCountry(buf7);

    m_addressChanged.postEmit(MMI_PHB_CONTACT_FIELD_ADDRESS, 0);
    getMainScr()->popPage();
}
#endif /* __MMI_PHB_INFO_FIELD__ */


/***************************************************************************** 
 * Class VappPhbEditorSelectStoragePage
 *****************************************************************************/
VappPhbEditorSelectStoragePage::VappPhbEditorSelectStoragePage(phb_storage_enum storage):
    m_oldStorage(storage),
    m_storage(storage),
    m_list(NULL)
{
}


void VappPhbEditorSelectStoragePage::onInit()
{
    VfxPage::onInit();

    // create title bar
    VcpTitleBar* titleBar;
    VFX_OBJ_CREATE(titleBar, VcpTitleBar, this);
    titleBar->setTitle(VFX_WSTR_RES(VAPP_PHB_STR_STORAGE));
    setTopBar(titleBar);

    VFX_OBJ_CREATE(m_list, VcpListMenu, this);
    m_list->setSize(getSize());
    m_list->setAlignParent(
        VFX_FRAME_ALIGNER_MODE_SIDE,
        VFX_FRAME_ALIGNER_MODE_SIDE,
        VFX_FRAME_ALIGNER_MODE_SIDE,
        VFX_FRAME_ALIGNER_MODE_SIDE);

    m_list->setCellStyle(VCP_LIST_MENU_CELL_STYLE_SINGLE_TEXT);
    m_list->setMenuMode(VCP_LIST_MENU_MODE_HEAD_SINGLE_CHECK_MARK);
    m_list->setContentProvider(this);

    m_list->m_signalItemSelectionStateChanged.connect(this, &VappPhbEditorSelectStoragePage::onStateChanged);
    m_list->m_signalItemTapped.connect(this, &VappPhbEditorSelectStoragePage::onItemTaped);
}


void VappPhbEditorSelectStoragePage::onQueryRotateEx(VfxScreenRotateParam &param)
{
}


void VappPhbEditorSelectStoragePage::onItemTaped(VcpListMenu *list, VfxU32 index)
{
    // same storage selected
    if (m_storage == m_oldStorage)
    {
        getMainScr()->popPage();
        return;
    }

    // change storage warning, now only popup warning for phone contact
    if (m_storage != m_oldStorage)
    {
        VcpConfirmPopup *confirm;
        VFX_OBJ_CREATE(confirm, VcpConfirmPopup, this);

        confirm->setText(VFX_WSTR_RES(STR_ID_VAPP_PHB_INFO_MISSED_CONTINUE));
        confirm->setInfoType(VCP_POPUP_TYPE_WARNING);
        confirm->setButtonSet(VCP_CONFIRM_BUTTON_SET_USER_DEFINE);
        confirm->setCustomButton(
                    VFX_WSTR_RES(STR_GLOBAL_CONTINUE),
                    VFX_WSTR_RES(STR_GLOBAL_CANCEL),
                    VCP_POPUP_BUTTON_TYPE_WARNING,
                    VCP_POPUP_BUTTON_TYPE_CANCEL);

        confirm->m_signalButtonClicked.connect(this, &VappPhbEditorSelectStoragePage::onButtonClicked);

        confirm->show(VFX_TRUE); 
    }
    else
    {
        m_storageChanged.postEmit(m_storage);
        getMainScr()->popPage();
    }
}


void VappPhbEditorSelectStoragePage::onButtonClicked(VfxObject *obj, VfxId id)
{
    if (id == VCP_CONFIRM_POPUP_BUTTON_USER_1)
    {
        m_storageChanged.postEmit(m_storage);
    }
    getMainScr()->popPage();
}


void VappPhbEditorSelectStoragePage::onStateChanged(VcpListMenu *list, VfxU32 index, VcpListMenuItemStateEnum state)
{
    if (state == VCP_LIST_MENU_ITEM_STATE_SELECTED)
    {
        if (index == 0)
        {
            m_storage = PHB_STORAGE_NVRAM;
        }
    #ifdef __MMI_PHB_TCARD_STORAGE_SUPPORT__
        else if (srv_fmgr_drv_is_accessible((U8)SRV_FMGR_CARD_DRV) && getCount() == index + 1)
        {
            m_storage = PHB_STORAGE_TCARD;
        }
    #endif /* __MMI_PHB_TCARD_STORAGE_SUPPORT__ */
        else
        {
            for (VfxU32 i = 0, j = 0; i < ContactSim::getTotal(); i++)
            {
                mmi_sim_enum sim = mmi_frm_index_to_sim(i);
                if (srv_sim_ctrl_is_inserted(sim))
                {
                    if (j++ == (index - 1))
                    {
                        m_storage = ContactSim::getStorage(sim);
                    }
                }
            }
        }
    }
}


VfxBool VappPhbEditorSelectStoragePage::getItemText(
    VfxU32 index,                    // [IN] the index of item
    VcpListMenuFieldEnum fieldType,  // [IN] the type of the field in the cell
    VfxWString &text,                // [OUT] the text resource
    VcpListMenuTextColorEnum &color  // [OUT] the text color
    )
{
    if (fieldType == VCP_LIST_MENU_FIELD_TEXT)
    {
        if (index == 0)
        {
            text = VFX_WSTR_RES(VAPP_PHB_STR_PHONE);
            return VFX_TRUE;
        }
    #ifdef __MMI_PHB_TCARD_STORAGE_SUPPORT__
        else if (srv_fmgr_drv_is_accessible((U8)SRV_FMGR_CARD_DRV) && getCount() == index + 1)
        {
            text = ContactStorage::getName(PHB_STORAGE_TCARD);
            return VFX_TRUE;
        }
    #endif /* __MMI_PHB_TCARD_STORAGE_SUPPORT__ */
        else
        {
            for (VfxU32 i = 0, j = 0; i < ContactSim::getTotal(); i++)
            {
                mmi_sim_enum sim = mmi_frm_index_to_sim(i);
                if (srv_sim_ctrl_is_inserted(sim))
                {
                    if (j++ == (index - 1))
                    {
                        text = ContactStorage::getName(ContactSim::getStorage(sim));
                        return VFX_TRUE;
                    }
                }
            }
        }
    }

    return VFX_FALSE;
}


VfxU32 VappPhbEditorSelectStoragePage::getCount() const
{
    VfxU32 count = srv_sim_ctrl_get_num_of_inserted();

#ifdef __MMI_PHB_TCARD_STORAGE_SUPPORT__
    if (srv_fmgr_drv_is_accessible((U8)SRV_FMGR_CARD_DRV))
    {
        return (count + 2);
    }
#endif /* __MMI_PHB_TCARD_STORAGE_SUPPORT__ */
    return (count + 1);
}


VcpListMenuItemStateEnum VappPhbEditorSelectStoragePage::getItemState(
    VfxU32 index                     // [IN] index of the item
    ) const
{
    if (index == 0)
    {
        if (m_storage == PHB_STORAGE_NVRAM)
        {
            return VCP_LIST_MENU_ITEM_STATE_SELECTED;
        }
    }
#ifdef __MMI_PHB_TCARD_STORAGE_SUPPORT__
    else if (srv_fmgr_drv_is_accessible((U8)SRV_FMGR_CARD_DRV) && getCount() == index + 1)
    {
        if (m_storage == PHB_STORAGE_TCARD)
        {
            return VCP_LIST_MENU_ITEM_STATE_SELECTED;
        }
    }
#endif /* __MMI_PHB_TCARD_STORAGE_SUPPORT__ */
    else
    {
        for (VfxU32 i = 0, j = 0; i < ContactSim::getTotal(); i++)
        {
            mmi_sim_enum sim = mmi_frm_index_to_sim(i);
            if (srv_sim_ctrl_is_inserted(sim))
            {
                if (j++ == (index - 1) && m_storage == ContactSim::getStorage(sim))
                {
                    return VCP_LIST_MENU_ITEM_STATE_SELECTED;
                }
            }
        }
    }

    return VCP_LIST_MENU_ITEM_STATE_UNSELECTED;
}


VfxBool VappPhbEditorSelectStoragePage::getItemIsDisabled(
    VfxU32 index                     // [IN] the index of item
    ) const
{
    if (index == 0)
    {
        return VFX_FALSE;
    }
    else
    {
        for (VfxU32 i = 0, j = 0; i < ContactSim::getTotal(); i++)
        {
            if (srv_sim_ctrl_is_inserted(mmi_frm_index_to_sim(i)))
            {
                if (j++ == (index - 1) && !srv_phb_startup_is_phb_support(i, PHB_PHONEBOOK))
                {
                    return VFX_TRUE;
                }
            }
        }
    }

    return VFX_FALSE;
}


/***************************************************************************** 
 * Class VappPhbEditorBdayPage
 *****************************************************************************/
#ifdef __MMI_PHB_BIRTHDAY_FIELD__
VappPhbEditorBdayPage::VappPhbEditorBdayPage(VappContactBday *bday)
    : m_bday(bday),
      m_form(NULL)
{
    m_year = m_bday->getYear();
    m_month = m_bday->getMonth();
    m_day = m_bday->getDay();
}


void VappPhbEditorBdayPage::onInit()
{
    VfxPage::onInit();

    // create title bar
    VcpTitleBar* titleBar;
    VFX_OBJ_CREATE(titleBar, VcpTitleBar, this);
    titleBar->setTitle(VFX_WSTR_RES(VAPP_PHB_STR_BDAY));
    setTopBar(titleBar);

    // create tool bar
    VcpToolBar *tool;
    VFX_OBJ_CREATE(tool, VcpToolBar, this);
    tool->addItem(VAPP_PHB_CONTACT_CMD_DONE, VFX_WSTR_RES(STR_GLOBAL_DONE), VCP_IMG_TOOL_BAR_COMMON_ITEM_OK);
    tool->addItem(VAPP_PHB_CONTACT_CMD_DELETE, VFX_WSTR_RES(STR_GLOBAL_DELETE), VCP_IMG_TOOL_BAR_COMMON_ITEM_DELETE);
    if (!m_bday->checkBday())
    {
        tool->setDisableItem(VAPP_PHB_CONTACT_CMD_DELETE, VFX_TRUE);
    }
    tool->addItem(VAPP_PHB_CONTACT_CMD_CANCEL, VFX_WSTR_RES(VCP_STR_TOOL_BAR_CANCEL), VCP_IMG_TOOL_BAR_COMMON_ITEM_CANCEL);
    setBottomBar(tool);

    tool->m_signalButtonTap.connect(this, &VappPhbEditorBdayPage::onToolBarClick);

    VFX_OBJ_CREATE(m_form, VcpForm, this);
    m_form->setSize(getSize());
    m_form->setAlignParent(
        VFX_FRAME_ALIGNER_MODE_SIDE,
        VFX_FRAME_ALIGNER_MODE_SIDE,
        VFX_FRAME_ALIGNER_MODE_SIDE,
        VFX_FRAME_ALIGNER_MODE_SIDE);

    // create time picker
    VappPhbEditorBdayPickerFormItem *picker;
    VFX_OBJ_CREATE(picker, VappPhbEditorBdayPickerFormItem, m_form);
    VcpDatePicker *datePicker = picker->getPicker();

    // set data format
    srv_setting_date_format_enum dataFormat = srv_setting_get_date_format();
    switch (dataFormat)
    {
    case SETTING_DATE_FORMAT_DD_MM_YYYY:
        datePicker->setFormat(VCP_DATE_PICKER_FORMAT_DDMMYYYY);
        break;
    case SETTING_DATE_FORMAT_MM_DD_YYYY:
        datePicker->setFormat(VCP_DATE_PICKER_FORMAT_MMDDYYYY);
        break;
    case SETTING_DATE_FORMAT_YYYY_MM_DD:
        datePicker->setFormat(VCP_DATE_PICKER_FORMAT_YYYYMMDD);
        break;
    default:
        break;
    }

    // set Min data
    VcpDatePickerStruct data;
    data.year = MMI_PHB_BDAY_MIN_YEAR_INT;
    data.month = 1;
    data.day = 1;
    datePicker->setMinDate(data);

    // set Max data
    data.year = MMI_PHB_BDAY_MAX_YEAR_INT;
    data.month = 12;
    data.day = 31;
    datePicker->setMaxDate(data);

    // set current data
    if (!m_bday->checkBday())
    {
        datePicker->setCurrDate();
    }
    else
    {
        data.year = m_year;
        data.month = m_month;
        data.day = m_day;
        datePicker->setDate(data);
    }

    datePicker->m_signalOnDateChanged.connect(this, &VappPhbEditorBdayPage::onBirthDayChanged);

    m_form->addItem(picker, VAPP_PHB_EDITOR_BDAY_TIMER_PICKER);
}


void VappPhbEditorBdayPage::onQueryRotateEx(VfxScreenRotateParam &param)
{
}


void VappPhbEditorBdayPage::onBirthDayChanged(VfxObject *obj, VcpDatePickerStruct* date)
{
    // update birthday
    m_year = date->year;
    m_month = date->month;
    m_day = date->day;
}


void VappPhbEditorBdayPage::onToolBarClick(VfxObject *obj, VfxId id)
{
    switch (id)
    {
        case VAPP_PHB_CONTACT_CMD_DONE:
        {
            m_bday->setYear(m_year);
            m_bday->setMonth(m_month);
            m_bday->setDay(m_day);

            m_signalBirthDayChanged.postEmit();
            getMainScr()->popPage();
            break;
        }
        case VAPP_PHB_CONTACT_CMD_DELETE:
        {
            m_bday->setYear(0);
            m_bday->setMonth(0);
            m_bday->setDay(0);
            m_signalBirthDayChanged.postEmit();
            getMainScr()->popPage();
            break;
        }
        case VAPP_PHB_CONTACT_CMD_CANCEL:
        {
            getMainScr()->popPage();
            break;
        }
    }
}
#endif /* __MMI_PHB_BIRTHDAY_FIELD__ */


/***************************************************************************** 
 * Class VappPhbPhotoCp
 *****************************************************************************/
VappPhbPhotoCp::VappPhbPhotoCp():
    m_disable(VFX_FALSE)
{
}


void VappPhbPhotoCp::onInit()
{
    VcpPhotoBorderFrame::onInit();

    setPlacement(VCP_PHOTO_BORDER_FRAME_PLACEMENT_FIT_EXACT_SIZE);
    setImageContentPlacement(VFX_FRAME_CONTENT_PLACEMENT_TYPE_RESIZE_ASPECT);
}


void VappPhbPhotoCp::setDisableClick(VfxBool disable)
{
    m_disable = disable;
}


void VappPhbPhotoCp::setPhoto(const VfxImageSrc& photo)
{
    if (photo.getType() == VFX_IMAGE_SRC_TYPE_RES_ID)
    {
        setImgResId(photo.getResId());
    }
    else if (photo.getType() == VFX_IMAGE_SRC_TYPE_PATH)
    {
        if (srv_fmgr_fs_path_exist((WCHAR*)(photo.getPath().getBuf())) >= 0)
        {
            setImgPath(photo.getPath());
        }
        else
        {
            setImgResId(IMG_COSMOS_HEAD_PORTRAIT);
        }
    }
    else if (photo.isEmpty())
    {
        setImgResId(IMG_COSMOS_HEAD_PORTRAIT);
    }
    else if(photo.getType() == VFX_IMAGE_SRC_TYPE_IMAGE_BUFFER)
    {
        setImgContent(photo);
    }
}


VfxBool VappPhbPhotoCp::onPenInput(VfxPenEvent &event)
{
    if (m_disable)
    {
        return VfxControl::onPenInput(event);
    }

    switch (event.type)
    {
        case VFX_PEN_EVENT_TYPE_DOWN:
        {
            if (containPoint(event.getRelPos(this)))
            {
                return VFX_TRUE;
            }

            break;
        }
        case VFX_PEN_EVENT_TYPE_UP:
        {
            if (containPoint(event.getRelPos(this)))
            {
                m_signalClicked.postEmit(this, 0);

                return VFX_TRUE;
            }
        }
    }

    return VfxControl::onPenInput(event);
}


/***************************************************************************** 
 * Class VappPhbNameCp
 *****************************************************************************/
VappPhbNameCp::VappPhbNameCp():
#ifdef __MMI_PHB_USIM_SUPPORT__
    m_nickname(NULL),
#endif
#ifdef __MMI_SNS_CONTACTS__
    m_comment(NULL),
#endif
    m_name(NULL)
{
}


void VappPhbNameCp::onInit()
{
    VfxControl::onInit();

    // create name
    VFX_OBJ_CREATE(m_name, VfxTextFrame, this);
    m_name->setFont(VfxFontDesc(VFX_FONT_DESC_VF_SIZE(VCPFRM_FONT_SIZE_4)));
    m_name->setColor(VCP_FORM_DARK_FONT_COLOR);
    m_name->setTruncateMode(VfxTextFrame::TRUNCATE_MODE_END);

#ifdef __MMI_PHB_USIM_SUPPORT__
    // create nickname
    VFX_OBJ_CREATE(m_nickname, VfxTextFrame, this);
    m_nickname->setFont(VfxFontDesc(VFX_FONT_DESC_VF_SIZE(VCPFRM_FONT_SIZE_1)));
    m_nickname->setColor(VCP_FORM_HINT_TEXT_COLOR);
    m_nickname->setTruncateMode(VfxTextFrame::TRUNCATE_MODE_END);
#endif /* __MMI_PHB_USIM_SUPPORT__ */

#ifdef __MMI_SNS_CONTACTS__
    // create comment
    VFX_OBJ_CREATE(m_comment, VfxTextFrame, this);
    m_comment->setFont(VfxFontDesc(VFX_FONT_DESC_VF_SIZE(VCPFRM_FONT_SIZE_1)));
    m_comment->setColor(VCP_FORM_HINT_TEXT_COLOR);
    m_comment->setLineMode(VfxTextFrame::LINE_MODE_MULTI);
    m_comment->setMaxLines(2);
    m_comment->setTruncateMode(VfxTextFrame::TRUNCATE_MODE_END);
#endif /* __MMI_SNS_CONTACTS__ */
}


void VappPhbNameCp::setName(const VfxWString& name)
{
    m_name->setString(name);
    checkUpdate();
}


#ifdef __MMI_PHB_USIM_SUPPORT__
void VappPhbNameCp::setNickname(const VfxWString& nickname)
{
    m_nickname->setString(nickname);
    checkUpdate();
}
#endif /* __MMI_PHB_USIM_SUPPORT__ */


#ifdef __MMI_SNS_CONTACTS__
void VappPhbNameCp::setComment(const VfxWString& comment)
{
    m_comment->setString(comment);
    checkUpdate();
}
#endif /* __MMI_SNS_CONTACTS__ */


void VappPhbNameCp::onUpdate()
{
    VfxS32 height = 0;
    VfxS32 width = 0;
    VfxSize size = getSize();

    if (!m_name->getString().isEmpty())
    {
        m_name->setPos(0, 0);
        m_name->setSize(size.width, VCPFRM_FONT_SIZE_3);
        m_name->setSize(m_name->getMeasureBounds().size);
        m_name->setAlignParent(
            VFX_FRAME_ALIGNER_SIDE_LEFT,
            VFX_FRAME_ALIGNER_MODE_SIDE);

        m_name->setAlignParent(
            VFX_FRAME_ALIGNER_SIDE_RIGHT,
            VFX_FRAME_ALIGNER_MODE_SIDE);

        height = m_name->getMeasureBounds().size.height;
        width = m_name->getMeasureBounds().size.width;
    }

#ifdef __MMI_PHB_USIM_SUPPORT__
    if (!m_nickname->getString().isEmpty())
    {
        height += NAME_GAP;
        m_nickname->setHidden(VFX_FALSE);
        m_nickname->setPos(0, height);
        m_nickname->setSize(size.width, VCPFRM_FONT_SIZE_1);
        m_nickname->setSize(m_nickname->getMeasureBounds().size);
        m_nickname->setAlignParent(
            VFX_FRAME_ALIGNER_SIDE_LEFT,
            VFX_FRAME_ALIGNER_MODE_SIDE);

        m_nickname->setAlignParent(
            VFX_FRAME_ALIGNER_SIDE_RIGHT,
            VFX_FRAME_ALIGNER_MODE_SIDE);

        height += m_nickname->getMeasureBounds().size.height;
        width = (width < m_nickname->getMeasureBounds().size.width) ?
                    m_nickname->getMeasureBounds().size.width :
                    width;
    }
#endif /* __MMI_PHB_USIM_SUPPORT__ */

#ifdef __MMI_SNS_CONTACTS__
    if (!m_comment->getString().isEmpty())
    {
        height += NAME_GAP;
        m_comment->setHidden(VFX_FALSE);
        m_comment->setPos(0, height);
        m_comment->setSize(size.width, VCPFRM_FONT_SIZE_1);
        m_comment->setSize(m_comment->getMeasureBounds().size.width, m_comment->getMeasureBounds().size.height * 2 + 4);
        m_comment->setAlignParent(
            VFX_FRAME_ALIGNER_SIDE_LEFT,
            VFX_FRAME_ALIGNER_MODE_SIDE);

        m_comment->setAlignParent(
            VFX_FRAME_ALIGNER_SIDE_RIGHT,
            VFX_FRAME_ALIGNER_MODE_SIDE);

        height += m_comment->getMeasureBounds().size.height * 2 + 4;
        width = (width < m_comment->getMeasureBounds().size.width) ?
                    m_comment->getMeasureBounds().size.width :
                    width;
    }
#endif /* __MMI_SNS_CONTACTS__ */

    width = (width < size.width) ? width : size.width;
    setSize(width, height);

    VfxControl::onUpdate();
}


/***************************************************************************** 
 * Class VappPhbEditorNameFormItem
 *****************************************************************************/
VappPhbEditorNameFormItem::VappPhbEditorNameFormItem():
    m_image(NULL),
#ifndef __MMI_PHB_LAST_NAME_FIELD__
    m_editor(NULL)
#else
    m_name(NULL),
    m_editBtn(NULL)
#endif
{
}


void VappPhbEditorNameFormItem::onInit()
{
    VcpFormItemBase::onInit();

    // set item height
    setHeight(ICON_SIZE + VCPFRM_SIDE_MARGIN_LARGE + VCPFRM_SIDE_MARGIN_LARGE);

    // create thumbnail image
    VFX_OBJ_CREATE(m_image, VappPhbPhotoCp, this);
    m_image->setAnchor(0, 0);
    m_image->setPos(VCPFRM_SIDE_MARGIN_LARGE, VCPFRM_SIDE_MARGIN_LARGE);
    m_image->setSize(VfxSize(ICON_SIZE, ICON_SIZE));
    m_image->setMaxSize(VfxSize(ICON_SIZE, ICON_SIZE));
    m_image->setPhoto(VfxImageSrc(VAPP_PHB_IMG_DEFAULT_CONTACT));

#ifndef __MMI_PHB_LAST_NAME_FIELD__
    // create name control
    VfxFrame* bg;
    VFX_OBJ_CREATE(bg, VfxFrame, this);
    bg->setAnchor(0, 0.5f);
    bg->setPos(m_image->getPos().x + m_image->getSize().width + VCPFRM_INDENT_L3, getSize().height/2);
    bg->setSize(
        getSize().width - (m_image->getPos().x + m_image->getSize().width + VCPFRM_INDENT_L3) - VCPFRM_SIDE_MARGIN_LARGE,
        VCPFRM_FONT_SIZE_3 + VCPFRM_ITEM_HORZ_GAP_1 + VCPFRM_STANDARD_BTN_HEIGHT + VCPFRM_ITEM_HORZ_GAP_1);

    bg->setAlignParent(
        VFX_FRAME_ALIGNER_MODE_SIDE,
        VFX_FRAME_ALIGNER_MODE_SIDE,
        VFX_FRAME_ALIGNER_MODE_SIDE,
        VFX_FRAME_ALIGNER_MODE_SIDE);

    // create name
    VfxTextFrame *label;
    VFX_OBJ_CREATE(label, VfxTextFrame, bg);
    label->setFont(VfxFontDesc(VFX_FONT_DESC_VF_SIZE(VCPFRM_FONT_SIZE_3)));
    label->setColor(VCP_FORM_DARK_FONT_COLOR);
    label->setString(VAPP_PHB_STR_NAME);
    label->setSize(label->getMeasureBounds().size);

    label->setAlignParent(
        VFX_FRAME_ALIGNER_SIDE_LEFT,
        VFX_FRAME_ALIGNER_MODE_SIDE);

    label->setAlignParent(
        VFX_FRAME_ALIGNER_SIDE_RIGHT,
        VFX_FRAME_ALIGNER_MODE_SIDE);

    // create editor
    VFX_OBJ_CREATE(m_editor, VcpTextEditor, bg);
    m_editor->setPos(0, label->getSize().height + VCPFRM_ITEM_HORZ_GAP_1);
    m_editor->setSize(bg->getSize().width, VCPFRM_STANDARD_BTN_HEIGHT);
    m_editor->setLineMode(VCP_TEXT_LINE_MODE_SINGLE);

    m_editor->setAlignParent(
        VFX_FRAME_ALIGNER_SIDE_LEFT,
        VFX_FRAME_ALIGNER_MODE_SIDE);

    m_editor->setAlignParent(
        VFX_FRAME_ALIGNER_SIDE_RIGHT,
        VFX_FRAME_ALIGNER_MODE_SIDE);
#else /* __MMI_PHB_LAST_NAME_FIELD__ */
    // create name control
    VFX_OBJ_CREATE(m_name, VappPhbNameCp, this);
    m_name->setAnchor(0, 0.5f);
    m_name->setPos(m_image->getPos().x + m_image->getSize().width + VCPFRM_INDENT_L3, getSize().height/2);
    m_name->setSize(
        getSize().width - (m_image->getPos().x + m_image->getSize().width + VCPFRM_INDENT_L3) - VCPFRM_STD_UI_CNTRL_HEIGHT - VCPFRM_SIDE_MARGIN_LARGE,
        m_image->getSize().height - VCPFRM_ITEM_HORZ_GAP_2);

    m_name->setAlignParent(
        VFX_FRAME_ALIGNER_SIDE_LEFT,
        VFX_FRAME_ALIGNER_MODE_SIDE);

    m_name->setAlignParent(
        VFX_FRAME_ALIGNER_SIDE_RIGHT,
        VFX_FRAME_ALIGNER_MODE_SIDE);

    // create edit button
    VFX_OBJ_CREATE(m_editBtn, VcpButton, this);
    m_editBtn->setPlacement(VCP_BUTTON_PLACEMENT_IMAGE_ONLY);
    m_editBtn->setImage(VcpStateImage(IMG_COSMOS_EDIT));
    m_editBtn->setAnchor(1.0f, 1.0f);
    m_editBtn->setPos(getSize().width - (VCPFRM_INDENT_L1 + VCPFRM_INDENT_L2), getSize().height - VCPFRM_SIDE_MARGIN_LARGE);
    m_editBtn->setSize(VCPFRM_STD_UI_EDITOR_HEIGHT, VCPFRM_STD_UI_EDITOR_HEIGHT);
    m_editBtn->setIsAutoResized(VFX_FALSE);
    m_editBtn->setAlignParent(
        VFX_FRAME_ALIGNER_SIDE_RIGHT,
        VFX_FRAME_ALIGNER_MODE_SIDE);

    m_editBtn->m_signalClicked.connect(this, &VappPhbEditorNameFormItem::onEditName);
#endif /* __MMI_PHB_LAST_NAME_FIELD__ */
}


VcpTextEditor* VappPhbEditorNameFormItem::getEditor()
{
    return m_editor;
}


VappPhbPhotoCp *VappPhbEditorNameFormItem::getImageBtn()
{
    return m_image;
}


#ifdef __MMI_PHB_LAST_NAME_FIELD__
void VappPhbEditorNameFormItem::onEditName(VfxObject* obj, VfxId id)
{
    m_nameTaped.postEmit();
}
#endif /* __MMI_PHB_LAST_NAME_FIELD__ */


void VappPhbEditorNameFormItem::setName(const VfxWString &name)
{
#ifndef __MMI_PHB_LAST_NAME_FIELD__
    m_editor->setText(name, MMI_PHB_NAME_LENGTH, VFX_FALSE);
#else
    m_name->setName(name);
#endif
}


void VappPhbEditorNameFormItem::setImage(const VfxImageSrc &image)
{
    m_image->setPhoto(image);
}


#ifdef __MMI_PHB_LAST_NAME_FIELD__
VfxBool VappPhbEditorNameFormItem::onPenInput(VfxPenEvent &event)
{
    switch (event.type)
    {
        case VFX_PEN_EVENT_TYPE_DOWN:
        {
            if (containPoint(event.getRelPos(this)))
            {
                return VFX_TRUE;
            }
            break;
        }
        case VFX_PEN_EVENT_TYPE_UP:
        {
            if (m_name->containPoint(event.getRelPos(m_name)))
            {
                m_nameTaped.postEmit();
                return VFX_TRUE;
            }
            break;
        }
    }

    return VcpFormItemBase::onPenInput(event);
}
#endif /* __MMI_PHB_LAST_NAME_FIELD__ */


#ifdef __MMI_PHB_INFO_FIELD__
/***************************************************************************** 
 * Class VappPhbEditorAddressFormItem
 *****************************************************************************/
void VappPhbEditorAddressFormItem::onInit()
{
    VcpFormItemBase::onInit();

    setHeight(VCPFRM_ITEM_HORZ_GAP_2 * 2 + VCPFRM_STD_UI_CNTRL_HEIGHT);

    VFX_OBJ_CREATE(m_label, VfxTextFrame, this);
    m_label->setFont(VfxFontDesc(VFX_FONT_DESC_VF_SIZE(VCPFRM_FONT_SIZE_2)));
    m_label->setColor(VCP_FORM_DARK_FONT_COLOR);
    m_label->setTruncateMode(VfxTextFrame::TRUNCATE_MODE_END);
    m_label->setAnchor(0.0, 0.5f);
    m_label->setPos(VCPFRM_SIDE_MARGIN_LARGE, getSize().height/2);
    m_label->setSize(getSize().width - VCPFRM_STD_UI_CNTRL_HEIGHT - VCPFRM_SIDE_MARGIN_LARGE * 2 - VCPFRM_SIDE_MARGIN_SMALL, VCPFRM_FONT_SIZE_2);
    m_label->setAlignParent(
        VFX_FRAME_ALIGNER_MODE_SIDE,
        VFX_FRAME_ALIGNER_MODE_SIDE,
        VFX_FRAME_ALIGNER_MODE_SIDE,
        VFX_FRAME_ALIGNER_MODE_SIDE);

    VFX_OBJ_CREATE(m_btn, VcpButton, this);
    m_btn->setPlacement(VCP_BUTTON_PLACEMENT_IMAGE_ONLY);
    m_btn->setImage(VcpStateImage(IMG_COSMOS_EDIT));
    m_btn->setAnchor(1.0f, 0.0f);
    m_btn->setPos(getSize().width - (VCPFRM_INDENT_L1 + VCPFRM_INDENT_L2), VCPFRM_ITEM_HORZ_GAP_2);
    m_btn->setSize(VCPFRM_STD_UI_EDITOR_HEIGHT, VCPFRM_STD_UI_EDITOR_HEIGHT);
    m_btn->setAlignParent(VFX_FRAME_ALIGNER_SIDE_RIGHT, VFX_FRAME_ALIGNER_MODE_SIDE);

    m_btn->m_signalClicked.connect(this, &VappPhbEditorAddressFormItem::onEditAddress);
}


void VappPhbEditorAddressFormItem::setLabel(const VfxWString& text)
{
    m_label->setString(text);
}


void VappPhbEditorAddressFormItem::onEditAddress(VfxObject* obj, VfxId id)
{
    m_addressTaped.postEmit();
}


VfxBool VappPhbEditorAddressFormItem::onPenInput(VfxPenEvent &event)
{
    switch (event.type)
    {
        case VFX_PEN_EVENT_TYPE_DOWN:
        {
            if (containPoint(event.getRelPos(this)))
            {
                return VFX_TRUE;
            }
            break;
        }
        case VFX_PEN_EVENT_TYPE_UP:
        {
            if (m_label->containPoint(event.getRelPos(m_label)))
            {
                m_addressTaped.postEmit();
                return VFX_TRUE;
            }
            break;
        }
    }

    return VcpFormItemBase::onPenInput(event);
}
#endif /* __MMI_PHB_INFO_FIELD__ */


/***************************************************************************** 
 * Class VappPhbEditorBdayPickerFormItem
 *****************************************************************************/
void VappPhbEditorBdayPickerFormItem::onInit()
{
    VcpFormItemBase::onInit();

    VFX_OBJ_CREATE_EX(m_picker, VcpDatePicker, this, (MMI_PHB_BDAY_MIN_YEAR_INT, MMI_PHB_BDAY_MAX_YEAR_INT));// Call new constructor

    setHeight(m_picker->getSize().height);

    m_picker->setAnchor(0.5f, 0.5f);
    m_picker->setPos(getSize().width/2, getSize().height/2);
    m_picker->setAlignParent(
        VFX_FRAME_ALIGNER_MODE_MID,
        VFX_FRAME_ALIGNER_MODE_MID,
        VFX_FRAME_ALIGNER_MODE_MID,
        VFX_FRAME_ALIGNER_MODE_MID);
}


VcpDatePicker *VappPhbEditorBdayPickerFormItem::getPicker()
{
    return m_picker;
}


/***************************************************************************** 
 * Class VappPhbFieldItem
 *****************************************************************************/
VappPhbFieldItem::VappPhbFieldItem():
    m_item(NULL),
    m_itemId(0)
{
}


void VappPhbFieldItem::onInit()
{
    VfxObject::onInit();

    VFX_OBJ_CREATE_EX(m_item, VappPhbFormItemStack, this, (MMI_PHB_CONTACT_MAX_ITEM));
}


VfxU32 VappPhbFieldItem::getNewItemId()
{
    return ++m_itemId;
}


void VappPhbFieldItem::setItem(const ContactItem& id)
{
    m_item->pushValue(id);
}


void VappPhbFieldItem::insertItem(const ContactItem& id, VfxU32 beforeItemId)
{
    m_item->insertValue(id, getItemIndex(beforeItemId));
}


void VappPhbFieldItem::removeItem(VfxU32 itemId)
{
    m_item->removeValue(getItemIndex(itemId));
}


VfxU32 VappPhbFieldItem::getItemCount()
{
    return m_item->getCount();
}


VfxObject* VappPhbFieldItem::getObj(VfxU32 fieldType, VfxU32 fieldId)
{
    for (VfxU32 i = 0; i < m_item->getCount(); i++)
    {
        if (m_item->getValue(i).m_fieldType == fieldType
            && m_item->getValue(i).m_fieldId == fieldId)
        {
            return m_item->getValue(i).m_obj;
        }
    }

    return NULL;
}


VfxObject* VappPhbFieldItem::getObj(VfxU32 itemType)
{
    for (VfxU32 i = 0; i < m_item->getCount(); i++)
    {
        if (m_item->getValue(i).m_itemType == itemType)
        {
            return m_item->getValue(i).m_obj;
        }
    }

    return NULL;
}


VappContactFieldItem& VappPhbFieldItem::getItemByIndex(VfxU32 index)
{
    return m_item->getValue(index);
}


VappContactFieldItem& VappPhbFieldItem::getPrevItem(VfxU32 itemId)
{
    VfxS32 index;

    for (index = 0; index < (VfxS32) m_item->getCount(); index++)
    {
        if (m_item->getValue(index).m_itemId == itemId)
        {
            index--;
            break;
        }
    }

    if (index < 0)
    {
        return m_temp;
    }

    return m_item->getValue(index);
}


VappContactFieldItem& VappPhbFieldItem::getNextItem(VfxU32 itemId)
{
    VfxU32 index;

    for (index = 0; index < m_item->getCount(); index++)
    {
        if (m_item->getValue(index).m_itemId == itemId)
        {
            index++;
            break;
        }
    }

    if (index >= getItemCount())
    {
        return m_temp;
    }

    return m_item->getValue(index);
}


VappContactFieldItem& VappPhbFieldItem::getItem(VfxU32 itemId)
{
    VfxU32 index;

    for (index = 0; index < m_item->getCount(); index++)
    {
        if (m_item->getValue(index).m_itemId == itemId)
        {
            break;
        }
    }

    return m_item->getValue(index);
}


VappContactFieldItem VappPhbFieldItem::getItemByItemType(VfxU32 itemType)
{
    for (VfxU32 i = 0; i < m_item->getCount(); i++)
    {
        if (m_item->getValue(i).m_itemType == itemType)
        {
            return m_item->getValue(i);
        }
    }

    return ContactItem();
}


VfxU32 VappPhbFieldItem::getItemIndex(VfxU32 itemId)
{
    for (VfxU32 i = 0; i < m_item->getCount(); i++)
    {
        if (m_item->getValue(i).m_itemId == itemId)
        {
            return i;
        }
    }

    return 0xFFFFFFFF;
}

S32 vapp_phb_imggallery_is_file_support(const WCHAR *path)

{

    S32         imgWidth, imgHeight;
    S32         view_x, view_y, view_w, view_h;
    S32         ret = CUI_PHB_IMGEDT_OK;
    FS_HANDLE   fs;
    GDI_RESULT  gdi_res;
    

   MMI_TRACE(MMI_MEDIA_TRC_G2_APP, TRC_IMGEDT_IS_FILE_SUPPORT, __LINE__);

   do
    {
    #ifdef __DRM_SUPPORT__
        if(DRM_METHOD_NONE != DRM_get_object_method(0, (kal_wchar*)path))
        {
            ret = CUI_PHB_IMGEDT_E_FILE_ACCESS_DENIED;
            break;
        }
    #endif

       if ((fs = FS_Open(path, FS_READ_ONLY)) < FS_NO_ERROR)
        {
            ret = CUI_PHB_IMGEDT_E_FILE_ACCESS_DENIED; 
            break;
        }
        FS_Close(fs);

        if (GDI_IMAGE_TYPE_INVALID == gdi_image_get_type_from_file((CHAR*) path))
        {
            ret = CUI_PHB_IMGEDT_E_UNSUPPORTED_FORMAT;
            break;
        }
    
        gdi_res = gdi_imgdec_get_dimension_file((U8*)path, &imgWidth, &imgHeight);
        if(GDI_SUCCEED != gdi_res)
        {
            ret = CUI_PHB_IMGEDT_E_UNSUPPORTED_FORMAT;
            break;
        }
        else
        {
            if((imgWidth  < IMGEDT_PHB_CLIP_MIN_LENGHTH) ||
               (imgHeight < IMGEDT_PHB_CLIP_MIN_LENGHTH))
            {
                ret = CUI_PHB_IMGEDT_E_UNSUPPORTED_RESOLUTION;
                break;
            }

            //init preview rect
            gdi_util_fit_box(GDI_UTIL_MODE_NO_RESIZE_OR_LONG_SIDE_FIT, 
                             GDI_LCD_WIDTH, 
                             GDI_LCD_HEIGHT, 
                             imgWidth, 
                             imgHeight, 
                             &view_x,
                             &view_y, 
                             &view_w, 
                             &view_h);
             if (view_w < IMGEDT_PHB_CLIP_MIN_LENGHTH || view_h < IMGEDT_PHB_CLIP_MIN_LENGHTH)
             {
                ret = CUI_PHB_IMGEDT_E_UNSUPPORTED_RESOLUTION;
                break;
             }
        }
    }while(0);

    //VAPP_IMGEDT_INFO_TRACE(ret);
    return ret;
}

