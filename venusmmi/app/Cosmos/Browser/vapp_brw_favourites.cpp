
/*****************************************************************************
*  Copyright Statement:
*  --------------------
*  This software is protected by Copyright and the information contained
*  herein is confidential. The software may not be copied and the information
*  contained herein may not be used or disclosed except with the written
*  permission of MediaTek Inc. (C) 2005
*
*  BY OPENING THIS FILE, BUYER HEREBY UNEQUIVOCALLY ACKNOWLEDGES AND AGREES
*  THAT THE SOFTWARE/FIRMWARE AND ITS DOCUMENTATIONS ("MEDIATEK SOFTWARE")
*  RECEIVED FROM MEDIATEK AND/OR ITS REPRESENTATIVES ARE PROVIDED TO BUYER ON
*  AN "AS-IS" BASIS ONLY. MEDIATEK EXPRESSLY DISCLAIMS ANY AND ALL WARRANTIES,
*  EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE IMPLIED WARRANTIES OF
*  MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE OR NONINFRINGEMENT.
*  NEITHER DOES MEDIATEK PROVIDE ANY WARRANTY WHATSOEVER WITH RESPECT TO THE
*  SOFTWARE OF ANY THIRD PARTY WHICH MAY BE USED BY, INCORPORATED IN, OR
*  SUPPLIED WITH THE MEDIATEK SOFTWARE, AND BUYER AGREES TO LOOK ONLY TO SUCH
*  THIRD PARTY FOR ANY WARRANTY CLAIM RELATING THERETO. MEDIATEK SHALL ALSO
*  NOT BE RESPONSIBLE FOR ANY MEDIATEK SOFTWARE RELEASES MADE TO BUYER'S
*  SPECIFICATION OR TO CONFORM TO A PARTICULAR STANDARD OR OPEN FORUM.
*
*  BUYER'S SOLE AND EXCLUSIVE REMEDY AND MEDIATEK'S ENTIRE AND CUMULATIVE
*  LIABILITY WITH RESPECT TO THE MEDIATEK SOFTWARE RELEASED HEREUNDER WILL BE,
*  AT MEDIATEK'S OPTION, TO REVISE OR REPLACE THE MEDIATEK SOFTWARE AT ISSUE,
*  OR REFUND ANY SOFTWARE LICENSE FEES OR SERVICE CHARGE PAID BY BUYER TO
*  MEDIATEK FOR SUCH MEDIATEK SOFTWARE AT ISSUE.
*
*  THE TRANSACTION CONTEMPLATED HEREUNDER SHALL BE CONSTRUED IN ACCORDANCE
*  WITH THE LAWS OF THE STATE OF CALIFORNIA, USA, EXCLUDING ITS CONFLICT OF
*  LAWS PRINCIPLES.  ANY DISPUTES, CONTROVERSIES OR CLAIMS ARISING THEREOF AND
*  RELATED THERETO SHALL BE SETTLED BY ARBITRATION IN SAN FRANCISCO, CA, UNDER
*  THE RULES OF THE INTERNATIONAL CHAMBER OF COMMERCE (ICC).
*
*****************************************************************************/

/*****************************************************************************
 *
 * Filename:
 * ---------
 * BrowserUIPlugIn.c
 *
 * Project:
 * --------
 *   MAUI
 *
 * Description:
 * ------------
 *   
 *
 * Author:
 * -------
 * -------
 *
 *============================================================================
 *             HISTORY
 * Below this line, this part is controlled by PVCS VM. DO NOT MODIFY!!
 *------------------------------------------------------------------------------
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
*------------------------------------------------------------------------------
 * Upper this line, this part is controlled by PVCS VM. DO NOT MODIFY!!
 *============================================================================
 ****************************************************************************/

#include "MMI_include.h"
#ifndef _VAPP_BRW_FAVOURITES_CPP_
#define _VAPP_BRW_FAVOURITES_CPP_

/*  Include: MMI header file */

#ifdef __MMI_BROWSER_2__

#ifdef __cplusplus
extern "C"
{
#endif /* __CPLUSPLUS__ */
#include "BrowserSrvInterface.h"
#include "BrowserSrvBookmarks.h"
#include "BrowserSrvGprot.h"
#include "mmi_rp_vapp_browser_def.h"
#include "vBookmark.h"
#include "Conversions.h"
#include "USBsrvGprot.h"
#include "CbmSrvGprot.h"

/*#if defined(__DCM_WITH_COMPRESSION_MMI_POOL_A__) 
#include "dcmgr.h" // DCM
#endif*/

extern void vappBrwCopyBookmarkCallback(void *msg);
#ifdef __cplusplus
}
#endif /* __cplusplus */
 
#include "vapp_brw_main.h"
#include "vapp_brw_favourites.h"
#include "vapp_brw_interface.h"
#include "vapp_brw_bookmark_cui.h"
#include "vapp_fmgr_cui_gprot.h"
#include "vcp_menu_popup.h"
#include "vapp_usb_gprot.h"
#include "vfx_adp_device.h"

//#pragma arm section code = "DYNAMIC_CODE_BROWSER_ROCODE", rodata = "DYNAMIC_CODE_BROWSER_RODATA"

void VappBrowserBookmarksContext::updateFileCount(void)
{
    VfxBool is_root_folder_list = (m_selFolderName[0] == 0);
    VfxChar *sel_folder_name;
    VFX_ALLOC_MEM(sel_folder_name, (SRV_BRW_BKM_MAX_FILE_NAME_LEN + 1), this);
    memset(sel_folder_name, 0, SRV_BRW_BKM_MAX_FILE_NAME_LEN + 1);
    mmi_chset_ucs2_to_utf8_string((U8*)sel_folder_name,
        (SRV_BRW_BKM_MAX_FILE_NAME_LEN + 1),
        (U8*)m_selFolderName);
    VfxU8 fileCount = VappBrowserUtility::getBookmarkItems((VfxU8*)sel_folder_name, m_bookmarkList);
    VFX_FREE_MEM(sel_folder_name);
    if(fileCount > 0)
    {
        if(is_root_folder_list)
        {
            srv_brw_bkm_arrange_bookmark_list_in_order(m_bookmarkList, fileCount);
        }
        else
        {
            srv_brw_bookmark_sort_bookmark_list(m_bookmarkList, 0, fileCount - 1);
        }
    }
    setTotalFileCount(fileCount);
}

VfxU8 VappBrowserBookmarksContext::getFileCountByType(srv_brw_bkm_types_enum selType)
{
    VfxU8 count = 0;
    for(VfxU8 index = 0; index < m_totalFileCount; index++)
    {
        if(g_srv_brw_cntx.bkm_cntx_p[m_bookmarkList[index].actual_index].type == selType)
        {
            count++;
        }
    }
    return count;
}

VfxBool VappBrowserBookmarksDataProvider::getItemText(
    VfxU32 index,
    VcpListMenuFieldEnum fieldType,
    VfxWString &text,
    VcpListMenuTextColorEnum &color
    )
{
    if(m_bookmarksContext->getTotalFileCount() == 0)
    {
        return VFX_TRUE;
    }
    if(fieldType == VCP_LIST_MENU_FIELD_TEXT)
    {
        MMI_ASSERT(index < m_bookmarksContext->getTotalFileCount());
        srv_brw_bkm_types_enum file_type = g_srv_brw_cntx.bkm_cntx_p[m_bookmarksContext->m_bookmarkList[index].actual_index].type;
        MMI_ASSERT(file_type != SRV_BRW_BKM_TYPE_EMPTY);
        VfxWChar *textPtr = text.lockBuf(128);
        mmi_chset_utf8_to_ucs2_string((kal_uint8*) textPtr, (SRV_BRW_BKM_MAX_FILE_NAME_LEN + 1)* ENCODING_LENGTH, (kal_uint8*) g_srv_brw_cntx.bkm_cntx_p[m_bookmarksContext->m_bookmarkList[index].actual_index].title);
        text.unlockBuf();
    }
    return VFX_TRUE;
}

VfxBool VappBrowserBookmarksDataProvider::getItemImage(
    VfxU32 index,
    VcpListMenuFieldEnum fieldType,
    VfxImageSrc &image
        )
{
    MMI_ASSERT(index < m_bookmarksContext->getTotalFileCount());
    srv_brw_bkm_types_enum file_type = g_srv_brw_cntx.bkm_cntx_p[m_bookmarksContext->m_bookmarkList[index].actual_index].type;
    MMI_ASSERT(file_type != SRV_BRW_BKM_TYPE_EMPTY);
    if(fieldType == VCP_LIST_MENU_FIELD_ICON)
    {
        if(file_type == SRV_BRW_BKM_TYPE_USER_CREATED_FILE)
        {
            image.setResId(IMG_ID_VAPP_BRW_LIST_ICON_USER_BKM_FILE);
        }
        else if(file_type == SRV_BRW_BKM_TYPE_DEFAULT_FILE)
        {
            image.setResId(IMG_ID_VAPP_BRW_LIST_ICON_DEFAULT_BKM_FILE);
        }
    #ifdef __MMI_BRW_BKM_FOLDER_SUPPORT__
        else if(file_type == SRV_BRW_BKM_TYPE_FOLDER)
        {
            image.setResId(IMG_ID_VAPP_BRW_LIST_ICON_BKM_FOLDER);
        }
    #endif
    }
#ifdef __MMI_BRW_BKM_FOLDER_SUPPORT__
    if(file_type == SRV_BRW_BKM_TYPE_FOLDER)
    {
        if(fieldType == VCP_LIST_MENU_FIELD_DISCLOSURE_IMG)
        {
            image.setResId(VCP_IMG_LIST_MENU_DEFAULT_DISCLOSURE);
        }
        else if(fieldType == VCP_LIST_MENU_FIELD_HIGHLIGHT_DISCLOSURE_IMG)
        {
            image.setResId(VCP_IMG_LIST_MENU_DEFAULT_HIGHLIGHT_DISCLOSURE);
        }
    }
    else
#endif
    {
        if(fieldType == VCP_LIST_MENU_FIELD_CMD_BUT_IMG_NORMAL)
        {
            image.setResId(IMG_ID_VAPP_BRW_FOLDER_NEXT_LEVEL);
        }
    }
    return VFX_TRUE;
}

VcpListMenuItemStateEnum VappBrowserBookmarksDataProvider::getItemState(
    VfxU32 index
    ) const
{
    if(m_selectedListInfo[index] == 0)
    {
        return VCP_LIST_MENU_ITEM_STATE_UNSELECTED;
    }
    else
    {
        return VCP_LIST_MENU_ITEM_STATE_SELECTED;
    }
}


VfxBool VappBrowserBookmarksDataProvider::isRootFolderSelected(void)
{
    return(m_bookmarksContext->m_selFolderName[0] == 0);
}

VfxBool VappBrowserBookmarksDataProvider::getItemIsDisabled(VfxU32 index) const
{
    if(list_mode == LIST_MODE_SELECTION)
    {
        srv_brw_bkm_types_enum file_type = g_srv_brw_cntx.bkm_cntx_p[m_bookmarksContext->m_bookmarkList[index].actual_index].type;
        if(file_type == SRV_BRW_BKM_TYPE_DEFAULT_FILE)
        {
            return VFX_TRUE;
        }
        else
        {
            return VFX_FALSE;
        }
    }
    else
    {
        return VFX_FALSE;
    }
}

VcpListMenuCellBaseControl * VappBrowserBookmarksDataProvider::getItemCustomControl(
    VfxU32 index,
    VcpListMenuCellControlLocationTypeEnum location,
    VfxFrame *parentFrame) 
{
    if(!m_isCustomControlNeeded)
    {
        return NULL;
    }
#ifdef __MMI_BRW_BKM_FOLDER_SUPPORT__
    srv_brw_bkm_types_enum file_type = g_srv_brw_cntx.bkm_cntx_p[m_bookmarksContext->m_bookmarkList[index].actual_index].type;
    if(location == VCP_LIST_MENU_CELL_CONTROL_LOCATION_TYPE_TAIL &&
        file_type != SRV_BRW_BKM_TYPE_FOLDER)
#else
	if(location == VCP_LIST_MENU_CELL_CONTROL_LOCATION_TYPE_TAIL)
#endif
    {
        VcpListMenuCmdButton *cmdButton;
        VcpStateImage stateImage;
        stateImage.setImage(IMG_ID_VAPP_BRW_FOLDER_NEXT_LEVEL, IMG_ID_VAPP_BRW_FOLDER_NEXT_LEVEL, 
            IMG_ID_VAPP_BRW_FOLDER_NEXT_LEVEL, IMG_ID_VAPP_BRW_FOLDER_NEXT_LEVEL);
        VFX_OBJ_CREATE_EX(cmdButton, VcpListMenuCmdButton, parentFrame, (stateImage));
        return (VcpListMenuCellBaseControl*)cmdButton;
    }
    return NULL;
}


VfxU32 VappBrowserRecentPageDataProvider::getGroupCount() const
{
    return ((VfxU32)(m_groupCount));
}

VfxU32 VappBrowserRecentPageDataProvider::getCount(VfxU32 group) const
{
    if(m_actualGroup[group] == RECENT_PAGES_GROUP_TODAY)
    {
        return (m_todaysRecentPageCount);
    }
    else if(m_actualGroup[group] == RECENT_PAGES_GROUP_YESTERDAY)
    {
        return (m_yesterdaysRecentPageCount);
    }
    else if(m_actualGroup[group] == RECENT_PAGES_GROUP_DAY_BEFORE_YESTERDAY)
    {
        return (m_beforeYesterdaysRecentPageCount);
    }
    else
    {
        return 0;
    }
}


void VappBrowserRecentPageDataProvider::updateGroupCount()
{
    VfxU8 index = 0;
    setTodaysCount(srv_brw_get_recent_pages_count_by_day(SRV_BRW_RECENT_PAGES_DAY_TODAY));
    setYesterdaysCount(srv_brw_get_recent_pages_count_by_day(SRV_BRW_RECENT_PAGES_DAY_YESTERDAY));
    setBeforeYesterdaysCount(srv_brw_get_recent_pages_count_by_day(SRV_BRW_RECENT_PAGES_DAY_BEFORE_YESTERDAY));
    m_groupCount = 0;
    if(getTodaysCount() > 0)
    {
        m_actualGroup[index++] = RECENT_PAGES_GROUP_TODAY;
        m_groupCount++;
    }

    if(getYesterdaysCount() > 0)
    {
        m_actualGroup[index++] = RECENT_PAGES_GROUP_YESTERDAY;
        m_groupCount++;
    }

    if(getBeforeYesterdaysCount() > 0)
    {
        m_actualGroup[index++] = RECENT_PAGES_GROUP_DAY_BEFORE_YESTERDAY;
        m_groupCount++;
    }
}

VfxBool VappBrowserRecentPageDataProvider::getItemText(
    VcpMenuPos pos,
    VcpListMenuFieldEnum fieldType,
    VfxWString &text,
    VcpListMenuTextColorEnum &color
    )
{
	switch(m_actualGroup[pos.group])
	{
        case RECENT_PAGES_GROUP_TODAY:
        {
            if(pos.pos == -1)
            {
                text.loadFromRes(STR_ID_VAPP_BRW_TODAY);
            }
            else
            {
                VfxWChar *textBuff = text.lockBuf((SRV_BRW_MAX_TITLE_LENGTH + 1) *ENCODING_LENGTH);
                mmi_chset_utf8_to_ucs2_string((U8*)textBuff, 
                    (SRV_BRW_MAX_TITLE_LENGTH + 1) * ENCODING_LENGTH, 
                    (U8*) srv_brw_recent_pages_list_get_item((S32)pos.pos));
                text.unlockBuf();
            }
            break;
        }

        case RECENT_PAGES_GROUP_YESTERDAY:
        {
            if(pos.pos == -1)
            {
                text.loadFromRes(STR_ID_VAPP_BRW_YESTERDAY);
            }
            else
            {
                VfxWChar *textBuff = text.lockBuf((SRV_BRW_MAX_TITLE_LENGTH + 1) *ENCODING_LENGTH);
                mmi_chset_utf8_to_ucs2_string((U8*)textBuff, 
                    (SRV_BRW_MAX_TITLE_LENGTH + 1) * ENCODING_LENGTH, 
                    (U8*) srv_brw_recent_pages_list_get_item((S32)(m_todaysRecentPageCount + pos.pos)));
                text.unlockBuf();
            }
            break;
        }

        case RECENT_PAGES_GROUP_DAY_BEFORE_YESTERDAY:
        {
            if(pos.pos == -1)
            {
                text.loadFromRes(STR_ID_VAPP_BRW_DAY_BEFORE_YESTERDAY);
            }
            else
            {
                VfxWChar *textBuff = text.lockBuf((SRV_BRW_MAX_TITLE_LENGTH + 1) *ENCODING_LENGTH);
                mmi_chset_utf8_to_ucs2_string((U8*)textBuff, 
                    (SRV_BRW_MAX_TITLE_LENGTH + 1) * ENCODING_LENGTH, 
                    (U8*) srv_brw_recent_pages_list_get_item((S32)(m_todaysRecentPageCount +m_yesterdaysRecentPageCount + pos.pos)));
                text.unlockBuf();
            }
            break;
        }
    }
    return VFX_TRUE;
}

VfxU32 VappBrowserRecentPageDataProvider::getActualRecentPageIndex(VcpMenuPos &pos)
{
    if(m_actualGroup[pos.group] == RECENT_PAGES_GROUP_TODAY)
    {
        return (VfxU32)srv_brw_recent_page_get_actual_index(pos.pos);
    }
    else if(m_actualGroup[pos.group] ==RECENT_PAGES_GROUP_YESTERDAY )
    {
        return (VfxU32)srv_brw_recent_page_get_actual_index(getTodaysCount() + pos.pos);
    }
    else
    {
        return (VfxU32)srv_brw_recent_page_get_actual_index(getTodaysCount() + getYesterdaysCount() + pos.pos);
    }
}


#ifdef __MMI_BRW_STORED_PAGES_SUPPORT__
VfxBool VappBrowserStoredPageDataProvider::getItemText(
    VfxU32 index,
    VcpListMenuFieldEnum fieldType,
    VfxWString &text,
    VcpListMenuTextColorEnum &color
    )
{
	if((VfxU32) srv_brw_get_stored_page_list_count())
	{
        VfxWChar *textBuff = text.lockBuf((SRV_BRW_MAX_TITLE_LENGTH + 1) *ENCODING_LENGTH);
        mmi_chset_utf8_to_ucs2_string((U8*)textBuff, 
            (SRV_BRW_MAX_TITLE_LENGTH + 1) * ENCODING_LENGTH, 
            (U8*) srv_brw_stored_pages_list_get_item((S32)index));
        text.unlockBuf();
	}
    return VFX_TRUE;
}

VfxBool VappBrowserStoredPageDataProvider::getItemImage(
    VfxU32 index,
    VcpListMenuFieldEnum fieldType,
    VfxImageSrc &image
        )
 {
    if(fieldType == VCP_LIST_MENU_FIELD_CMD_BUT_IMG_NORMAL)
    {
        image.setResId(IMG_ID_VAPP_BRW_FOLDER_NEXT_LEVEL);
    }
    return VFX_TRUE;
 }

VcpListMenuItemStateEnum VappBrowserStoredPageDataProvider::getItemState(
    VfxU32 index
    ) const
{
    if(m_selectedListInfo[index] == 0)
    {
        return VCP_LIST_MENU_ITEM_STATE_UNSELECTED;
    }
    else
    {
        return VCP_LIST_MENU_ITEM_STATE_SELECTED;
    }
}
#endif

#ifdef __MMI_BRW_BKM_FOLDER_SUPPORT__
U32 VappBrowserFoldersDataProvider::initialize(VfxWString &selFolderName)
{
	#ifdef __MMI_BRW_BKM_FOLDER_SUPPORT__
    VfxU8 index, array_index = 0, temp_array_count = 0, select_index = 0;
    srv_brw_bkm_bookmark_context_struct *bkm_cntx_ptr = g_srv_brw_cntx.bkm_cntx_p;
    for(index = 0; index < SRV_BRW_BKM_MAX_COUNT; index++)
    {
        if(bkm_cntx_ptr[index].type == SRV_BRW_BKM_TYPE_FOLDER)
        {
            m_bookmarkFolderList[array_index].actual_index = index;
            array_index++;
            temp_array_count++;
            if(!selFolderName.isEmpty() && m_selectedIndex == SRV_BRW_ROOT_PARENT_INDEX)
            {
                VfxWChar *sel_folder_name;
                VFX_ALLOC_MEM(sel_folder_name, ((SRV_BRW_BKM_MAX_FILE_NAME_LEN + 1)*ENCODING_LENGTH), this);
                memset(sel_folder_name, 0, (SRV_BRW_BKM_MAX_FILE_NAME_LEN + 1)*ENCODING_LENGTH);
                mmi_chset_utf8_to_ucs2_string((U8*)sel_folder_name, 
                    (SRV_BRW_BKM_MAX_FILE_NAME_LEN + 1) * ENCODING_LENGTH, 
                    (U8*) bkm_cntx_ptr[index].title);
                if(!mmi_ucs2cmp((CHAR*)sel_folder_name, (const CHAR*) selFolderName.getBuf()))
                {
                    m_selectedIndex = index;
					select_index = array_index;
                }
                VFX_FREE_MEM(sel_folder_name);
            }
        }
    }
    if(temp_array_count > 0)
    {
        srv_brw_bookmark_sort_bookmark_list(m_bookmarkFolderList, 0, temp_array_count - 1);
    }
    m_folderCount = temp_array_count;
	return select_index;
	#endif
}

VcpListMenuItemStateEnum VappBrowserFoldersDataProvider::getItemState(
    VfxU32 index
    ) const
{
    if(index == 0)
    {
        if(m_selectedIndex == SRV_BRW_ROOT_PARENT_INDEX)
        {
            return VCP_LIST_MENU_ITEM_STATE_SELECTED;
        }
        else
        {
            return VCP_LIST_MENU_ITEM_STATE_UNSELECTED;
        }
    }
    else
    {
        if(m_bookmarkFolderList[index - 1].actual_index == m_selectedIndex)
        {
            return VCP_LIST_MENU_ITEM_STATE_SELECTED;
        }
        else
        {
            return VCP_LIST_MENU_ITEM_STATE_UNSELECTED;
        }
    }
}

VfxBool VappBrowserFoldersDataProvider::getItemText(
    VfxU32 index,
    VcpListMenuFieldEnum fieldType,
    VfxWString &text,
    VcpListMenuTextColorEnum &color
    )
{
    if(fieldType == VCP_LIST_MENU_FIELD_TEXT)
    {
        if(index == 0)
        {
            text.loadFromRes(STR_ID_VAPP_BRW_BOOKMARKS);
        }
        else
        {
            VfxWChar *textPtr = text.lockBuf(128);
            mmi_chset_utf8_to_ucs2_string((kal_uint8*) textPtr, (SRV_BRW_BKM_MAX_FILE_NAME_LEN + 1)*ENCODING_LENGTH, (kal_uint8*) g_srv_brw_cntx.bkm_cntx_p[m_bookmarkFolderList[index - 1].actual_index].title);
            text.unlockBuf();
        }
    }
    return VFX_TRUE;
}


VfxBool VappBrowserFoldersDataProvider::getItemTextFrameFormat(
    VfxU32 index,                   // [IN] the index of item
    VcpListMenuFieldEnum fieldType, // [IN] the type of the field in the cell
    VfxTextFrame *frame             // [OUT] the text frame
    ) 
{
    if (index != 0)
    {
        frame->setMargins(FOLDER_INDENTATION_SIZE,0,0,0);
        return VFX_TRUE;
    }
    else
    {
        return VFX_FALSE;
    }
}
#endif

VFX_IMPLEMENT_CLASS("VappBrowserFavouritesPage", VappBrowserFavouritesPage, VcpTabCtrlPage);
void VappBrowserFavouritesPage::onInit()
{
    VcpTabCtrlPage::onInit();
    addTab(VAPP_BRW_FAVOURITES_TAB_BOOKMARKS, VFX_WSTR_RES(STR_ID_VAPP_BRW_BOOKMARKS), VcpStateImage(IMG_ID_VAPP_BRW_TITLEBAR_BOOKMARKS));
	#ifdef __MMI_BRW_STORED_PAGES_SUPPORT__
    addTab(VAPP_BRW_FAVOURITES_TAB_STORED_PAGES, VFX_WSTR_RES(STR_ID_VAPP_BRW_STORED_PAGES), VcpStateImage(IMG_ID_VAPP_BRW_TITLEBAR_SAVED_PAGES));    
	#endif
	#ifndef __MMI_BRW_SLIM__
    addTab(VAPP_BRW_FAVOURITES_TAB_RECENT_PAGES, VFX_WSTR_RES(STR_ID_VAPP_BRW_RECENT_PAGES), VcpStateImage(IMG_ID_VAPP_BRW_TITLEBAR_HISTORY));
	#endif
	setBookmarksListAvailability(VFX_TRUE);
    if (getAllListAvailability())
    {
        showPage();
    }
    else
    {
        VFX_OBJ_CREATE(m_popup,VcpIndicatorPopup,this);
        m_popup->setInfoType(VCP_INDICATOR_POPUP_STYLE_ACTIVITY);
        m_popup->setText(VFX_WSTR_RES(STR_ID_VAPP_BRW_PLEASE_WAIT));
        m_popup->setAutoDestory(VFX_FALSE);
        m_popup->show(VFX_TRUE);
        requestListData();
    }
}

void VappBrowserFavouritesPage::onDeinit()
{
#ifndef __MMI_BRW_SLIM__
    if(m_recentPageTabPage)
    {
        VFX_OBJ_CLOSE(m_recentPageTabPage);
    }
#endif
    if(g_srv_brw_cntx.brw_instance_id > 0)
    {
        srv_brw_dynamic_list_free_memory(SRV_BRW_LIST_TYPE_RECENT_PAGES_LIST);
        srv_brw_dynamic_list_free_memory(SRV_BRW_LIST_TYPE_DYNAMIC_LIST);                
    }
	#ifdef __MMI_BRW_STORED_PAGES_SUPPORT__
    if(m_storedPageTabPage)
    {
        VFX_OBJ_CLOSE(m_storedPageTabPage);
    }
	#endif
    if(m_bookmarksTabPage)
    {
        VFX_OBJ_CLOSE(m_bookmarksTabPage);
    }
    VfxPage::onDeinit(); 
}
void VappBrowserFavouritesPage::showPage()
{
    setCurrTab(m_selectedTab);
}


void VappBrowserFavouritesPage::requestListData()
{
	#ifdef __MMI_BRW_STORED_PAGES_SUPPORT__
    if(!m_isStoredPagesListAvailable)
    {
        getStoredPageListData();
    }
	#endif
	#ifndef __MMI_BRW_SLIM__
    if(!m_isRecentPagesListAvailable)
    {
        getRecentPageListData();
    }
	#endif
}
#ifdef __MMI_BRW_STORED_PAGES_SUPPORT__

void VappBrowserFavouritesPage::getStoredPageListData()
{
    srv_brw_act_req_struct obj = {0};
    obj.rsp_callback = VappBrwServiceInterface::getStoredPageListHdlr;
    ((VappBrwServiceInterface *)VFX_OBJ_GET_INSTANCE(VappBrwServiceInterface))->m_getStoredPagesListCallback.connect(this , &VappBrowserFavouritesPage::storedPageListDataReceiveCallback);
    srv_brw_get_stored_pages_list_start_req(&obj);
}

void VappBrowserFavouritesPage::storedPageListDataReceiveCallback(S32 userData, U32 result, void *data)
{
    setStoredPageListAvailability(VFX_TRUE);
    if(getAllListAvailability())
    {
        if(m_storedPageTabPage)
        {
            m_storedPageTabPage->m_storedPagesList->updateAllItems();
        }
        else
        {
            showPage();
        }
        m_popup->hide(VFX_TRUE);
        VFX_OBJ_CLOSE(m_popup);
    }
    ((VappBrwServiceInterface *)VFX_OBJ_GET_INSTANCE(VappBrwServiceInterface))->m_getStoredPagesListCallback.disconnect(this , &VappBrowserFavouritesPage::storedPageListDataReceiveCallback);
}
#endif
void VappBrowserFavouritesPage::getRecentPageListData()
{
    srv_brw_act_req_struct obj = {0};
    obj.rsp_callback = VappBrwServiceInterface::getRecentPageListHdlr;
    ((VappBrwServiceInterface *)VFX_OBJ_GET_INSTANCE(VappBrwServiceInterface))->m_getRecentPagesListCallback.connect(this , &VappBrowserFavouritesPage::recentPageListDataReceiveCallback);
    srv_brw_get_recent_pages_list_start_req(&obj);
}

void VappBrowserFavouritesPage::recentPageListDataReceiveCallback(S32 userData, U32 result, void *data)
{
	#ifndef __MMI_BRW_SLIM__
    setRecentPageListAvailability(VFX_TRUE);
	#endif
    srv_brw_create_recent_page_list();
    if(getAllListAvailability())
    {
    #ifndef __MMI_BRW_SLIM__
        if(m_recentPageTabPage)
        {
            m_recentPageTabPage->m_recentPagesList->updateAllItems();
        }
        else
	#endif
        {
            showPage();
        }
        m_popup->hide(VFX_TRUE);
        VFX_OBJ_CLOSE(m_popup);
    }
    ((VappBrwServiceInterface *)VFX_OBJ_GET_INSTANCE(VappBrwServiceInterface))->m_getRecentPagesListCallback.disconnect(this , &VappBrowserFavouritesPage::recentPageListDataReceiveCallback);
}

#ifndef __MMI_BRW_SLIM__
VfxPage* VappBrowserFavouritesPage::showRecentPagesList()
{
    VFX_OBJ_CREATE(m_recentPageTabPage, VappBrowserRecentPage, this);
    return ((VfxPage*)m_recentPageTabPage);
}
#endif

#ifdef __MMI_BRW_STORED_PAGES_SUPPORT__
VfxPage* VappBrowserFavouritesPage::showStoredPagesList()
{
    VFX_OBJ_CREATE(m_storedPageTabPage, VappBrowserStoredPage, this);
    return ((VfxPage*)m_storedPageTabPage);
}
#endif
VfxPage* VappBrowserFavouritesPage::showBookmarksList()
{
    VFX_OBJ_CREATE(m_bookmarksTabPage, VappBrowserBookmarkPage, this);
    return ((VfxPage*)m_bookmarksTabPage);
}

#ifndef __MMI_BRW_SLIM__

void VappBrowserRecentPage::onInit(void)
{
    VfxPage::onInit();
    VFX_OBJ_CREATE(m_recentPagesList, VcpGroupListMenu, this);
    VFX_OBJ_CREATE(m_recentPageContentProvider, VappBrowserRecentPageDataProvider, this);
    m_recentPageContentProvider->updateGroupCount();
    m_recentPagesList->setContentProvider(m_recentPageContentProvider);
    m_recentPagesList->setCellStyle(VCP_LIST_MENU_CELL_STYLE_SINGLE_TEXT);
    m_recentPagesList->m_signalItemTapped.connect(this, &VappBrowserRecentPage::onItemTap);
    m_recentPagesList->m_signalItemLongTapped.connect(this, &VappBrowserRecentPage::onItemLongTapped);
    VFX_OBJ_CREATE(m_toolBar, VcpToolBar, this);
    m_toolBar->addItem(FAVOURITES_RECENT_PAGES_CLEAR, VFX_WSTR_RES(STR_GLOBAL_CLEAR), VCP_IMG_TOOL_BAR_COMMON_ITEM_CLEAR);
    m_toolBar->m_signalButtonTap.connect(this, &VappBrowserRecentPage::onTBClick);
    updateTBState();
    setBottomBar(m_toolBar);
    VfxRect page_rect = getRect();
    m_recentPagesList->setRect(0, 0, page_rect.size.width, page_rect.size.height );
    m_recentPagesList->setAlignParent(VFX_FRAME_ALIGNER_MODE_SIDE, VFX_FRAME_ALIGNER_MODE_SIDE, 
        VFX_FRAME_ALIGNER_MODE_SIDE, VFX_FRAME_ALIGNER_MODE_SIDE);
}


void VappBrowserRecentPage::updateTBState(void)
{
    m_toolBar->setDisableItem(FAVOURITES_RECENT_PAGES_CLEAR, (VfxBool)(!(m_recentPageContentProvider->getGroupCount() > 0)));
}

void VappBrowserRecentPage::onItemTap(VcpGroupListMenu *sender, VcpMenuPos pos)
{
    selectedRecentPageIndex = m_recentPageContentProvider->getActualRecentPageIndex(pos);
        srv_brw_load_recent_page_req(selectedRecentPageIndex);
        getMainScr()->popPage();
    }

void VappBrowserRecentPage::wifiBearerCallback(VfxU32 state, VfxU32 errorCause)
{
    if(state == SRV_CBM_ACTIVATED)
    {
        ((VappBrwServiceInterface *)VFX_OBJ_GET_INSTANCE(VappBrwServiceInterface))->m_setProfileCallback.connect(this , &VappBrowserRecentPage::launchUrlCallback);
    }
    else
    {
        if(errorCause != ABM_E_REJECTED)
        {
            VappBrowserUtility::displayPopup(
                STR_ID_VAPP_BRW_CONNECTION_FAILED,
                MMI_NMGR_BALLOON_TYPE_FAILURE,
			    MMI_EVENT_INFO_BALLOON);
        }
        VFX_OBJ_CLOSE(m_popup);
    }
    ((VappBrwServiceInterface *)VFX_OBJ_GET_INSTANCE(VappBrwServiceInterface))->m_WifiBearerCallback.disconnect(this , &VappBrowserRecentPage::wifiBearerCallback);
}

void VappBrowserRecentPage::launchUrlCallback(void)
{
    ((VappBrwServiceInterface *)VFX_OBJ_GET_INSTANCE(VappBrwServiceInterface))->m_setProfileCallback.disconnect(this , &VappBrowserRecentPage::launchUrlCallback);
    srv_brw_load_recent_page_req(selectedRecentPageIndex);
    VFX_OBJ_CLOSE(m_popup);
    getMainScr()->popPage();
}

void VappBrowserRecentPage::onItemLongTapped(VcpGroupListMenu *sender, VcpMenuPos pos)
{
    VfxWString itemText;
    sender->getItemTextIfPresent(pos, VCP_LIST_MENU_FIELD_TEXT, itemText);
    VFX_OBJ_CREATE(m_contextMenu, VcpMenuPopup, this);
    m_contextMenu->setTitle(itemText);
    m_contextMenu->addItem(COMMAND_LONG_TAP_DELETE, VFX_WSTR_RES(STR_GLOBAL_DELETE));
    m_contextMenu->m_signalMenuCallback.connect(this, &VappBrowserRecentPage::contextMenuCallack);
    m_contextMenu->show(VFX_TRUE);
    selectedRecentPageIndex = m_recentPageContentProvider->getActualRecentPageIndex(pos);
    vfx_adp_touch_fb_play(VFX_ADP_TOUCH_FB_TYPE_HOLD);

}

void VappBrowserRecentPage::contextMenuCallack(VcpMenuPopup *menu, VcpMenuPopupEventEnum event, VcpMenuPopupItem *item)
{
    if(event == VCP_MENU_POPUP_EVENT_ITEM_SELECTED)
    {
        VcpConfirmPopup *confirmPopup;
        confirmPopup = VappBrowserUtility::displayDeleteConfirmPopup(this, VCP_POPUP_TYPE_WARNING,
            VFX_WSTR_RES(STR_ID_VAPP_BRW_DELETE_HISTORY_CONFIRM),
            VFX_WSTR_RES(STR_GLOBAL_DELETE));
        confirmPopup->m_signalButtonClicked.connect(this, &VappBrowserRecentPage::recentpageDeleteHandler);
    }
}

void VappBrowserRecentPage::recentpageDeleteHandler(VfxObject* obj, VfxId id)
{
    if (id == VCP_CONFIRM_POPUP_BUTTON_USER_1)
    {
        srv_brw_act_req_struct obj = {0};
        srv_brw_list_element_req_struct data;
        obj.rsp_callback = &VappBrwServiceInterface::deleteRecentPageHdlr;
        ((VappBrwServiceInterface *)VFX_OBJ_GET_INSTANCE(VappBrwServiceInterface))->m_deleteRecentPageCallback.connect(this , &VappBrowserRecentPage::clearRecentPageCallback);
        data.index = selectedRecentPageIndex;
        obj.req_data = (void*)&data;
        srv_brw_delete_recent_page_req(&obj);
        VFX_OBJ_CREATE(m_popup,VcpIndicatorPopup,this);
        m_popup->setInfoType(VCP_INDICATOR_POPUP_STYLE_ACTIVITY);
        m_popup->setText(VFX_WSTR_RES(STR_ID_VAPP_BRW_PLEASE_WAIT));
        m_popup->setAutoDestory(VFX_FALSE);
        m_popup->show(VFX_TRUE);
    }
}

void VappBrowserRecentPage::onTBClick(VfxObject* sender, VfxId id)
{
    switch(id)
    {
        case FAVOURITES_RECENT_PAGES_CLEAR:
        {
            VFX_OBJ_CREATE(m_commandPopup, VcpCommandPopup, this);
            m_commandPopup->setInfoType(VCP_POPUP_TYPE_QUESTION);
            m_commandPopup->setText(VFX_WSTR_RES(STR_ID_VAPP_BRW_CLEAR_HISTORY));
            m_commandPopup->addItem(COMMAND_CLEAR_TODAYS, VFX_WSTR_RES(STR_ID_VAPP_BRW_TODAY));
            m_commandPopup->addItem(COMMAND_CLEAR_LAST_TWO_DAYS, VFX_WSTR_RES(STR_ID_VAPP_BRW_LAST_TWO_DAYS));
            m_commandPopup->addItem(COMMAND_CLEAR_ALL, VFX_WSTR_RES(STR_ID_VAPP_BRW_CLEAR_ALL));
            m_commandPopup->addItem(COMMAND_CLEAR_CANCEL, VFX_WSTR_RES(STR_GLOBAL_CANCEL), VCP_POPUP_BUTTON_TYPE_CANCEL);
            if(m_recentPageContentProvider->getTodaysCount() == 0)
            {
                m_commandPopup->disableItem(COMMAND_CLEAR_TODAYS);
                if(m_recentPageContentProvider->getYesterdaysCount() == 0)
                {
                    m_commandPopup->disableItem(COMMAND_CLEAR_LAST_TWO_DAYS);
                    if(m_recentPageContentProvider->getBeforeYesterdaysCount() == 0)
                    {
                        m_commandPopup->disableItem(COMMAND_CLEAR_ALL);
                    }
                }
            }
            m_commandPopup->show(VFX_TRUE);
            m_commandPopup->m_signalButtonClicked.connect(this, &VappBrowserRecentPage::onCommandCallClick);
            break;
        }
        default:
            break;
	}
}

void VappBrowserRecentPage::onCommandCallClick(VfxObject *obj, VfxId id)
{
    switch(id)
    {
        case COMMAND_CLEAR_TODAYS:
        {
            VcpConfirmPopup *m_confirmPopup;
            m_confirmPopup = VappBrowserUtility::displayDeleteConfirmPopup(this, VCP_POPUP_TYPE_WARNING,
                VFX_WSTR_RES(STR_ID_VAPP_BRW_CLEAR_TODAYS_CONFIRMATION),
                VFX_WSTR_RES(STR_GLOBAL_CLEAR));
            m_confirmPopup->m_signalButtonClicked.connect(this, &VappBrowserRecentPage::clearTodaysEventHandler);
            break;
        }

        case COMMAND_CLEAR_LAST_TWO_DAYS:
        {
            VcpConfirmPopup *m_confirmPopup;
            m_confirmPopup = VappBrowserUtility::displayDeleteConfirmPopup(this, VCP_POPUP_TYPE_WARNING,
                VFX_WSTR_RES(STR_ID_VAPP_BRW_CLEAR_TWO_DAYS_CONFIRMATION),
                VFX_WSTR_RES(STR_GLOBAL_CLEAR));
            m_confirmPopup->m_signalButtonClicked.connect(this, &VappBrowserRecentPage::clearTwoDaysEventHandler);
            break;
        }

        case COMMAND_CLEAR_ALL:
        {
            VcpConfirmPopup *m_confirmPopup;
            m_confirmPopup = VappBrowserUtility::displayDeleteConfirmPopup(this, VCP_POPUP_TYPE_WARNING,
                VFX_WSTR_RES(STR_ID_VAPP_BRW_CLEAR_ALL_CONFIRMATION),
                VFX_WSTR_RES(STR_GLOBAL_CLEAR));
            m_confirmPopup->m_signalButtonClicked.connect(this, &VappBrowserRecentPage::clearAllEventHandler);
            break;
        }

        default:
            break;
	}
}

void VappBrowserRecentPage::clearTodaysEventHandler(VfxObject* obj, VfxId id)
{
    if (id == VCP_CONFIRM_POPUP_BUTTON_USER_1)
    {
        srv_brw_act_req_struct obj = {0};
        obj.rsp_callback = &VappBrwServiceInterface::deleteRecentPageHdlr;
        ((VappBrwServiceInterface *)VFX_OBJ_GET_INSTANCE(VappBrwServiceInterface))->m_deleteRecentPageCallback.connect(this , &VappBrowserRecentPage::clearRecentPageCallback);
        srv_brw_delete_recent_page_by_day_req(SRV_BRW_RECENT_PAGES_DELETE_TODAYS, &obj);
        VFX_OBJ_CREATE(m_popup,VcpIndicatorPopup,this);
        m_popup->setInfoType(VCP_INDICATOR_POPUP_STYLE_ACTIVITY);
        m_popup->setText(VFX_WSTR_RES(STR_ID_VAPP_BRW_PLEASE_WAIT));
        m_popup->setAutoDestory(VFX_FALSE);
        m_popup->show(VFX_TRUE);
    }
}

void VappBrowserRecentPage::clearTwoDaysEventHandler(VfxObject* obj, VfxId id)
{
    if (id == VCP_CONFIRM_POPUP_BUTTON_USER_1)
    {
        srv_brw_act_req_struct obj = {0};
        obj.rsp_callback = &VappBrwServiceInterface::deleteRecentPageHdlr;
        ((VappBrwServiceInterface *)VFX_OBJ_GET_INSTANCE(VappBrwServiceInterface))->m_deleteRecentPageCallback.connect(this , &VappBrowserRecentPage::clearRecentPageCallback);
        srv_brw_delete_recent_page_by_day_req(SRV_BRW_RECENT_PAGES_DELETE_LAST_TWO_DAYS, &obj);
        VFX_OBJ_CREATE(m_popup,VcpIndicatorPopup,this);
        m_popup->setInfoType(VCP_INDICATOR_POPUP_STYLE_ACTIVITY);
        m_popup->setText(VFX_WSTR_RES(STR_ID_VAPP_BRW_PLEASE_WAIT));
        m_popup->setAutoDestory(VFX_FALSE);
        m_popup->show(VFX_TRUE);
    }
}

void VappBrowserRecentPage::clearAllEventHandler(VfxObject* obj, VfxId id)
{
    if (id == VCP_CONFIRM_POPUP_BUTTON_USER_1)
    {
        srv_brw_act_req_struct obj = {0};
        obj.rsp_callback = &VappBrwServiceInterface::deleteRecentPageHdlr;
        ((VappBrwServiceInterface *)VFX_OBJ_GET_INSTANCE(VappBrwServiceInterface))->m_deleteRecentPageCallback.connect(this , &VappBrowserRecentPage::clearRecentPageCallback);
        srv_brw_delete_all_recent_pages_req(&obj);
        VFX_OBJ_CREATE(m_popup,VcpIndicatorPopup,this);
        m_popup->setInfoType(VCP_INDICATOR_POPUP_STYLE_ACTIVITY);
        m_popup->setText(VFX_WSTR_RES(STR_ID_VAPP_BRW_PLEASE_WAIT));
        m_popup->setAutoDestory(VFX_FALSE);
        m_popup->show(VFX_TRUE);

    }
}

void VappBrowserRecentPage::clearRecentPageCallback(S32 userData, U32 result, void *data)
{
    srv_brw_dynamic_list_free_memory(SRV_BRW_LIST_TYPE_RECENT_PAGES_LIST);
    srv_brw_dynamic_list_free_memory(SRV_BRW_LIST_TYPE_DYNAMIC_LIST);                
    srv_brw_act_req_struct obj = {0};
    obj.rsp_callback = VappBrwServiceInterface::getRecentPageListHdlr;
    ((VappBrwServiceInterface *)VFX_OBJ_GET_INSTANCE(VappBrwServiceInterface))->m_getRecentPagesListCallback.connect(this , &VappBrowserRecentPage::recentPageListDataReceiveCallback);
    ((VappBrwServiceInterface *)VFX_OBJ_GET_INSTANCE(VappBrwServiceInterface))->m_deleteRecentPageCallback.disconnect(this , &VappBrowserRecentPage::clearRecentPageCallback);
    srv_brw_get_recent_pages_list_start_req(&obj);
}

void VappBrowserRecentPage::recentPageListDataReceiveCallback(S32 userData, U32 result, void *data)
{
    srv_brw_create_recent_page_list();
    m_recentPageContentProvider->updateGroupCount();
    m_recentPagesList->resetAllItems(VFX_TRUE);
    updateTBState();
    m_popup->hide(VFX_TRUE);
    VFX_OBJ_CLOSE(m_popup);
}


void VappBrowserRecentPage::onDeinit(void)
{
    VFX_OBJ_CLOSE(m_recentPagesList);
    VFX_OBJ_CLOSE(m_recentPageContentProvider);
    VFX_OBJ_CLOSE(m_toolBar);
    VfxPage::onDeinit(); 
}


void VappBrowserRecentPage::onQueryRotateEx(VfxScreenRotateParam & param)
{
	if(param.rotateTo == VFX_SCR_ROTATE_TYPE_0 || param.rotateTo == VFX_SCR_ROTATE_TYPE_270 || param.rotateTo == VFX_SCR_ROTATE_TYPE_90) 
	{
				
	}
	else
	{
		param.rotateTo = VFX_SCR_ROTATE_TYPE_NORMAL;
	}
}
#endif

#ifdef __MMI_BRW_STORED_PAGES_SUPPORT__
void VappBrowserStoredPage::onInit(void)
{
    VfxPage::onInit();
    VFX_OBJ_CREATE(m_storedPagesList, VcpListMenu, this);
    VFX_OBJ_CREATE(m_storedPageContentProvider, VappBrowserStoredPageDataProvider, this);

    m_storedPagesList->setContentProvider(m_storedPageContentProvider);
    //m_storedPagesList->setPos(0,0);
    //m_storedPagesList->setSize(300, 350);
    m_storedPagesList->setCellStyle(VCP_LIST_MENU_CELL_STYLE_SINGLE_TEXT);
    m_storedPagesList->setMenuControlMode(VCP_LIST_MENU_CONTROL_MODE_CMD_BUTTON, VFX_FALSE);
    m_storedPagesList->m_signalItemTapped.connect(this, &VappBrowserStoredPage::onItemTap);
    m_storedPagesList->m_signalCmdButtonClicked.connect(this, &VappBrowserStoredPage::onButtonClick);
    m_storedPagesList->m_signalItemLongTapped.connect(this, &VappBrowserStoredPage::onItemLongTapped);
    m_storedPagesList->m_signalItemSelectionStateChanged.connect(this, &VappBrowserStoredPage::onSelectionChanged);

	mySetBottomBar();
   
    VfxRect page_rect = getRect();
    m_storedPagesList->setRect(0, 0, page_rect.size.width, page_rect.size.height );
    m_storedPagesList->setAlignParent(VFX_FRAME_ALIGNER_MODE_SIDE, VFX_FRAME_ALIGNER_MODE_SIDE, 
        VFX_FRAME_ALIGNER_MODE_SIDE, VFX_FRAME_ALIGNER_MODE_SIDE);
}

void VappBrowserStoredPage::mySetBottomBar()
{
    VFX_OBJ_CREATE(m_toolBar, VcpToolBar, this);
    m_toolBar->addItem(FAVOURITES_STORED_PAGES_DELETE, VFX_WSTR_RES(STR_GLOBAL_DELETE), VCP_IMG_TOOL_BAR_COMMON_ITEM_DELETE);
    m_toolBar->m_signalButtonTap.connect(this, &VappBrowserStoredPage::onTBClick);
    setBottomBar(m_toolBar);
    updateTBState();
}

void VappBrowserStoredPage::onItemTap(VcpListMenu *sender, VfxU32 index)
{
#ifdef __MMI_USB_SUPPORT__
    if(srv_usb_is_in_mass_storage_mode())
    {
        vapp_usb_unavailable_popup(0);
    }
    else
#endif
    {
        selectedStoredPageIndex = index;
            srv_brw_load_stored_page_req(selectedStoredPageIndex);
            getMainScr()->popPage();
        }
    }

void VappBrowserStoredPage::wifiBearerCallback(VfxU32 state, VfxU32 errorCause)
{
    if(state == SRV_CBM_ACTIVATED)
    {
        ((VappBrwServiceInterface *)VFX_OBJ_GET_INSTANCE(VappBrwServiceInterface))->m_setProfileCallback.connect(this , &VappBrowserStoredPage::launchUrlCallback);
    }
    else
    {
        if(errorCause != ABM_E_REJECTED)
        {
            VappBrowserUtility::displayPopup(
                STR_ID_VAPP_BRW_CONNECTION_FAILED,
                MMI_NMGR_BALLOON_TYPE_FAILURE,
			    MMI_EVENT_INFO_BALLOON);
        }
        VFX_OBJ_CLOSE(m_popup);
    }
    ((VappBrwServiceInterface *)VFX_OBJ_GET_INSTANCE(VappBrwServiceInterface))->m_WifiBearerCallback.disconnect(this , &VappBrowserStoredPage::wifiBearerCallback);
}

void VappBrowserStoredPage::launchUrlCallback(void)
{
    ((VappBrwServiceInterface *)VFX_OBJ_GET_INSTANCE(VappBrwServiceInterface))->m_setProfileCallback.disconnect(this , &VappBrowserStoredPage::launchUrlCallback);
    srv_brw_load_stored_page_req(selectedStoredPageIndex);
    VFX_OBJ_CLOSE(m_popup);
    getMainScr()->popPage();
}

void VappBrowserStoredPage::onItemLongTapped(VcpListMenu *sender, VfxU32 index)
{
#ifdef __MMI_USB_SUPPORT__
    if(srv_usb_is_in_mass_storage_mode())
    {
        return;
    }
#endif
    VfxWString itemText;
    sender->getItemTextIfPresent(index, VCP_LIST_MENU_FIELD_TEXT, itemText);
    VFX_OBJ_CREATE(m_contextMenu, VcpMenuPopup, this);
    m_contextMenu->setTitle(itemText);
    m_contextMenu->addItem(COMMAND_LONG_TAP_DELETE, VFX_WSTR_RES(STR_GLOBAL_DELETE));
    m_contextMenu->m_signalMenuCallback.connect(this, &VappBrowserStoredPage::contextMenuCallack);
    m_contextMenu->show(VFX_TRUE);
    selectedStoredPageIndex = index;
    vfx_adp_touch_fb_play(VFX_ADP_TOUCH_FB_TYPE_HOLD);
}

void VappBrowserStoredPage::contextMenuCallack(VcpMenuPopup *menu, VcpMenuPopupEventEnum event, VcpMenuPopupItem *item)
{
    if(event == VCP_MENU_POPUP_EVENT_ITEM_SELECTED)
    {
    #ifdef __MMI_USB_SUPPORT__
        if(srv_usb_is_in_mass_storage_mode())
        {
            vapp_usb_unavailable_popup(0);
            return;
        }
    #endif
        VcpConfirmPopup *confirmPopup;
        confirmPopup = VappBrowserUtility::displayDeleteConfirmPopup(this, VCP_POPUP_TYPE_WARNING,
            VFX_WSTR_RES(STR_ID_VAPP_BRW_DELETE_SELECTED_STORED_PAGE),
            VFX_WSTR_RES(STR_GLOBAL_DELETE));
        confirmPopup->m_signalButtonClicked.connect(this, &VappBrowserStoredPage::storedpageDeleteHandler);
    }
}

void VappBrowserStoredPage::storedpageDeleteHandler(VfxObject* obj, VfxId id)
{
    if (id == VCP_CONFIRM_POPUP_BUTTON_USER_1)
    {
    #ifdef __MMI_USB_SUPPORT__
        if(srv_usb_is_in_mass_storage_mode())
        {
            vapp_usb_unavailable_popup(0);
            return;
        }
    #endif
        srv_brw_act_req_struct obj = {0};
        srv_brw_list_element_req_struct data;
        obj.rsp_callback = &VappBrwServiceInterface::deleteStoredPageHdlr;
        ((VappBrwServiceInterface *)VFX_OBJ_GET_INSTANCE(VappBrwServiceInterface))->m_deleteStoredPageCallback.connect(this , &VappBrowserStoredPage::deleteStoredPageCallback);
        data.index = selectedStoredPageIndex;
        obj.req_data = (void*)&data;
        srv_brw_delete_stored_page_req(&obj);
        VFX_OBJ_CREATE(m_popup,VcpIndicatorPopup,this);
        m_popup->setInfoType(VCP_INDICATOR_POPUP_STYLE_ACTIVITY);
        m_popup->setText(VFX_WSTR_RES(STR_ID_VAPP_BRW_PLEASE_WAIT));
        m_popup->setAutoDestory(VFX_FALSE);
        m_popup->show(VFX_TRUE);
    }
}


void VappBrowserStoredPage::deleteStoredPageCallback(S32 userData, U32 result, void *data)
{
    ((VappBrwServiceInterface *)VFX_OBJ_GET_INSTANCE(VappBrwServiceInterface))->m_deleteStoredPageCallback.disconnect(this , &VappBrowserStoredPage::deleteStoredPageCallback);
    srv_brw_dynamic_list_free_memory(SRV_BRW_LIST_TYPE_SAVED_PAGES_LIST);
    srv_brw_act_req_struct obj = {0};
    obj.rsp_callback = ((VappBrwServiceInterface *)VFX_OBJ_GET_INSTANCE(VappBrwServiceInterface))->getStoredPageListHdlr;
    ((VappBrwServiceInterface *)VFX_OBJ_GET_INSTANCE(VappBrwServiceInterface))->m_getStoredPagesListCallback.connect(this , &VappBrowserStoredPage::storedPageListDataReceiveCallback);
    srv_brw_get_stored_pages_list_start_req(&obj);
}

void VappBrowserStoredPage::storedPageListDataReceiveCallback(S32 userData, U32 result, void *data)
{
    m_storedPagesList->resetAllItems(VFX_TRUE);
    updateTBState();
    m_popup->hide(VFX_TRUE);
    VFX_OBJ_CLOSE(m_popup);
    ((VappBrwServiceInterface *)VFX_OBJ_GET_INSTANCE(VappBrwServiceInterface))->m_getStoredPagesListCallback.disconnect(this , &VappBrowserStoredPage::storedPageListDataReceiveCallback);
}


void VappBrowserStoredPage::onButtonClick(VcpListMenu *sender, VfxU32 index)
{
    VappBrowserApp *m_brwApp = ((VappBrowserApp *)VfxAppLauncher::getObject(m_browserAppID));
    VFX_OBJ_CREATE_EX(m_brwApp->scr->m_storedPageDetailsPage, VappBrowserStoredPageDetailsPage, m_brwApp->scr, (index));
    m_brwApp->scr->pushPage(BRW_PAGE_STORED_PAGE_DETAILS, m_brwApp->scr->m_storedPageDetailsPage);
}

void VappBrowserStoredPage::onTBClick(VfxObject* sender, VfxId id)
{
#ifdef __MMI_USB_SUPPORT__
    if(srv_usb_is_in_mass_storage_mode())
    {
        vapp_usb_unavailable_popup(0);
        return;
    }
#endif
    switch(id)
    {
        case FAVOURITES_STORED_PAGES_DELETE:
        {
            m_storedPageContentProvider->m_selectedListInfo = (VfxU8*)VappBrowserASMMemoryMgmt::allocMemory(m_storedPageContentProvider->getCount());
            memset(m_storedPageContentProvider->m_selectedListInfo, 0, m_storedPageContentProvider->getCount());
            m_storedPagesList->setMenuMode(VCP_LIST_MENU_MODE_MULTI_SELECTION, VFX_TRUE);
            m_storedPagesList->resetAllItems(VFX_TRUE);
            m_storedPagesList->setMenuControlMode(VCP_LIST_MENU_CONTROL_MODE_NORMAL, VFX_FALSE);
            m_storedPagesList->m_signalItemTapped.disconnect(this, &VappBrowserStoredPage::onItemTap);
            m_storedPagesList->m_signalCmdButtonClicked.disconnect(this, &VappBrowserStoredPage::onButtonClick);
            m_storedPagesList->m_signalItemLongTapped.disconnect(this, &VappBrowserStoredPage::onItemLongTapped);
            VFX_OBJ_CREATE(m_multiOptionToolBar, VcpToolBar, this);
            m_multiOptionToolBar->addItem(MULTI_OPTION_SELECT_ALL, VFX_WSTR_RES(STR_GLOBAL_MARK_ALL), VCP_IMG_TOOL_BAR_COMMON_ITEM_SELECT_ALL);
            m_multiOptionToolBar->addItem(MULTI_OPTION_DELETE, VFX_WSTR_RES(STR_GLOBAL_DELETE), VCP_IMG_TOOL_BAR_COMMON_ITEM_DELETE);
            m_multiOptionToolBar->setDisableItem(MULTI_OPTION_DELETE, VFX_TRUE);
            m_multiOptionToolBar->addItem(MULTI_OPTION_CANCEL,  VFX_WSTR_RES(STR_GLOBAL_CANCEL), VCP_IMG_TOOL_BAR_COMMON_ITEM_CANCEL);
            m_isSelectAll = VFX_TRUE;
            m_selectedItemsCount = 0;
            m_multiOptionToolBar->m_signalButtonTap.connect(this, &VappBrowserStoredPage::onMultiOptionTBClick);
            setBottomBar(m_multiOptionToolBar);
			if(m_toolBar)
			{
				VFX_OBJ_CLOSE(m_toolBar);
			}
            break;
        }
        default:
            break;
	}
}

void VappBrowserStoredPage::onMultiOptionTBClick(VfxObject* sender, VfxId id)
{
    switch(id)
    {
        case MULTI_OPTION_SELECT_ALL:
            if(m_isSelectAll)
            {
                memset(m_storedPageContentProvider->m_selectedListInfo, 1, m_storedPageContentProvider->getCount());
                m_selectedItemsCount = m_storedPageContentProvider->getCount();
                m_multiOptionToolBar->changeItem(MULTI_OPTION_SELECT_ALL, VFX_WSTR_RES(STR_GLOBAL_UNMARK_ALL), VCP_IMG_TOOL_BAR_COMMON_ITEM_UNSELECT_ALL);
                m_isSelectAll = VFX_FALSE;
            }
            else
            {
                memset(m_storedPageContentProvider->m_selectedListInfo, 0, m_storedPageContentProvider->getCount());
                m_selectedItemsCount = 0;
                m_multiOptionToolBar->changeItem(MULTI_OPTION_SELECT_ALL, VFX_WSTR_RES(STR_GLOBAL_MARK_ALL), VCP_IMG_TOOL_BAR_COMMON_ITEM_SELECT_ALL);
                m_isSelectAll = VFX_TRUE;
            }
            m_storedPagesList->updateAllItems();
            break;

        case MULTI_OPTION_DELETE:
        {
        #ifdef __MMI_USB_SUPPORT__
            if(srv_usb_is_in_mass_storage_mode())
            {
                vapp_usb_unavailable_popup(0);
                return;
            }
        #endif
            VcpConfirmPopup *m_confirmPopup;
            if(m_selectedItemsCount > 1)
            {
                VfxWString deleteConfirmation;
                deleteConfirmation.loadFromRes(STR_ID_VAPP_BRW_DELETE_SELECTED_STORED_PAGES);
                VfxWString deleteConfirmationCount;
                deleteConfirmation += VFX_WSTR_RES(STR_ID_VAPP_BRW_LEFT_BRACKET);
                deleteConfirmationCount.format("%d", m_selectedItemsCount);
                deleteConfirmation += deleteConfirmationCount;
                deleteConfirmation += VFX_WSTR_RES(STR_ID_VAPP_BRW_RIGHT_BRACKET);
                deleteConfirmation += VFX_WSTR_RES(STR_ID_VAPP_BRW_QUESTION_MARK);
                m_confirmPopup = VappBrowserUtility::displayDeleteConfirmPopup(this, VCP_POPUP_TYPE_WARNING,
                    deleteConfirmation,
                    VFX_WSTR_RES(STR_GLOBAL_DELETE));
            }
            else
            {
                m_confirmPopup = VappBrowserUtility::displayDeleteConfirmPopup(this, VCP_POPUP_TYPE_WARNING,
                    VFX_WSTR_RES(STR_ID_VAPP_BRW_DELETE_SELECTED_STORED_PAGE),
                    VFX_WSTR_RES(STR_GLOBAL_DELETE));
            }
            m_confirmPopup->m_signalButtonClicked.connect(this, &VappBrowserStoredPage::multiDeleteEventHandler);
            break;
        }

        case MULTI_OPTION_CANCEL:
            m_storedPagesList->m_signalItemTapped.connect(this, &VappBrowserStoredPage::onItemTap);
            m_storedPagesList->m_signalCmdButtonClicked.connect(this, &VappBrowserStoredPage::onButtonClick);
            m_storedPagesList->m_signalItemLongTapped.connect(this, &VappBrowserStoredPage::onItemLongTapped);
            m_storedPagesList->setMenuMode(VCP_LIST_MENU_MODE_NORMAL, VFX_TRUE);
            m_storedPagesList->setMenuControlMode(VCP_LIST_MENU_CONTROL_MODE_CMD_BUTTON, VFX_FALSE);
            VFX_OBJ_CLOSE(m_multiOptionToolBar);
            m_storedPagesList->resetAllItems(VFX_TRUE);
            VappBrowserASMMemoryMgmt::freeMemory(m_storedPageContentProvider->m_selectedListInfo);
			m_storedPageContentProvider->m_selectedListInfo = NULL;
			mySetBottomBar();
            //setBottomBar(m_toolBar);
            break;

        default:
            break;
	}
}

void VappBrowserStoredPage::multiDeleteEventHandler(VfxObject* obj, VfxId id)
{
    if (id == VCP_CONFIRM_POPUP_BUTTON_USER_1)
    {
    #ifdef __MMI_USB_SUPPORT__
        if(srv_usb_is_in_mass_storage_mode())
        {
            vapp_usb_unavailable_popup(0);
            return;
        }
    #endif
        srv_brw_act_req_struct obj = {0};
        obj.rsp_callback = &VappBrwServiceInterface::deleteStoredPageHdlr;
        ((VappBrwServiceInterface *)VFX_OBJ_GET_INSTANCE(VappBrwServiceInterface))->m_deleteStoredPageCallback.connect(this , &VappBrowserStoredPage::deleteStoredPageCallback);
        srv_brw_delete_multiple_stored_page_req(&obj, (U8*)m_storedPageContentProvider->m_selectedListInfo);
        VFX_OBJ_CREATE(m_popup,VcpIndicatorPopup,this);
        m_popup->setInfoType(VCP_INDICATOR_POPUP_STYLE_ACTIVITY);
        m_popup->setText(VFX_WSTR_RES(STR_ID_VAPP_BRW_PLEASE_WAIT));
        m_popup->setAutoDestory(VFX_FALSE);
        m_popup->show(VFX_TRUE);
        if(m_multiOptionToolBar)
        {
            VFX_OBJ_CLOSE(m_multiOptionToolBar);
            m_storedPagesList->resetAllItems(VFX_TRUE);
            VappBrowserASMMemoryMgmt::freeMemory(m_storedPageContentProvider->m_selectedListInfo);
			m_storedPageContentProvider->m_selectedListInfo = NULL;
            m_storedPagesList->m_signalItemTapped.connect(this, &VappBrowserStoredPage::onItemTap);
            m_storedPagesList->m_signalCmdButtonClicked.connect(this, &VappBrowserStoredPage::onButtonClick);
            m_storedPagesList->m_signalItemLongTapped.connect(this, &VappBrowserStoredPage::onItemLongTapped);
            m_storedPagesList->setMenuMode(VCP_LIST_MENU_MODE_NORMAL, VFX_TRUE);
            m_storedPagesList->setMenuControlMode(VCP_LIST_MENU_CONTROL_MODE_CMD_BUTTON, VFX_FALSE);
            mySetBottomBar();
        }
    }
}

void VappBrowserStoredPage::onSelectionChanged(VcpListMenu *menu, VfxU32 index, VcpListMenuItemStateEnum newState)
{
    if (newState == VCP_LIST_MENU_ITEM_STATE_SELECTED)
    {
        m_storedPageContentProvider->m_selectedListInfo[index] = 1;
        if(m_selectedItemsCount != m_storedPageContentProvider->getCount())
        {
            m_selectedItemsCount++;
        }
    }
    else if(newState == VCP_LIST_MENU_ITEM_STATE_UNSELECTED)
    {
        m_storedPageContentProvider->m_selectedListInfo[index] = 0;
        if(m_selectedItemsCount > 0)
        {
            m_selectedItemsCount--;
        }
    }
    if(m_selectedItemsCount == 0)
    {
        m_multiOptionToolBar->setDisableItem(MULTI_OPTION_DELETE, VFX_TRUE);
        m_multiOptionToolBar->changeItem(MULTI_OPTION_SELECT_ALL, VFX_WSTR_RES(STR_GLOBAL_MARK_ALL), VCP_IMG_TOOL_BAR_COMMON_ITEM_SELECT_ALL);
    }
    else
    {
        if(m_selectedItemsCount == m_storedPageContentProvider->getCount())
        {
            m_multiOptionToolBar->changeItem(MULTI_OPTION_SELECT_ALL, VFX_WSTR_RES(STR_GLOBAL_UNMARK_ALL), VCP_IMG_TOOL_BAR_COMMON_ITEM_UNSELECT_ALL);
            m_isSelectAll = VFX_FALSE;
        }
        else
        {
            m_multiOptionToolBar->changeItem(MULTI_OPTION_SELECT_ALL, VFX_WSTR_RES(STR_GLOBAL_MARK_ALL), VCP_IMG_TOOL_BAR_COMMON_ITEM_SELECT_ALL);
            m_isSelectAll = VFX_TRUE;
        }
        m_multiOptionToolBar->setDisableItem(MULTI_OPTION_DELETE, VFX_FALSE);
    }
}


void VappBrowserStoredPage::onQueryRotateEx(VfxScreenRotateParam & param)
{
	if(param.rotateTo == VFX_SCR_ROTATE_TYPE_0 || param.rotateTo == VFX_SCR_ROTATE_TYPE_270 || param.rotateTo == VFX_SCR_ROTATE_TYPE_90) 
	{
				
	}
	else
	{
		param.rotateTo = VFX_SCR_ROTATE_TYPE_NORMAL;
	}

}


void VappBrowserStoredPage::onBack()
{
    if(m_multiOptionToolBar)
    { 
        m_storedPagesList->m_signalItemTapped.connect(this, &VappBrowserStoredPage::onItemTap);
        m_storedPagesList->m_signalCmdButtonClicked.connect(this, &VappBrowserStoredPage::onButtonClick);
        m_storedPagesList->m_signalItemLongTapped.connect(this, &VappBrowserStoredPage::onItemLongTapped);
        m_storedPagesList->setMenuMode(VCP_LIST_MENU_MODE_NORMAL, VFX_TRUE);
        m_storedPagesList->setMenuControlMode(VCP_LIST_MENU_CONTROL_MODE_CMD_BUTTON, VFX_FALSE);
        VFX_OBJ_CLOSE(m_multiOptionToolBar);
        m_storedPagesList->resetAllItems(VFX_TRUE);
        VappBrowserASMMemoryMgmt::freeMemory(m_storedPageContentProvider->m_selectedListInfo);
		m_storedPageContentProvider->m_selectedListInfo = NULL;
		mySetBottomBar();
        //setBottomBar(m_toolBar);
    }
    else
    {
        VfxPage::onBack();
    }
}

void VappBrowserStoredPage::updateTBState(void)
{
    if(m_storedPageContentProvider->getCount() == 0)
    {
        m_toolBar->setDisableItem(FAVOURITES_STORED_PAGES_DELETE, VFX_TRUE);
    }
    else
    {
        m_toolBar->setDisableItem(FAVOURITES_STORED_PAGES_DELETE, VFX_FALSE);
    }
}

void VappBrowserStoredPage::onDeinit(void)
{
    if(m_multiOptionToolBar)
    {
        VFX_OBJ_CLOSE(m_multiOptionToolBar);
		if(m_storedPageContentProvider->m_selectedListInfo)
		{	
			ASSERT(m_storedPageContentProvider->m_selectedListInfo != NULL);
        VappBrowserASMMemoryMgmt::freeMemory(m_storedPageContentProvider->m_selectedListInfo);
			m_storedPageContentProvider->m_selectedListInfo = NULL;
		}
    }
    if(g_srv_brw_cntx.brw_instance_id > 0)
    {
        srv_brw_dynamic_list_free_memory(SRV_BRW_LIST_TYPE_SAVED_PAGES_LIST);
    }
    VFX_OBJ_CLOSE(m_storedPagesList);
    VFX_OBJ_CLOSE(m_storedPageContentProvider);
    VFX_OBJ_CLOSE(m_toolBar);
    VfxPage::onDeinit(); 
}
#endif

void VappBrowserBookmarkPage::onInit(void)
{
    VfxPage::onInit();

	#ifdef __MMI_BRW_SLIM__
	VFX_OBJ_CREATE(m_titleBar, VcpTitleBar, this);
    m_titleBar->setTitle(VFX_WSTR_RES(STR_ID_VAPP_BRW_BOOKMARKS));
    setTopBar(m_titleBar); 
	#endif
	
    VFX_OBJ_CREATE(m_bookmarksList, VcpListMenu, this);
    VFX_OBJ_CREATE(m_bookmarksContentProvider, VappBrowserBookmarksDataProvider, this);
    m_bookmarksContentProvider->initialize();

	setOrignalBookmarkItems(m_bookmarksContentProvider->m_bookmarksContext->getTotalFileCount());

    m_bookmarksList->setContentProvider(m_bookmarksContentProvider);
    m_bookmarksContentProvider->setNormalMode(); 
    m_bookmarksList->setCellStyle(VCP_LIST_MENU_CELL_STYLE_ICON_SINGLE_TEXT);
    m_bookmarksList->setMenuControlMode(VCP_LIST_MENU_CONTROL_MODE_DISCLOSURE, VFX_FALSE);
    m_bookmarksList->m_signalCmdButtonClicked.connect(this, &VappBrowserBookmarkPage::onButtonClick);
    m_bookmarksList->m_signalItemTapped.connect(this, &VappBrowserBookmarkPage::onItemTap);
    m_bookmarksList->m_signalItemLongTapped.connect(this, &VappBrowserBookmarkPage::onItemLongTapped);
    m_bookmarksList->m_signalItemSelectionStateChanged.connect(this, &VappBrowserBookmarkPage::onSelectionChanged);

	bkmSetBottomBar();
	
    VfxRect page_rect = getRect();
    m_bookmarksList->setRect(0, 0, page_rect.size.width, page_rect.size.height );
    m_bookmarksList->setAlignParent(VFX_FRAME_ALIGNER_MODE_SIDE, VFX_FRAME_ALIGNER_MODE_SIDE, 
        VFX_FRAME_ALIGNER_MODE_SIDE, VFX_FRAME_ALIGNER_MODE_SIDE);

    ((VappBrwServiceInterface *)VFX_OBJ_GET_INSTANCE(VappBrwServiceInterface))->m_bkmprovisioningCallback.connect(this, &VappBrowserBookmarkPage::bkmProvisioningCallback);
}

void VappBrowserBookmarkPage::bkmSetBottomBar()
{
    VFX_OBJ_CREATE(m_toolBar, VcpToolBar, this);
    m_toolBar->addItem(FAVOURITES_BOOKMARKS_ADD, VFX_WSTR_RES(STR_GLOBAL_ADD), VCP_IMG_TOOL_BAR_COMMON_ITEM_ADD);
    m_toolBar->addItem(FAVOURITES_BOOKMARKS_DELETE, VFX_WSTR_RES(STR_GLOBAL_DELETE), VCP_IMG_TOOL_BAR_COMMON_ITEM_DELETE);
	#ifndef __MMI_BRW_SLIM__
    m_toolBar->addItem(FAVOURITES_IMPORT_BOOKMARK, VFX_WSTR_RES(STR_GLOBAL_IMPORT), VCP_IMG_TOOL_BAR_COMMON_ITEM_INSERT);
    m_toolBar->addItem(FAVOURITES_EXPORT_BOOKMARK, VFX_WSTR_RES(STR_GLOBAL_EXPORT), IMG_ID_VAPP_BRW_EXPORT_BKM);
	#endif
    updateTBState();
    m_toolBar->m_signalButtonTap.connect(this, &VappBrowserBookmarkPage::onTBClick);
    setBottomBar(m_toolBar);
}

void VappBrowserBookmarkPage::bkmProvisioningCallback(void *param)
{
    setUpdateNeededStatus(VFX_TRUE);
    if(m_multiOptionToolBar)
    {
        m_multiOptionToolBar->changeItem(MULTI_OPTION_SELECT_ALL, VFX_WSTR_RES(STR_GLOBAL_MARK_ALL), VCP_IMG_TOOL_BAR_COMMON_ITEM_SELECT_ALL);
        m_isSelectAll = VFX_TRUE;
        m_totalSelectableItems++;
    }
}

void VappBrowserBookmarkPage::onItemLongTapped(VcpListMenu *sender, VfxU32 index)
{
    srv_brw_bkm_types_enum file_type = g_srv_brw_cntx.bkm_cntx_p[m_bookmarksContentProvider->m_bookmarksContext->m_bookmarkList[index].actual_index].type;
    if(file_type != SRV_BRW_BKM_TYPE_DEFAULT_FILE)
    {
        VfxWString itemText;
        sender->getItemTextIfPresent(index, VCP_LIST_MENU_FIELD_TEXT, itemText);
        VFX_OBJ_CREATE(m_contextMenu, VcpMenuPopup, this);
        m_contextMenu->setTitle(itemText);
		#ifdef __MMI_BRW_BKM_FOLDER_SUPPORT__
        if(file_type == SRV_BRW_BKM_TYPE_FOLDER)
        {
            m_contextMenu->addItem(COMMAND_LONG_TAP_EDIT, VFX_WSTR_RES(STR_GLOBAL_RENAME));
        }
        else
		#endif
        {
            m_contextMenu->addItem(COMMAND_LONG_TAP_EDIT, VFX_WSTR_RES(STR_GLOBAL_EDIT));
			#ifndef __MMI_BRW_SLIM__
            m_contextMenu->addItem(COMMAND_LONG_TAP_SHARE, VFX_WSTR_RES(STR_GLOBAL_SHARE));
			#endif
        }
        m_contextMenu->addItem(COMMAND_LONG_TAP_DELETE, VFX_WSTR_RES(STR_GLOBAL_DELETE));
        m_contextMenu->m_signalMenuCallback.connect(this, &VappBrowserBookmarkPage::contextMenuCallack);
        m_contextMenu->show(VFX_TRUE);
        selectedBookmarkItemIndex = index;
        vfx_adp_touch_fb_play(VFX_ADP_TOUCH_FB_TYPE_HOLD);
    }
}

void VappBrowserBookmarkPage::contextMenuCallack(VcpMenuPopup *menu, VcpMenuPopupEventEnum event, VcpMenuPopupItem *item)
{
    if(event != VCP_MENU_POPUP_EVENT_ITEM_SELECTED)
    {
        return;
    }
    switch(item->getId())
    {
        case COMMAND_LONG_TAP_EDIT:
        {
            VappBrowserApp *m_brwApp = ((VappBrowserApp *)VfxAppLauncher::getObject(m_browserAppID));
            VfxU8 actualIndex = m_bookmarksContentProvider->m_bookmarksContext->m_bookmarkList[selectedBookmarkItemIndex].actual_index;
			
			#ifdef __MMI_BRW_BKM_FOLDER_SUPPORT__
			if(g_srv_brw_cntx.bkm_cntx_p[actualIndex].type == SRV_BRW_BKM_TYPE_FOLDER)
            {
                VFX_OBJ_CREATE(m_folderInput, VcpInputPopup, this);
                m_folderMode = FOLDER_MODE_ADD;
                m_folderInput->setTitle(VFX_WSTR_RES(STR_ID_VAPP_BRW_FOLDER_NAME));
                VfxWString itemText;
                m_bookmarksList->getItemTextIfPresent(selectedBookmarkItemIndex, VCP_LIST_MENU_FIELD_TEXT, itemText);
                m_bookmarksContentProvider->m_bookmarksContext->m_selFileName = itemText;
                m_folderInput->setTitle(VFX_WSTR_RES(STR_ID_VAPP_BRW_RENAME));
                VcpTextEditor *textEditor = m_folderInput->getInputbox();
            	VsrvInputBinding inputBinding(
                IMM_INPUT_TYPE_SENTENCE,
                IME_DISABLE_NEW_LINE_SYMBOL,
                IME_INPUT_STYLE_NONE,
                textEditor->m_editing
                );
            	inputBinding.setDisabledChars(VFX_WSTR_MEM((VfxWChar*)srv_fmgr_path_get_invalid_chars()));
            	textEditor->setIME(inputBinding);
                textEditor->setText(itemText, SRV_BRW_MAX_TITLE_LENGTH, VFX_FALSE, VCP_TEXT_ENCODING_ASCII);
                textEditor->setHighlight(0, itemText.getLength());
                m_folderInput->m_signalButtonClicked.connect(this, &VappBrowserBookmarkPage::onClickInputButton);
                m_folderInput->show(VFX_TRUE);
                m_folderMode = FOLDER_MODE_EDIT;
            }
            else
			#endif
            {
            	VFX_OBJ_CREATE_EX(m_brwApp->scr->m_addBookmarkPage,VappBrowserAddBookmark,m_brwApp->scr, (actualIndex));
                m_brwApp->scr->pushPage(BRW_PAGE_ADD_BOOKMARK, m_brwApp->scr->m_addBookmarkPage);
            }
            break;
        }
		#ifndef __MMI_BRW_SLIM__
        case COMMAND_LONG_TAP_SHARE:
        {
            VfxU8 actualIndex = m_bookmarksContentProvider->m_bookmarksContext->m_bookmarkList[selectedBookmarkItemIndex].actual_index;
            VappBrowserShareLink *m_browserShareLink;
            VfxWChar *shareURL = (VfxWChar*)VappBrowserASMMemoryMgmt::allocMemory((SRV_BRW_MAX_URL_LENGTH + 1) * ENCODING_LENGTH);
            memset(shareURL, 0, (SRV_BRW_MAX_URL_LENGTH + 1) * ENCODING_LENGTH);
            mmi_asc_n_to_ucs2((CHAR*)shareURL, (CHAR*) g_srv_brw_cntx.bkm_cntx_p[actualIndex].url, SRV_BRW_MAX_URL_LENGTH);
            VFX_OBJ_CREATE_EX(m_browserShareLink, VappBrowserShareLink, this, (shareURL));
            m_browserShareLink->showCommandPopup();
            VappBrowserASMMemoryMgmt::freeMemory(shareURL);
            break;
        }
		#endif	//	?__MMI_BRW_SLIM__
        case COMMAND_LONG_TAP_DELETE:
        {
            VcpConfirmPopup *confirmPopup;
            confirmPopup = VappBrowserUtility::displayDeleteConfirmPopup(this, VCP_POPUP_TYPE_WARNING,
                VFX_WSTR_RES(STR_ID_VAPP_BRW_DELETE_SELECTED_BOOKMARK),
                VFX_WSTR_RES(STR_GLOBAL_DELETE));
            confirmPopup->m_signalButtonClicked.connect(this, &VappBrowserBookmarkPage::bookmarkDeleteHandler);
            break;
        }
        default:
            break;
    }
}

void VappBrowserBookmarkPage::bookmarkDeleteHandler(VfxObject* obj, VfxId id)
{
    if (id == VCP_CONFIRM_POPUP_BUTTON_USER_1)
    {
        VfxU8 actualIndex = m_bookmarksContentProvider->m_bookmarksContext->m_bookmarkList[selectedBookmarkItemIndex].actual_index;
		#ifdef __MMI_BRW_BKM_FOLDER_SUPPORT__
        srv_brw_bkm_types_enum file_type = g_srv_brw_cntx.bkm_cntx_p[actualIndex].type;
		if(file_type == SRV_BRW_BKM_TYPE_FOLDER)
        {
            //srv_brw_bkm_delete_bookmark(actualIndex);
			VappBrowserUtility::deleteBookmarkFolder(actualIndex);
        }
        else
		#endif	
        {
            //VappBrowserUtility::deleteBookmarkFolder(actualIndex);
            srv_brw_bkm_delete_bookmark(actualIndex);
        }
        m_bookmarksContentProvider->m_bookmarksContext->updateFileCount();
        m_bookmarksList->resetAllItems(VFX_TRUE);
        updateTBState();
    }
}

void VappBrowserBookmarkPage::onItemTap(VcpListMenu *sender, VfxU32 index)
{
    VfxU8 actualIndex = m_bookmarksContentProvider->m_bookmarksContext->m_bookmarkList[index].actual_index;
	#ifdef __MMI_BRW_BKM_FOLDER_SUPPORT__
    if(g_srv_brw_cntx.bkm_cntx_p[actualIndex].type == SRV_BRW_BKM_TYPE_FOLDER)
    {
        VfxWString itemText;
        m_bookmarksList->getItemTextIfPresent(index, VCP_LIST_MENU_FIELD_TEXT, itemText);
        VappBrowserApp *m_brwApp = ((VappBrowserApp *)VfxAppLauncher::getObject(m_browserAppID));
        VFX_OBJ_CREATE_EX(m_brwApp->scr->m_bookmarkFolderPage, VappBrowserBookmarkFolderPage, m_brwApp->scr, (itemText));
        m_brwApp->scr->pushPage(BRW_PAGE_BOOKMARK_FOLDER, m_brwApp->scr->m_bookmarkFolderPage);
    }
    else
	#endif
    {
        m_bookmarkUrl = (VfxWChar*)VappBrowserASMMemoryMgmt::allocMemory((SRV_BRW_MAX_URL_LENGTH + 1) * ENCODING_LENGTH);
        memset(m_bookmarkUrl, 0, (SRV_BRW_MAX_URL_LENGTH + 1) * ENCODING_LENGTH);
        mmi_asc_to_ucs2((CHAR*) m_bookmarkUrl, (CHAR*)g_srv_brw_cntx.bkm_cntx_p[actualIndex].url);
            srv_brw_load_url_req((U8*)m_bookmarkUrl, WAP_BAM_UNKNOWN_CHARSET);
            getMainScr()->popPage();
            VappBrowserASMMemoryMgmt::freeMemory(m_bookmarkUrl);
			m_bookmarkUrl = NULL;
        }
    }

void VappBrowserBookmarkPage::wifiBearerCallback(VfxU32 state, VfxU32 errorCause)
{
    if(state == SRV_CBM_ACTIVATED)
    {
        ((VappBrwServiceInterface *)VFX_OBJ_GET_INSTANCE(VappBrwServiceInterface))->m_setProfileCallback.connect(this , &VappBrowserBookmarkPage::launchUrlCallback);
    }
    else
    {
        if(errorCause != ABM_E_REJECTED)
        {
            VappBrowserUtility::displayPopup(
                STR_ID_VAPP_BRW_CONNECTION_FAILED,
                MMI_NMGR_BALLOON_TYPE_FAILURE,
			    MMI_EVENT_INFO_BALLOON);
        }
        VFX_OBJ_CLOSE(m_popup);
        VappBrowserASMMemoryMgmt::freeMemory(m_bookmarkUrl);
		m_bookmarkUrl = NULL;
    }
    ((VappBrwServiceInterface *)VFX_OBJ_GET_INSTANCE(VappBrwServiceInterface))->m_WifiBearerCallback.disconnect(this , &VappBrowserBookmarkPage::wifiBearerCallback);
}

void VappBrowserBookmarkPage::launchUrlCallback(void)
{
    ((VappBrwServiceInterface *)VFX_OBJ_GET_INSTANCE(VappBrwServiceInterface))->m_setProfileCallback.disconnect(this , &VappBrowserBookmarkPage::launchUrlCallback);
    srv_brw_load_url_req((U8*)m_bookmarkUrl, WAP_BAM_UNKNOWN_CHARSET);
    VFX_OBJ_CLOSE(m_popup);
    getMainScr()->popPage();
    VappBrowserASMMemoryMgmt::freeMemory(m_bookmarkUrl);
	m_bookmarkUrl = NULL;
}

void VappBrowserBookmarkPage::onButtonClick(VcpListMenu *sender, VfxU32 index)
{
    VfxU8 actualIndex = m_bookmarksContentProvider->m_bookmarksContext->m_bookmarkList[index].actual_index;
	#ifdef __MMI_BRW_BKM_FOLDER_SUPPORT__
    if(g_srv_brw_cntx.bkm_cntx_p[actualIndex].type != SRV_BRW_BKM_TYPE_FOLDER)
	#endif
    {
        VappBrowserApp *m_brwApp = ((VappBrowserApp *)VfxAppLauncher::getObject(m_browserAppID));
        VFX_OBJ_CREATE_EX(m_brwApp->scr->m_bookmarkDetailsPage, VappBrowserBookmarksDetailsPage, m_brwApp->scr, (actualIndex));
        m_brwApp->scr->pushPage(BRW_PAGE_BOOKMARK_DETAILS, m_brwApp->scr->m_bookmarkDetailsPage);
        m_brwApp->scr->m_bookmarkDetailsPage->m_deleteCallback.connect(this, &VappBrowserBookmarkPage::onBookmarkDeleteCallback);
    }
}

void VappBrowserBookmarkPage::onBookmarkDeleteCallback()
{
	#ifdef __MMI_BRW_SLIM__
	m_bookmarksContentProvider->m_bookmarksContext->updateFileCount();
    m_bookmarksList->resetAllItems(VFX_TRUE);
    updateTBState();
	#endif
    setUpdateNeededStatus(VFX_TRUE);
}

void VappBrowserBookmarkPage::onTBClick(VfxObject* sender, VfxId id)
{
    switch(id)
    {
        case FAVOURITES_BOOKMARKS_DELETE:
        {
			m_bookmarksContentProvider->m_selectedListInfo = (VfxU8*)VappBrowserASMMemoryMgmt::allocMemory(SRV_BRW_BKM_MAX_COUNT);
			memset(m_bookmarksContentProvider->m_selectedListInfo, 0, SRV_BRW_BKM_MAX_COUNT);			
            m_bookmarksList->m_signalCmdButtonClicked.disconnect(this, &VappBrowserBookmarkPage::onButtonClick);
            m_bookmarksList->m_signalItemTapped.disconnect(this, &VappBrowserBookmarkPage::onItemTap);
            m_bookmarksList->m_signalItemLongTapped.disconnect(this, &VappBrowserBookmarkPage::onItemLongTapped);
            m_bookmarksContentProvider->setSelectionMode();
            m_bookmarksList->setMenuMode(VCP_LIST_MENU_MODE_MULTI_SELECTION, VFX_TRUE);
            m_bookmarksList->resetAllItems(VFX_TRUE);
            m_bookmarksContentProvider->updateCustomControlStatus(VFX_FALSE);
            m_bookmarksList->setMenuControlMode(VCP_LIST_MENU_CONTROL_MODE_NORMAL, VFX_FALSE);
            VFX_OBJ_CREATE(m_multiOptionToolBar, VcpToolBar, this);
            m_multiOptionToolBar->addItem(MULTI_OPTION_SELECT_ALL, VFX_WSTR_RES(STR_GLOBAL_MARK_ALL), VCP_IMG_TOOL_BAR_COMMON_ITEM_SELECT_ALL);
            m_multiOptionToolBar->addItem(MULTI_OPTION_DELETE, VFX_WSTR_RES(STR_GLOBAL_DELETE), VCP_IMG_TOOL_BAR_COMMON_ITEM_DELETE);
            m_multiOptionToolBar->setDisableItem(MULTI_OPTION_DELETE, VFX_TRUE);
            m_multiOptionToolBar->addItem(MULTI_OPTION_CANCEL,  VFX_WSTR_RES(STR_GLOBAL_CANCEL), VCP_IMG_TOOL_BAR_COMMON_ITEM_CANCEL);
            m_isSelectAll = VFX_TRUE;
            m_selectedItemsCount = 0;
            m_totalSelectableItems = m_bookmarksContentProvider->getCount() - m_bookmarksContentProvider->m_bookmarksContext->getFileCountByType(SRV_BRW_BKM_TYPE_DEFAULT_FILE);;
            m_multiOptionToolBar->m_signalButtonTap.connect(this, &VappBrowserBookmarkPage::onMultiOptionTBClick);
            setBottomBar(m_multiOptionToolBar);
			if(m_toolBar)
			{
				VFX_OBJ_CLOSE(m_toolBar);
			}
            break;
        }
        case FAVOURITES_BOOKMARKS_ADD:
        {
            VcpCommandPopup *m_commandPopup;
            VFX_OBJ_CREATE(m_commandPopup, VcpCommandPopup, this);
            m_commandPopup->setInfoType(VCP_POPUP_TYPE_QUESTION);
            m_commandPopup->setText(VFX_WSTR_RES(STR_GLOBAL_ADD));
            m_commandPopup->addItem(COMMAND_ADD_BOOKMARK, VFX_WSTR_RES(STR_ID_VAPP_BRW_BOOKMARK));
			#ifdef __MMI_BRW_BKM_FOLDER_SUPPORT__
            m_commandPopup->addItem(COMMAND_ADD_FOLDER, VFX_WSTR_RES(STR_ID_VAPP_BRW_FOLDER));
			#endif
            m_commandPopup->addItem(COMMAND_ADD_CANCEL, VFX_WSTR_RES(STR_GLOBAL_CANCEL), VCP_POPUP_BUTTON_TYPE_CANCEL);
            m_commandPopup->show(VFX_TRUE);
            m_commandPopup->m_signalButtonClicked.connect(this, &VappBrowserBookmarkPage::onCommandCallClick);
            break;
        }
		#ifndef __MMI_BRW_SLIM__
        case FAVOURITES_IMPORT_BOOKMARK:
        {
            if(VappBrowserUtility::checkAvailableBookmarkMemory() == VFX_FALSE)
            {
                return;
            }
			FMGR_FILTER filter;
			FMGR_FILTER_INIT(&filter);
            FMGR_FILTER_SET(&filter, FMGR_TYPE_URL);
            FMGR_FILTER_SET(&filter, FMGR_TYPE_VBM);
            FMGR_FILTER_SET(&filter, FMGR_TYPE_FOLDER);
			mmi_id cui_id = vcui_file_selector_create(m_browserAppID, (const WCHAR*)L"root", &filter, VCUI_FILE_SELECTOR_STYLE_FILE_ONLY, VCUI_FILE_SELECTOR_OPT_FOLDER_TRAVERSE_ALL);
			if (cui_id != GRP_ID_INVALID)
			{
				vcui_file_selector_run(cui_id);
                VappBrowserApp::m_eventCallback.connect(this, &VappBrowserBookmarkPage::fmgrCuiCallback);
			}
            break;
        }
        case FAVOURITES_EXPORT_BOOKMARK:
        {
            mmi_id cui_id = vcui_folder_selector_create(m_browserAppID, (const WCHAR*)L"root", VCUI_FOLDER_SELECTOR_STYLE_WRITE, VCUI_FOLDER_SELECTOR_OPT_FIXED_PATH_ON);
			if (cui_id != GRP_ID_INVALID)
			{
				vcui_folder_selector_run(cui_id);
                VappBrowserApp::m_eventCallback.connect(this, &VappBrowserBookmarkPage::fmgrCuiCallback);
			}
            break;
        }
		#endif
        default:
            break;
	}
}

void VappBrowserBookmarkPage::fmgrCuiCallback(void *param)
{
    switch(((mmi_event_struct*)param)->evt_id)
    {
        case EVT_ID_VCUI_FILE_SELECTOR_RESULT:
        {
            vcui_file_selector_result_event_struct *evt = (vcui_file_selector_result_event_struct*)param;
            if (evt->result == 1)
            {
                if(VappBrowserUtility::checkAvailableBookmarkMemory() == VFX_FALSE)
                {
                    vcui_file_selector_close(evt->sender_id);
                    return;
                }
                VfxWChar *filePath = NULL;
                VfxS32 error_code = 0;
                FS_HANDLE file_handle;
                VFX_ALLOC_MEM(filePath, (SRV_BRW_BKM_MAX_PATH_LEN + 1)* ENCODING_LENGTH, this);
                memset(filePath, 0, (SRV_BRW_BKM_MAX_PATH_LEN + 1)* ENCODING_LENGTH);
                error_code = vcui_file_selector_get_selected_filepath(evt->sender_id, NULL, (WCHAR*)filePath, (SRV_BRW_BKM_MAX_PATH_LEN + 1)* ENCODING_LENGTH);
                if(error_code < FS_NO_ERROR)
                {
                    VappBrowserUtility::fileSystemErrorHandler(error_code);
                }
                else
                {
                    file_handle = FS_Open((UI_string_type) filePath, FS_READ_ONLY);
                    if (srv_vbkm_reader_validate_file(file_handle))
                    {
                        VfxWChar *fileName;
                        VFX_ALLOC_MEM(fileName, (SRV_FMGR_PATH_MAX_FILE_NAME_LEN + 1)*ENCODING_LENGTH, this);
                        memset(fileName, 0, (SRV_FMGR_PATH_MAX_FILE_NAME_LEN + 1)*ENCODING_LENGTH);
                        srv_brw_bookmarks_parse_filepath(SRV_BRW_BKM_GET_FILENAME_WITHOUT_EXTN, (U8*)filePath, (U8*)fileName);
                        VfxWChar *truncatedFileName;
                        VFX_ALLOC_MEM(truncatedFileName, (SRV_BRW_BKM_MAX_INPUT_FILE_NAME_LEN + 1)*ENCODING_LENGTH, this);
                        memset(truncatedFileName, 0, (SRV_BRW_BKM_MAX_INPUT_FILE_NAME_LEN + 1)*ENCODING_LENGTH);
                        mmi_ucs2ncpy((CHAR*)truncatedFileName, (CHAR*)fileName, SRV_BRW_BKM_MAX_INPUT_FILE_NAME_LEN);
                        VFX_FREE_MEM(fileName);
                        srv_brw_bookmarks_modify_file_for_save((U8*)truncatedFileName, SRV_BRW_ROOT_PARENT_INDEX);
                        srv_brw_bookmark_file_struct *obj = (srv_brw_bookmark_file_struct*) OslMalloc(sizeof(srv_brw_bookmark_file_struct));
                        memset(obj, 0, sizeof(srv_brw_bookmark_file_struct));
                        mmi_ucs2cpy((CHAR*)obj->file_name, (CHAR*)truncatedFileName);
                        VFX_FREE_MEM(truncatedFileName);
                        srv_vbkm_reader_extract_url(file_handle, obj->file_url);
                        obj->selected_bookmark_index = (S8)SRV_BRW_BKM_INVALID_INDEX; // this warning , need discuss with service
                        error_code = srv_brw_bookmark_add_item(obj);
                        OslMfree(obj);
                        if(error_code == SRV_BRW_BKM_ERROR_OK)
                        {
                            m_bookmarksContentProvider->m_bookmarksContext->updateFileCount();
                            m_bookmarksList->resetAllItems(VFX_TRUE);
                            updateTBState();
                            VappBrowserUtility::displayPopup(
                            STR_GLOBAL_DONE,
                            MMI_NMGR_BALLOON_TYPE_SUCCESS,
                            MMI_EVENT_INFO_BALLOON);
                        }
                        else
                        {
                            VappBrowserUtility::displayPopup(
                            VappBrowserUtility::getErrorString(error_code),
                            MMI_NMGR_BALLOON_TYPE_FAILURE,
                            MMI_EVENT_INFO_BALLOON);
                        }
                    }
                    else
                    {
                        VappBrowserUtility::displayPopup(
                        STR_ID_VAPP_BRW_INVALID_BOOKMARK_FILE,
                        MMI_NMGR_BALLOON_TYPE_FAILURE,
                        MMI_EVENT_INFO_BALLOON);
                    }
                    FS_Close(file_handle);
                }
                VFX_FREE_MEM(filePath);
                vcui_file_selector_close(evt->sender_id);					
            }
            else
            {
                vcui_file_selector_close(evt->sender_id);
            }
            break;
        }
        case EVT_ID_VCUI_FOLDER_SELECTOR_RESULT:
        {
            vcui_folder_selector_result_event_struct *evt = (vcui_folder_selector_result_event_struct*)param;
            if (evt->result == 1)
            {
                VfxWChar *folderPath = NULL;
                VfxS32 error_code = 0;
                VFX_ALLOC_MEM(folderPath, (SRV_BRW_BKM_MAX_PATH_LEN + 1)* ENCODING_LENGTH, this);
                memset(folderPath, 0, (SRV_BRW_BKM_MAX_PATH_LEN + 1)* ENCODING_LENGTH);
                vcui_folder_selector_get_selected_filepath(evt->sender_id, NULL, (WCHAR*)folderPath, (SRV_BRW_BKM_MAX_PATH_LEN + 1)* ENCODING_LENGTH);
                error_code = srv_brw_bookmark_export_all_bookmarks((U8*)folderPath, vappBrwCopyBookmarkCallback);
                VFX_FREE_MEM(folderPath);
                if(error_code == SRV_BRW_BKM_ERROR_OK)
                {
                    VFX_OBJ_CREATE(m_popup,VcpIndicatorPopup,this);
                    m_popup->setInfoType(VCP_INDICATOR_POPUP_STYLE_ACTIVITY);
                    m_popup->setText(VFX_WSTR_RES(STR_ID_VAPP_BRW_PLEASE_WAIT));
                    m_popup->setAutoDestory(VFX_FALSE);
                    m_popup->show(VFX_TRUE);
                    ((VappBrwServiceInterface *)VFX_OBJ_GET_INSTANCE(VappBrwServiceInterface))->m_bookmarkExportCallback.connect(this , &VappBrowserBookmarkPage::bookmarkExportCallback);
                }
                else
                {
                    VappBrowserUtility::displayPopup(
                    VappBrowserUtility::getErrorString(error_code),
                    MMI_NMGR_BALLOON_TYPE_SUCCESS,
                    MMI_EVENT_INFO_BALLOON);
                }
            }
            vcui_folder_selector_close(evt->sender_id);
            break;
        }
    }
}

void VappBrowserBookmarkPage::bookmarkExportCallback(void *param)
{
    srv_brw_bookmark_export_rsp_struct *msg = (srv_brw_bookmark_export_rsp_struct*)param;
    //VcpConfirmPopup *m_confirmPopup;
    VFX_OBJ_CREATE(m_confirmPopup, VcpConfirmPopup, this);
    m_confirmPopup->setInfoType(VCP_POPUP_TYPE_INFO);
    m_confirmPopup->setButtonSet(VCP_CONFIRM_BUTTON_SET_OK);
    VfxWString message;
    VfxWString count;
    message.loadFromRes(STR_ID_VAPP_BRW_EXPORT_SUCCESS);
    message += VFX_WSTR_RES(STR_ID_VAPP_BRW_LEFT_BRACKET);
    count.format("%d", msg->exported);
    message += count;
    message += VFX_WSTR_RES(STR_ID_VAPP_BRW_RIGHT_BRACKET);
    message += VFX_WSTR_RES(STR_ID_VAPP_BRW_EXPORT_FAILED);
    message += VFX_WSTR_RES(STR_ID_VAPP_BRW_LEFT_BRACKET);
    count.format("%d", msg->failed);
    message += count;
    message += VFX_WSTR_RES(STR_ID_VAPP_BRW_RIGHT_BRACKET);
    message += VFX_WSTR_RES(STR_ID_VAPP_BRW_DOT);
    m_confirmPopup->setText(message);
    m_confirmPopup->setAutoDestory(VFX_FALSE);
    m_confirmPopup->show(VFX_TRUE);
    m_popup->hide(VFX_TRUE);
    VFX_OBJ_CLOSE(m_popup);
    ((VappBrwServiceInterface *)VFX_OBJ_GET_INSTANCE(VappBrwServiceInterface))->m_bookmarkExportCallback.disconnect(this , &VappBrowserBookmarkPage::bookmarkExportCallback);

}

void VappBrowserBookmarkPage::onCommandCallClick(VfxObject *obj, VfxId id)
{
    switch(id)
    {
        case COMMAND_ADD_BOOKMARK:
        {
            if(VappBrowserUtility::checkAvailableBookmarkMemory() == VFX_FALSE)
            {
                return;
            }
            VappBrowserApp *m_brwApp = ((VappBrowserApp *)VfxAppLauncher::getObject(m_browserAppID));
            VfxWString parent = VFX_WSTR_MEM(m_bookmarksContentProvider->m_bookmarksContext->m_selFolderName);
            VFX_OBJ_CREATE_EX(m_brwApp->scr->m_addBookmarkPage,VappBrowserAddBookmark,m_brwApp->scr, (parent));
            m_brwApp->scr->pushPage(BRW_PAGE_ADD_BOOKMARK, m_brwApp->scr->m_addBookmarkPage);
            break;
        }
		#ifdef __MMI_BRW_BKM_FOLDER_SUPPORT__
        case COMMAND_ADD_FOLDER:
        {
            if(VappBrowserUtility::checkAvailableBookmarkMemory() == VFX_FALSE)
            {
                return;
            }
            VFX_OBJ_CREATE(m_folderInput, VcpInputPopup, this);
            m_folderMode = FOLDER_MODE_ADD;
            m_folderInput->setTitle(VFX_WSTR_RES(STR_ID_VAPP_BRW_FOLDER_NAME));
            m_folderInput->getInputbox()->setText(VFX_WSTR(""), SRV_BRW_MAX_TITLE_LENGTH, VFX_FALSE, VCP_TEXT_ENCODING_ASCII);
            VcpTextEditor *textEditor = m_folderInput->getInputbox();
            VsrvInputBinding inputBinding(
                IMM_INPUT_TYPE_SENTENCE,
                IME_DISABLE_NEW_LINE_SYMBOL,
                IME_INPUT_STYLE_NONE,
                textEditor->m_editing
                );
            inputBinding.setDisabledChars(VFX_WSTR_MEM((VfxWChar*)srv_fmgr_path_get_invalid_chars()));
            textEditor->setIME(inputBinding);
            m_folderInput->m_signalButtonClicked.connect(this, &VappBrowserBookmarkPage::onClickInputButton);
            m_folderInput->show(VFX_TRUE);
            break;
        }
		#endif
        default:
            break;
	}
}

#ifdef __MMI_BRW_BKM_FOLDER_SUPPORT__
void VappBrowserBookmarkPage::onClickInputButton(VfxObject* sender, VcpInputPopupButtonEnum button_id)
{
    if (button_id == VCP_INPUT_POPUP_BTN_OK)
    {
        m_folderInput->setErrorText((VFX_WSTR_RES(0)));
        VfxWString folderName = m_folderInput->getText();
        VfxWChar *folderNameBuffPtr = folderName.lockBuf((SRV_BRW_MAX_TITLE_LENGTH + 1) *ENCODING_LENGTH);
        srv_brw_bookmark_folder_struct *obj = (srv_brw_bookmark_folder_struct*) VappBrowserASMMemoryMgmt::allocMemory(sizeof(srv_brw_bookmark_folder_struct));
        memset(obj, 0, sizeof(srv_brw_bookmark_folder_struct));
        mmi_ucs2ncpy((CHAR*)obj->folder_name, (CHAR*)folderNameBuffPtr, SRV_BRW_MAX_TITLE_LENGTH);
        folderName.unlockBuf();

        srv_brw_bkm_folder_opeartion_enum op_mode;
        if(m_folderMode == FOLDER_MODE_ADD)
        {
            op_mode = SRV_BRW_BKM_FOLDER_CREATE;
            obj->selected_folder_index = SRV_BRW_BKM_INVALID_INDEX;
        }
        else
        {
            op_mode = SRV_BRW_BKM_FOLDER_RENAME;
            obj->selected_folder_index = m_bookmarksContentProvider->m_bookmarksContext->m_bookmarkList[selectedBookmarkItemIndex].actual_index;
        }
        S32 error_code = srv_brw_bookmark_validate_folder(obj, op_mode);
        if (error_code == SRV_BRW_BKM_ERROR_OK)
        {
            error_code = srv_brw_bookmark_create_folder(obj, op_mode);
        }
        VappBrowserASMMemoryMgmt::freeMemory(obj);
        if(error_code == SRV_BRW_BKM_ERROR_OK)
        {
            m_bookmarksContentProvider->m_bookmarksContext->updateFileCount();
			setOrignalBookmarkItems(m_bookmarksContentProvider->m_bookmarksContext->getTotalFileCount());
            m_bookmarksList->resetAllItems(VFX_TRUE);
            updateTBState();
            VappBrowserUtility::displayPopup(
                STR_GLOBAL_SAVED,
                MMI_NMGR_BALLOON_TYPE_SUCCESS,
				MMI_EVENT_INFO_BALLOON);
            VFX_OBJ_CLOSE(m_folderInput);
        }
        else
        {
            m_folderInput->setErrorText(VFX_WSTR_RES(VappBrowserUtility::getErrorString(error_code)));
        }
    }
    else if (button_id == VCP_INPUT_POPUP_BTN_CANCEL)
    {
        VFX_OBJ_CLOSE(m_folderInput);
    }
}
#endif
void VappBrowserBookmarkPage::selectAllItems(VfxBool isSelected)
{
    if(isSelected)
    {
        VfxU8 totalCount = m_bookmarksContentProvider->getCount();
        for(VfxU8 index = 0; index < totalCount; index++)
        {
            srv_brw_bkm_types_enum file_type = g_srv_brw_cntx.bkm_cntx_p[m_bookmarksContentProvider->m_bookmarksContext->m_bookmarkList[index].actual_index].type;
            if(file_type != SRV_BRW_BKM_TYPE_DEFAULT_FILE)
            {
                m_bookmarksContentProvider->m_selectedListInfo[index] = 1;
            }
        }
    }
    else
    {
        memset(m_bookmarksContentProvider->m_selectedListInfo, 0, m_bookmarksContentProvider->getCount());
    }
}

void VappBrowserBookmarkPage::onMultiOptionTBClick(VfxObject* sender, VfxId id)
{
    switch(id)
    {
        case MULTI_OPTION_SELECT_ALL:
        {
            if(m_isSelectAll)
            {
                selectAllItems(VFX_TRUE);
                m_selectedItemsCount = m_bookmarksContentProvider->getCount()- m_bookmarksContentProvider->m_bookmarksContext->getFileCountByType(SRV_BRW_BKM_TYPE_DEFAULT_FILE);
                m_multiOptionToolBar->changeItem(MULTI_OPTION_SELECT_ALL, VFX_WSTR_RES(STR_GLOBAL_UNMARK_ALL), VCP_IMG_TOOL_BAR_COMMON_ITEM_UNSELECT_ALL);
                m_multiOptionToolBar->setDisableItem(MULTI_OPTION_DELETE, VFX_FALSE);
                m_isSelectAll = VFX_FALSE;
            }
            else
            {
                selectAllItems(VFX_FALSE);
                m_selectedItemsCount = 0;
                m_multiOptionToolBar->changeItem(MULTI_OPTION_SELECT_ALL, VFX_WSTR_RES(STR_GLOBAL_MARK_ALL), VCP_IMG_TOOL_BAR_COMMON_ITEM_SELECT_ALL);
                m_multiOptionToolBar->setDisableItem(MULTI_OPTION_DELETE, VFX_TRUE);
                m_isSelectAll = VFX_TRUE;
            }
            m_bookmarksList->updateAllItems();
            break;
        }

        case MULTI_OPTION_DELETE:
        {
            //VcpConfirmPopup *m_confirmPopup;
            if(m_selectedItemsCount > 1)
            {
                VfxWString deleteConfirmation;
                deleteConfirmation.loadFromRes(STR_ID_VAPP_BRW_DELETE_SELECTED_BOOKMARKS);
                VfxWString deleteConfirmationCount;
                deleteConfirmation += VFX_WSTR_RES(STR_ID_VAPP_BRW_LEFT_BRACKET);
                deleteConfirmationCount.format("%d", m_selectedItemsCount);
                deleteConfirmation += deleteConfirmationCount;
                deleteConfirmation += VFX_WSTR_RES(STR_ID_VAPP_BRW_RIGHT_BRACKET);
                deleteConfirmation += VFX_WSTR_RES(STR_ID_VAPP_BRW_QUESTION_MARK);
                m_confirmPopup = VappBrowserUtility::displayDeleteConfirmPopup(this, VCP_POPUP_TYPE_WARNING,
                    deleteConfirmation,
                    VFX_WSTR_RES(STR_GLOBAL_DELETE));
            }
            else
            {
                m_confirmPopup = VappBrowserUtility::displayDeleteConfirmPopup(this, VCP_POPUP_TYPE_WARNING,
                    VFX_WSTR_RES(STR_ID_VAPP_BRW_DELETE_SELECTED_BOOKMARK),
                    VFX_WSTR_RES(STR_GLOBAL_DELETE));
            }
            m_confirmPopup->m_signalButtonClicked.connect(this, &VappBrowserBookmarkPage::multiDeleteEventHandler);
			m_confirmPopup_wpt = m_confirmPopup;//use weak pointer to check this popup // for fix MAUI_03180415
            break;
        }

        case MULTI_OPTION_CANCEL:
        {
            m_bookmarksList->m_signalCmdButtonClicked.connect(this, &VappBrowserBookmarkPage::onButtonClick);
            m_bookmarksList->m_signalItemTapped.connect(this, &VappBrowserBookmarkPage::onItemTap);
            m_bookmarksList->m_signalItemLongTapped.connect(this, &VappBrowserBookmarkPage::onItemLongTapped);
            m_bookmarksContentProvider->setNormalMode();
            m_bookmarksList->setMenuMode(VCP_LIST_MENU_MODE_NORMAL, VFX_TRUE);
            m_bookmarksContentProvider->updateCustomControlStatus(VFX_TRUE);
            m_bookmarksList->setMenuControlMode(VCP_LIST_MENU_CONTROL_MODE_DISCLOSURE, VFX_FALSE);
            VFX_OBJ_CLOSE(m_multiOptionToolBar);
            m_bookmarksList->resetAllItems(VFX_TRUE);
            VappBrowserASMMemoryMgmt::freeMemory(m_bookmarksContentProvider->m_selectedListInfo);
			m_bookmarksContentProvider->m_selectedListInfo = NULL;
			bkmSetBottomBar();
            //setBottomBar(m_toolBar);
            break;
        }

        default:
            break;
	}
}

void VappBrowserBookmarkPage::multiDeleteEventHandler(VfxObject* obj, VfxId id)
{
    if (id == VCP_CONFIRM_POPUP_BUTTON_USER_1)
    {
        VfxU8 totalCount = m_bookmarksContentProvider->getCount();
        for(VfxU8 index = 0; (index < totalCount) && (m_selectedItemsCount > 0); index++)
        {
            if(m_bookmarksContentProvider->m_selectedListInfo[index] == 1)
            {
                VfxU8 actualIndex = m_bookmarksContentProvider->m_bookmarksContext->m_bookmarkList[index].actual_index;
                srv_brw_bkm_types_enum file_type = g_srv_brw_cntx.bkm_cntx_p[actualIndex].type;
				if(file_type == NULL)
				{

				}
				#ifdef __MMI_BRW_BKM_FOLDER_SUPPORT__
				else if(file_type == SRV_BRW_BKM_TYPE_FOLDER)
                {
                    VappBrowserUtility::deleteBookmarkFolder(actualIndex);
                }
				#endif
                else if(file_type == SRV_BRW_BKM_TYPE_USER_CREATED_FILE)
                {
                    srv_brw_bkm_delete_bookmark(actualIndex);
                }
                m_selectedItemsCount--;
            }
        }
        if(m_multiOptionToolBar)
        {
            VFX_OBJ_CLOSE(m_multiOptionToolBar);
            m_bookmarksList->resetAllItems(VFX_TRUE);
            VappBrowserASMMemoryMgmt::freeMemory(m_bookmarksContentProvider->m_selectedListInfo);
			m_bookmarksContentProvider->m_selectedListInfo = NULL;
            m_bookmarksList->m_signalCmdButtonClicked.connect(this, &VappBrowserBookmarkPage::onButtonClick);
            m_bookmarksList->m_signalItemTapped.connect(this, &VappBrowserBookmarkPage::onItemTap);
            m_bookmarksList->m_signalItemLongTapped.connect(this, &VappBrowserBookmarkPage::onItemLongTapped);
            m_bookmarksContentProvider->setNormalMode();
            m_bookmarksList->setMenuMode(VCP_LIST_MENU_MODE_NORMAL, VFX_TRUE);
            m_bookmarksContentProvider->updateCustomControlStatus(VFX_TRUE);
            m_bookmarksList->setMenuControlMode(VCP_LIST_MENU_CONTROL_MODE_DISCLOSURE, VFX_FALSE);
            bkmSetBottomBar();
        }
        m_bookmarksContentProvider->m_bookmarksContext->updateFileCount();
        m_bookmarksList->resetAllItems(VFX_TRUE);
        updateTBState();
    }
}


void VappBrowserBookmarkPage::onSelectionChanged(VcpListMenu *menu, VfxU32 index, VcpListMenuItemStateEnum newState)
{
	m_totalSelectableItems = m_bookmarksContentProvider->getCount() - m_bookmarksContentProvider->m_bookmarksContext->getFileCountByType(SRV_BRW_BKM_TYPE_DEFAULT_FILE);;
    if (newState == VCP_LIST_MENU_ITEM_STATE_SELECTED)
    {
        m_bookmarksContentProvider->m_selectedListInfo[index] = 1;
        if(m_selectedItemsCount != m_totalSelectableItems)
        {
            m_selectedItemsCount++;
        }
    }
    else if(newState == VCP_LIST_MENU_ITEM_STATE_UNSELECTED)
    {
        m_bookmarksContentProvider->m_selectedListInfo[index] = 0;
        if(m_selectedItemsCount > 0)
        {
            m_selectedItemsCount--;
        }
    }
    if(m_selectedItemsCount == 0)
    {
        m_multiOptionToolBar->setDisableItem(MULTI_OPTION_DELETE, VFX_TRUE);
        m_multiOptionToolBar->changeItem(MULTI_OPTION_SELECT_ALL, VFX_WSTR_RES(STR_GLOBAL_MARK_ALL), VCP_IMG_TOOL_BAR_COMMON_ITEM_SELECT_ALL);
    }
    else
    {
        m_multiOptionToolBar->setDisableItem(MULTI_OPTION_DELETE, VFX_FALSE);
        if(m_selectedItemsCount == m_totalSelectableItems)
        {
            m_multiOptionToolBar->changeItem(MULTI_OPTION_SELECT_ALL, VFX_WSTR_RES(STR_GLOBAL_UNMARK_ALL), VCP_IMG_TOOL_BAR_COMMON_ITEM_UNSELECT_ALL);
            m_isSelectAll = VFX_FALSE;
        }
        else
        {
            m_multiOptionToolBar->changeItem(MULTI_OPTION_SELECT_ALL, VFX_WSTR_RES(STR_GLOBAL_MARK_ALL), VCP_IMG_TOOL_BAR_COMMON_ITEM_SELECT_ALL);
            m_isSelectAll = VFX_TRUE;
        }
    }
}

void VappBrowserBookmarkPage::onQueryRotateEx(VfxScreenRotateParam & param)
{
	if(param.rotateTo == VFX_SCR_ROTATE_TYPE_0 || param.rotateTo == VFX_SCR_ROTATE_TYPE_270 || param.rotateTo == VFX_SCR_ROTATE_TYPE_90) 
	{
				
	}
	else
	{
		param.rotateTo = VFX_SCR_ROTATE_TYPE_NORMAL;
	}

}


void VappBrowserBookmarkPage::onBack()
{
    if(m_multiOptionToolBar)
    { 
    	if(m_confirmPopup_wpt.isValid())// for fix MAUI_03180415
    	{
			VFX_OBJ_CLOSE(m_confirmPopup);
		}
        m_bookmarksList->m_signalCmdButtonClicked.connect(this, &VappBrowserBookmarkPage::onButtonClick);
        m_bookmarksList->m_signalItemTapped.connect(this, &VappBrowserBookmarkPage::onItemTap);
        m_bookmarksList->m_signalItemLongTapped.connect(this, &VappBrowserBookmarkPage::onItemLongTapped);
        m_bookmarksContentProvider->setNormalMode();
        m_bookmarksList->setMenuMode(VCP_LIST_MENU_MODE_NORMAL, VFX_TRUE);
        m_bookmarksContentProvider->updateCustomControlStatus(VFX_TRUE);
        m_bookmarksList->setMenuControlMode(VCP_LIST_MENU_CONTROL_MODE_DISCLOSURE, VFX_FALSE);
        VFX_OBJ_CLOSE(m_multiOptionToolBar);
        m_bookmarksList->resetAllItems(VFX_TRUE);
        VappBrowserASMMemoryMgmt::freeMemory(m_bookmarksContentProvider->m_selectedListInfo);
		m_bookmarksContentProvider->m_selectedListInfo = NULL;

		bkmSetBottomBar();	
		
    }
    else
    {
        VfxPage::onBack();
    }
}

void VappBrowserBookmarkPage::updateTBState(void)
{
	#ifdef __MMI_BRW_BKM_FOLDER_SUPPORT__
	VfxU32 folderCount = 0;
    folderCount= m_bookmarksContentProvider->m_bookmarksContext->getFileCountByType(SRV_BRW_BKM_TYPE_FOLDER);
	#endif
    VfxU32 defaultFileCount = m_bookmarksContentProvider->m_bookmarksContext->getFileCountByType(SRV_BRW_BKM_TYPE_DEFAULT_FILE);
    if(m_bookmarksContentProvider->getCount() == defaultFileCount)
    {
        m_toolBar->setDisableItem(FAVOURITES_BOOKMARKS_DELETE, VFX_TRUE);
    }
    else
    {
        m_toolBar->setDisableItem(FAVOURITES_BOOKMARKS_DELETE, VFX_FALSE);
    }
	#ifndef __MMI_BRW_SLIM__
	VfxU32 userFileCount = g_srv_brw_cntx.bookmark_count - defaultFileCount;
	#ifdef __MMI_BRW_BKM_FOLDER_SUPPORT__
	userFileCount -= folderCount;
	#endif
    if(userFileCount > 0)
    {
        m_toolBar->setDisableItem(FAVOURITES_EXPORT_BOOKMARK, VFX_FALSE);
    }
    else
    {
        m_toolBar->setDisableItem(FAVOURITES_EXPORT_BOOKMARK, VFX_TRUE);
    }
	#endif
}

void VappBrowserBookmarkPage::onDeinit(void)
{
    if(m_multiOptionToolBar)
    {
        VFX_OBJ_CLOSE(m_multiOptionToolBar);
		if(m_bookmarksContentProvider->m_selectedListInfo)
		{
			ASSERT(m_bookmarksContentProvider->m_selectedListInfo != NULL);
        VappBrowserASMMemoryMgmt::freeMemory(m_bookmarksContentProvider->m_selectedListInfo);
			m_bookmarksContentProvider->m_selectedListInfo = NULL;
		}
    }
	if(m_bookmarkUrl)
	{
		ASSERT(m_bookmarkUrl != NULL);
		VappBrowserASMMemoryMgmt::freeMemory(m_bookmarkUrl);
		m_bookmarkUrl = NULL;
	}
    VFX_OBJ_CLOSE(m_bookmarksList);
    m_bookmarksContentProvider->deinitialize();
    VFX_OBJ_CLOSE(m_bookmarksContentProvider);
    VFX_OBJ_CLOSE(m_toolBar);
    if(m_exportbookmarkfolder)
        VFX_FREE_MEM(m_exportbookmarkfolder);
    VfxPage::onDeinit(); 
}

VfxPage* VappBrowserFavouritesPage :: onCreateTabPage(VfxId tabId)
{
	#if 0
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
		#ifndef __MMI_BRW_SLIM__
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
		#endif
		#ifdef __MMI_BRW_STORED_PAGES_SUPPORT__
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
		#endif
/* under construction !*/
/* under construction !*/
/* under construction !*/
	#endif
	if(VAPP_BRW_FAVOURITES_TAB_BOOKMARKS == tabId)
	{	
		return (showBookmarksList());
	}
	#ifndef __MMI_BRW_SLIM__
	else if(VAPP_BRW_FAVOURITES_TAB_RECENT_PAGES == tabId)
	{	
		return (showRecentPagesList());
	}
	#endif
	#ifdef __MMI_BRW_STORED_PAGES_SUPPORT__
	else if(VAPP_BRW_FAVOURITES_TAB_STORED_PAGES == tabId)
	{
		return (showStoredPagesList());
	}
	#endif
	else
	{
		return NULL;
	}
		
} 

VfxBool VappBrowserBookmarkPage::isBookMarkAddedSuccess()
{
	m_bookmarksContentProvider->m_bookmarksContext->updateFileCount();
	if(getOrignalBookmarkItems() < m_bookmarksContentProvider->m_bookmarksContext->getTotalFileCount())
	{
		return VFX_TRUE;
	}
	else
	{
		return VFX_FALSE;
	}
}

void VappBrowserFavouritesPage::onEnter(VfxBool isBackward)
{
    VcpTabCtrlPage::onEnter(isBackward);
	#ifdef __MMI_BRW_STORED_PAGES_SUPPORT__
    if((getCurrTab() == VAPP_BRW_FAVOURITES_TAB_STORED_PAGES) &&isBackward)
    { 
        m_storedPageTabPage->m_storedPagesList->updateAllItems();
        m_storedPageTabPage->updateTBState();
    }
	#endif
    if(isBackward)
    {
            m_bookmarksTabPage->m_bookmarksContentProvider->m_bookmarksContext->updateFileCount();
            m_bookmarksTabPage->m_bookmarksList->resetAllItems(VFX_TRUE);
            m_bookmarksTabPage->setUpdateNeededStatus(VFX_FALSE);
    	if(m_bookmarksTabPage->m_toolBar)
    	{
			m_bookmarksTabPage->updateTBState();
        }
		/*fix MAUI_03105205*/
		if(m_bookmarksTabPage->m_multiOptionToolBar) // if there is multiOptionToolBar, we update it.
		{
			VappBrowserApp *m_brwApp = ((VappBrowserApp *)VfxAppLauncher::getObject(m_browserAppID));
			if(m_bookmarksTabPage->isBookMarkAddedSuccess() == VFX_TRUE)
			{
				m_brwApp->scr->m_isAddBookMarkSuccess = VFX_TRUE;
			}
			if(m_brwApp->scr->m_isAddBookMarkSuccess == VFX_TRUE)
			{
				m_brwApp->scr->m_isAddBookMarkSuccess = VFX_FALSE;
				m_bookmarksTabPage->setOrignalBookmarkItems(m_bookmarksTabPage->m_bookmarksContentProvider->m_bookmarksContext->getTotalFileCount());
				m_bookmarksTabPage->onBack();
				return;
			}
		}
    }

}


void VappBrowserFavouritesPage::onQueryRotateEx(VfxScreenRotateParam & param)
{
	if(param.rotateTo == VFX_SCR_ROTATE_TYPE_0 || param.rotateTo == VFX_SCR_ROTATE_TYPE_270 || param.rotateTo == VFX_SCR_ROTATE_TYPE_90) 
	{
				
	}
	else
	{
		param.rotateTo = VFX_SCR_ROTATE_TYPE_NORMAL;
}

}



#ifdef __MMI_BRW_STORED_PAGES_SUPPORT__

//Stored pages details
void VappBrowserStoredPageDetailsPage::onInit(void)
{
    VfxPage::onInit(); 
    VFX_OBJ_CREATE(m_popup,VcpIndicatorPopup,this);
    m_popup->setInfoType(VCP_INDICATOR_POPUP_STYLE_ACTIVITY);
    m_popup->setText(VFX_WSTR_RES(STR_ID_VAPP_BRW_PLEASE_WAIT));
    m_popup->setAutoDestory(VFX_FALSE);
    m_popup->show(VFX_TRUE);
    requestStoredPageData();
}

void VappBrowserStoredPageDetailsPage::requestStoredPageData(void)
{
    srv_brw_act_req_struct obj = {0};
    srv_brw_list_element_req_struct data;
    obj.rsp_callback = &VappBrwServiceInterface::getStoredPageHdlr;
    data.index = m_selectedIndex;
    obj.req_data = (void*)&data;
    ((VappBrwServiceInterface *)VFX_OBJ_GET_INSTANCE(VappBrwServiceInterface))->m_getStoredPageDetailsCallback.connect(this , &VappBrowserStoredPageDetailsPage::getDetailsReceiveCallback);
    srv_brw_get_stored_page_req(&obj);
}

void VappBrowserStoredPageDetailsPage::getDetailsReceiveCallback(S32 userData, U32 result, void *data)
{
    ((VappBrwServiceInterface *)VFX_OBJ_GET_INSTANCE(VappBrwServiceInterface))->m_getStoredPageDetailsCallback.disconnect(this , &VappBrowserStoredPageDetailsPage::getDetailsReceiveCallback);
    showPage();
    m_popup->hide(VFX_TRUE);
    VFX_OBJ_CLOSE(m_popup);
}


void VappBrowserStoredPageDetailsPage::showPage(void)
{
    VFX_OBJ_CREATE(m_titleBar, VcpTitleBar, this);
    m_titleBar->setTitle(VFX_WSTR_RES(STR_ID_VAPP_BRW_DETAILS));
    setTopBar(m_titleBar); 

    VFX_OBJ_CREATE(m_toolBar, VcpToolBar, this);
    m_toolBar->addItem(STORED_PAGES_DETAILS_TAB_DELETE, VFX_WSTR_RES(STR_GLOBAL_DELETE), VCP_IMG_TOOL_BAR_COMMON_ITEM_DELETE);
    m_toolBar->m_signalButtonTap.connect(this, &VappBrowserStoredPageDetailsPage::onTBClick);

    setBottomBar(m_toolBar);
    
    VFX_OBJ_CREATE(m_textDisplay, VcpTextView, this);
    VfxRect page_rect = getRect();
    m_textDisplay->setRect(0, 0, page_rect.size.width, page_rect.size.height);
	m_textDisplay->setAlignParent(VFX_FRAME_ALIGNER_MODE_SIDE, VFX_FRAME_ALIGNER_MODE_SIDE, 
        VFX_FRAME_ALIGNER_MODE_SIDE, VFX_FRAME_ALIGNER_MODE_SIDE);

    m_outputStr = (VfxWChar*)VappBrowserASMMemoryMgmt::allocMemory(BRW_DETAILS_TEXT_MAX_LENGTH);
    memset(m_outputStr, 0, BRW_DETAILS_TEXT_MAX_LENGTH);
    m_textDisplay->setText(m_outputStr, VFX_TRUE);
    m_textDisplay->setMargins(BRW_DETAILS_MARGIN, BRW_DETAILS_MARGIN, BRW_DETAILS_MARGIN, BRW_DETAILS_MARGIN);

    VfxWString name;
    name.loadFromRes(STR_ID_VAPP_BRW_NAME);
    name += VFX_WSTR("\n");
    m_textDisplay->addDetail(name, VCP_TEXT_DETAIL_TITLE, BRW_DETAILS_TEXT_MAX_LENGTH);

    VfxWString pageTitle;
    VfxWChar *pageTitleBuff = pageTitle.lockBuf((SRV_BRW_MAX_TITLE_LENGTH+ 1) * ENCODING_LENGTH);
    mmi_chset_utf8_to_ucs2_string((U8*)pageTitleBuff, 
        (SRV_BRW_MAX_TITLE_LENGTH + 1) * ENCODING_LENGTH, 
        (U8*) srv_brw_get_stored_page_label());
    pageTitle.unlockBuf();
    pageTitle += VFX_WSTR("\n");

    m_textDisplay->addDetail(pageTitle, VCP_TEXT_DETAIL_CONTENT, BRW_DETAILS_TEXT_MAX_LENGTH);

    VfxWString url;
    url.loadFromRes(STR_ID_VAPP_BRW_URL);
    url += VFX_WSTR("\n");
    m_textDisplay->addDetail(url, VCP_TEXT_DETAIL_TITLE, BRW_DETAILS_TEXT_MAX_LENGTH);

    VfxWString pageURL;
    VfxWChar *pageURLBuff = pageURL.lockBuf((SRV_BRW_MAX_URL_LENGTH+ 1) * ENCODING_LENGTH);
    mmi_asc_to_ucs2((CHAR*) pageURLBuff, (CHAR*) srv_brw_get_stored_page_URL());
    pageURL.unlockBuf();

    m_textDisplay->addDetail(pageURL, VCP_TEXT_DETAIL_CONTENT, BRW_DETAILS_TEXT_MAX_LENGTH);
    m_textDisplay->setLineMode(VCP_TEXT_LINE_MODE_MULTI);
}


void VappBrowserStoredPageDetailsPage::onDeinit(void)
{
    VFX_OBJ_CLOSE(m_titleBar);
    VFX_OBJ_CLOSE(m_textDisplay);
    VFX_OBJ_CLOSE(m_toolBar);
    VappBrowserASMMemoryMgmt::freeMemory(m_outputStr);
    VfxPage::onDeinit(); 
}

void VappBrowserStoredPageDetailsPage::onTBClick(VfxObject* sender, VfxId id)
{
#ifdef __MMI_USB_SUPPORT__
    if(srv_usb_is_in_mass_storage_mode())
    {
        vapp_usb_unavailable_popup(0);
        return;
    }
#endif
    switch(id)
    {
        case STORED_PAGES_DETAILS_TAB_DELETE:
        {
            VcpConfirmPopup *m_confirmPopup;
            m_confirmPopup = VappBrowserUtility::displayDeleteConfirmPopup(this, VCP_POPUP_TYPE_WARNING,
                VFX_WSTR_RES(STR_ID_VAPP_BRW_DELETE_SELECTED_STORED_PAGE),
                VFX_WSTR_RES(STR_GLOBAL_DELETE));
            m_confirmPopup->m_signalButtonClicked.connect(this, &VappBrowserStoredPageDetailsPage::deleteStoredPageEventHandler);
            break;
        }
        default:
            break;
	}
}

void VappBrowserStoredPageDetailsPage::deleteStoredPageEventHandler(VfxObject* obj, VfxId id)
{
    if (id == VCP_CONFIRM_POPUP_BUTTON_USER_1)
    {
    #ifdef __MMI_USB_SUPPORT__
        if(srv_usb_is_in_mass_storage_mode())
        {
            vapp_usb_unavailable_popup(0);
            return;
        }
    #endif
        srv_brw_act_req_struct obj = {0};
        srv_brw_list_element_req_struct data;
        obj.rsp_callback = &VappBrwServiceInterface::deleteStoredPageHdlr;
        data.index = m_selectedIndex;
        ((VappBrwServiceInterface *)VFX_OBJ_GET_INSTANCE(VappBrwServiceInterface))->m_deleteStoredPageCallback.connect(this , &VappBrowserStoredPageDetailsPage::deleteStoredPageCallback);
        obj.req_data = (void*)&data;
        srv_brw_delete_stored_page_req(&obj);
        VFX_OBJ_CREATE(m_popup,VcpIndicatorPopup,this);
        m_popup->setInfoType(VCP_INDICATOR_POPUP_STYLE_ACTIVITY);
        m_popup->setText(VFX_WSTR_RES(STR_ID_VAPP_BRW_PLEASE_WAIT));
        m_popup->setAutoDestory(VFX_FALSE);
        m_popup->show(VFX_TRUE);

    }
}

void VappBrowserStoredPageDetailsPage::deleteStoredPageCallback(S32 userData, U32 result, void *data)
{
    ((VappBrwServiceInterface *)VFX_OBJ_GET_INSTANCE(VappBrwServiceInterface))->m_deleteStoredPageCallback.disconnect(this , &VappBrowserStoredPageDetailsPage::deleteStoredPageCallback);
    srv_brw_dynamic_list_free_memory(SRV_BRW_LIST_TYPE_SAVED_PAGES_LIST);
    srv_brw_act_req_struct obj = {0};
    obj.rsp_callback = ((VappBrwServiceInterface *)VFX_OBJ_GET_INSTANCE(VappBrwServiceInterface))->getStoredPageListHdlr;
    ((VappBrwServiceInterface *)VFX_OBJ_GET_INSTANCE(VappBrwServiceInterface))->m_getStoredPagesListCallback.connect(this , &VappBrowserStoredPageDetailsPage::storedPageListDataReceiveCallback);
    srv_brw_get_stored_pages_list_start_req(&obj);
}

void VappBrowserStoredPageDetailsPage::storedPageListDataReceiveCallback(S32 userData, U32 result, void *data)
{
    VappBrowserUtility::displayPopup(
        STR_GLOBAL_DONE,
        MMI_NMGR_BALLOON_TYPE_SUCCESS,
        MMI_EVENT_INFO_BALLOON);
    ((VappBrwServiceInterface *)VFX_OBJ_GET_INSTANCE(VappBrwServiceInterface))->m_getStoredPagesListCallback.disconnect(this , &VappBrowserStoredPageDetailsPage::storedPageListDataReceiveCallback);
    m_popup->hide(VFX_TRUE);
    VFX_OBJ_CLOSE(m_popup);
    getMainScr()->popPage();
}


void VappBrowserStoredPageDetailsPage::onQueryRotateEx(VfxScreenRotateParam & param)
{
	if(param.rotateTo == VFX_SCR_ROTATE_TYPE_0 || param.rotateTo == VFX_SCR_ROTATE_TYPE_270 || param.rotateTo == VFX_SCR_ROTATE_TYPE_90) 
	{
				
	}
	else
	{
		param.rotateTo = VFX_SCR_ROTATE_TYPE_NORMAL;
}
}


#endif
//Bookmark details
void VappBrowserBookmarksDetailsPage::onInit(void)
{
    VfxPage::onInit(); 

    VFX_OBJ_CREATE(m_titleBar, VcpTitleBar, this);
    m_titleBar->setTitle(VFX_WSTR_RES(STR_ID_VAPP_BRW_BOOKMARK_DETAILS));
    setTopBar(m_titleBar); 

    srv_brw_bkm_types_enum file_type = g_srv_brw_cntx.bkm_cntx_p[m_selFileIndex].type;
    if(file_type != SRV_BRW_BKM_TYPE_DEFAULT_FILE)
    {
        VFX_OBJ_CREATE(m_toolBar, VcpToolBar, this);
        m_toolBar->addItem(BOOKMARKS_DETAILS_TAB_EDIT,  VFX_WSTR_RES(STR_GLOBAL_EDIT), VCP_IMG_TOOL_BAR_COMMON_ITEM_EDIT);
		#ifndef __MMI_BRW_SLIM__
        m_toolBar->addItem(BOOKMARKS_DETAILS_TAB_SHARE, VFX_WSTR_RES(STR_GLOBAL_SHARE), VCP_IMG_TOOL_BAR_COMMON_ITEM_SHARE);
		#endif
        m_toolBar->addItem(BOOKMARKS_DETAILS_TAB_DELETE, VFX_WSTR_RES(STR_GLOBAL_DELETE), VCP_IMG_TOOL_BAR_COMMON_ITEM_DELETE);
        m_toolBar->m_signalButtonTap.connect(this, &VappBrowserBookmarksDetailsPage::onTBClick);
        setBottomBar(m_toolBar);
    }    
    VFX_OBJ_CREATE(m_textDisplay, VcpTextView, this);
    VfxRect page_rect = getRect();
    m_textDisplay->setRect(0, 0, page_rect.size.width, page_rect.size.height);

    m_outputStr = (VfxWChar*) VappBrowserASMMemoryMgmt::allocMemory(BRW_DETAILS_TEXT_MAX_LENGTH);
    memset(m_outputStr, 0, BRW_DETAILS_TEXT_MAX_LENGTH);
    m_textDisplay->setText(m_outputStr, VFX_TRUE);
	m_textDisplay->setAlignParent(VFX_FRAME_ALIGNER_MODE_SIDE, VFX_FRAME_ALIGNER_MODE_SIDE, 
        VFX_FRAME_ALIGNER_MODE_SIDE, VFX_FRAME_ALIGNER_MODE_SIDE);

    m_textDisplay->setLineMode(VCP_TEXT_LINE_MODE_MULTI);
    m_textDisplay->setMargins(BRW_DETAILS_MARGIN, BRW_DETAILS_MARGIN, BRW_DETAILS_MARGIN, BRW_DETAILS_MARGIN);

    VfxWString name;
    name.loadFromRes(STR_ID_VAPP_BRW_NAME);
    name += VFX_WSTR("\n");
    m_textDisplay->addDetail(name, VCP_TEXT_DETAIL_TITLE, BRW_DETAILS_TEXT_MAX_LENGTH);

    VfxWString bookmarkTitle;
    VfxWChar *bookmarkTitleBuff = bookmarkTitle.lockBuf((SRV_BRW_MAX_TITLE_LENGTH+ 1) * ENCODING_LENGTH);
    mmi_chset_utf8_to_ucs2_string((kal_uint8*) bookmarkTitleBuff, 
        SRV_BRW_MAX_TITLE_LENGTH * ENCODING_LENGTH,
        (kal_uint8*) g_srv_brw_cntx.bkm_cntx_p[m_selFileIndex].title);
    bookmarkTitle.unlockBuf();
    bookmarkTitle += VFX_WSTR("\n");

    m_textDisplay->addDetail(bookmarkTitle, VCP_TEXT_DETAIL_CONTENT, BRW_DETAILS_TEXT_MAX_LENGTH);

    VfxWString url;
    url.loadFromRes(STR_GLOBAL_ADDRESS);
    url += VFX_WSTR("\n");
    m_textDisplay->addDetail(url, VCP_TEXT_DETAIL_TITLE, BRW_DETAILS_TEXT_MAX_LENGTH);

    VfxWChar *bookmarkURLBuff = (VfxWChar*) VappBrowserASMMemoryMgmt::allocMemory((SRV_BRW_MAX_URL_LENGTH+ 1) * ENCODING_LENGTH);
    memset(bookmarkURLBuff, 0, (SRV_BRW_MAX_URL_LENGTH+ 1) * ENCODING_LENGTH);
    mmi_asc_to_ucs2((CHAR*) bookmarkURLBuff, (CHAR*)g_srv_brw_cntx.bkm_cntx_p[m_selFileIndex].url);
    VfxWString bookmarkURL;
    bookmarkURL.loadFromMem(bookmarkURLBuff);
    VappBrowserASMMemoryMgmt::freeMemory(bookmarkURLBuff);
    bookmarkURL += VFX_WSTR("\n");

    m_textDisplay->addDetail(bookmarkURL, VCP_TEXT_DETAIL_CONTENT, BRW_DETAILS_TEXT_MAX_LENGTH);

	#ifdef __MMI_BRW_BKM_FOLDER_SUPPORT__
    VfxWString folder;
    folder.loadFromRes(STR_ID_VAPP_BRW_FOLDER_NAME);
    folder += VFX_WSTR("\n");
    m_textDisplay->addDetail(folder, VCP_TEXT_DETAIL_TITLE, BRW_DETAILS_TEXT_MAX_LENGTH);

    if(g_srv_brw_cntx.bkm_cntx_p[m_selFileIndex].parent_index == SRV_BRW_ROOT_PARENT_INDEX)
    {
        VfxWString folderName;
        folderName.loadFromRes(STR_ID_VAPP_BRW_BOOKMARKS);
        m_textDisplay->addDetail(folderName, VCP_TEXT_DETAIL_CONTENT, BRW_DETAILS_TEXT_MAX_LENGTH);
    }
    else
    {
        VfxWString folderName;
        VfxWChar *folderNameBuff = folderName.lockBuf((SRV_BRW_MAX_TITLE_LENGTH+ 1) * ENCODING_LENGTH);
        mmi_chset_utf8_to_ucs2_string((kal_uint8*) folderNameBuff, 
            SRV_BRW_MAX_TITLE_LENGTH * ENCODING_LENGTH,
            (kal_uint8*) g_srv_brw_cntx.bkm_cntx_p[g_srv_brw_cntx.bkm_cntx_p[m_selFileIndex].parent_index].title);
        folderName.unlockBuf();
        m_textDisplay->addDetail(folderName, VCP_TEXT_DETAIL_CONTENT, BRW_DETAILS_TEXT_MAX_LENGTH);
    }
	#endif
}

void VappBrowserBookmarksDetailsPage::onDeinit(void)
{
    VFX_OBJ_CLOSE(m_titleBar);
    VFX_OBJ_CLOSE(m_textDisplay);
    if(m_toolBar)
    {
        VFX_OBJ_CLOSE(m_toolBar);
    }
    VappBrowserASMMemoryMgmt::freeMemory(m_outputStr);
    VfxPage::onDeinit(); 
}

void VappBrowserBookmarksDetailsPage::onTBClick(VfxObject* sender, VfxId id)
{
    switch(id)
    {
        case BOOKMARKS_DETAILS_TAB_EDIT:
        {
            VappBrowserApp *m_brwApp = ((VappBrowserApp *)VfxAppLauncher::getObject(m_browserAppID));
            VFX_OBJ_CREATE_EX(m_brwApp->scr->m_addBookmarkPage,VappBrowserAddBookmark,m_brwApp->scr, 
                                                        (m_selFileIndex));
            m_brwApp->scr->pushPage(BRW_PAGE_ADD_BOOKMARK, m_brwApp->scr->m_addBookmarkPage);
            break;
        }
		#ifndef __MMI_BRW_SLIM__
        case BOOKMARKS_DETAILS_TAB_SHARE:
        {
            VappBrowserShareLink *m_browserShareLink;
            VfxWChar *shareURL = (VfxWChar*)VappBrowserASMMemoryMgmt::allocMemory((SRV_BRW_MAX_URL_LENGTH + 1) * ENCODING_LENGTH);
            memset(shareURL, 0, (SRV_BRW_MAX_URL_LENGTH + 1) * ENCODING_LENGTH);
            mmi_asc_n_to_ucs2((CHAR*)shareURL, (CHAR*) g_srv_brw_cntx.bkm_cntx_p[m_selFileIndex].url, SRV_BRW_MAX_URL_LENGTH);
            VFX_OBJ_CREATE_EX(m_browserShareLink, VappBrowserShareLink, this, (shareURL));
            m_browserShareLink->showCommandPopup();
            VappBrowserASMMemoryMgmt::freeMemory(shareURL);
            break;
        }
		#endif
		
        case BOOKMARKS_DETAILS_TAB_DELETE:
        {
            VcpConfirmPopup *m_confirmPopup;
            m_confirmPopup = VappBrowserUtility::displayDeleteConfirmPopup(this, VCP_POPUP_TYPE_WARNING,
                VFX_WSTR_RES(STR_ID_VAPP_BRW_DELETE_SELECTED_BOOKMARK),
                VFX_WSTR_RES(STR_GLOBAL_DELETE));
            m_confirmPopup->m_signalButtonClicked.connect(this, &VappBrowserBookmarksDetailsPage::bookmarkDeleteHandler);
            break;
        }

        default:
            break;
	}
}

void VappBrowserBookmarksDetailsPage::bookmarkDeleteHandler(VfxObject* obj, VfxId id)
{
    if (id == VCP_CONFIRM_POPUP_BUTTON_USER_1)
    {
        VfxS32 error_code = srv_brw_bkm_delete_bookmark(m_selFileIndex);
        if(error_code >= 0)
        {
            VappBrowserUtility::displayPopup(
                STR_GLOBAL_DONE,
                MMI_NMGR_BALLOON_TYPE_SUCCESS,
                MMI_EVENT_INFO_BALLOON);
            m_deleteCallback.emit();
            getMainScr()->closePage(BRW_PAGE_BOOKMARK_DETAILS);
        }
        else
        {
            VappBrowserUtility::fileSystemErrorHandler(error_code);
        }
    }
}



void VappBrowserBookmarksDetailsPage::onQueryRotateEx(VfxScreenRotateParam & param)
{
	if(param.rotateTo == VFX_SCR_ROTATE_TYPE_0 || param.rotateTo == VFX_SCR_ROTATE_TYPE_270 || param.rotateTo == VFX_SCR_ROTATE_TYPE_90) 
	{
				
	}
	else
	{
		param.rotateTo = VFX_SCR_ROTATE_TYPE_NORMAL;
	}
}

// Add Bookmark Page Begin
VappBrowserAddBookmark::VappBrowserAddBookmark(VfxU8 selFileIndex):
		m_bookmarkMode(BOOKMARK_MODE_EDIT),
		m_selectedFileIndex(selFileIndex),
        m_titleBar(NULL),
        m_form(NULL),
        m_titleCaption(NULL),
        m_UrlCaption(NULL),
        m_titleInput(NULL),
        m_UrlInput(NULL),
        #ifdef __MMI_BRW_BKM_FOLDER_SUPPORT__
        m_selectedParentFolder(NULL),
        m_parentFolderCaption(NULL),
        m_parentFolderCell(NULL),
        #endif
        m_toolBar(NULL),
        m_funcBar(NULL)
{
	#ifdef __MMI_BRW_BKM_FOLDER_SUPPORT__
    if(g_srv_brw_cntx.bkm_cntx_p[selFileIndex].parent_index != SRV_BRW_ROOT_PARENT_INDEX)
    {
        VfxWChar *parentFolderBuffPtr = m_parentFolder.lockBuf((SRV_BRW_BKM_MAX_FILE_NAME_LEN + 1) *ENCODING_LENGTH);
        mmi_chset_utf8_to_ucs2_string((kal_uint8*) parentFolderBuffPtr, 
            (SRV_BRW_BKM_MAX_FILE_NAME_LEN + 1) * ENCODING_LENGTH,
            (kal_uint8*) g_srv_brw_cntx.bkm_cntx_p[g_srv_brw_cntx.bkm_cntx_p[selFileIndex].parent_index].title);
        m_parentFolder.unlockBuf();
    }
    else
	#endif
    {
        m_parentFolder.setEmpty();
    }
}

void VappBrowserAddBookmark::onInit(void)
{
    VfxPage::onInit();
    VFX_OBJ_CREATE(m_titleBar, VcpTitleBar, this);
    if(m_bookmarkMode == BOOKMARK_MODE_ADD)
    {
        m_titleBar->setTitle(VFX_WSTR_RES(STR_ID_VAPP_BRW_ADD_BOOKMARK));
    }
    else if (m_bookmarkMode == BOOKMARK_MODE_EDIT)
    {
        m_titleBar->setTitle(VFX_WSTR_RES(STR_ID_VAPP_BRW_EDIT_BOOKMARK));
    }
    else if (m_bookmarkMode == BOOKMARK_MODE_ADD_TO)
    {
        m_titleBar->setTitle(VFX_WSTR_RES(STR_ID_VAPP_BRW_ADD_TO_BOOKMARK));
    }
	#ifdef __MMI_BRW_BKM_FOLDER_SUPPORT__
    VFX_ALLOC_MEM(m_selectedParentFolder, (SRV_BRW_BKM_MAX_PATH_LEN + 1) *ENCODING_LENGTH, this);
    memset(m_selectedParentFolder, 0, (SRV_BRW_BKM_MAX_PATH_LEN + 1) *ENCODING_LENGTH);
    if(m_bookmarkMode != BOOKMARK_MODE_ADD_TO)
    {
        VfxWChar *parentFolderBuffPtr = m_parentFolder.lockBuf((SRV_BRW_BKM_MAX_PATH_LEN + 1) *ENCODING_LENGTH);
        mmi_ucs2cpy((CHAR*) m_selectedParentFolder, (CHAR*) parentFolderBuffPtr);
        m_parentFolder.unlockBuf();
    }
	#endif
    setTopBar(m_titleBar);

    VfxWChar *m_bookmarkTitle;
    VFX_ALLOC_MEM(m_bookmarkTitle, (SRV_BRW_MAX_TITLE_LENGTH + 1) *ENCODING_LENGTH, this);
    memset(m_bookmarkTitle, 0, (SRV_BRW_MAX_TITLE_LENGTH + 1) * ENCODING_LENGTH);
    VfxWChar *m_bookmarkURL;
    VFX_ALLOC_MEM(m_bookmarkURL, (SRV_BRW_MAX_URL_LENGTH + 1) *ENCODING_LENGTH, this);
    memset(m_bookmarkURL, 0, (SRV_BRW_MAX_URL_LENGTH + 1) * ENCODING_LENGTH);

    if(m_bookmarkMode == BOOKMARK_MODE_ADD_TO)
    {
        if(!(m_titleStrimg.isEmpty()))
            mmi_ucs2ncpy((CHAR*)m_bookmarkTitle, (const CHAR*)m_titleStrimg.getBuf() , SRV_BRW_MAX_TITLE_LENGTH);
        mmi_ucs2ncpy((CHAR*)m_bookmarkURL, (const CHAR*)m_urlStrimg.getBuf() , SRV_BRW_MAX_URL_LENGTH);
    }
    VFX_OBJ_CREATE(m_toolBar, VcpToolBar, this);
    m_toolBar->addItem(ADD_BOOKMARK_SAVE, VFX_WSTR_RES(STR_GLOBAL_SAVE), VCP_IMG_TOOL_BAR_COMMON_ITEM_SAVE);
    m_toolBar->addItem(ADD_BOOKMARK_CANCEL, VFX_WSTR_RES(STR_GLOBAL_CANCEL), VCP_IMG_TOOL_BAR_COMMON_ITEM_CANCEL);
    m_toolBar->m_signalButtonTap.connect(this, &VappBrowserAddBookmark::onTBClick);
    setBottomBar(m_toolBar); 

    VFX_OBJ_CREATE(m_form, VcpForm, this);

    VfxRect page_rect = getRect();
    m_form->setRect(0, 0, page_rect.size.width, page_rect.size.height );
    m_form->setAlignParent(VFX_FRAME_ALIGNER_MODE_SIDE, VFX_FRAME_ALIGNER_MODE_SIDE, 
        VFX_FRAME_ALIGNER_MODE_SIDE, VFX_FRAME_ALIGNER_MODE_SIDE);

    VFX_OBJ_CREATE(m_titleCaption , VcpFormItemCaption, this);
    m_titleCaption->setText(VFX_WSTR_RES(STR_ID_VAPP_BRW_NAME));

    VFX_OBJ_CREATE(m_titleInput, VcpFormItemTextInput, m_form);
    VcpTextEditor *textEditor = m_titleInput->getTextBox();
    if (m_bookmarkMode == BOOKMARK_MODE_EDIT)
    {
        mmi_chset_utf8_to_ucs2_string((kal_uint8*) m_bookmarkTitle, 
            SRV_BRW_BKM_MAX_FILE_NAME_LEN * ENCODING_LENGTH,
            (kal_uint8*) g_srv_brw_cntx.bkm_cntx_p[m_selectedFileIndex].title);
    }
    textEditor->setText(m_bookmarkTitle, SRV_BRW_BKM_MAX_INPUT_FILE_NAME_LEN, VFX_FALSE, VCP_TEXT_ENCODING_ASCII);

    VsrvInputBinding inputBinding(
        IMM_INPUT_TYPE_SENTENCE,
        IME_DISABLE_NEW_LINE_SYMBOL,
        IME_INPUT_STYLE_NONE,
        textEditor->m_editing
        );
    inputBinding.setDisabledChars(VFX_WSTR_MEM((VfxWChar*)srv_fmgr_path_get_invalid_chars()));
    textEditor->setIME(inputBinding);

    VFX_OBJ_CREATE(m_UrlCaption , VcpFormItemCaption, this);
    m_UrlCaption->setText(VFX_WSTR_RES(STR_ID_VAPP_BRW_URL));

    VFX_OBJ_CREATE(m_UrlInput, VcpFormItemTextInput, m_form);
    textEditor = m_UrlInput->getTextBox();
    if (m_bookmarkMode == BOOKMARK_MODE_EDIT)
    {
        mmi_asc_to_ucs2((CHAR*) m_bookmarkURL, (CHAR*)g_srv_brw_cntx.bkm_cntx_p[m_selectedFileIndex].url);
    }
    else if (m_bookmarkMode == BOOKMARK_MODE_ADD)
    {
        mmi_asc_to_ucs2((CHAR*) m_bookmarkURL, (CHAR*) BRW_DEFAULT_ENTER_ADDR_STR);
    }
    textEditor->setText(m_bookmarkURL, SRV_BRW_MAX_URL_LENGTH);
    textEditor->setIME(IMM_INPUT_TYPE_URL, IME_DISABLE_NEW_LINE_SYMBOL);
	
	#ifdef __MMI_BRW_BKM_FOLDER_SUPPORT__
    VFX_OBJ_CREATE(m_parentFolderCaption , VcpFormItemCaption, this);
    m_parentFolderCaption->setText(VFX_WSTR_RES(STR_ID_VAPP_BRW_SELECT_FOLDER));

    VFX_OBJ_CREATE(m_parentFolderCell, VcpFormItemLauncherCell, m_form);
    VfxWString folderName;
    if(m_parentFolder.isEmpty())
    {
        m_parentFolderCell->setMainText(VFX_WSTR_RES(STR_ID_VAPP_BRW_BOOKMARKS));
    }
    else
    {
        m_parentFolderCell->setMainText(m_parentFolder);
    }
    m_parentFolderCell->setAccessory(VCPFORM_NEXT_ITEM_ICON);
    m_parentFolderCell->m_signalTap.connect(this, &VappBrowserAddBookmark::onButtonClicked);
	#endif
	
    m_form->addItem(m_titleCaption,0);
    m_form->addItem(m_titleInput,1);
    m_form->addItem(m_UrlCaption,2);
    m_form->addItem(m_UrlInput,3);
	#ifdef __MMI_BRW_BKM_FOLDER_SUPPORT__
    m_form->addItem(m_parentFolderCaption,4);
    m_form->addItem(m_parentFolderCell,5);
	#endif

    VFX_OBJ_CREATE(m_funcBar, VcpFunctionBar, this);
    m_funcBar->addItem(BOOKMARK_FB_PREV, VFX_WSTR_RES(STR_ID_VAPP_BRW_PREV));
    m_funcBar->setDisableItem(BOOKMARK_FB_PREV, VFX_TRUE);
    m_funcBar->addItem(BOOKMARK_FB_NEXT, VFX_WSTR_RES(STR_ID_VAPP_BRW_NEXT));
    m_funcBar->addItem(BOOKMARK_FB_SAVE, VFX_WSTR_RES(STR_GLOBAL_SAVE));
    m_funcBar->setItemSpecial(BOOKMARK_FB_SAVE);
    (m_titleInput->getTextBox())->setFunctionBar(m_funcBar);

    (m_UrlInput->getTextBox())->setFunctionBar(m_funcBar);
    m_funcBar->m_signalButtonTap.connect(this,&VappBrowserAddBookmark::onFuncBarItemSelected);

    VFX_FREE_MEM(m_bookmarkTitle);
    VFX_FREE_MEM(m_bookmarkURL);
    m_titleInput->getTextBox()->activate();
    m_titleInput->getTextBox()->m_signalActivated.connect(this, &VappBrowserAddBookmark::onTitleEditorActivated);
    m_UrlInput->getTextBox()->m_signalActivated.connect(this, &VappBrowserAddBookmark::onUrlEditorActivated);
}

void VappBrowserAddBookmark::onTitleEditorActivated(VcpTextEditor *editor, VfxBool activated)
{
    if(activated)
    {
        onFuncBarItemSelected((VfxObject*)m_funcBar, BOOKMARK_FB_PREV);
    }
}

void VappBrowserAddBookmark::onUrlEditorActivated(VcpTextEditor *editor, VfxBool activated)
{
    if(activated)
    {
        onFuncBarItemSelected((VfxObject*)m_funcBar, BOOKMARK_FB_NEXT);
    }
}

void VappBrowserAddBookmark::onFuncBarItemSelected(VfxObject *sender, VfxId id)
{
    switch(id)
    {
        case BOOKMARK_FB_NEXT:
        {
            m_funcBar->setDisableItem(BOOKMARK_FB_PREV, VFX_FALSE);
            m_funcBar->setDisableItem(BOOKMARK_FB_NEXT, VFX_TRUE);
            //m_form->scrollItemToView(3, VCPFORM_SCROLL_BOTTOM);
            (m_UrlInput->getTextBox())->activate();
			/* fix MAUI_03094490 */
			m_form->scrollItemToView(m_UrlInput->getId(),VCPFORM_SCROLL_BOTTOM,VFX_TRUE);
            break;
        }

        case BOOKMARK_FB_PREV:
        {
            m_funcBar->setDisableItem(BOOKMARK_FB_PREV, VFX_TRUE);
            m_funcBar->setDisableItem(BOOKMARK_FB_NEXT, VFX_FALSE);
            //m_form->scrollItemToView(1, VCPFORM_SCROLL_BOTTOM);
            (m_titleInput->getTextBox())->activate();
			/* fix MAUI_03094490 */
			m_form->scrollItemToView(m_titleInput->getId(),VCPFORM_SCROLL_BOTTOM,VFX_TRUE);
            break;
        }

        case BOOKMARK_FB_SAVE:
        {
            onTBClick((VfxObject*)m_toolBar, ADD_BOOKMARK_SAVE);
            break;
        }
    }
}

#ifdef __MMI_BRW_BKM_FOLDER_SUPPORT__
void VappBrowserAddBookmark::onButtonClicked(VcpFormItemCell* sender, VfxId Id)
{
	m_titleInput->getTextBox()->deactivate();
	m_UrlInput->getTextBox()->deactivate();
    if(m_bowserBookmarkCuiId != GRP_ID_INVALID)
    {
        VappBrwBookmarkCui *bookmarkCui = ((VappBrwBookmarkCui *)VfxAppLauncher::getObject(m_bowserBookmarkCuiId));
	    VFX_OBJ_CREATE_EX(bookmarkCui->m_bookmarkScr->m_selectFolderPage ,VappBrowserSelectFolderPage,bookmarkCui->m_bookmarkScr, (m_selectedParentFolder));
        bookmarkCui->m_bookmarkScr->pushPage(0, bookmarkCui->m_bookmarkScr->m_selectFolderPage);
        bookmarkCui->m_bookmarkScr->m_selectFolderPage->m_selectedFolderCallback.connect(this, &VappBrowserAddBookmark::onFolderSelect);
    }
    else
    {
        VappBrowserApp *m_brwApp = ((VappBrowserApp *)VfxAppLauncher::getObject(m_browserAppID));
	    VFX_OBJ_CREATE_EX(m_brwApp->scr->m_selectFolderPage ,VappBrowserSelectFolderPage,m_brwApp->scr, (m_selectedParentFolder));
        m_brwApp->scr->pushPage(BRW_PAGE_SELECT_FOLDER, m_brwApp->scr->m_selectFolderPage);
        m_brwApp->scr->m_selectFolderPage->m_selectedFolderCallback.connect(this, &VappBrowserAddBookmark::onFolderSelect);
    }
}

void VappBrowserAddBookmark::onFolderSelect(VfxWChar *selectedFolderPath)
{
    mmi_ucs2ncpy((CHAR*)m_selectedParentFolder, (CHAR*)selectedFolderPath , SRV_BRW_BKM_MAX_PATH_LEN);
    if(m_selectedParentFolder[0] == 0)
    {
        m_parentFolderCell->setMainText(VFX_WSTR_RES(STR_ID_VAPP_BRW_BOOKMARKS));
    }
    else
    {
        m_parentFolderCell->setMainText(VFX_WSTR_MEM(m_selectedParentFolder));
    }
}
#endif

void VappBrowserAddBookmark::onTBClick(VfxObject* sender, VfxId id)
{
    switch(id)
    {
        case ADD_BOOKMARK_SAVE:
        {
            srv_brw_bookmark_file_struct *obj;
            VFX_ALLOC_MEM(obj, sizeof(srv_brw_bookmark_file_struct), this);
            memset(obj, 0, sizeof(srv_brw_bookmark_file_struct));
            if(!(m_titleInput->getText().isEmpty()))
            {
                mmi_ucs2ncpy((CHAR*)obj->file_name, (CHAR*)(m_titleInput->getText().getBuf()), SRV_BRW_BKM_MAX_INPUT_FILE_NAME_LEN);
            }
            mmi_ucs2ncpy((CHAR*)obj->file_url, (CHAR*)(m_UrlInput->getText().getBuf()), SRV_BRW_MAX_URL_LEN);
			#ifdef __MMI_BRW_BKM_FOLDER_SUPPORT__
            mmi_chset_ucs2_to_utf8_string((U8*)obj->parent_folder,
                (SRV_BRW_BKM_MAX_FILE_NAME_LEN + 1),
                (U8*)m_selectedParentFolder);
			#endif
            if(m_bookmarkMode == BOOKMARK_MODE_EDIT)
            {
                obj->selected_bookmark_index = m_selectedFileIndex;
            }
            else
            {
                obj->selected_bookmark_index = (S8)SRV_BRW_BKM_INVALID_INDEX;// this warning need discuss with service
            }
            S32 error_code;
            if(m_bookmarkMode == BOOKMARK_MODE_ADD || m_bookmarkMode == BOOKMARK_MODE_ADD_TO)
            {
                error_code = srv_brw_bookmark_validate_file_for_add(obj);
                if (error_code == SRV_BRW_BKM_ERROR_OK)
                {
                    error_code = srv_brw_bookmark_add_item(obj);
                }
            }
            else
            {
                error_code = srv_brw_bookmark_validate_file_for_edit(obj);
                if (error_code == SRV_BRW_BKM_ERROR_OK)
                {
                    error_code = srv_brw_bookmark_edit_item(obj, MMI_TRUE);
                }
            }
            if(error_code == SRV_BRW_BKM_ERROR_OK)
            {
                if(m_bookmarkMode != BOOKMARK_MODE_ADD_TO)
                {
                    VappBrowserApp *m_brwApp = ((VappBrowserApp *)VfxAppLauncher::getObject(m_browserAppID));
					#ifdef __MMI_BRW_BKM_FOLDER_SUPPORT__
                    if(getMainScr()->getPage(BRW_PAGE_BOOKMARK_FOLDER))
                    {
                        m_brwApp->scr->m_bookmarkFolderPage->setUpdateNeededStatus(VFX_TRUE);
                    }
					#endif
					#ifndef __MMI_BRW_SLIM__
                    m_brwApp->scr->m_favouritePage->m_bookmarksTabPage->setUpdateNeededStatus(VFX_TRUE);
					m_brwApp->scr->m_favouritePage->m_bookmarksTabPage->m_bookmarksContentProvider->m_bookmarksContext->updateFileCount();
					VfxU32 bookmarkNumber = m_brwApp->scr->m_favouritePage->m_bookmarksTabPage->m_bookmarksContentProvider->m_bookmarksContext->getTotalFileCount();
					m_brwApp->scr->m_favouritePage->m_bookmarksTabPage->setOrignalBookmarkItems(bookmarkNumber);
					#else
					m_brwApp->scr->m_bookmarkPage->setUpdateNeededStatus(VFX_TRUE);
					m_brwApp->scr->m_bookmarkPage->m_bookmarksContentProvider->m_bookmarksContext->updateFileCount();
					VfxU32 bookmarkNumber = m_brwApp->scr->m_bookmarkPage->m_bookmarksContentProvider->m_bookmarksContext->getTotalFileCount();
					m_brwApp->scr->m_bookmarkPage->setOrignalBookmarkItems(bookmarkNumber);
					m_brwApp->scr->m_bookmarkPage->m_bookmarksList->resetAllItems(VFX_TRUE);
					m_brwApp->scr->m_bookmarkPage->updateTBState();
					#endif
					
                    getMainScr()->closePage(BRW_PAGE_BOOKMARK_DETAILS);
                }
				VappBrowserApp *m_brwApp = ((VappBrowserApp *)VfxAppLauncher::getObject(m_browserAppID));
				if(m_brwApp != NULL)
				{
					m_brwApp->scr->m_isAddBookMarkSuccess = VFX_TRUE;
				}
				
                getMainScr()->popPage();
                VappBrowserUtility::displayPopup(
                    STR_ID_VAPP_BRW_BOOKMARK_SAVED,
                    MMI_NMGR_BALLOON_TYPE_SUCCESS,
					MMI_EVENT_INFO_BALLOON);
            }
            else
            {
                VfxBool isTitleError = VFX_FALSE;
                VfxBool isUrlError = VFX_FALSE;
                if(error_code == SRV_BRW_BKM_ERROR_INVALID_URL)
                {
                    m_UrlInput->setWarningText((VFX_WSTR_RES(STR_GLOBAL_INVALID_URL)));
                    isUrlError = VFX_TRUE;
                }
                else
                {
                    if(error_code > SRV_BRW_BKM_ERROR_OK)
                    {
                        if (srv_brw_validate_url((U8*)obj->file_url, SRV_BRW_MAX_URL_LEN) < 0)
                        {
                            m_UrlInput->setWarningText((VFX_WSTR_RES(STR_GLOBAL_INVALID_URL)));
                            isUrlError = VFX_TRUE;
                        }
                        m_titleInput->setWarningText((VFX_WSTR_RES(VappBrowserUtility::getErrorString(error_code))));
                        isTitleError = VFX_TRUE;
                    }
                    else
                    {
                        VappBrowserUtility::fileSystemErrorHandler(error_code);
                    }
                }
                if(!isUrlError)
                {
                    m_UrlInput->setWarningText((VFX_WSTR_RES(0)));
					m_titleInput->getTextBox()->activate();
                }
                if(!isTitleError)
                {
                    m_titleInput->setWarningText((VFX_WSTR_RES(0)));
					m_UrlInput->getTextBox()->activate();
                }
            }
            VFX_FREE_MEM(obj);
            break;
        }

        case ADD_BOOKMARK_CANCEL:
            getMainScr()->popPage();
            break;

        default:
            break;
	}
}



void VappBrowserAddBookmark::onQueryRotateEx(VfxScreenRotateParam & param)
{
	if(param.rotateTo == VFX_SCR_ROTATE_TYPE_0 || param.rotateTo == VFX_SCR_ROTATE_TYPE_270 || param.rotateTo == VFX_SCR_ROTATE_TYPE_90) 
	{
				
	}
	else
	{
		param.rotateTo = VFX_SCR_ROTATE_TYPE_NORMAL;
	}
}

void VappBrowserAddBookmark::onRotate(const VfxScreenRotateParam & param)
{
	if(param.rotateTo == VFX_SCR_ROTATE_TYPE_270 || param.rotateTo == VFX_SCR_ROTATE_TYPE_90)
	{			
		//VFX_OBJ_CLOSE(m_titleBar);
		setTopBar(NULL);
		toggleBar(VFX_PAGE_BAR_LOCATION_TOP, VFX_FALSE);
		//onUpdate();
	}
	else if(param.rotateTo == VFX_SCR_ROTATE_TYPE_0)
	{

		//VFX_OBJ_CREATE(m_titleBar, VcpTitleBar, this);
		//m_titleBar->setTitle(VFX_WSTR_RES(STR_GLOBAL_EDIT));
		setTopBar(m_titleBar); 
		toggleBar(VFX_PAGE_BAR_LOCATION_TOP, VFX_TRUE);		
	}
}

void VappBrowserAddBookmark::onDeinit(void)
{
	#ifdef __MMI_BRW_BKM_FOLDER_SUPPORT__
    VFX_FREE_MEM(m_selectedParentFolder);
	#endif
    VFX_OBJ_CLOSE(m_titleBar);
    VFX_OBJ_CLOSE(m_toolBar);
    VfxPage::onDeinit(); 
}


// BookmarkFolderPage
#ifdef __MMI_BRW_BKM_FOLDER_SUPPORT__

void VappBrowserBookmarkFolderPage::onInit(void)
{
    VfxPage::onInit();
    VfxWString titleString;
    VFX_OBJ_CREATE(m_titleBar, VcpTitleBar, this);
    m_titleBar->setTitle(m_selFolderName);
    setTopBar(m_titleBar);

    VFX_OBJ_CREATE(m_bookmarksList, VcpListMenu, this);
    VFX_OBJ_CREATE(m_bookmarksContentProvider, VappBrowserBookmarksDataProvider, this);
    VfxWString folderName = VFX_WSTR_MEM(m_selFolderName);
    m_bookmarksContentProvider->initialize(folderName);

    m_bookmarksList->setContentProvider(m_bookmarksContentProvider);
    m_bookmarksContentProvider->setNormalMode(); 
    m_bookmarksList->setCellStyle(VCP_LIST_MENU_CELL_STYLE_ICON_SINGLE_TEXT);
    m_bookmarksContentProvider->updateCustomControlStatus(VFX_FALSE);
    m_bookmarksList->setMenuControlMode(VCP_LIST_MENU_CONTROL_MODE_CMD_BUTTON, VFX_FALSE);
    m_bookmarksList->m_signalCmdButtonClicked.connect(this, &VappBrowserBookmarkFolderPage::onButtonClick);
    m_bookmarksList->m_signalItemTapped.connect(this, &VappBrowserBookmarkFolderPage::onItemTap);
    m_bookmarksList->m_signalItemLongTapped.connect(this, &VappBrowserBookmarkFolderPage::onItemLongTapped);
    m_bookmarksList->m_signalItemSelectionStateChanged.connect(this, &VappBrowserBookmarkFolderPage::onSelectionChanged);

	bkmFolderSetBottomBar();
	
    VfxRect page_rect = getRect();
    m_bookmarksList->setRect(0, 0, page_rect.size.width, page_rect.size.height );
    m_bookmarksList->setAlignParent(VFX_FRAME_ALIGNER_MODE_SIDE, VFX_FRAME_ALIGNER_MODE_SIDE, 
        VFX_FRAME_ALIGNER_MODE_SIDE, VFX_FRAME_ALIGNER_MODE_SIDE);
}

void VappBrowserBookmarkFolderPage::bkmFolderSetBottomBar(void)
{
    VFX_OBJ_CREATE(m_toolBar, VcpToolBar, this);
    m_toolBar->addItem(FAVOURITES_BOOKMARKS_ADD_BOOKMARK, VFX_WSTR_RES(STR_ID_VAPP_BRW_ADD_BOOKMARK), IMG_ID_VAPP_BRW_TOOLBAR_ADD_BOOKMARK);
    m_toolBar->addItem(FAVOURITES_BOOKMARKS_DELETE, VFX_WSTR_RES(STR_GLOBAL_DELETE), VCP_IMG_TOOL_BAR_COMMON_ITEM_DELETE);
    updateTBState();

    m_toolBar->m_signalButtonTap.connect(this, &VappBrowserBookmarkFolderPage::onTBClick);
    setBottomBar(m_toolBar);
}

void VappBrowserBookmarkFolderPage::onItemLongTapped(VcpListMenu *sender, VfxU32 index)
{
    VfxWString itemText;
    sender->getItemTextIfPresent(index, VCP_LIST_MENU_FIELD_TEXT, itemText);
    VFX_OBJ_CREATE(m_contextMenu, VcpMenuPopup, this);
    m_contextMenu->setTitle(itemText);
    m_contextMenu->addItem(COMMAND_LONG_TAP_EDIT, VFX_WSTR_RES(STR_GLOBAL_EDIT));
    m_contextMenu->addItem(COMMAND_LONG_TAP_SHARE, VFX_WSTR_RES(STR_GLOBAL_SHARE));
    m_contextMenu->addItem(COMMAND_LONG_TAP_DELETE, VFX_WSTR_RES(STR_GLOBAL_DELETE));
    m_contextMenu->m_signalMenuCallback.connect(this, &VappBrowserBookmarkFolderPage::contextMenuCallack);
    m_contextMenu->show(VFX_TRUE);
    selectedBookmarkItemIndex = m_bookmarksContentProvider->m_bookmarksContext->m_bookmarkList[index].actual_index;
    vfx_adp_touch_fb_play(VFX_ADP_TOUCH_FB_TYPE_HOLD);
}

void VappBrowserBookmarkFolderPage::contextMenuCallack(VcpMenuPopup *menu, VcpMenuPopupEventEnum event, VcpMenuPopupItem *item)
{
    if(event != VCP_MENU_POPUP_EVENT_ITEM_SELECTED)
    {
        return;
    }
    switch(item->getId())
    {
        case COMMAND_LONG_TAP_EDIT:
        {
            VappBrowserApp *m_brwApp = ((VappBrowserApp *)VfxAppLauncher::getObject(m_browserAppID));
            VFX_OBJ_CREATE_EX(m_brwApp->scr->m_addBookmarkPage,VappBrowserAddBookmark,m_brwApp->scr, (selectedBookmarkItemIndex));
            m_brwApp->scr->pushPage(BRW_PAGE_ADD_BOOKMARK, m_brwApp->scr->m_addBookmarkPage);
            break;
        }

        case COMMAND_LONG_TAP_SHARE:
        {
            VappBrowserShareLink *m_browserShareLink;
            VfxWChar *shareURL = (VfxWChar*)VappBrowserASMMemoryMgmt::allocMemory((SRV_BRW_MAX_URL_LENGTH + 1) * ENCODING_LENGTH);
            memset(shareURL, 0, (SRV_BRW_MAX_URL_LENGTH + 1) * ENCODING_LENGTH);
            mmi_asc_n_to_ucs2((CHAR*)shareURL, (CHAR*) g_srv_brw_cntx.bkm_cntx_p[selectedBookmarkItemIndex].url, SRV_BRW_MAX_URL_LENGTH);
            VFX_OBJ_CREATE_EX(m_browserShareLink, VappBrowserShareLink, this, (shareURL));
            m_browserShareLink->showCommandPopup();
            VappBrowserASMMemoryMgmt::freeMemory(shareURL);
            break;
        }

        case COMMAND_LONG_TAP_DELETE:
        {
            VcpConfirmPopup *confirmPopup;
            confirmPopup = VappBrowserUtility::displayDeleteConfirmPopup(this, VCP_POPUP_TYPE_WARNING,
                VFX_WSTR_RES(STR_ID_VAPP_BRW_DELETE_SELECTED_BOOKMARK),
                VFX_WSTR_RES(STR_GLOBAL_DELETE));
            confirmPopup->m_signalButtonClicked.connect(this, &VappBrowserBookmarkFolderPage::bookmarkDeleteHandler);
            break;
        }
        default:
            break;
    }
}

void VappBrowserBookmarkFolderPage::bookmarkDeleteHandler(VfxObject* obj, VfxId id)
{
    if (id == VCP_CONFIRM_POPUP_BUTTON_USER_1)
    {
        srv_brw_bkm_delete_bookmark(selectedBookmarkItemIndex);
        m_bookmarksContentProvider->m_bookmarksContext->updateFileCount();
        m_bookmarksList->resetAllItems(VFX_TRUE);
        updateTBState();
    }
    VappBrowserASMMemoryMgmt::freeMemory(m_selectedBookmarkPath);
}

void VappBrowserBookmarkFolderPage::onQueryRotateEx(VfxScreenRotateParam & param)
{
	if(param.rotateTo == VFX_SCR_ROTATE_TYPE_0 || param.rotateTo == VFX_SCR_ROTATE_TYPE_270 || param.rotateTo == VFX_SCR_ROTATE_TYPE_90) 
	{
				
	}
	else
	{
		param.rotateTo = VFX_SCR_ROTATE_TYPE_NORMAL;
	}
}

void VappBrowserBookmarkFolderPage::onItemTap(VcpListMenu *sender, VfxU32 index)
{
    m_bookmarkUrl = (VfxWChar*)VappBrowserASMMemoryMgmt::allocMemory((SRV_BRW_MAX_URL_LENGTH + 1) * ENCODING_LENGTH);
    memset(m_bookmarkUrl, 0, (SRV_BRW_MAX_URL_LENGTH + 1) * ENCODING_LENGTH);
    VfxU8 actualIndex = m_bookmarksContentProvider->m_bookmarksContext->m_bookmarkList[index].actual_index;
    mmi_asc_to_ucs2((CHAR*) m_bookmarkUrl, (CHAR*)g_srv_brw_cntx.bkm_cntx_p[actualIndex].url);
        srv_brw_load_url_req((U8*)m_bookmarkUrl, WAP_BAM_UNKNOWN_CHARSET);
        getMainScr()->closePage(BRW_PAGE_FAVORITES);
        getMainScr()->popPage();
        VappBrowserASMMemoryMgmt::freeMemory(m_bookmarkUrl);
		m_bookmarkUrl = NULL;
    }

void VappBrowserBookmarkFolderPage::wifiBearerCallback(VfxU32 state, VfxU32 errorCause)
{
    if(state == SRV_CBM_ACTIVATED)
    {
        ((VappBrwServiceInterface *)VFX_OBJ_GET_INSTANCE(VappBrwServiceInterface))->m_setProfileCallback.connect(this , &VappBrowserBookmarkFolderPage::launchUrlCallback);
    }
    else
    {
        if(errorCause != ABM_E_REJECTED)
        {
            VappBrowserUtility::displayPopup(
                STR_ID_VAPP_BRW_CONNECTION_FAILED,
                MMI_NMGR_BALLOON_TYPE_FAILURE,
			    MMI_EVENT_INFO_BALLOON);
        }
        VFX_OBJ_CLOSE(m_popup);
        VappBrowserASMMemoryMgmt::freeMemory(m_bookmarkUrl);
		m_bookmarkUrl = NULL;
    }
    ((VappBrwServiceInterface *)VFX_OBJ_GET_INSTANCE(VappBrwServiceInterface))->m_WifiBearerCallback.disconnect(this , &VappBrowserBookmarkFolderPage::wifiBearerCallback);
}

void VappBrowserBookmarkFolderPage::launchUrlCallback(void)
{
    ((VappBrwServiceInterface *)VFX_OBJ_GET_INSTANCE(VappBrwServiceInterface))->m_setProfileCallback.disconnect(this , &VappBrowserBookmarkFolderPage::launchUrlCallback);
    srv_brw_load_url_req((U8*)m_bookmarkUrl, WAP_BAM_UNKNOWN_CHARSET);
    VFX_OBJ_CLOSE(m_popup);
    getMainScr()->closePage(BRW_PAGE_FAVORITES);
    getMainScr()->popPage();
    VappBrowserASMMemoryMgmt::freeMemory(m_bookmarkUrl);
	m_bookmarkUrl = NULL;
}

void VappBrowserBookmarkFolderPage::onButtonClick(VcpListMenu *sender, VfxU32 index)
{
    VfxU8 actualIndex = m_bookmarksContentProvider->m_bookmarksContext->m_bookmarkList[index].actual_index;
    VappBrowserApp *m_brwApp = ((VappBrowserApp *)VfxAppLauncher::getObject(m_browserAppID));
    VFX_OBJ_CREATE_EX(m_brwApp->scr->m_bookmarkDetailsPage, VappBrowserBookmarksDetailsPage, m_brwApp->scr, (actualIndex));
    m_brwApp->scr->pushPage(BRW_PAGE_BOOKMARK_DETAILS, m_brwApp->scr->m_bookmarkDetailsPage);
    m_brwApp->scr->m_bookmarkDetailsPage->m_deleteCallback.connect(this, &VappBrowserBookmarkFolderPage::onBookmarkDeleteCallback);
}

void VappBrowserBookmarkFolderPage::onBookmarkDeleteCallback()
{
    setUpdateNeededStatus(VFX_TRUE);
}

void VappBrowserBookmarkFolderPage::onTBClick(VfxObject* sender, VfxId id)
{
    switch(id)
    {
        case FAVOURITES_BOOKMARKS_DELETE:
        {
			m_bookmarksContentProvider->m_selectedListInfo = (VfxU8*)VappBrowserASMMemoryMgmt::allocMemory(SRV_BRW_BKM_MAX_COUNT);
			memset(m_bookmarksContentProvider->m_selectedListInfo, 0, SRV_BRW_BKM_MAX_COUNT);
            m_bookmarksList->m_signalCmdButtonClicked.disconnect(this, &VappBrowserBookmarkFolderPage::onButtonClick);
            m_bookmarksList->m_signalItemTapped.disconnect(this, &VappBrowserBookmarkFolderPage::onItemTap);
            m_bookmarksList->m_signalItemLongTapped.disconnect(this, &VappBrowserBookmarkFolderPage::onItemLongTapped);
            m_bookmarksList->setMenuMode(VCP_LIST_MENU_MODE_MULTI_SELECTION, VFX_TRUE);
            m_bookmarksList->resetAllItems(VFX_TRUE);
            m_bookmarksContentProvider->setSelectionMode();
            m_bookmarksList->setMenuControlMode(VCP_LIST_MENU_CONTROL_MODE_NORMAL, VFX_FALSE);
            VFX_OBJ_CREATE(m_multiOptionToolBar, VcpToolBar, this);
            m_multiOptionToolBar->addItem(MULTI_OPTION_SELECT_ALL, VFX_WSTR_RES(STR_GLOBAL_MARK_ALL), VCP_IMG_TOOL_BAR_COMMON_ITEM_SELECT_ALL);
            m_multiOptionToolBar->addItem(MULTI_OPTION_DELETE, VFX_WSTR_RES(STR_GLOBAL_DELETE), VCP_IMG_TOOL_BAR_COMMON_ITEM_DELETE);
            m_multiOptionToolBar->setDisableItem(MULTI_OPTION_DELETE, VFX_TRUE);
            m_multiOptionToolBar->addItem(MULTI_OPTION_CANCEL,  VFX_WSTR_RES(STR_GLOBAL_CANCEL), VCP_IMG_TOOL_BAR_COMMON_ITEM_CANCEL);
            m_isSelectAll = VFX_TRUE;
            m_selectedItemsCount = 0;
            m_multiOptionToolBar->m_signalButtonTap.connect(this, &VappBrowserBookmarkFolderPage::onMultiOptionTBClick);
            setBottomBar(m_multiOptionToolBar);
            
            VFX_OBJ_CREATE(m_deleteTitleBar, VcpTitleBar, this);
            m_deleteTitleBar->setTitle(VFX_WSTR_RES(STR_ID_VAPP_BRW_DELETE_BOOKMARKS));
            setTopBar(m_deleteTitleBar);
			if(m_toolBar)
			{
				VFX_OBJ_CLOSE(m_toolBar);
			}
            break;
        }

        case FAVOURITES_BOOKMARKS_ADD_BOOKMARK:
        {
            if(VappBrowserUtility::checkAvailableBookmarkMemory() == VFX_FALSE)
            {
                return;
            }
            VappBrowserApp *m_brwApp = ((VappBrowserApp *)VfxAppLauncher::getObject(m_browserAppID));
            VfxWString parent = VFX_WSTR_MEM(m_bookmarksContentProvider->m_bookmarksContext->m_selFolderName);
            VFX_OBJ_CREATE_EX(m_brwApp->scr->m_addBookmarkPage,VappBrowserAddBookmark,m_brwApp->scr, 
                                                        (parent));
            m_brwApp->scr->pushPage(BRW_PAGE_ADD_BOOKMARK, m_brwApp->scr->m_addBookmarkPage);
            setUpdateNeededStatus(VFX_TRUE);
            break;
        }

        default:
            break;
	}
}

void VappBrowserBookmarkFolderPage::selectAllItems(VfxBool isSelected)
{
    if(isSelected)
    {
        VfxU8 totalCount = m_bookmarksContentProvider->getCount();
        for(VfxU8 index = 0; index < totalCount; index++)
        {
            srv_brw_bkm_types_enum file_type = g_srv_brw_cntx.bkm_cntx_p[m_bookmarksContentProvider->m_bookmarksContext->m_bookmarkList[index].actual_index].type;
            if(file_type != SRV_BRW_BKM_TYPE_DEFAULT_FILE)
            {
                m_bookmarksContentProvider->m_selectedListInfo[index] = 1;
            }
        }
    }
    else
    {
        memset(m_bookmarksContentProvider->m_selectedListInfo, 0, m_bookmarksContentProvider->getCount());
    }
}

void VappBrowserBookmarkFolderPage::onMultiOptionTBClick(VfxObject* sender, VfxId id)
{
    switch(id)
    {
        case MULTI_OPTION_SELECT_ALL:
        {
            if(m_isSelectAll)
            {
                selectAllItems(VFX_TRUE);
                m_selectedItemsCount = m_bookmarksContentProvider->getCount();
                m_multiOptionToolBar->changeItem(MULTI_OPTION_SELECT_ALL, VFX_WSTR_RES(STR_GLOBAL_UNMARK_ALL), VCP_IMG_TOOL_BAR_COMMON_ITEM_UNSELECT_ALL);
                m_isSelectAll = VFX_FALSE;
            }
            else
            {
                selectAllItems(VFX_FALSE);
                m_selectedItemsCount = 0;
                m_multiOptionToolBar->changeItem(MULTI_OPTION_SELECT_ALL, VFX_WSTR_RES(STR_GLOBAL_MARK_ALL), VCP_IMG_TOOL_BAR_COMMON_ITEM_SELECT_ALL);
                m_isSelectAll = VFX_TRUE;
            }
            m_bookmarksList->updateAllItems();
            break;
        }

        case MULTI_OPTION_DELETE:
        {
            //VcpConfirmPopup *m_confirmPopup;
            if(m_selectedItemsCount > 1)
            {
                VfxWString deleteConfirmation;
                deleteConfirmation.loadFromRes(STR_ID_VAPP_BRW_DELETE_SELECTED_BOOKMARKS);
                VfxWString deleteConfirmationCount;
                deleteConfirmation += VFX_WSTR_RES(STR_ID_VAPP_BRW_LEFT_BRACKET);
                deleteConfirmationCount.format("%d", m_selectedItemsCount);
                deleteConfirmation += deleteConfirmationCount;
                deleteConfirmation += VFX_WSTR_RES(STR_ID_VAPP_BRW_RIGHT_BRACKET);
                deleteConfirmation += VFX_WSTR_RES(STR_ID_VAPP_BRW_QUESTION_MARK);
                m_confirmPopup = VappBrowserUtility::displayDeleteConfirmPopup(this, VCP_POPUP_TYPE_WARNING,
                    deleteConfirmation,
                    VFX_WSTR_RES(STR_GLOBAL_DELETE));
            }
            else
            {
                m_confirmPopup = VappBrowserUtility::displayDeleteConfirmPopup(this, VCP_POPUP_TYPE_WARNING,
                    VFX_WSTR_RES(STR_ID_VAPP_BRW_DELETE_SELECTED_BOOKMARK),
                    VFX_WSTR_RES(STR_GLOBAL_DELETE));
            }
            m_confirmPopup->m_signalButtonClicked.connect(this, &VappBrowserBookmarkFolderPage::multiDeleteEventHandler);
			m_confirmPopup_wpt = m_confirmPopup;
            break;
        }

        case MULTI_OPTION_CANCEL:
        {
            m_bookmarksList->m_signalCmdButtonClicked.connect(this, &VappBrowserBookmarkFolderPage::onButtonClick);
            m_bookmarksList->m_signalItemTapped.connect(this, &VappBrowserBookmarkFolderPage::onItemTap);
            m_bookmarksList->m_signalItemLongTapped.connect(this, &VappBrowserBookmarkFolderPage::onItemLongTapped);
            m_bookmarksContentProvider->setNormalMode();
            m_bookmarksList->setMenuMode(VCP_LIST_MENU_MODE_NORMAL, VFX_TRUE);
            m_bookmarksList->setMenuControlMode(VCP_LIST_MENU_CONTROL_MODE_CMD_BUTTON, VFX_FALSE);
            VFX_OBJ_CLOSE(m_multiOptionToolBar);
            m_bookmarksList->resetAllItems(VFX_TRUE);
            VFX_OBJ_CLOSE(m_deleteTitleBar);
            VappBrowserASMMemoryMgmt::freeMemory(m_bookmarksContentProvider->m_selectedListInfo);
			m_bookmarksContentProvider->m_selectedListInfo = NULL;
			bkmFolderSetBottomBar();
            //setBottomBar(m_toolBar);
            setTopBar(m_titleBar);
            break;
        }

        default:
            break;
	}
}

void VappBrowserBookmarkFolderPage::multiDeleteEventHandler(VfxObject* obj, VfxId id)
{
    if (id == VCP_CONFIRM_POPUP_BUTTON_USER_1)
    {
        VfxU8 totalCount = m_bookmarksContentProvider->getCount();
        for(VfxU8 index = 0; (index < totalCount) && (m_selectedItemsCount > 0); index++)
        {
            if(m_bookmarksContentProvider->m_selectedListInfo[index] == 1)
            {
                VfxU8 actualIndex = m_bookmarksContentProvider->m_bookmarksContext->m_bookmarkList[index].actual_index;
                srv_brw_bkm_delete_bookmark(actualIndex);
                m_selectedItemsCount--;
            }
        }
        if(m_multiOptionToolBar)
        {
            VFX_OBJ_CLOSE(m_multiOptionToolBar);
            m_bookmarksList->resetAllItems(VFX_TRUE);
            VappBrowserASMMemoryMgmt::freeMemory(m_bookmarksContentProvider->m_selectedListInfo);
			m_bookmarksContentProvider->m_selectedListInfo = NULL;
            m_bookmarksList->m_signalCmdButtonClicked.connect(this, &VappBrowserBookmarkFolderPage::onButtonClick);
            m_bookmarksList->m_signalItemTapped.connect(this, &VappBrowserBookmarkFolderPage::onItemTap);
            m_bookmarksList->m_signalItemLongTapped.connect(this, &VappBrowserBookmarkFolderPage::onItemLongTapped);
            m_bookmarksContentProvider->setNormalMode();
            m_bookmarksList->setMenuMode(VCP_LIST_MENU_MODE_NORMAL, VFX_TRUE);
            m_bookmarksList->setMenuControlMode(VCP_LIST_MENU_CONTROL_MODE_CMD_BUTTON, VFX_FALSE);
            bkmFolderSetBottomBar();
            VFX_OBJ_CLOSE(m_deleteTitleBar);
            setTopBar(m_titleBar);
        }
        m_bookmarksContentProvider->m_bookmarksContext->updateFileCount();
        m_bookmarksList->resetAllItems(VFX_TRUE);
        updateTBState();
    }
}


void VappBrowserBookmarkFolderPage::onSelectionChanged(VcpListMenu *menu, VfxU32 index, VcpListMenuItemStateEnum newState)
{
    if (newState == VCP_LIST_MENU_ITEM_STATE_SELECTED)
    {
        m_bookmarksContentProvider->m_selectedListInfo[index] = 1;
        if(m_selectedItemsCount != m_bookmarksContentProvider->getCount())
        {
            m_selectedItemsCount++;
        }
    }
    else if(newState == VCP_LIST_MENU_ITEM_STATE_UNSELECTED)
    {
        m_bookmarksContentProvider->m_selectedListInfo[index] = 0;
        if(m_selectedItemsCount > 0)
        {
            m_selectedItemsCount--;
        }
    }

	updateMulitiTBState();
	
}

void VappBrowserBookmarkFolderPage::onBack()
{
    if(m_multiOptionToolBar)
    { 
		if(m_confirmPopup_wpt.isValid())
		{
			VFX_OBJ_CLOSE(m_confirmPopup);
		}	
        m_bookmarksList->m_signalCmdButtonClicked.connect(this, &VappBrowserBookmarkFolderPage::onButtonClick);
        m_bookmarksList->m_signalItemTapped.connect(this, &VappBrowserBookmarkFolderPage::onItemTap);
        m_bookmarksList->m_signalItemLongTapped.connect(this, &VappBrowserBookmarkFolderPage::onItemLongTapped);
        m_bookmarksList->setMenuMode(VCP_LIST_MENU_MODE_NORMAL, VFX_TRUE);
        m_bookmarksContentProvider->setNormalMode();
        m_bookmarksList->setMenuControlMode(VCP_LIST_MENU_CONTROL_MODE_CMD_BUTTON, VFX_FALSE);
        VFX_OBJ_CLOSE(m_multiOptionToolBar);
        m_bookmarksList->resetAllItems(VFX_TRUE);
        VappBrowserASMMemoryMgmt::freeMemory(m_bookmarksContentProvider->m_selectedListInfo);
		m_bookmarksContentProvider->m_selectedListInfo = NULL;
        setBottomBar(m_toolBar);
        VFX_OBJ_CLOSE(m_deleteTitleBar);

		bkmFolderSetBottomBar();
		
        setTopBar(m_titleBar);
    }
    else
    {
        VfxPage::onBack();
    }
}

void VappBrowserBookmarkFolderPage::onEnter(VfxBool isBackward)
{
    //if(isUpdateNeeded())
    {
        m_bookmarksContentProvider->m_bookmarksContext->updateFileCount();
        m_bookmarksList->resetAllItems(VFX_TRUE);
        setUpdateNeededStatus(VFX_FALSE);
		if(m_toolBar)
		{
        updateTBState();
		}
		if(m_multiOptionToolBar)//if this page is shown , there is must be browser app
		{
			VappBrowserApp *m_brwApp = ((VappBrowserApp *)VfxAppLauncher::getObject(m_browserAppID));
			if(m_brwApp->scr->m_favouritePage->m_bookmarksTabPage->isBookMarkAddedSuccess() == VFX_TRUE)
			{
				m_brwApp->scr->m_isAddBookMarkSuccess = VFX_TRUE;
				m_brwApp->scr->m_favouritePage->m_bookmarksTabPage->setOrignalBookmarkItems(m_brwApp->scr->m_favouritePage->m_bookmarksTabPage->m_bookmarksContentProvider->m_bookmarksContext->getTotalFileCount());
			}
			if(m_brwApp->scr->m_isAddBookMarkSuccess == VFX_TRUE)
			{
				m_brwApp->scr->m_isAddBookMarkSuccess = VFX_FALSE;
				onBack();
				return;
			}
			updateMulitiTBState();
		}
		
    }
}

void VappBrowserBookmarkFolderPage::updateTBState(void)
{
    if(m_bookmarksContentProvider->getCount() == 0)
    {
        m_toolBar->setDisableItem(FAVOURITES_BOOKMARKS_DELETE, VFX_TRUE);
    }
    else
    {
        m_toolBar->setDisableItem(FAVOURITES_BOOKMARKS_DELETE, VFX_FALSE);
    }
}

void VappBrowserBookmarkFolderPage::updateMulitiTBState(void)
{
	if(m_selectedItemsCount == 0)
		    {
		        m_multiOptionToolBar->setDisableItem(MULTI_OPTION_DELETE, VFX_TRUE);
		        m_multiOptionToolBar->changeItem(MULTI_OPTION_SELECT_ALL, VFX_WSTR_RES(STR_GLOBAL_MARK_ALL), VCP_IMG_TOOL_BAR_COMMON_ITEM_SELECT_ALL);
		    }
		    else
		    {
		        if(m_selectedItemsCount == m_bookmarksContentProvider->getCount())
		        {
		            m_multiOptionToolBar->changeItem(MULTI_OPTION_SELECT_ALL, VFX_WSTR_RES(STR_GLOBAL_UNMARK_ALL), VCP_IMG_TOOL_BAR_COMMON_ITEM_UNSELECT_ALL);
		            m_isSelectAll = VFX_FALSE;
		        }
		        else
		        {
		            m_multiOptionToolBar->changeItem(MULTI_OPTION_SELECT_ALL, VFX_WSTR_RES(STR_GLOBAL_MARK_ALL), VCP_IMG_TOOL_BAR_COMMON_ITEM_SELECT_ALL);
		            m_isSelectAll = VFX_TRUE;
		        }
		        m_multiOptionToolBar->setDisableItem(MULTI_OPTION_DELETE, VFX_FALSE);
		    }

}


void VappBrowserBookmarkFolderPage::onDeinit(void)
{
    if(m_multiOptionToolBar)
    {
        VFX_OBJ_CLOSE(m_multiOptionToolBar);
		if(m_bookmarksContentProvider->m_selectedListInfo)
		{
			ASSERT(m_bookmarksContentProvider->m_selectedListInfo != NULL);
        VappBrowserASMMemoryMgmt::freeMemory(m_bookmarksContentProvider->m_selectedListInfo);
			m_bookmarksContentProvider->m_selectedListInfo = NULL;
		}
        
        VFX_OBJ_CLOSE(m_deleteTitleBar);
    }
    m_bookmarksContentProvider->deinitialize();
    VFX_OBJ_CLOSE(m_bookmarksList);
    VFX_OBJ_CLOSE(m_bookmarksContentProvider);
    VfxPage::onDeinit(); 
}


VappBrowserSelectFolderPage::VappBrowserSelectFolderPage(VfxWChar *selFolderName):
    m_titleBar(NULL),
    m_foldersList(NULL),
    m_foldersContentProvider(NULL),
    m_index(0)
{
    MMI_ASSERT(selFolderName);
    VFX_ALLOC_MEM(m_selFolderName, ((SRV_BRW_BKM_MAX_PATH_LEN + 1) *ENCODING_LENGTH), this);
    memset(m_selFolderName, 0, (SRV_BRW_BKM_MAX_PATH_LEN + 1) *ENCODING_LENGTH);
    mmi_ucs2cpy((CHAR*) m_selFolderName, (CHAR*) selFolderName);
}

void VappBrowserSelectFolderPage::onInit(void)
{
    VfxPage::onInit();

    VFX_OBJ_CREATE(m_titleBar, VcpTitleBar, this);
    m_titleBar->setTitle(VFX_WSTR_RES(STR_ID_VAPP_BRW_SELECT_FOLDER));
    setTopBar(m_titleBar); 

    VFX_OBJ_CREATE(m_foldersList, VcpListMenu, this);
    VFX_OBJ_CREATE(m_foldersContentProvider, VappBrowserFoldersDataProvider, this);
    VfxWString folderName = VFX_WSTR_MEM(m_selFolderName);
    m_index = m_foldersContentProvider->initialize(folderName);

    m_foldersList->setContentProvider(m_foldersContentProvider);
    m_foldersList->setCellStyle(VCP_LIST_MENU_CELL_STYLE_SINGLE_TEXT);
    m_foldersList->setMenuMode(VCP_LIST_MENU_MODE_HEAD_SINGLE_CHECK_MARK);
    m_foldersList->m_signalItemTapped.connect(this, &VappBrowserSelectFolderPage::onItemTap);

    VfxRect page_rect = getRect();
    m_foldersList->setRect(0, 0, page_rect.size.width, page_rect.size.height);
    m_foldersList->setAlignParent(VFX_FRAME_ALIGNER_MODE_SIDE, VFX_FRAME_ALIGNER_MODE_SIDE, 
        VFX_FRAME_ALIGNER_MODE_SIDE, VFX_FRAME_ALIGNER_MODE_SIDE);
	m_foldersList->setVisibleMenuItem(m_index);

	
}

void VappBrowserSelectFolderPage::onItemTap(VcpListMenu *sender, VfxU32 index)
{
    memset(m_selFolderName, 0, (SRV_BRW_BKM_MAX_PATH_LEN + 1) *ENCODING_LENGTH);
    if(index > 0)
    {
        VfxWString selFolderName;
        m_foldersList->getItemTextIfPresent(index, VCP_LIST_MENU_FIELD_TEXT, selFolderName);
        mmi_ucs2cpy((CHAR*) m_selFolderName, (CHAR*) selFolderName.getBuf());
    }
    m_selectedFolderCallback.emit(m_selFolderName);
    getMainScr()->popPage();
}

void VappBrowserSelectFolderPage::onQueryRotateEx(VfxScreenRotateParam & param)
{
	if(param.rotateTo == VFX_SCR_ROTATE_TYPE_0 || param.rotateTo == VFX_SCR_ROTATE_TYPE_270 || param.rotateTo == VFX_SCR_ROTATE_TYPE_90) 
	{
				
	}
	else
	{
		param.rotateTo = VFX_SCR_ROTATE_TYPE_NORMAL;
	}
}

void VappBrowserSelectFolderPage::onDeinit(void)
{
    VFX_FREE_MEM(m_selFolderName);
    VFX_OBJ_CLOSE(m_titleBar);
    VFX_OBJ_CLOSE(m_foldersList);
    VFX_OBJ_CLOSE(m_foldersContentProvider);
    VfxPage::onDeinit(); 
}

#endif
//#pragma arm section code, rodata

#endif /* __MMI_BROWSER_2__ */

#endif /* _VAPP_BRW_FAVOURITES_CPP_ */
