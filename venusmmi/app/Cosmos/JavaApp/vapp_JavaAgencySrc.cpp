/*****************************************************************************
*  Copyright Statement:
*  --------------------
*  This software is protected by Copyright and the information contained
*  herein is confidential. The software may not be copied and the information
*  contained herein may not be used or disclosed except with the written
*  permission of MediaTek Inc. (C) 2005
*
*  BY OPENING THIS FILE, BUYER HEREBY UNEQUIVOCALLY ACKNOWLEDGES AND AGREES
*  THAT THE SOFTWARE/FIRMWARE AND ITS DOCUMENTATIONS ("MEDIATEK SOFTWARE")
*  RECEIVED FROM MEDIATEK AND/OR ITS REPRESENTATIVES ARE PROVIDED TO BUYER ON
*  AN "AS-IS" BASIS ONLY. MEDIATEK EXPRESSLY DISCLAIMS ANY AND ALL WARRANTIES,
*  EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE IMPLIED WARRANTIES OF
*  MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE OR NONINFRINGEMENT.
*  NEITHER DOES MEDIATEK PROVIDE ANY WARRANTY WHATSOEVER WITH RESPECT TO THE
*  SOFTWARE OF ANY THIRD PARTY WHICH MAY BE USED BY, INCORPORATED IN, OR
*  SUPPLIED WITH THE MEDIATEK SOFTWARE, AND BUYER AGREES TO LOOK ONLY TO SUCH
*  THIRD PARTY FOR ANY WARRANTY CLAIM RELATING THERETO. MEDIATEK SHALL ALSO
*  NOT BE RESPONSIBLE FOR ANY MEDIATEK SOFTWARE RELEASES MADE TO BUYER'S
*  SPECIFICATION OR TO CONFORM TO A PARTICULAR STANDARD OR OPEN FORUM.
*
*  BUYER'S SOLE AND EXCLUSIVE REMEDY AND MEDIATEK'S ENTIRE AND CUMULATIVE
*  LIABILITY WITH RESPECT TO THE MEDIATEK SOFTWARE RELEASED HEREUNDER WILL BE,
*  AT MEDIATEK'S OPTION, TO REVISE OR REPLACE THE MEDIATEK SOFTWARE AT ISSUE,
*  OR REFUND ANY SOFTWARE LICENSE FEES OR SERVICE CHARGE PAID BY BUYER TO
*  MEDIATEK FOR SUCH MEDIATEK SOFTWARE AT ISSUE. 
*
*  THE TRANSACTION CONTEMPLATED HEREUNDER SHALL BE CONSTRUED IN ACCORDANCE
*  WITH THE LAWS OF THE STATE OF CALIFORNIA, USA, EXCLUDING ITS CONFLICT OF
*  LAWS PRINCIPLES.  ANY DISPUTES, CONTROVERSIES OR CLAIMS ARISING THEREOF AND
*  RELATED THERETO SHALL BE SETTLED BY ARBITRATION IN SAN FRANCISCO, CA, UNDER
*  THE RULES OF THE INTERNATIONAL CHAMBER OF COMMERCE (ICC).
*
*****************************************************************************/

/*******************************************************************************
 * Filename:
 * ---------
 *  vapp_javaagencysrc.cpp
 *
 * Project:
 * --------
 *  Venus
 *
 * Description:
 * ------------
 *  
 *
 * Author:
 * -------
 * -------
 *
 *============================================================================
 *             HISTORY
 * Below this line, this part is controlled by PVCS VM. DO NOT MODIFY!!
 *------------------------------------------------------------------------------
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 *
 *------------------------------------------------------------------------------
 * Upper this line, this part is controlled by PVCS VM. DO NOT MODIFY!!
 *============================================================================
 ****************************************************************************/

/***************************************************************************** 
 * Include
 *****************************************************************************/
#ifdef __J2ME__
#include "MMI_features.h" 
#include "vapp_JavaAgencySrc.h"
#include "mmi_rp_vapp_java_def.h"
#ifdef __AFX_RT_TEST__
#include "vtst_rt_main.h"
#endif
#include "../xml/vfx_xml_loader.h"
#include "MMI_include.h"
#include "vapp_java_adp.h"
#include "vapp_java_srv.h"
#include "vcui_dtcnt_select_gprot.h"
#include "Vcui_cbm_gprot.h"
#include "App_datetime.h"
#include "vcp_loading_popup.h"
#include "vcp_global_popup.h"
#include "vapp_javaagencymidsinstall.h"
#include "JavaAgencyNCenter.h"
#include "Jam_mvm_manager.h"
#include "TimerEvents.h"
#include "vapp_ncenter_gprot.h"
#include "vapp_charger_gprot.h"
#ifdef __MMI_USB_SUPPORT__
#include "Vapp_usb_gprot.h"
#endif
extern "C"
{
#ifdef __MMI_USB_SUPPORT__
    #include "USBSrvGProt.h"
    #include "mmi_rp_vapp_usbmmi_def.h"
#endif
#include "JavaAppFactorySrvGprot.h"
#if defined(__GADGET_SUPPORT__) && !defined(__VM_CONCURRENCE__)
    #include "MRESrvGProt.h"
#endif
    #include "App_str.h"
}
#include "vcp_global_popup.h"
#include "vapp_nmgr_gprot.h"
#include "vapp_screen_lock_gprot.h"

/***************************************************************************** 
 * Define
 *****************************************************************************/
extern "C" kal_bool g_java_list_lock;
S32 g_vjava_force_resume_global_popup = VCP_GLOBAL_POPUP_INVALID_HANDLE;
S32 g_vjava_terminate_confirm_global_popup = VCP_GLOBAL_POPUP_INVALID_HANDLE;
extern "C" mmi_ret forceResumeProc(mmi_event_struct *evt);
/***************************************************************************** 
 * Typedef
 *****************************************************************************/
typedef enum
{
        MMI_JAVA_SETTING_AUD = 0,
        //MMI_JAVA_SETTING_BKL,
        MMI_JAVA_SETTING_VIB,
#ifdef SUPPORT_JAVA_NET_ICON_SETTING
/* under construction !*/
#endif
#ifdef __MMI_FOURWAYS_KEY_DISABLE__
        MMI_JAVA_SETTING_VK,
#endif
        //MMI_JAVA_NW_SETTING,
#ifdef JAVA_SETTING_SHOW_FREE_STORAGE
        //MMI_JAVA_SETTING_STOR,
#endif
        //MMI_JAVA_HEAP,
        MMI_JAVA_SETTING_TOTAL
    }mmi_vjava_enum_setting_item_number;

/***************************************************************************** 
 * Global Variable
 *****************************************************************************/
VappJavaMIDDetailScreen *gdetailScr = NULL; 
VfxMainScr* g_parent_screen = NULL; 

VappJavaMidsSettingPage* SettingPage = NULL;
VappJavaMIDDetailControllor* g_mmi_vjava_detail_controllor = NULL;
CHAR * g_mmi_vjava_select_app_name = NULL;

VfxU32 g_vjava_per_item_index = 0;
VfxU32 g_vjava_per_item_count = 0;
extern U16* setting_select_string[5];
mmi_id g_vjava_screen_switch = GRP_ID_INVALID;
mmi_id g_vjava_always_ask;
#if !(defined(J2ME_SLIM_MEMORY_SUPPORT) && defined(__COSMOS_MMI_PACKAGE__))
VappJavaScreenSwitchScr *g_vjava_screen_switch_scr = NULL;
#endif
mids_delete_callback g_vjava_delete_callabck = NULL;
void * g_vjava_user_data = NULL;
VappJavaPopup * g_vapp_java_global_popup_scr = NULL;
kal_wchar *g_mmi_vjava_permission_text = NULL;
U16 g_mmi_vjava_permission_title_id;
VappJavaHelper vappjavaHelper;
VfxBool g_mmi_vjava_task_manager_is_push = KAL_FALSE;
kal_bool g_vjava_is_select_screen_active = KAL_FALSE;
static VfxBool g_mmi_vjava_permission_is_force_fgmmi = VFX_FALSE;
VfxId g_mmi_vjava_advanced_permission_page = 102;

VappJavaIndicatingCatScr *g_vjava_indicating_catscr_ptr=NULL;
VappJavaScreenSwitchCatScr *g_vjava_screenswitch_catscr_ptr=NULL;
VappJavaPermissionDialogCatScr *g_vjava_permissiondialog_catscr_ptr=NULL;
S32 g_vjava_terminate_confirm_popup = VCP_GLOBAL_POPUP_INVALID_HANDLE;              



/***************************************************************************** 
 * Function
 *****************************************************************************/
extern "C" void mmi_java_mids_install_internal(void);

void VappJavaHelper::reEntryInstall()
{
    if(VappJavaAgency::getInstance()&&
        VappJavaAgency::getInstance()->get_install_screen())
    {
        VappJavaAgency::getInstance()->get_install_screen()->setNeedAbortInstall(VFX_FALSE);
    }    
    vapp_java_close_venus_screen();
    if(!is_home_key_pressed)
    {
        mmi_java_mids_install_internal();
    }
    else
    {
        mmi_java_mids_install_abort();
    }
}
void VappJavaHelper::launchAfterInstall()
{
    vapp_java_close_venus_screen();
    vapp_java_launch_after_install_entry();
}
void VappJavaHelper::launchJavaApp()
{
    vapp_java_close_venus_screen();
    srv_java_appfactory_launch(SRV_APP_FACTORY_APP_LAUNCH_TYPE,g_java_current_install_app_name,NULL,0);
}
void VappJavaHelper::entryRightManager()
{
    vapp_java_close_venus_screen();
    #ifdef __MMI_JAVA_INSTALL_PUSHINSTALL__  
    mmi_java_entry_drm_acquire_right_confirm();
    #endif
}

void VappJavaHelper::restoreSettings(VfxId id, void *userData)
{
    if (id == VCP_CONFIRM_POPUP_BUTTON_USER_1)
    {
        srv_java_appfactory_set_vk_on(KAL_FALSE, (CHAR*)userData);
        
        vapp_java_get_mids_info_by_app_name((CHAR*)userData);
        if(mmi_wcslen((const U16 *)g_java.mids_info[g_java.mids_index - g_java.mids_info_start].storage_name) < 127)
        {       
            app_ucs2_str_to_asc_str((kal_int8 *) g_mmi_java_current_selected_mids_root, (kal_int8 *)g_java.mids_info[g_java.mids_index - g_java.mids_info_start].storage_name);
        }
        else
        {                
            app_ucs2_str_n_to_asc_str((kal_int8 *) g_mmi_java_current_selected_mids_root, (kal_int8 *)g_java.mids_info[g_java.mids_index - g_java.mids_info_start].storage_name, 127);
        }      
        mmi_java_send_mids_restore_req();
    }
}

void VappJavaHelper::closeJavaApp()
{
    vapp_java_close_venus_screen();
}

void VappJavaHelper::closeMIDletScreen()
{
    mmi_java_close_MIDlet_screen();
    vapp_java_close_venus_screen();
}

extern mmi_id g_mmi_vjava_ui_option_menu_gid;
void VappJavaHelper::closeJavaUIscreen()
{
    if(g_mmi_vjava_ui_option_menu_gid)
    {
        VfxAppLauncher::terminate(g_mmi_vjava_ui_option_menu_gid);
        g_mmi_vjava_ui_option_menu_gid = NULL;
    }
}

void VappJavaHelper::switchEntry()
{
    kal_trace(JAM_JAVAAGENCY_GROUP,VAPP_JAVA_HELPER_SWITCH_ENTRY,_entry);
    switch(_entry)
    {
        case VAPP_JAVA_ENTRY_NONE:            
            break;
        case VAPP_JAVA_ENTRY_LAUNCH_AFTER_INSTALL:            
            if(g_mmi_java_install_mids_id > 0 && mmi_java_is_allow_to_popup_screen())
            {
                launchAfterInstall();
            }
            else
            {
                closeJavaApp();
            }
            break;
        case VAPP_JAVA_ENTRY_RIGHT_MANAGER:
            entryRightManager();
            break;
        case VAPP_JAVA_ENTRY_REINSTALL:
            reEntryInstall();
            break;            
        case VAPP_JAVA_ENTRY_CLOSE_JAVA_APP:
            closeJavaApp();
            break;
        case VAPP_JAVA_ENTRY_CLOSE_MIDLET_SCREEN:
            closeMIDletScreen();
            break;
        default:
            ASSERT(0);        
    }
    _entry = VAPP_JAVA_ENTRY_NONE;
    is_home_key_pressed = VFX_FALSE;
}


void VappJavaHelper::closeMidSettingPage()
{
    if(SettingPage!=NULL)
        SettingPage->getMainScr()->popPage();
}

void VappJavaHelper::onResumeConfirm(VfxId id, void *userData)
{
    if(id == VCP_CONFIRM_POPUP_BUTTON_USER_1)
    {
        mmi_event_struct evt;
        MMI_FRM_INIT_EVENT(&evt, 0);
        MMI_FRM_POST_EVENT(&evt, forceResumeProc, NULL);
     }
    else if(id == VCP_CONFIRM_POPUP_BUTTON_USER_2)
    {
        if(g_mmi_java_current_selected_vm_id != -1)
        {
            jam_mvm_set_vm_resume_ind(g_mmi_java_current_selected_vm_id, KAL_FALSE);
            g_mmi_java_current_selected_vm_id = -1;
        }
    }
    vcp_global_popup_cancel(g_vjava_force_resume_global_popup);
    g_vjava_force_resume_global_popup = VCP_GLOBAL_POPUP_INVALID_HANDLE;
}


extern "C" mmi_ret TerminatingEventCB(mmi_event_struct *evt)
{
    VappJavaHelper::showTerminating();
    return MMI_RET_OK;
}


void VappJavaHelper::terminateRunningCB(VfxId id, void *userData)
{
    mmi_event_struct evt;
    if(id == VCP_CONFIRM_POPUP_BUTTON_USER_1)
    {
        g_java.screen_after_terminate = TER_ENTRY_TASK_MANAGER;
        if(jam_mvm_get_vm_state(0)!=JVM_TERMINATE_STATE &&
            jam_mvm_get_vm_state(0)!=JVM_TERMINATING_STATE)
        {
            jam_enter_terminate_mode(0);
        }
        //vfxPostInvoke0(&vappjavaHelper,&VappJavaHelper::showTerminating);
        MMI_FRM_INIT_EVENT(&evt, 0);
        MMI_FRM_POST_EVENT(&evt, TerminatingEventCB, NULL);
    }
    #if 0
/* under construction !*/
/* under construction !*/
#if(MAX_VM_INSTANCE_NUM == 1)
/* under construction !*/
/* under construction !*/
#endif
/* under construction !*/
    #endif     
    else
    {
#if(MAX_VM_INSTANCE_NUM == 1)
        mmi_frm_scrn_set_leave_proc(APP_JAVA, SCR_JAVA_DUMMY, NULL);
        mmi_frm_group_close(APP_JAVA);
#endif
    }
}

void VappJavaHelper::showTerminating(void)
{
    vapp_java_indicating_entry();
}


VFX_IMPLEMENT_CLASS("VappJavaMidsBGSettingControllor",VappJavaMidsBGSettingControllor,VfxControl);
void VappJavaMidsBGSettingControllor::setBGHandler(VcpSwitch *thiz, VfxBool status)
{
    VcpMenuPos pos;
    VFX_UNUSED(thiz);
    if(status)
        srv_java_appfactory_set_bg_enabled_apname(KAL_TRUE, g_mmi_vjava_select_app_name);
    else
        srv_java_appfactory_set_bg_enabled_apname(KAL_FALSE, g_mmi_vjava_select_app_name);
    pos.group = 0;
    pos.pos = 0;
    SettingPage->getListMenu()->updateItem(pos);
}


void VappJavaMidsBGSettingControllor::onInit()
{
    VfxControl::onInit();
}


VFX_IMPLEMENT_CLASS("VappJavaMidsVKSettingControllor",VappJavaMidsVKSettingControllor,VfxControl);
void VappJavaMidsVKSettingControllor::setVKHandler(VcpSwitch *thiz, VfxBool status)
{
    VcpMenuPos pos;
    VFX_UNUSED(thiz);
    if(status)
        srv_java_appfactory_set_vk_on(KAL_TRUE,g_mmi_vjava_select_app_name);
    else
       srv_java_appfactory_set_vk_on(KAL_FALSE,g_mmi_vjava_select_app_name);
    pos.group = 0;
    pos.pos = 0;
    SettingPage->getListMenu()->updateItem(pos);
}


void VappJavaMidsVKSettingControllor::onInit()
{
    VfxControl::onInit();
}


VFX_IMPLEMENT_CLASS("VappjavaSettingContentProvider",VappjavaSettingContentProvider,VfxObject);
void VappjavaSettingContentProvider::onInit()
{
    VfxObject::onInit();
}

VfxU32 VappjavaSettingContentProvider::getGroupCount() const
{
    if (mmi_java_nw_is_need_hide())
    {
#if (defined(J2ME_SLIM_MEMORY_SUPPORT) && defined(J2ME_SUPPORT_BACKGROUND)) || defined(__SUPPORT_JAVA_VIRTUAL_KEYPAD__)
        return 2;
#else
        return 1;
#endif
    }
    else
    {
        return 2;
    }
}


VfxU32 VappjavaSettingContentProvider::getCount(VfxU32 group) const
{
    if(mmi_java_nw_is_need_hide())
    {
#if (defined(J2ME_SLIM_MEMORY_SUPPORT) && defined(J2ME_SUPPORT_BACKGROUND)) || defined(__SUPPORT_JAVA_VIRTUAL_KEYPAD__)
        if(group == 0)
        {
            return (VAPP_JAVA_SETTING_MAX - 1);
        }
        else if(group == 1)
#else
        if(group == 0)
#endif
        {
            return J2ME_SETTING_MAX;
        }
    }
    else
    {
        if(group == 0)
        {
            return VAPP_JAVA_SETTING_MAX;
        }
        if(group == 1)
        {
            return J2ME_SETTING_MAX;
        }
    }
}

VfxBool VappjavaSettingContentProvider::getItemText(
    VcpMenuPos pos,                  // [IN] the position of item
    VcpListMenuFieldEnum fieldType,  // [IN] the type of the field in the cell
    VfxWString &text,                // [OUT] the text resource
    VcpListMenuTextColorEnum &color  // [OUT] the text color
)
{
    MMI_BOOL ret;
    srv_dtcnt_sim_type_enum simType = SRV_DTCNT_SIM_TYPE_1;

    if(mmi_java_nw_is_need_hide())
    {
#if (defined(J2ME_SLIM_MEMORY_SUPPORT) && defined(J2ME_SUPPORT_BACKGROUND)) || defined(__SUPPORT_JAVA_VIRTUAL_KEYPAD__)
        if(pos.group == 0)
        {
            switch(pos.pos)
            {
                case -1:
                    text.loadFromRes(STR_ID_VAPP_JAVA_APP_SETTINGS);
                    break;
#if defined(J2ME_SLIM_MEMORY_SUPPORT) && defined(J2ME_SUPPORT_BACKGROUND)
                case VAPP_JAVA_SETTING_SUPPORT_BG:
                    if(fieldType == VCP_LIST_MENU_FIELD_TEXT)
                       text.loadFromRes(STR_ID_VAPP_JAVA_MINIMIZE);
                    else if(fieldType == VCP_LIST_MENU_FIELD_SUB_TEXT1)
                    {
                        return VFX_FALSE;
                    }
                    break;
#endif
#ifdef __SUPPORT_JAVA_VIRTUAL_KEYPAD__
                case VAPP_JAVA_SETTING_SUPPORT_VK:
                    if(fieldType == VCP_LIST_MENU_FIELD_TEXT)
                       text.loadFromRes(STR_ID_VAPP_JAVA_VK_SWITCH);
                    else if(fieldType == VCP_LIST_MENU_FIELD_SUB_TEXT1)
                    {
                        return VFX_FALSE;
                    }
                    break;
#endif
                default:
                    break;   
            }
        }
        if(pos.group == 1)
#else
        if(pos.group == 0)
#endif
            switch(pos.pos)
                {
                    case -1:
                        text.loadFromRes(STR_ID_VAPP_JAVA_PERMISSION);
                        break;
                    case J2ME_SETTING_NETWORK_ACCESS:
                        if(fieldType == VCP_LIST_MENU_FIELD_TEXT)
                            text.loadFromRes(STR_JAVA_SETTING_NETWORK_ACCESS);
                        if(fieldType == VCP_LIST_MENU_FIELD_SUB_TEXT1)
                        {
                            text = VFX_WSTR_STATIC(vapp_jave_get_permission(J2ME_SETTING_NETWORK_ACCESS));
                            color = VCP_LIST_MENU_TEXT_COLOR_LOWLIGHT;
                        }
                        break;
                     case J2ME_SETTING_AUTO_INVOCATION:
                        if(fieldType == VCP_LIST_MENU_FIELD_TEXT)
                            text.loadFromRes(STR_JAVA_SETTING_AUTO_INVOCATION);
                        if(fieldType == VCP_LIST_MENU_FIELD_SUB_TEXT1)
                        {
                                text = VFX_WSTR_STATIC(vapp_jave_get_permission(J2ME_SETTING_AUTO_INVOCATION));
                                color = VCP_LIST_MENU_TEXT_COLOR_LOWLIGHT;
                        }
                        break;
                    case J2ME_SETTING_MESSAGING:
                        if(fieldType == VCP_LIST_MENU_FIELD_TEXT)
                            text.loadFromRes(STR_JAVA_SETTING_MESSAGING);
                        if(fieldType == VCP_LIST_MENU_FIELD_SUB_TEXT1)
                        {
                            text = VFX_WSTR_STATIC(vapp_jave_get_permission(J2ME_SETTING_MESSAGING));
                            color = VCP_LIST_MENU_TEXT_COLOR_LOWLIGHT;
                        }
                        break;
                    case J2ME_SETTING_MULTIMEDIA:
                        if(fieldType == VCP_LIST_MENU_FIELD_TEXT)
                            text.loadFromRes(STR_JAVA_SETTING_MULTIMEDIA);
                        if(fieldType == VCP_LIST_MENU_FIELD_SUB_TEXT1)
                        {
                            text = VFX_WSTR_STATIC(vapp_jave_get_permission(J2ME_SETTING_MULTIMEDIA));
                            color = VCP_LIST_MENU_TEXT_COLOR_LOWLIGHT;
                        }
                        break;
                    case J2ME_SETTING_DATA_READ:
                        if(fieldType == VCP_LIST_MENU_FIELD_TEXT)
                            text.loadFromRes(STR_JAVA_SETTING_FILE_READ);
                        if(fieldType == VCP_LIST_MENU_FIELD_SUB_TEXT1)
                        {
                            text = VFX_WSTR_STATIC(vapp_jave_get_permission(J2ME_SETTING_DATA_READ));
                            color = VCP_LIST_MENU_TEXT_COLOR_LOWLIGHT;
                        }
                        break;
                    case J2ME_SETTING_DATA_WRITE:
                        if(fieldType == VCP_LIST_MENU_FIELD_TEXT)
                            text.loadFromRes(STR_JAVA_SETTING_FILE_WRITE);
                        if(fieldType == VCP_LIST_MENU_FIELD_SUB_TEXT1)
                        {
                            text = VFX_WSTR_STATIC(vapp_jave_get_permission(J2ME_SETTING_DATA_WRITE));
                            color = VCP_LIST_MENU_TEXT_COLOR_LOWLIGHT;
                        }
                        break;
                    case J2ME_SETTING_LOCAL_CONNECTIVITY:
                        if(fieldType == VCP_LIST_MENU_FIELD_TEXT)
                            text.loadFromRes(STR_JAVA_SETTING_LOCAL_CONNECTIVITY);
                        if(fieldType == VCP_LIST_MENU_FIELD_SUB_TEXT1)
                        {
                            text = VFX_WSTR_STATIC(vapp_jave_get_permission(J2ME_SETTING_LOCAL_CONNECTIVITY));
                            color = VCP_LIST_MENU_TEXT_COLOR_LOWLIGHT;
                        }
                        break;
#ifdef SUPPORT_JSR_179
                    case J2ME_SETTING_LOCATION_ACCESS:
                        if(fieldType == VCP_LIST_MENU_FIELD_TEXT)
                            text.loadFromRes(STR_JAVA_SETTING_LOCATION_ACCESS);
                        if(fieldType == VCP_LIST_MENU_FIELD_SUB_TEXT1)
                        {
                            text = VFX_WSTR_STATIC(vapp_jave_get_permission(J2ME_SETTING_LOCATION_ACCESS));
                            color = VCP_LIST_MENU_TEXT_COLOR_LOWLIGHT;
                        }
                        break;
#endif                        
#ifdef SUPPORT_JSR_177
                    case J2ME_SETTING_SATSA:
                        if(fieldType == VCP_LIST_MENU_FIELD_TEXT)
                            text.loadFromRes(STR_JAVA_SECURITY_TRUST);
                        if(fieldType == VCP_LIST_MENU_FIELD_SUB_TEXT1)
                        {
                            text = VFX_WSTR_STATIC(vapp_jave_get_permission(J2ME_SETTING_SATSA));
                            color = VCP_LIST_MENU_TEXT_COLOR_LOWLIGHT;
                        }
                        break;
#endif
#if SUPPORT_JSR_257
                case J2ME_SETTING_CONTACTLESS_COMMUNICATION:
                    if(fieldType == VCP_LIST_MENU_FIELD_TEXT)
                        text.loadFromRes(STR_JAVA_CONTACTLESS_COMMUNICATION);
                    if(fieldType == VCP_LIST_MENU_FIELD_SUB_TEXT1)
                    {
                        text = VFX_WSTR_STATIC(vapp_jave_get_permission(J2ME_SETTING_CONTACTLESS_COMMUNICATION));
                        color = VCP_LIST_MENU_TEXT_COLOR_LOWLIGHT;
                    }
                    break;
#endif
                    default:
                        break;              
                }
    }
    else /* mmi_java_nw_is_need_hide() */
    {
        if(pos.group == 0)
        {
            switch(pos.pos)
            {
                case -1:
                    text.loadFromRes(STR_ID_VAPP_JAVA_APP_SETTINGS);
                    break;
#if defined(J2ME_SLIM_MEMORY_SUPPORT) && defined(J2ME_SUPPORT_BACKGROUND)
                case VAPP_JAVA_SETTING_SUPPORT_BG:
                    if(fieldType == VCP_LIST_MENU_FIELD_TEXT)
                       text.loadFromRes(STR_ID_VAPP_JAVA_MINIMIZE);
                    else if(fieldType == VCP_LIST_MENU_FIELD_SUB_TEXT1)
                    {
                        return VFX_FALSE;
                    }
                    break;
#endif
                #ifdef __SUPPORT_JAVA_VIRTUAL_KEYPAD__
                case VAPP_JAVA_SETTING_SUPPORT_VK:
                    if(fieldType == VCP_LIST_MENU_FIELD_TEXT)
                       text.loadFromRes(STR_ID_VAPP_JAVA_VK_SWITCH);
                    else if(fieldType == VCP_LIST_MENU_FIELD_SUB_TEXT1)
                    {
                        return VFX_FALSE;
                    }
                    break; 
        #endif                    
                case VAPP_JAVA_SETTING_DATA_ACCOUNT:                
                    if(fieldType == VCP_LIST_MENU_FIELD_TEXT)            
                        text.loadFromRes(STR_GLOBAL_DATA_CONN_SETTING);
                    if(fieldType == VCP_LIST_MENU_FIELD_SUB_TEXT1)
                    {   
                        return VFX_FALSE;
                    }
                    break;
                default:
                    break;   
            }
        }
        if(pos.group == 1)
        {
                switch(pos.pos)
                {
                    case -1:
                        text.loadFromRes(STR_ID_VAPP_JAVA_PERMISSION);
                        break;
                    case J2ME_SETTING_NETWORK_ACCESS:
                        if(fieldType == VCP_LIST_MENU_FIELD_TEXT)
                            text.loadFromRes(STR_JAVA_SETTING_NETWORK_ACCESS);
                        if(fieldType == VCP_LIST_MENU_FIELD_SUB_TEXT1)
                            {
                                text = VFX_WSTR_STATIC(vapp_jave_get_permission(J2ME_SETTING_NETWORK_ACCESS));
                                color = VCP_LIST_MENU_TEXT_COLOR_LOWLIGHT;
                            }
                        break;
                     case J2ME_SETTING_AUTO_INVOCATION:
                        if(fieldType == VCP_LIST_MENU_FIELD_TEXT)
                            text.loadFromRes(STR_JAVA_SETTING_AUTO_INVOCATION);
                        if(fieldType == VCP_LIST_MENU_FIELD_SUB_TEXT1)
                            {
                                text = VFX_WSTR_STATIC(vapp_jave_get_permission(J2ME_SETTING_AUTO_INVOCATION));
                                color = VCP_LIST_MENU_TEXT_COLOR_LOWLIGHT;
                            }
                        break;
                    case J2ME_SETTING_MESSAGING:
                        if(fieldType == VCP_LIST_MENU_FIELD_TEXT)
                            text.loadFromRes(STR_JAVA_SETTING_MESSAGING);
                        if(fieldType == VCP_LIST_MENU_FIELD_SUB_TEXT1)
                            {
                                text = VFX_WSTR_STATIC(vapp_jave_get_permission(J2ME_SETTING_MESSAGING));
                                color = VCP_LIST_MENU_TEXT_COLOR_LOWLIGHT;
                            }
                        break;
                    case J2ME_SETTING_MULTIMEDIA:
                        if(fieldType == VCP_LIST_MENU_FIELD_TEXT)
                            text.loadFromRes(STR_JAVA_SETTING_MULTIMEDIA);
                        if(fieldType == VCP_LIST_MENU_FIELD_SUB_TEXT1)
                            {
                                text = VFX_WSTR_STATIC(vapp_jave_get_permission(J2ME_SETTING_MULTIMEDIA));
                                color = VCP_LIST_MENU_TEXT_COLOR_LOWLIGHT;
                            }
                        break;
                    case J2ME_SETTING_DATA_READ:
                        if(fieldType == VCP_LIST_MENU_FIELD_TEXT)
                            text.loadFromRes(STR_JAVA_SETTING_FILE_READ);
                        if(fieldType == VCP_LIST_MENU_FIELD_SUB_TEXT1)
                            {
                                text = VFX_WSTR_STATIC(vapp_jave_get_permission(J2ME_SETTING_DATA_READ));
                                color = VCP_LIST_MENU_TEXT_COLOR_LOWLIGHT;
                            }
                        break;
                    case J2ME_SETTING_DATA_WRITE:
                        if(fieldType == VCP_LIST_MENU_FIELD_TEXT)
                            text.loadFromRes(STR_JAVA_SETTING_FILE_WRITE);
                        if(fieldType == VCP_LIST_MENU_FIELD_SUB_TEXT1)
                            {
                                text = VFX_WSTR_STATIC(vapp_jave_get_permission(J2ME_SETTING_DATA_WRITE));
                                color = VCP_LIST_MENU_TEXT_COLOR_LOWLIGHT;
                            }
                        break;
                    case J2ME_SETTING_LOCAL_CONNECTIVITY:
                        if(fieldType == VCP_LIST_MENU_FIELD_TEXT)
                            text.loadFromRes(STR_JAVA_SETTING_LOCAL_CONNECTIVITY);
                        if(fieldType == VCP_LIST_MENU_FIELD_SUB_TEXT1)
                            {
                                text = VFX_WSTR_STATIC(vapp_jave_get_permission(J2ME_SETTING_LOCAL_CONNECTIVITY));
                                color = VCP_LIST_MENU_TEXT_COLOR_LOWLIGHT;
                            }
                        break;
#ifdef SUPPORT_JSR_179
                    case J2ME_SETTING_LOCATION_ACCESS:
                        if(fieldType == VCP_LIST_MENU_FIELD_TEXT)
                            text.loadFromRes(STR_JAVA_SETTING_LOCATION_ACCESS);
                        if(fieldType == VCP_LIST_MENU_FIELD_SUB_TEXT1)
                            {
                                text = VFX_WSTR_STATIC(vapp_jave_get_permission(J2ME_SETTING_LOCATION_ACCESS));
                                color = VCP_LIST_MENU_TEXT_COLOR_LOWLIGHT;
                            }
                        break;
#endif
#if SUPPORT_JSR_177
                    case J2ME_SETTING_SATSA:
                        if(fieldType == VCP_LIST_MENU_FIELD_TEXT)
                            text.loadFromRes(STR_JAVA_SECURITY_TRUST);
                        if(fieldType == VCP_LIST_MENU_FIELD_SUB_TEXT1)
                        {
                            text = VFX_WSTR_STATIC(vapp_jave_get_permission(J2ME_SETTING_SATSA));
                            color = VCP_LIST_MENU_TEXT_COLOR_LOWLIGHT;
                        }
                        break;
#endif
#if SUPPORT_JSR_257
                case J2ME_SETTING_CONTACTLESS_COMMUNICATION:
                    if(fieldType == VCP_LIST_MENU_FIELD_TEXT)
                        text.loadFromRes(STR_JAVA_CONTACTLESS_COMMUNICATION);
                    if(fieldType == VCP_LIST_MENU_FIELD_SUB_TEXT1)
                    {
                        text = VFX_WSTR_STATIC(vapp_jave_get_permission(J2ME_SETTING_CONTACTLESS_COMMUNICATION));
                        color = VCP_LIST_MENU_TEXT_COLOR_LOWLIGHT;
                    }
                    break;
#endif                    
                    default:
                        break;              
                }
            }            
    }
    return VFX_TRUE;
}

VfxBool VappjavaSettingContentProvider::getItemImage(
    VcpMenuPos pos,                    
    VcpListMenuFieldEnum fieldType,  
    VfxImageSrc &image              
    ) 
{
     if (fieldType == VCP_LIST_MENU_FIELD_DISCLOSURE_IMG)
    {
        image.setResId(VCP_IMG_LIST_MENU_DEFAULT_DISCLOSURE);
        return VFX_TRUE;
    }
    else
        return VFX_FALSE;
}



VfxBool VappjavaSettingContentProvider::getItemIsDisabled(VcpMenuPos pos) const
{
    if(pos.group == 1)
    {
           switch(pos.pos)
           {
                case J2ME_SETTING_NETWORK_ACCESS:
                     if (g_java.mids_setting.permission_network == PERMISSION_ALLOW ||
                         g_java.mids_setting.permission_network == PERMISSION_NEVER )
                         {
                           return VFX_TRUE;
                         }                    
                    break;
                case J2ME_SETTING_AUTO_INVOCATION:
                      if (g_java.mids_setting.permission_push == PERMISSION_ALLOW||
                          g_java.mids_setting.permission_push == PERMISSION_NEVER)
                          {
                              return VFX_TRUE;
                           }    
                    break;
                case J2ME_SETTING_MESSAGING:
                     if (g_java.mids_setting.permission_message == PERMISSION_ALLOW ||
                         g_java.mids_setting.permission_message == PERMISSION_NEVER )
                         {
                              return VFX_TRUE;
                           }    
                    break;
                case J2ME_SETTING_MULTIMEDIA:
                     if (g_java.mids_setting.permission_multimedia == PERMISSION_ALLOW ||
                        g_java.mids_setting.permission_multimedia == PERMISSION_NEVER )
                         {
                              return VFX_TRUE;
                          }    
                    break;
                case J2ME_SETTING_DATA_READ:
                      if (g_java.mids_setting.permission_data_read == PERMISSION_ALLOW ||
                      g_java.mids_setting.permission_data_read == PERMISSION_NEVER )
                      {
                              return VFX_TRUE;
                      }
                    break;
                case J2ME_SETTING_DATA_WRITE:
                      if (g_java.mids_setting.permission_data_write == PERMISSION_ALLOW ||
                      g_java.mids_setting.permission_data_write == PERMISSION_NEVER)
                      {
                              return VFX_TRUE;
                      }
                    break;
                case J2ME_SETTING_LOCAL_CONNECTIVITY:
                    if (g_java.mids_setting.permission_local_connectivity == PERMISSION_ALLOW ||
                    g_java.mids_setting.permission_local_connectivity == PERMISSION_NEVER)
                    {
                              return VFX_TRUE;
                    }
                    break;
#ifdef SUPPORT_JSR_179
                case J2ME_SETTING_LOCATION_ACCESS:
                    if (g_java.mids_setting.permission_location_access== PERMISSION_ALLOW ||
                    g_java.mids_setting.permission_location_access == PERMISSION_NEVER )
                    {
                              return VFX_TRUE;
                    }
                    break;
#endif
#if SUPPORT_JSR_177
                case J2ME_SETTING_SATSA:
                    if (g_java.mids_setting.permission_satsa== PERMISSION_ALLOW ||
                    g_java.mids_setting.permission_satsa == PERMISSION_NEVER )
                    {
                              return VFX_TRUE;
                    }
                    break;
#endif
#if SUPPORT_JSR_257
                case J2ME_SETTING_CONTACTLESS_COMMUNICATION:
                    if ((g_java.mids_setting.permission_contactless_communication == PERMISSION_ALLOW ||
                    g_java.mids_setting.permission_contactless_communication == PERMISSION_NEVER )
                    {
                              return VFX_TRUE;
                    }
                    break;
#endif                    
                default:
                    break;                
                    }
        }
    return VFX_FALSE;
}


VcpListMenuCellBaseControl * 
VappjavaSettingContentProvider::getItemCustomControl(
    VcpMenuPos pos,                                  // [IN] position of the item
    VcpListMenuCellControlLocationTypeEnum location, // [IN] Control location
    VfxFrame *parentFrame 

)
{
    VappJavaSettingListMenuCell *custFrame = NULL;

    if(pos.group == 0 && location == VCP_LIST_MENU_CELL_CONTROL_LOCATION_TYPE_TAIL)
    switch(pos.pos)
    {
    case -1:
        break;     
    case 2:
        break;
#if defined(J2ME_SLIM_MEMORY_SUPPORT) && defined(J2ME_SUPPORT_BACKGROUND)
    case VAPP_JAVA_SETTING_SUPPORT_BG:
        kal_bool is_bg_enabled;
        srv_java_appfactory_get_bg_enabled_apname(&is_bg_enabled, g_mmi_vjava_select_app_name);
        VFX_OBJ_CREATE(custFrame, VappJavaSettingListMenuCell, parentFrame);
        custFrame->switchCell->setChecked(is_bg_enabled);
        custFrame->switchCell->m_signalSwitchChanged.connect(this, &VappJavaMidsBGSettingControllor::setBGHandler);
        return (VcpListMenuCellBaseControl *)custFrame;    
#endif
#ifdef __SUPPORT_JAVA_VIRTUAL_KEYPAD__
    case VAPP_JAVA_SETTING_SUPPORT_VK:
        VFX_OBJ_CREATE(custFrame, VappJavaSettingListMenuCell, parentFrame);
        custFrame->switchCell->setChecked(srv_java_appfactory_vk_is_on_by_app_name(g_mmi_vjava_select_app_name));
         custFrame->switchCell->m_signalSwitchChanged.connect(this, &VappJavaMidsVKSettingControllor::setVKHandler);
        return (VcpListMenuCellBaseControl *)custFrame;    
#endif
    default:
        break;   
    }
    return NULL;
}


VfxBool VappjavaSettingContentProvider::getItemIsHighlightable(VcpMenuPos pos) const
{
    /*if (mmi_java_nw_is_need_hide())
    {
        return VFX_TRUE;
    }
    else
    {
    #ifdef __SUPPORT_JAVA_VIRTUAL_KEYPAD__
        if(pos.group == 0 && pos.pos == 1)
    #else
        if(pos.group == 0 && pos.pos == 0)
    #endif
            return VFX_FALSE;
        else
            return VFX_TRUE;
    }*/
    return VFX_TRUE;
}


VFX_IMPLEMENT_CLASS("VappJavaSettingListMenuCell",VappJavaSettingListMenuCell,VcpListMenuCellBaseControl);
void VappJavaSettingListMenuCell::onInit()
{
    VfxSize size;
    VcpListMenuCellBaseControl::onInit();
    VFX_OBJ_CREATE(switchCell,VcpSwitch,this);
    //this->setSize(50,50);
    //switchCell->setSize(this->getSize());
    //switchCell->setPos(0, this->getSize().height/3);
    setSize(switchCell->getSize());
    switchCell->setAlignParent(
    VFX_FRAME_ALIGNER_MODE_NONE,
    VFX_FRAME_ALIGNER_MODE_NONE,
    VFX_FRAME_ALIGNER_MODE_SIDE,
    VFX_FRAME_ALIGNER_MODE_MID);
}


VFX_IMPLEMENT_CLASS("VjavaPerListMenuContentProvider",VjavaPerListMenuContentProvider,VfxObject);
void VjavaPerListMenuContentProvider::onInit()
{
    VfxObject::onInit();
}


VfxU32 VjavaPerListMenuContentProvider::getCount() const
{
    return g_vjava_per_item_count;
}


VfxBool VjavaPerListMenuContentProvider::getItemText(
                VfxU32 index,                    // [IN] the index of item
                VcpListMenuFieldEnum fieldType,  // [IN] the type of the field in the cell
                VfxWString &text,                // [OUT] the text resource
                VcpListMenuTextColorEnum &color  // [OUT] the text color
        )
{
    if(fieldType == VCP_LIST_MENU_FIELD_TEXT)
    {
        text = VFX_WSTR_STATIC(setting_select_string[index]);
        color = VCP_LIST_MENU_TEXT_COLOR_NORMAL;
    }
    return VFX_TRUE;
}

VcpListMenuItemStateEnum VjavaPerListMenuContentProvider::getItemState(VfxU32 index) const
{   
    if (vapp_jave_get_permission_level_by_index(g_vjava_per_item_index) == index)
    {
        return VCP_LIST_MENU_ITEM_STATE_SELECTED;
    }
    else
    {
        return VCP_LIST_MENU_ITEM_STATE_UNSELECTED;
    }
}

VFX_IMPLEMENT_CLASS("VappJavaPermissionListPage",VappJavaPermissionListPage,VfxPage);
void VappJavaPermissionListPage::tapItem(VcpListMenu *menu, VfxU32 index)
{

    //set permission here
    g_java.mids_choice_index[g_vjava_per_item_index] = index;
    getMainScr()->popPage();
    emitEvent();
}

void VappJavaPermissionListPage::emitEvent()
{
    eventUpdatePer.emit();
}

void VappJavaPermissionListPage::onInit()
{
    VfxPage::onInit();

    VFX_OBJ_CREATE(listMenu, VcpListMenu, this);
    VFX_OBJ_CREATE(contentProvider,VjavaPerListMenuContentProvider, this);
    VFX_OBJ_CREATE(title,VcpTitleBar, this);
    listMenu->setCellStyle(VCP_LIST_MENU_CELL_STYLE_SINGLE_TEXT); // Set a single text cell style
    listMenu->setContentProvider(contentProvider); // Assign the content provider

    // The optinal setting of list menu
    listMenu->setMenuMode(VCP_LIST_MENU_MODE_HEAD_SINGLE_CHECK_MARK, VFX_FALSE); // Set single selection mode (radio button)
    
    listMenu->m_signalItemTapped.connect(this, &VappJavaPermissionListPage::tapItem); 

    title->setTitle(STR_ID_VAPP_JAVA_PERMISSION);
    setTopBar(title);
    // Set the basic parameters of VfxFrame, this is required
    listMenu->setBounds(VfxRect(0, 0, LCD_WIDTH, LCD_HEIGHT));   
}

VFX_IMPLEMENT_CLASS("VappJavaMidsSettingPage",VappJavaMidsSettingPage,VfxPage);
void VappJavaMidsSettingPage::VappJavaRefreshPer()
{
    VcpMenuPos pos;
     pos.pos = g_vjava_per_item_index;
    if(mmi_java_nw_is_need_hide())
    {
    #if (defined(J2ME_SLIM_MEMORY_SUPPORT) && defined(J2ME_SUPPORT_BACKGROUND)) || defined(__SUPPORT_JAVA_VIRTUAL_KEYPAD__)
        pos.group = 1;
    #else
        pos.group = 0;
    #endif
    }
    else
    {
        pos.group = 1;
    }
    listMenu->updateItem(pos);
}


void VappJavaMidsSettingPage::VappJavaMidsPermissionEntry(VfxU8 index)
{    
    VappJavaPermissionListPage * perListMenuPage;
    VFX_OBJ_CREATE(perListMenuPage, VappJavaPermissionListPage, getMainScr());
    //perListMenuPage->setCount(mmi_vjava_get_permission_item_count(index)); 
    g_vjava_per_item_count = vapp_java_get_permission_item_count(index);
    g_vjava_per_item_index = index;
    perListMenuPage->eventUpdatePer.connect(this, &VappJavaMidsSettingPage::VappUpdateJavaMidsPer);
    getMainScr()->pushPage(g_mmi_vjava_advanced_permission_page, perListMenuPage);
}


void VappJavaMidsSettingPage::VappUpdateJavaMidsPer()
{
    //update permmission in subtext and global var.
    vapp_java_update_mids_setting();
    VappJavaRefreshPer();
}

void VappJavaMidsSettingPage::VappJavaMidsSettingEntry(VcpGroupListMenu* listMenu, VcpMenuPos pos)
{
    if(mmi_java_nw_is_need_hide())
    {
    #if (defined(J2ME_SLIM_MEMORY_SUPPORT) && defined(J2ME_SUPPORT_BACKGROUND)) || defined(__SUPPORT_JAVA_VIRTUAL_KEYPAD__)
        if(pos.group == 1)
    #else
        if(pos.group == 0)
    #endif
        {
            VappJavaMidsPermissionEntry(pos.pos);
        }
    }
    else if(pos.group == 0)
    {
        if(pos.pos == VAPP_JAVA_SETTING_DATA_ACCOUNT) /* default data account */              
        {
            kal_trace(JAM_JAVAAGENCY_GROUP,VAPP_JAVA_ENTRY_MIDLET_SETTING,1);
            mmi_java_nw_entry_dtcnt_cui();  
            mmi_frm_group_set_caller_proc(g_mmi_java_nw_cntx.sg_id_dtcnt, &VappJavaMidsSettingPage::static_callerProc, (void*)this);
        }
    }
    else if(pos.group == 1)/*Permission setting*/
    {
        VappJavaMidsPermissionEntry(pos.pos);
    }   
}

mmi_ret VappJavaMidsSettingPage::static_callerProc(mmi_event_struct *evt)
{
    VappJavaMidsSettingPage *page = (VappJavaMidsSettingPage*)evt->user_data;
    return page->onProc(evt);
}


mmi_ret VappJavaMidsSettingPage::onProc(mmi_event_struct *evt)
{
    cui_dtcnt_select_event_any_sim_selected_struct * dncntSelectEvt;
    cui_dtcnt_sim_enum sim;
    VcpMenuPos pos;
#ifdef __MMI_WLAN_FEATURES__
    pos.pos = 1;
#else
    pos.pos = 0;
#endif    
    pos.group = 0;
    switch(evt->evt_id)
    {
        case CUI_DTCNT_SELECT_EVENT_RESULT_OK:
            vcui_dtcnt_select_close(g_mmi_java_nw_cntx.sg_id_dtcnt);
            break;
        case CUI_DTCNT_SELECT_EVENT_RESULT_CANCEL:
        case CUI_DTCNT_SELECT_EVENT_RESULT_FAILED:
        case CUI_DTCNT_SELECT_EVENT_CLOSE:
            vcui_dtcnt_select_close(g_mmi_java_nw_cntx.sg_id_dtcnt);
            break;
        case CUI_DTCNT_SELECT_EVENT_ANY_SIM_ACCOUNT_SELECTED:    
            dncntSelectEvt = (cui_dtcnt_select_event_any_sim_selected_struct*)evt;
            sim = dncntSelectEvt->selectSim;
            g_mmi_java_nw_cntx.network[sim].account_id = dncntSelectEvt->accountId;
            switch (sim)
            {
                case CUI_DTCNT_SIM1: 
                    g_mmi_java_nw_cntx.sim_index |= NW_SIM_ID_SIM1;
                    break;
                case CUI_DTCNT_SIM2:
                    g_mmi_java_nw_cntx.sim_index |= NW_SIM_ID_SIM2;
                    break;
                case CUI_DTCNT_SIM3:
                    g_mmi_java_nw_cntx.sim_index |= NW_SIM_ID_SIM3;
                    break;
                case CUI_DTCNT_SIM4:                    
                    g_mmi_java_nw_cntx.sim_index |= NW_SIM_ID_SIM4;
                    break;
                default:
                    break;
            }
            mmi_java_nw_set_local_setting();
            listMenu->resetAllItems(VFX_TRUE);
            break;
        default:
            break;        
    }
        return MMI_RET_OK;    
}


void VappJavaMidsSettingPage::onDeinit()
{
    VfxPage:: onDeinit();
    SettingPage = NULL;
}


void VappJavaMidsSettingPage::onInit()
{
    VfxPage::onInit();
    VfxWString  setting;
    VFX_OBJ_CREATE(title, VcpTitleBar,this);
    VFX_OBJ_CREATE(listMenu, VcpGroupListMenu, this);
    VFX_OBJ_CREATE(settingContentProvider,VappjavaSettingContentProvider, this);
    setting.loadFromRes(STR_GLOBAL_SETTINGS);
    title->setTitle(setting);
    title->setTitleStyle(VCP_TITLE_BAR_STYLE_BASE);
    setTopBar(title);
    
    listMenu->setCellStyle(VCP_LIST_MENU_CELL_STYLE_MULTI_TEXT); 
    listMenu->setContentProvider(settingContentProvider); // Assign the content provider
    listMenu->setMenuControlMode(VCP_LIST_MENU_CONTROL_MODE_DISCLOSURE);
    listMenu->m_signalItemTapped.connect(this, &VappJavaMidsSettingPage::VappJavaMidsSettingEntry); 
    listMenu->setPos(0,0);
    listMenu->setSize(getSize().width, getSize().height);
    listMenu->setAlignParent(
            VFX_FRAME_ALIGNER_MODE_SIDE,
            VFX_FRAME_ALIGNER_MODE_SIDE,
            VFX_FRAME_ALIGNER_MODE_SIDE,
            VFX_FRAME_ALIGNER_MODE_SIDE);
    //listMenu->setBounds(VfxRect(0, 0, getSize().width, getSize().height));
    SettingPage = this;
    g_mmi_java_nw_cntx.sg_id_parent = getApp()->getGroupId();
}

#ifdef _J2ME_SUPPORT_SETTING_

VFX_IMPLEMENT_CLASS("VappjavaGlobalSettingContentProvider",VappjavaGlobalSettingContentProvider,VfxObject);
void VappjavaGlobalSettingContentProvider::onInit()
{
    VfxObject::onInit();
}


VfxU32 VappjavaGlobalSettingContentProvider:: getCount(VfxU32 group) const
{
    return MMI_JAVA_SETTING_TOTAL;
}


VfxBool VappjavaGlobalSettingContentProvider::getItemImage(
    VcpMenuPos pos,                    
    VcpListMenuFieldEnum fieldType,  
    VfxImageSrc &image              
    ) 
{
     if (fieldType == VCP_LIST_MENU_FIELD_DISCLOSURE_IMG)
    {
        image.setResId(VCP_IMG_LIST_MENU_DEFAULT_DISCLOSURE);
    }
    return VFX_TRUE;
}


VfxResId VappjavaGlobalSettingContentProvider::getStrResIDFromVolume(VfxU8 val)
{
    switch(val)
    {
        case 0:
            return STR_GLOBAL_OFF;
        case 1:
            return STR_GLOBAL_1;
        case 2:
            return STR_GLOBAL_2;
        case 3:
            return STR_GLOBAL_3;
        case 4:
            return STR_GLOBAL_4;
        case 5:
            return STR_GLOBAL_5;
        case 6:
            return STR_GLOBAL_6;
        case 7:
            return STR_GLOBAL_7;
        default:
            return STR_GLOBAL_4; 
    }
}

VfxBool VappjavaGlobalSettingContentProvider::getItemText(
    VcpMenuPos pos,                  // [IN] the position of item
    VcpListMenuFieldEnum fieldType,  // [IN] the type of the field in the cell
    VfxWString &text,                // [OUT] the text resource
    VcpListMenuTextColorEnum &color  // [OUT] the text color
)
{
         switch(pos.pos)
             {
                 case -1:
                     text.loadFromRes(STR_ID_FNG_SETTING_JAVA);
                     break;
                 case 0:/* Audio */
                     if(fieldType == VCP_LIST_MENU_FIELD_TEXT)
                         text.loadFromRes(STR_ID_FNG_SETTING_JAVA_AUD);
                    if(fieldType == VCP_LIST_MENU_FIELD_SUB_TEXT1)
                        text.loadFromRes(getStrResIDFromVolume(g_mmi_java_aud_volume_level));
                            
                        color = VCP_LIST_MENU_TEXT_COLOR_LOWLIGHT;
                     break;
                 case 1:/* Vibrate */
                     if(fieldType == VCP_LIST_MENU_FIELD_TEXT)
                         text.loadFromRes(STR_ID_FNG_SETTING_JAVA_VIB);                    
                     if(fieldType == VCP_LIST_MENU_FIELD_SUB_TEXT1)
                     {
                        if(g_mmi_java_is_vib_on == 0)
                            text.loadFromRes(STR_GLOBAL_OFF);
                        else
                            text.loadFromRes(STR_GLOBAL_ON);
                        
                        color = VCP_LIST_MENU_TEXT_COLOR_LOWLIGHT;
                     }
                     break;
                    case 2:/* VK */
    #ifdef __MMI_FOURWAYS_KEY_DISABLE__
                     if(fieldType == VCP_LIST_MENU_FIELD_TEXT)
                         text.loadFromRes(STR_ID_FNG_SETTING_JAVA_VK);                    
                     if(fieldType == VCP_LIST_MENU_FIELD_SUB_TEXT1)
                     {
                         if(g_mmi_java_vk_permission == 0)
                             text.loadFromRes(STR_GLOBAL_OFF);
                         else
                             text.loadFromRes(STR_GLOBAL_ON);  
                         
                         color = VCP_LIST_MENU_TEXT_COLOR_LOWLIGHT;
                     }
    #endif
                     break;
                     default:
                        break;
            }
    return VFX_TRUE;
}

VfxU32 VappjavaGlobalSettingContentProvider::getGroupCount() const
{
    return 1;
}
#endif
#ifdef _J2ME_SUPPORT_SETTING_

VFX_IMPLEMENT_CLASS("VappJavaGolbalSettingPage",VappJavaGolbalSettingPage,VfxPage);
void VappJavaGolbalSettingPage::onInit()
{
    VfxPage::onInit();
    VfxWString  setting;
    VFX_OBJ_CREATE(title, VcpTitleBar,this);
    VFX_OBJ_CREATE(listMenu, VcpGroupListMenu, this);
    VFX_OBJ_CREATE(settingContentProvider,VappjavaGlobalSettingContentProvider, this);
    setting.loadFromRes(STR_ID_FNG_SETTING_JAVA);
    title->setTitle(setting);
    title->setTitleStyle(VCP_TITLE_BAR_STYLE_BASE);
    setTopBar(title);

    listMenu->setCellStyle(VCP_LIST_MENU_CELL_STYLE_MULTI_TEXT); 
    listMenu->setContentProvider(settingContentProvider); // Assign the content provider
    listMenu->setMenuControlMode(VCP_LIST_MENU_CONTROL_MODE_DISCLOSURE);
    listMenu->m_signalItemTapped.connect(this, &VappJavaGolbalSettingPage::VappJavaGlobalSettingEntry); 

    listMenu->setBounds(VfxRect(0, 0, LCD_WIDTH, LCD_HEIGHT));

}


void VappJavaGolbalSettingPage::VappJavaGlobalSettingEntry(VcpGroupListMenu* listMenu, VcpMenuPos pos)
{      
    VappjavaGlobalSettingOptionPage* optionPage = NULL;
    VappJavaGlobalSettingVolumePage * volumePage = NULL;
    if(pos.group == 0)/* network*/
    {
        kal_trace(JAM_JAVAAGENCY_GROUP,VAPP_JAVA_ENTRY_GLOBAL_SETTING,pos.pos);
        switch(pos.pos)
        {

            case 0:
                VFX_OBJ_CREATE(volumePage,VappJavaGlobalSettingVolumePage,this);
                volumePage->volumeUpdateOption.connect(this,&VappJavaGolbalSettingPage::VappJavaGlobalSettingRefresh);
                getMainScr()->pushPage(0, volumePage);

                break;
            case 1:
                VFX_OBJ_CREATE(optionPage,VappjavaGlobalSettingOptionPage,this);
                optionPage->setIndex(VIBRATION);
                optionPage->eventUpdateOption.connect(this,&VappJavaGolbalSettingPage::VappJavaGlobalSettingRefresh);
                getMainScr()->pushPage(0, optionPage);
                break;
    #ifdef __MMI_FOURWAYS_KEY_DISABLE__
            case 2:
                VFX_OBJ_CREATE(optionPage,VappjavaGlobalSettingOptionPage,this);
                optionPage->setIndex(VIRTUAL_KEYPAD);
                optionPage->eventUpdateOption.connect(this,&VappJavaGolbalSettingPage::VappJavaGlobalSettingRefresh);
                getMainScr()->pushPage(0, optionPage);                
                break;
    #endif
            default:
                break;
        }
    }
}

void VappJavaGolbalSettingPage::VappJavaGlobalSettingRefresh()
{
    VcpMenuPos pos;
    kal_trace(JAM_JAVAAGENCY_GROUP,VAPP_JAVA_REFLASH_GLOBAL_SETTING,VappjavaGlobalSettingOptionPage::getIndex());
    if(VappjavaGlobalSettingOptionPage::getIndex() == 0)
        pos.pos = AUDIO_VOLUME;
    else
    pos.pos = VappjavaGlobalSettingOptionPage::getIndex();
    
    pos.group = 0;
    listMenu->updateItem(pos);
    VappjavaGlobalSettingOptionPage::setIndex(AUDIO_VOLUME);
}
#endif
#ifdef _J2ME_SUPPORT_SETTING_

VFX_IMPLEMENT_CLASS("VappjavaOptionContentProvider",VappjavaOptionContentProvider,VfxObject);
void VappjavaOptionContentProvider::onInit()
{
    VfxObject::onInit();
}


VfxU32 VappjavaOptionContentProvider::getCount() const
{
    return 2;
}


VfxBool VappjavaOptionContentProvider::getItemText(
    VfxU32 index,                 // [IN] the position of item
    VcpListMenuFieldEnum fieldType,  // [IN] the type of the field in the cell
    VfxWString &text,                // [OUT] the text resource
    VcpListMenuTextColorEnum &color  // [OUT] the text color
)
{
    kal_trace(JAM_JAVAAGENCY_GROUP,VAPP_JAVA_OPTION_CONTENT_PROVIDER_GET_ITEM_TEXT,index);
    switch(index)
    {
      case 0:
          if(fieldType == VCP_LIST_MENU_FIELD_TEXT)
              text.loadFromRes(STR_GLOBAL_OFF);
          break;
      case 1:
          if(fieldType == VCP_LIST_MENU_FIELD_TEXT)
              text.loadFromRes(STR_GLOBAL_ON);
          break;
      default:
        break;
    }
return VFX_TRUE;
}


VfxBool VappjavaOptionContentProvider::getItemImage(
        VfxU32 index,                    
        VcpListMenuFieldEnum fieldType,  
        VfxImageSrc &image              
) 
{
        return VFX_TRUE;
}


VcpListMenuItemStateEnum VappjavaOptionContentProvider::getItemState(VfxU32 index) const
{
    if (0 == index )
        if((VappjavaGlobalSettingOptionPage::getIndex() == VIBRATION && g_mmi_java_is_vib_on == 0)
#ifdef __MMI_FOURWAYS_KEY_DISABLE__
        ||(VappjavaGlobalSettingOptionPage::getIndex() == VIRTUAL_KEYPAD && g_mmi_java_vk_permission == 0)
#endif
        )
    {
        return VCP_LIST_MENU_ITEM_STATE_SELECTED;
    }
    if (1 == index)  
        if((VappjavaGlobalSettingOptionPage::getIndex() == VIBRATION && g_mmi_java_is_vib_on == 1)
#ifdef __MMI_FOURWAYS_KEY_DISABLE__
    ||(VappjavaGlobalSettingOptionPage::getIndex() == VIRTUAL_KEYPAD && g_mmi_java_vk_permission == 1))
#endif
        )
    {
        return VCP_LIST_MENU_ITEM_STATE_SELECTED;
    }
    return VCP_LIST_MENU_ITEM_STATE_UNSELECTED;

}
#endif
#ifdef _J2ME_SUPPORT_SETTING_

VFX_IMPLEMENT_CLASS("VappjavaGlobalSettingOptionPage", VappjavaGlobalSettingOptionPage, VfxPage);
VcpListMenuOptionIndexEnum VappjavaGlobalSettingOptionPage::optionIndex = AUDIO_VOLUME;
void VappjavaGlobalSettingOptionPage::onInit()
{
    VfxPage::onInit();

    VFX_OBJ_CREATE(listMenu, VcpListMenu, this);
    VFX_OBJ_CREATE(optionContentProvider,VappjavaOptionContentProvider, this);
    VFX_OBJ_CREATE(title,VcpTitleBar, this);
    listMenu->setCellStyle(VCP_LIST_MENU_CELL_STYLE_SINGLE_TEXT); // Set a single text cell style
    listMenu->setContentProvider(optionContentProvider); // Assign the content provider

    // The optinal setting of list menu
    listMenu->setMenuMode(VCP_LIST_MENU_MODE_HEAD_SINGLE_CHECK_MARK, VFX_FALSE); // Set single selection mode (radio button)
    
    listMenu->m_signalItemTapped.connect(this, &VappjavaGlobalSettingOptionPage::tapItem); 

    title->setTitle(STR_GLOBAL_OPTIONS);
    setTopBar(title);
    // Set the basic parameters of VfxFrame, this is required
    listMenu->setBounds(VfxRect(0, 0, LCD_WIDTH, LCD_HEIGHT));  

}



void VappjavaGlobalSettingOptionPage::tapItem(VcpListMenu *menu, VfxU32 index)
{
    kal_trace(JAM_JAVAAGENCY_GROUP,VAPP_JAVA_GLOBAL_SETTING_OPTION_PAGE_TAP_ITEM,index);
    switch(getIndex())
    {
    #ifdef __MMI_FOURWAYS_KEY_DISABLE__
        case VIRTUAL_KEYPAD:
            g_mmi_java_vk_permission = index;
            break;
    #endif
        case VIBRATION:
            g_mmi_java_is_vib_on = index;
            break;
        default:
            break;
    }
    getMainScr()->popPage();
    emitEvent();
}


void VappjavaGlobalSettingOptionPage::emitEvent()
{
    eventUpdateOption.emit();
}
#endif
#ifdef _J2ME_SUPPORT_SETTING_

VFX_IMPLEMENT_CLASS("VappJavaGlobalSettingVolumePage",VappJavaGlobalSettingVolumePage, VfxPage);
void VappJavaGlobalSettingVolumePage::onVolumeValueChange(VfxObject *sender, VfxFloat oldval, VfxFloat newval)
{
    volume = newval;
}

    
void VappJavaGlobalSettingVolumePage::onVolumeValueChangeDrag(VcpSlider * sender, VfxFloat newval)
{
    if(newval > 7)
        newval = 7;
    volume = newval;      
}


void VappJavaGlobalSettingVolumePage::emitEvent()
{
    volumeUpdateOption.emit();
}

void VappJavaGlobalSettingVolumePage::saveVolume()
{
    g_mmi_java_aud_volume_level = volume;
    getMainScr()->popPage();
    emitEvent(); 
}
void VappJavaGlobalSettingVolumePage::cancelVolume()
{
    getMainScr()->popPage();
    emitEvent(); 
}

void VappJavaGlobalSettingVolumePage::onOptionTBClick(VfxObject  * sender, VfxId id)
{
     switch(id)
    {
        /* Update */
        case 'TBB1':
            saveVolume();
            break;
        /* Setting */
        case 'TBB2':
            cancelVolume();
            break;
        default:
            break;
        }   
}


void VappJavaGlobalSettingVolumePage::onInit()
{

    VfxPage::onInit();
    setBgColor(VFX_COLOR_WHITE);
    VFX_OBJ_CREATE(volume_slider,VcpSlider,this);
    volume_slider->setPos(VfxPoint(OFFSET_X, OFFSET_Y));
    volume_slider->setLength(LCD_WIDTH-OFFSET_X);
    volume_slider->setMaxValue(7);
    volume_slider->setMinValue(0);
    volume_slider->setSliderMode(VCP_SLIDER_MODE_INTERACTIVE_CONTINUOUS );
    //volume_slider->m_signalUserChangedValue.connect(this, &VappJavaGlobalSettingVolumePage::onVolumeValueChange);    
    volume_slider->m_signalThumbDrag.connect(this, &VappJavaGlobalSettingVolumePage::onVolumeValueChangeDrag);
    volume_slider->setCurrentValue((VfxFloat)g_mmi_java_aud_volume_level);

    VFX_OBJ_CREATE(optionToolBar,VcpToolBar,this);
    VFX_OBJ_CREATE(title,VcpTitleBar,this);
    
    title->setTitle(VFX_WSTR("Java audio volume"));
    title->setTitleStyle(VCP_TITLE_BAR_STYLE_BASE);

    setTopBar(title);
    optionToolBar->m_signalButtonTap.connect(this, &VappJavaGlobalSettingVolumePage::onOptionTBClick);
    setBottomBar(optionToolBar);
 
    optionToolBar->addItem('TBB1', VFX_WSTR("Save"),VCP_IMG_TOOL_BAR_COMMON_ITEM_SAVE);
    optionToolBar->addItem('TBB2', VFX_WSTR("Cancel"),VCP_IMG_TOOL_BAR_COMMON_ITEM_CANCEL); 

}
#endif

VFX_IMPLEMENT_CLASS("VappJavaMIDDetailControllor", VappJavaMIDDetailControllor, VfxControl);
VcpIndicatorPopup*  VappJavaMIDDetailControllor::m_indacatorppPopup = NULL;
void VappJavaMIDDetailControllor::updateMidsHandler(CHAR* app_name,VfxMainScr* screen)   // Refer deleteMidsHandler
{
    VcpConfirmPopup* alertPopup = NULL;
#if defined(J2ME_SLIM_MEMORY_SUPPORT)
    if (FS_GetDevStatus(SRV_FMGR_CARD_DRV, FS_MOUNT_STATE_ENUM) != FS_NO_ERROR)
    {
        vapp_java_display_popup(STR_JAVA_ERROR_CODE_NO_CARD,VJAVA_POPUP_WARNING,VAPP_JAVA_ENTRY_NONE);
        return;
    }
#endif
    g_mmi_vjava_select_app_name = app_name;
    g_parent_screen = screen;
    vapp_java_get_mids_info_by_app_name(app_name);
#ifdef __USB_IN_NORMAL_MODE__             
    if (srv_usb_is_in_mass_storage_mode())
    {                                     
         /* in mass storage mode */        
        kal_trace(JAM_JAVAAGENCY_GROUP,VAPP_JAVA_ENTRY_UPDATE_CONFIRM,0);
        vapp_usb_unavailable_popup(0);   /* pass 0 will show default string */  //need to modify       
        return;                                                               
    }                                     
#endif /* __USB_IN_NORMAL_MODE__ */       
    if (mmi_java_is_no_network_service()) 
    {                                     
        VFX_OBJ_CREATE(alertPopup, VcpConfirmPopup, screen);
        alertPopup->setInfoType(VCP_POPUP_TYPE_FAILURE);
        alertPopup->setButtonSet(VCP_CONFIRM_BUTTON_SET_OK);  
        alertPopup->setText(STR_JAVA_ERROR_CODE_NETWORK_FAILTURE);
        alertPopup->setAutoDestory(VFX_TRUE);
        alertPopup->show(VFX_TRUE);
        kal_trace(JAM_JAVAAGENCY_GROUP,VAPP_JAVA_ENTRY_UPDATE_CONFIRM,1);
        return;                           
    }                                     
    if (vapp_java_check_and_display_is_busy())                                             
    {
        kal_trace(JAM_JAVAAGENCY_GROUP,VAPP_JAVA_ENTRY_UPDATE_CONFIRM,2);
        return;                           
    } 
    kal_trace(JAM_JAVAAGENCY_GROUP,VAPP_JAVA_ENTRY_UPDATE_CONFIRM,3);
    mmi_java_send_mids_update_req();

}


void VappJavaMIDDetailControllor::midsSettingHandler(CHAR* app_name,VfxMainScr* screen)
{
    if(srv_java_appfactory_is_app_running(app_name))
    {
        vapp_java_display_popup(STR_ID_VAPP_JAVA_MIDS_RUNNING_WARNING,VJAVA_POPUP_FAILURE,VAPP_JAVA_ENTRY_NONE);
    }
#if defined(J2ME_SLIM_MEMORY_SUPPORT)
    else if (FS_GetDevStatus(SRV_FMGR_CARD_DRV, FS_MOUNT_STATE_ENUM) != FS_NO_ERROR)
    {
        vapp_java_display_popup(STR_JAVA_ERROR_CODE_NO_CARD,VJAVA_POPUP_WARNING,VAPP_JAVA_ENTRY_NONE);
    }
#endif
    else 
    {
        g_mmi_vjava_select_app_name = app_name;
        g_parent_screen = screen;
        vapp_java_get_mids_info_by_app_name(app_name);
        g_mmi_java_nw_cntx.is_local = MMI_TRUE;
        mmi_java_nw_get_local_setting();/*Get permission setting in the cnf handler*/
    }
}

void VappJavaMIDDetailControllor::midsRestoreHandler(CHAR* app_name,VfxMainScr* screen)
{
    if(srv_java_appfactory_is_app_running(app_name))
    {
        vapp_java_display_popup(STR_ID_VAPP_JAVA_MIDS_RUNNING_WARNING,VJAVA_POPUP_FAILURE,VAPP_JAVA_ENTRY_NONE);
    }
    else if (jam_is_busy())                                             
    {
        vapp_java_display_popup(STR_ID_VAPP_JAVA_VM_BUSY,VJAVA_POPUP_WARNING,VAPP_JAVA_ENTRY_NONE);                                                         
    }
#if defined(J2ME_SLIM_MEMORY_SUPPORT)
    if (FS_GetDevStatus(SRV_FMGR_CARD_DRV, FS_MOUNT_STATE_ENUM) != FS_NO_ERROR)
    {
        vapp_java_display_popup(STR_JAVA_ERROR_CODE_NO_CARD,VJAVA_POPUP_WARNING,VAPP_JAVA_ENTRY_NONE);
    }
#endif
    else
    {
        vcp_global_popup_show_confirm_two_button_id(
            mmi_frm_group_get_active_id(),
            VCP_POPUP_TYPE_QUESTION,
            STR_ID_FNG_SECURITY_JAVA_RESTORE_DEFAULT_CONFIRM,
            STR_GLOBAL_YES,
            STR_GLOBAL_CANCEL,
            VCP_POPUP_BUTTON_TYPE_WARNING,
            VCP_POPUP_BUTTON_TYPE_CANCEL,
            &VappJavaHelper::restoreSettings,
            (void*)app_name);
    }
}


void VappJavaMIDDetailControllor::deleteMidsHandler(CHAR* app_name,void * user_data, mids_delete_callback callback)
{
    kal_int32 ret = J2ME_NO_ERROR;
    CHAR storage_name[30] = {0};
#if defined(J2ME_SLIM_MEMORY_SUPPORT)
    if (FS_GetDevStatus(SRV_FMGR_CARD_DRV, FS_MOUNT_STATE_ENUM) != FS_NO_ERROR)
    {
        vapp_java_display_popup(STR_JAVA_ERROR_CODE_NO_CARD,VJAVA_POPUP_WARNING,VAPP_JAVA_ENTRY_NONE);
        return;
    }
#endif
    g_mmi_vjava_select_app_name = app_name;
    g_vjava_delete_callabck = callback;
    g_vjava_user_data = user_data;
    srv_java_appfactory_get_storage_name_by_app_name(storage_name,app_name);
    g_mmi_java_is_background_display = MMI_FALSE;
    g_mmi_java_current_running_cmd = MMI_JAVA_CMD_REMOVE_BY_USER;
    ret = mmi_java_mids_delete(-1,storage_name,KAL_FALSE);
    if(ret!= J2ME_NO_ERROR)
    {
        callback(user_data,0);
    }
}


void VappJavaMIDDetailControllor::onInit()
{
    VfxControl::onInit();
    g_mmi_vjava_detail_controllor = this;
    vapp_java_event_init();
}


VFX_IMPLEMENT_CLASS("VappJavaMIDDetailScreen", VappJavaMIDDetailScreen, VfxMainScr);
/* For UT */
void VappJavaMIDDetailScreen::on1stReady()
{
    VfxMainScr::on1stReady();
    VcpStatusIconBar * statusIconBar;
    VappJavaMIDDetailControllor *detailPage;
    VappJavaMidsSettingPage * SettingPage;
    VFX_OBJ_CREATE(statusIconBar, VcpStatusIconBar, this);
    g_mmi_vjava_select_app_name = "java.Unknown.PlatformRequest";
    gdetailScr = this;
    #define MID_SETTING_UT
    VFX_OBJ_CREATE(detailPage, VappJavaMIDDetailControllor, this);
    //VFX_OBJ_CREATE(SettingPage, VappJavaMidsSettingPage, this);
    //pushPage(0, SettingPage);
    detailPage->midsSettingHandler(g_mmi_vjava_select_app_name,gdetailScr);

#ifdef _J2ME_SUPPORT_SETTING_

    #define GLOBAL_SETTING_UT
    VappJavaGolbalSettingPage* globalSettingPage = NULL;
    VFX_OBJ_CREATE(globalSettingPage,VappJavaGolbalSettingPage,this);
    pushPage(0, globalSettingPage);
#endif

}

void VappJavaMIDDetailScreen::entrySettingPage()
{
    VappJavaMidsSettingPage* settingPage;
    VFX_OBJ_CREATE(settingPage, VappJavaMidsSettingPage,this);
    settingPage->setBgColor(VRT_COLOR_WHITE);
    settingPage->setSize(LCD_WIDTH,400);
    pushPage(0, settingPage);
}


VFX_IMPLEMENT_CLASS("VappJavaPushScr",VappJavaPushScr,VfxMainScr);
void VappJavaPushScr::on1stReady()
{
    VfxMainScr::on1stReady();
    VcpCommandPopup* confirmPopup;
    VFX_OBJ_CREATE(confirmPopup, VcpCommandPopup, this);
    confirmPopup->setInfoType(VCP_POPUP_TYPE_QUESTION);
    confirmPopup->setText(STR_GLOBAL_OPTIONS);
    confirmPopup->addItem(PUSH_OPT_YES, STR_GLOBAL_YES);
    confirmPopup->addItem(PUSH_OPT_NO, STR_GLOBAL_NO);
    confirmPopup->addItem(PUSH_OPT_ASK_ME_LATER,VFX_WSTR("Ask me later"));
    confirmPopup->setAutoDestory(VFX_FALSE);
    confirmPopup->show(VFX_TRUE);
    confirmPopup->m_signalButtonClicked.connect(this, &VappJavaPushScr::pushOption);     
}


void VappJavaPushScr::pushOption(VfxObject *obj, VfxId id)
{
    if (id == PUSH_OPT_YES)
    {
        g_mmi_java_push_cntx.option_choice = 0;
    }
    if (id == PUSH_OPT_NO)
    {
        g_mmi_java_push_cntx.option_choice = 1;
    }
    if(id == PUSH_OPT_ASK_ME_LATER)
    {
        g_mmi_java_push_cntx.option_choice = 2;
    }
    mmi_java_push_confirm_hdlr();
}


VFX_IMPLEMENT_CLASS("VappJavaTerminatePage",VappJavaTerminatePage,VfxPage);
void VappJavaTerminatePage::onInit()
{
    VcpCommandPopup * option;
    VfxPage::onInit();
    VFX_OBJ_CREATE(option, VcpCommandPopup, this);
    option->setInfoType(VCP_POPUP_TYPE_QUESTION);
    //option->setText(STR_ID_VENUS_BRW_ADD);
    option->addItem(OPT_MIN, VFX_WSTR("Minimize"));
    option->addItem(OPT_TER, VFX_WSTR("Terminate"));
    option->addItem(OPT_CANCEL, VFX_WSTR("Cancel"));
    option->show(VFX_TRUE);
    option->m_signalButtonClicked.connect(this, &VappJavaTerminatePage::onTerminatePageClick);
}


void VappJavaTerminatePage::onTerminatePageClick(VfxObject *obj, VfxId id)
{
    kal_wchar * mid_name = NULL;
    VfxU32 vm_id = g_mmi_java_current_selected_vm_id;
    if (id == OPT_MIN)
    {
        mid_name = jam_mvm_get_vm_mid_name(vm_id);
        mmi_java_ncenter_on_going_cell_add(vm_id);
        jam_enter_minimize_mode(g_mmi_java_current_selected_vm_id,KAL_FALSE);
        g_mmi_java_current_selected_vm_id = -1;
        vapp_java_close_venus_screen();
    }
    if (id == OPT_TER)
    {
        jam_enter_terminate_mode(vm_id);
        g_mmi_java_current_selected_vm_id = -1;
        vapp_java_close_venus_screen();
    }
    if(id == OPT_CANCEL)
    {
        g_mmi_java_current_selected_vm_id = -1;
        vapp_java_close_venus_screen();
    }

}
#if !(defined(J2ME_SLIM_MEMORY_SUPPORT) && defined(__COSMOS_MMI_PACKAGE__))

VFX_IMPLEMENT_CLASS("VappJavaScreenSwitchScr",VappJavaScreenSwitchScr,VfxAppScr);
void VappJavaScreenSwitchScr::onInit()
{
    VfxAppScr::onInit(); 
    g_vjava_screen_switch_scr = this;
    VcpCommandPopup * option;
    VcpStatusIconBar * statusIconBar;
    VFX_OBJ_CREATE(option, VcpCommandPopup, this);
    VFX_OBJ_CREATE(statusIconBar, VcpStatusIconBar, this);
#if defined(__GADGET_SUPPORT__) && !defined(__VM_CONCURRENCE__)
    if (srv_mre_get_bg_app_num() > 0)
    {
        option->setText(STR_ID_VAPP_JAVA_RESOURCE_CONFLICT);
        option->setTextAlignMode(VfxTextFrame::ALIGN_MODE_LEFT);
    }
    else
#endif
    {
        option->setText(jam_mvm_get_vm_mid_name(g_mmi_java_current_selected_vm_id));
        option->setTextAlignMode(VfxTextFrame::ALIGN_MODE_CENTER);
    }
    option->setInfoType(VCP_POPUP_TYPE_QUESTION);
#if defined(__GADGET_SUPPORT__) && !defined(__VM_CONCURRENCE__)
    if (srv_mre_get_bg_app_num() == 0)
#endif
    {
        option->addItem(OPT_MIN, STR_ID_VAPP_JAVA_MINIMIZE);
    }
    option->addItem(OPT_TER, STR_ID_VAPP_JAVA_TERMINATE);
    option->addItem(OPT_CANCEL, STR_GLOBAL_CANCEL,VCP_POPUP_BUTTON_TYPE_CANCEL);
    option->show(VFX_TRUE);
    option->m_signalButtonClicked.connect(this, &VappJavaScreenSwitchScr::onOptionClick);
}


void VappJavaScreenSwitchScr::onDeinit()
{

    VfxAppScr::onDeinit();
    g_vjava_screen_switch_scr = NULL;
}


void VappJavaScreenSwitchScr::onOptionClick(VfxObject *obj, VfxId id)
{
    kal_wchar * mid_name = NULL;
    kal_int32 vm_id = g_mmi_java_current_selected_vm_id;
    
    if(vm_id < 0|| vm_id >= MAX_VM_INSTANCE_NUM)
        vm_id = jam_mvm_get_current_vm_id();
    
    if (id == OPT_MIN)
    {
        if(vm_id >= 0 && vm_id < MAX_VM_INSTANCE_NUM)
        {
            mid_name = jam_mvm_get_vm_mid_name(vm_id);
            mmi_java_ncenter_on_going_cell_add(vm_id);
            jam_enter_minimize_mode(vm_id,KAL_FALSE);
            g_mmi_java_current_selected_vm_id = -1;
        }
        vapp_java_close_venus_screen();
    }
    if (id == OPT_TER)
    {
        jam_enter_terminate_mode(vm_id);
        g_mmi_java_current_selected_vm_id = -1;
        if(jam_mvm_get_current_vm_id() == INVALIDE_VM_ID)
        {
            mmi_frm_group_close(GRP_ID_JAVA_APP);
            jam_delete_fg_mmi_screen();
        }
        vapp_java_close_venus_screen();
    }
    if(id == OPT_CANCEL)
    {
        g_mmi_java_current_selected_vm_id = -1;
        vapp_java_close_venus_screen();
    }
}

#endif

VFX_IMPLEMENT_CLASS("VappJavaAlwaysAskScr",VappJavaAlwaysAskScr,VfxMainScr);
void VappJavaAlwaysAskScr::on1stReady()
{
    VfxMainScr::on1stReady(); 
}

VFX_IMPLEMENT_CLASS("VappJavaPopup",VappJavaPopup,VfxAppScr);
VfxResId VappJavaPopup::resID = VFX_RES_ID_NULL;
vapp_java_popup_type_enum VappJavaPopup::m_type = VJAVA_POPUP_NULL;
void VappJavaPopup::onInit()
{

    VfxAppScr::onInit();
    g_vapp_java_global_popup_scr = this;
}


void VappJavaPopup::displayJavaPopup(vapp_java_popup_type_enum type)
{
    switch(type)
    {
        case VJAVA_POPUP_INDICATOR_ACTIVITY:
            VFX_OBJ_CREATE(m_indacatorppPopup,VcpIndicatorPopup,this);
            m_indacatorppPopup->setInfoType(VCP_INDICATOR_POPUP_STYLE_ACTIVITY);
            m_indacatorppPopup->setText(resID);
            m_indacatorppPopup->setAutoDestory(VFX_FALSE);
            m_indacatorppPopup->show(VFX_TRUE);
            break;
       #if !((defined(J2ME_SLIM_MEMORY_SUPPORT))&&(MAX_VM_INSTANCE_NUM == 1))
        case VJAVA_POPUP_CONFIRM_TYPE_INFO:
            VFX_OBJ_CREATE(commandPopup, VcpCommandPopup, this);
            commandPopup->setInfoType(VCP_POPUP_TYPE_INFO);
            commandPopup->setText(resID);
            commandPopup->addItem(OPT_OK, STR_GLOBAL_OK);
            commandPopup->setAutoDestory(VFX_TRUE);
            commandPopup->show(VFX_TRUE);
            commandPopup->m_signalButtonClicked.connect(this, &VappJavaTaskManagerPage::emptyConfirm);
            break;
        #endif
        case VJAVA_POPUP_WARNING:
            VFX_OBJ_CREATE(confirmPopup, VcpConfirmPopup, this);
            confirmPopup->setInfoType(VCP_POPUP_TYPE_FAILURE);
            confirmPopup->setButtonSet(VCP_CONFIRM_BUTTON_SET_OK);  
            confirmPopup->setText(resID);
            confirmPopup->setAutoDestory(VFX_TRUE);
            confirmPopup->show(VFX_TRUE);
            break;
        case VJAVA_POPUP_STOP:
            VFX_OBJ_CREATE(stopPopup, VappJavaStopPopup, this);
            stopPopup->setInfoType(VCP_POPUP_TYPE_FAILURE);
            stopPopup->setButtonSet(VCP_CONFIRM_BUTTON_SET_OK);   
            stopPopup->setText(resID);
            stopPopup->show(VFX_TRUE);
            break;
         default:
            break;
    }
}

#if 0
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
#endif
VFX_IMPLEMENT_CLASS("VappJavaMidletSelectProvider",VappJavaMidletSelectProvider,VfxObject);
void VappJavaMidletSelectProvider::onInit()
{
    VfxObject::onInit();
}
VfxU32 VappJavaMidletSelectProvider::getCount() const
{
    return g_java.total_java_app_mid;
}


VfxBool VappJavaMidletSelectProvider::getItemText(
        VfxU32 index,                    // [IN] the index of item
        VcpListMenuFieldEnum fieldType,  // [IN] the type of the field in the cell
        VfxWString &text,                // [OUT] the text resource
        VcpListMenuTextColorEnum &color  // [OUT] the text color
)
{

    if(fieldType == VCP_LIST_MENU_FIELD_TEXT)
    {
        text = VFX_WSTR_STATIC((U16*)g_java.mid_info[index].mid_name);
        color = VCP_LIST_MENU_TEXT_COLOR_NORMAL;
    }
    return VFX_TRUE;
}


VfxBool VappJavaMidletSelectProvider::getItemImage(
        VfxU32 index,                    
        VcpListMenuFieldEnum fieldType,  
        VfxImageSrc &image              
) 
{
    if (fieldType == VCP_LIST_MENU_FIELD_ICON)
    {
        if (g_java.mid_info[index].mid_icon)
        {
            image.setMem(g_java.mid_info[index].mid_icon);
        }
        else
        {
            image.setResId(IMG_JAVA_STAR1);      /* g_java.mid_info[i].mid_icon; */
        }
    }
    return VFX_TRUE;
}


VFX_IMPLEMENT_CLASS("VappJavaMidletSelectPage",VappJavaMidletSelectPage,VfxPage);
void VappJavaMidletSelectPage::onCancelTBClick(VfxObject  * sender, VfxId id)
{
    vfxPostInvoke0(&vappjavaHelper,&VappJavaHelper::closeJavaApp);
    mmi_frm_group_close(APP_JAVA);
}

void VappJavaMidletSelectPage::onInit()
{
    VfxPage::onInit();
    VFX_OBJ_CREATE(midList, VcpListMenu, this);
    VFX_OBJ_CREATE(contentProvider,VappJavaMidletSelectProvider, this);
    VFX_OBJ_CREATE(title,VcpTitleBar, this);
    VFX_OBJ_CREATE(toolBar,VcpToolBar,this);
    midList->setCellStyle(VCP_LIST_MENU_CELL_STYLE_ICON_SINGLE_TEXT); // Set a single text cell style
    midList->setContentProvider(contentProvider); // Assign the content provider

    //midList->setMenuMode(VCP_LIST_MENU_MODE_HEAD_SINGLE_CHECK_MARK, VFX_FALSE); // Set single selection mode (radio button)
    midList->m_signalItemTapped.connect(this, &VappJavaMidletSelectPage::tapItem); 
    title->setTitle(STR_GLOBAL_SELECT);
    setTopBar(title); 
    toolBar->m_signalButtonTap.connect(this, &VappJavaMidletSelectPage::onCancelTBClick);
    setBottomBar(toolBar);
    toolBar->addItem(OPT_CANCEL, STR_GLOBAL_CANCEL,VCP_IMG_TOOL_BAR_COMMON_ITEM_CANCEL); 
    midList->setBounds(VfxRect(0, 0, LCD_WIDTH, getSize().height -toolBar->getSize().height*2)); 
    vapp_java_enable_lock_screen();
}

void VappJavaMidletSelectPage::tapItem(VcpListMenu *menu, VfxU32 index)
{
    kal_trace(JAM_JAVAAGENCY_GROUP,VAPP_JAVA_SELECT_PAGE_TAP,index);
    vapp_java_disable_lock_screen();
    g_java.mid_index = index;
    mmi_java_entry_mid_launch();
}

void VappJavaMidletSelectPage::onBack()
{
    vapp_java_close_venus_screen();
    mmi_frm_group_close(APP_JAVA);
}


void VappJavaMidletSelectPage::onDeinit()
{
    VfxPage::onDeinit();
    g_java_list_lock = KAL_FALSE;
    g_java.msg_ctrl &= (~SEND_MID_GET_LIST_CTRL);
}

VFX_IMPLEMENT_CLASS("VappJavaMidletSelectScr",VappJavaMidletSelectScr,VfxMainScr);
void VappJavaMidletSelectScr::on1stReady()
{
    VappJavaMidletSelectPage * listPage = NULL;
    VfxMainScr::on1stReady();
    VFX_OBJ_CREATE(listPage,VappJavaMidletSelectPage,this);
    pushPage(0, listPage);
}

#if !(defined(J2ME_SLIM_MEMORY_SUPPORT) && defined(__COSMOS_MMI_PACKAGE__))

VFX_IMPLEMENT_CLASS("VappJavaPermissionDialogPage",VappJavaPermissionDialogPage, VfxPage);
void VappJavaPermissionDialogPage::onInit()
{
    VfxPage::onInit();
    VFX_OBJ_CREATE(text, VcpTextView, this);
    VFX_OBJ_CREATE(title,VcpTitleBar, this);
    VFX_OBJ_CREATE(toolBar,VcpToolBar,this);

    title->setTitle(g_mmi_vjava_permission_title_id);
    setTopBar(title);
    text->setPos(VfxPoint(0, 0));
    text->setText(g_mmi_vjava_permission_text, NULL); 
    text->setLineMode(VCP_TEXT_LINE_MODE_MULTI);
    text->setAlignMode(VCP_TEXT_ALIGN_MODE_LEFT);
    toolBar->m_signalButtonTap.connect(this, &VappJavaPermissionDialogPage::onOptionTBClick);
    setBottomBar(toolBar);
    text->setBounds(VfxRect(0, 0, LCD_WIDTH, getSize().height -toolBar->getSize().height*2)); 
    toolBar->addItem(OPT_OK, STR_GLOBAL_OK,VCP_IMG_TOOL_BAR_COMMON_ITEM_OK);
    toolBar->addItem(OPT_CANCEL, STR_GLOBAL_CANCEL,VCP_IMG_TOOL_BAR_COMMON_ITEM_CANCEL); 
    setSelected(VFX_FALSE);

    g_mmi_vjava_permission_is_force_fgmmi = mmi_java_is_permission_force_fgmmi();
}

void VappJavaPermissionDialogPage::onDeinit()
{
    VfxPage::onDeinit();
    if(mmi_java_get_permission_index != NULL &&
        ((*mmi_java_get_permission_index) == 255||(*mmi_java_get_permission_index) == -1)&&
        getSelected() == VFX_FALSE)
    {
        (*mmi_java_get_permission_index) = MMI_FALSE;
    }
    g_jam_user_update_setting_exclusive = KAL_FALSE;
    if(g_mmi_java_select_permission_vm_id != -1)
        g_mmi_java_select_permission_vm_id = -1; 

    if(g_mmi_vjava_permission_is_force_fgmmi)
    {
        g_mmi_vjava_permission_is_force_fgmmi = KAL_FALSE;
    }
}


void VappJavaPermissionDialogPage::onOptionTBClick(VfxObject  * sender, VfxId id)
{
     switch(id)
    {
        case OPT_OK:
            mmi_java_get_permission_res(MMI_TRUE);
            setSelected(VFX_TRUE);
            break;
        case OPT_CANCEL:
            mmi_java_get_permission_res(MMI_FALSE);
            setSelected(VFX_TRUE);
            break;
        default:
            break;
        }   
    if(g_mmi_vjava_permission_is_force_fgmmi)
    {
        g_mmi_vjava_permission_is_force_fgmmi = KAL_FALSE;
    }
    
    if(g_jam_user_update_setting_exclusive)
        vfxPostInvoke0(&vappjavaHelper,&VappJavaHelper::closeMidSettingPage);
    vapp_java_close_venus_screen();
}

mmi_ret VappJavaPermissionDialogPage::onProc(mmi_event_struct *evt)
{
    switch(evt->evt_id)
    {
        case EVT_ID_VAPP_NCENTER_DRAG:
            //if(jam_is_busy())
            {
                return MMI_RET_ERR;
            }
        default:
            break;
    }
    return VfxPage::onProc(evt);
}
#endif
#if !(defined(J2ME_SLIM_MEMORY_SUPPORT) && defined(__COSMOS_MMI_PACKAGE__))

VFX_IMPLEMENT_CLASS("VappJavaPermissionDialogScr",VappJavaPermissionDialogScr,VfxMainScr);
void VappJavaPermissionDialogScr::on1stReady()
{
    VappJavaPermissionDialogPage* permDialogPage=NULL;
    VfxMainScr::on1stReady();
    VFX_OBJ_CREATE(permDialogPage, VappJavaPermissionDialogPage, this);
    pushPage(0, permDialogPage);
}


void VappJavaPermissionDialogScr::onDeinit()
{
}
#endif
#if !((defined(J2ME_SLIM_MEMORY_SUPPORT))&&(MAX_VM_INSTANCE_NUM == 1))
VFX_IMPLEMENT_CLASS("VappJavaTaskMgrProvider",VappJavaTaskMgrProvider,VfxObject);
void VappJavaTaskMgrProvider::onInit()
{
    VfxObject::onInit();
}
VfxU32 VappJavaTaskMgrProvider::getCount() const
{
    if(!g_mmi_vjava_task_manager_is_push)
    {
        return running_count;
    }
    else
    {
        return g_mmi_java_push_cntx.running_mid_count;
    }
}


VfxBool VappJavaTaskMgrProvider::getItemText(
        VfxU32 index,                    // [IN] the index of item
        VcpListMenuFieldEnum fieldType,  // [IN] the type of the field in the cell
        VfxWString &text,                // [OUT] the text resource
        VcpListMenuTextColorEnum &color  // [OUT] the text color
)
{
    if(!g_mmi_vjava_task_manager_is_push)
    {
        if(fieldType == VCP_LIST_MENU_FIELD_TEXT)
        {
            text = VFX_WSTR_STATIC(g_mmi_java_running_mid_name[index]);
            color = VCP_LIST_MENU_TEXT_COLOR_NORMAL;
        }
    }
    else
    {
        if(fieldType == VCP_LIST_MENU_FIELD_TEXT)
        {
            text = VFX_WSTR_STATIC(g_mmi_java_push_cntx.running_mid_list[index].mid_name);
            color = VCP_LIST_MENU_TEXT_COLOR_NORMAL;
        }
    }
    return VFX_TRUE;
}


VfxBool VappJavaTaskMgrProvider::getItemImage(
        VfxU32 index,                    
        VcpListMenuFieldEnum fieldType,  
        VfxImageSrc &image              
) 
{
    if (fieldType == VCP_LIST_MENU_FIELD_ICON)
    {
        //image = VfxImageSrc(IMG_ID_VJAVA_PLAY);
    }
    return VFX_TRUE;
}

#endif

#if !((defined(J2ME_SLIM_MEMORY_SUPPORT))&&(MAX_VM_INSTANCE_NUM == 1))
VFX_IMPLEMENT_CLASS("VappJavaTaskManagerPage",VappJavaTaskManagerPage,VfxPage);
 VfxBool VappJavaTaskManagerPage::Choosed = VFX_FALSE;
void VappJavaTaskManagerPage::onInit()
{
    VfxPage::onInit();
    VFX_OBJ_CREATE(text, VfxTextFrame, this);
    VFX_OBJ_CREATE(midList, VcpListMenu, this);
    VFX_OBJ_CREATE(contentProvider,VappJavaTaskMgrProvider, this);
    VFX_OBJ_CREATE(title,VcpTitleBar, this);
    VFX_OBJ_CREATE(toolBar,VcpToolBar,this);    
   
    title->setTitle(STR_ID_VAPP_JAVA_TASK_MANAGER);
    setTopBar(title);

    text->setString(STR_ID_VAPP_JAVA_TASK_MANAGER_DESC);
    text->setBgColor(VFX_COLOR_GREY);
    //text->setFont(VFX_FONT_DESC_SMALL);
    text->setLineMode(VfxTextFrame::LINE_MODE_MULTI);
    text->setPos(0,0);
    text->setBounds(VfxRect(0,  0, LCD_WIDTH, 64));  

    midList->setCellStyle(VCP_LIST_MENU_CELL_STYLE_SINGLE_TEXT); // Set a single text cell style
    midList->setMenuMode(VCP_LIST_MENU_MODE_NORMAL, VFX_FALSE);
    midList->setContentProvider(contentProvider); // Assign the content provider
    midList->m_signalItemTapped.connect(this, &VappJavaTaskManagerPage::tapItem); 
    midList->setPos(0,text->getSize().height);
    midList->setSize(getSize().width, getSize().height-text->getSize().height);

    toolBar->m_signalButtonTap.connect(this, &VappJavaTaskManagerPage::onTBClick);
    setBottomBar(toolBar);
   // if (!g_mmi_vjava_task_manager_is_push)
   // {
        toolBar->addItem(OPT_TER_ALL, STR_JAVA_TERMINATE_ALL,VCP_IMG_TOOL_BAR_COMMON_ITEM_EXIT);
   // }
    toolBar->addItem(OPT_CANCEL, STR_GLOBAL_CANCEL,VCP_IMG_TOOL_BAR_COMMON_ITEM_CANCEL); 
         
}

void VappJavaTaskManagerPage::onTBClick(VfxObject  * sender, VfxId id)
{
    if (id == OPT_TER_ALL)
    {
#ifdef J2ME_SUPPORT_BACKGROUND
        jam_mvm_shutdown_all_req();
#endif 
#ifdef __COSMOS_MMI_PACKAGE__
        vapp_java_close_MIDelt_screen();
#endif
    }
    else
    {
        if (g_mmi_vjava_task_manager_is_push)
        {
            g_mmi_java_push_cntx.scrn_force_del_check = MMI_FALSE; 
            mmi_java_push_send_push_res(g_mmi_java_push_cntx.processing_idx, g_java.mids_setting.permission_push, KAL_FALSE);
        }
        else
        {
            if(g_java.screen_after_terminate == TER_ENTRY_TASK_MANAGER)
                g_java.screen_after_terminate = TER_ENTRY_NONE;
        }

        vfxPostInvoke0(&vappjavaHelper,&VappJavaHelper::closeJavaApp);
    }
}

void VappJavaTaskManagerPage::onDeinit()
{
    VfxPage::onDeinit();
    confirmPopup = NULL;
    setChoosed(VFX_FALSE);    
    if (!g_mmi_vjava_task_manager_is_push)
    {
    #if (MAX_VM_INSTANCE_NUM > 1)
        mmi_java_get_running_list_scr_exit();
    #endif
    }
    else
    {
        if (g_mmi_java_push_cntx.is_processing && g_java.screen_after_terminate != TER_ENTRY_LAUNCH_WHEN_PUSH)
        {
            g_mmi_java_push_cntx.is_exit_tskmgr = KAL_TRUE;
        }
        mmi_java_push_exit_vm_status_screen();
    }
    g_mmi_vjava_task_manager_is_push = VFX_FALSE;
}


void VappJavaTaskManagerPage::onBack()
{
    VfxPage::onBack();
    setChoosed(VFX_FALSE);
    if (g_mmi_vjava_task_manager_is_push)
    {
        g_mmi_java_push_cntx.scrn_force_del_check = MMI_FALSE; 
        mmi_java_push_send_push_res(g_mmi_java_push_cntx.processing_idx, g_java.mids_setting.permission_push, KAL_FALSE);
    }
    else
    {
        if(g_java.screen_after_terminate == TER_ENTRY_TASK_MANAGER)
            g_java.screen_after_terminate = TER_ENTRY_NONE;
    }
}

void VappJavaTaskManagerPage::onEnter(VfxBool isBackward)
{
    if(confirmPopup!=NULL && isBackward == VFX_TRUE)
        {
            VFX_OBJ_CLOSE(confirmPopup);
        }
}

VfxBool VappJavaTaskManagerPage::onKeyInput(VfxKeyEvent &event)
{
    if (event.keyCode == VFX_KEY_CODE_HOME && event.type == VFX_KEY_EVENT_TYPE_FULL_PRESS_DOWN)
    {
        if( g_mmi_vjava_task_manager_is_push)
        {
            g_mmi_java_push_cntx.scrn_force_del_check = MMI_FALSE; 
            mmi_java_push_send_push_res(g_mmi_java_push_cntx.processing_idx, g_java.mids_setting.permission_push, KAL_FALSE);
        }
        else
        {
            if(g_java.screen_after_terminate == TER_ENTRY_TASK_MANAGER)
                g_java.screen_after_terminate = TER_ENTRY_NONE;
        }
    }

    return VfxPage::onKeyInput(event);
}


void VappJavaTaskManagerPage::taskMgrOption(VfxObject *obj, VfxId id)
{
    switch(id)
    {
        case VCP_CONFIRM_POPUP_BUTTON_USER_1:
            if(!g_mmi_vjava_task_manager_is_push)
            {
            setChoosed(VFX_TRUE);
            g_java.screen_after_terminate = TER_ENTRY_TASK_MANAGER;
                jam_enter_terminate_mode(g_mmi_java_current_selected_vm_id);
                g_mmi_java_current_selected_vm_id = -1;
            }
            else /*Push*/
            {
                mmi_java_push_vm_terminate_hdlr();
            }
            break;
        case VCP_CONFIRM_POPUP_BUTTON_USER_2:
            confirmPopup->exit(VFX_TRUE);
            break;
        default:
            break;
    }
    confirmPopup = NULL;
}

void VappJavaTaskManagerPage::tapItem(VcpListMenu *menu, VfxU32 index)
{
     kal_trace(JAM_JAVAAGENCY_GROUP,VAPP_JAVA_SELECT_PAGE_TAP,index);
     running_index = index;
     if (!jam_mvm_is_shutdowning() && !getChoosed() &&
         ((!g_mmi_vjava_task_manager_is_push && jam_mvm_midlet_is_bg_running_by_vm_id(g_mmi_java_running_mid_list[running_index].vm_id)) ||
         (g_mmi_vjava_task_manager_is_push && jam_mvm_midlet_is_bg_running_by_vm_id(g_mmi_java_push_cntx.running_mid_list[running_index].vm_id))))
     {
            if (!g_mmi_vjava_task_manager_is_push)
            {
                g_mmi_java_current_selected_vm_id = g_mmi_java_running_mid_list[running_index].vm_id;
            }
            else
            {
                g_mmi_java_push_cntx.vm_status_menu_hilite_idx = running_index;
            }
            VFX_OBJ_CREATE(confirmPopup, VcpConfirmPopup, getMainScr());

            confirmPopup->setInfoType(VCP_POPUP_TYPE_QUESTION);
            confirmPopup->setButtonSet(VCP_CONFIRM_BUTTON_SET_USER_DEFINE);
            confirmPopup->setTextAlignMode(VfxTextFrame::ALIGN_MODE_LEFT);
            confirmPopup->setText(STR_ID_VAPP_JAVA_OVERMAX_LAUNCH_CONFIRM);
            confirmPopup->setCustomButton(STR_GLOBAL_YES, 
                                                 STR_GLOBAL_CANCEL,
                                                 VCP_POPUP_BUTTON_TYPE_WARNING,
                                                 VCP_POPUP_BUTTON_TYPE_CANCEL);

            confirmPopup->setAutoDestory(VFX_TRUE);
            confirmPopup->show(VFX_TRUE);
            confirmPopup->m_signalButtonClicked.connect(this, &VappJavaTaskManagerPage::taskMgrOption); 
     }
     else
     {
            /*Do nothing*/
     }
}

void VappJavaTaskManagerPage::emptyConfirm(VfxObject *obj, VfxId id)
{
    //vapp_java_destroy_global_popup();
}
#endif
#if !((defined(J2ME_SLIM_MEMORY_SUPPORT))&&(MAX_VM_INSTANCE_NUM == 1))

VFX_IMPLEMENT_CLASS("VappJavaTaskManagerScr",VappJavaTaskManagerScr,VfxMainScr);
void VappJavaTaskManagerScr::on1stReady()
{
    VfxMainScr::on1stReady();
    VFX_OBJ_CREATE(javaTaskMgrPage,VappJavaTaskManagerPage,this);
    pushPage(0,javaTaskMgrPage);
}

mmi_ret VappJavaTaskManagerScr::onProc(mmi_event_struct *evt)
{
    switch(evt->evt_id)
    {
        case EVT_ID_VAPP_NCENTER_DRAG:
            return MMI_RET_ERR;
        default:
            break;
    }
    return VfxMainScr::onProc(evt);
}
#endif
VFX_IMPLEMENT_CLASS("VappLaunchAfterConfirmScr",VappLaunchAfterConfirmScr,VfxAppScr);
void VappLaunchAfterConfirmScr::onInit()
{
    VfxAppScr::onInit();

    VFX_OBJ_CREATE(statusBar, VcpStatusIconBar, this);
    statusBar->setPos(0, 0);
    VFX_OBJ_CREATE(confirmPopup, VcpConfirmPopup, this);
    confirmPopup->setInfoType(VCP_POPUP_TYPE_QUESTION);
    confirmPopup->setButtonSet(VCP_CONFIRM_BUTTON_SET_USER_DEFINE);
    confirmPopup->setTextAlignMode(VfxTextFrame::ALIGN_MODE_LEFT);
    confirmPopup->setText(STR_JAVA_LAUNCH_AFTER_INSTALL);
    confirmPopup->setCustomButton(STR_GLOBAL_YES, 
                                         STR_GLOBAL_CANCEL,
                                         VCP_POPUP_BUTTON_TYPE_NORMAL,
                                         VCP_POPUP_BUTTON_TYPE_CANCEL);

    confirmPopup->setAutoDestory(VFX_TRUE);
    confirmPopup->show(VFX_TRUE);
    confirmPopup->m_signalButtonClicked.connect(this, &VappLaunchAfterConfirmScr::launchAfterInstall); 
}
void VappLaunchAfterConfirmScr::onDeinit()
{
    VfxAppScr::onDeinit();
}

void VappLaunchAfterConfirmScr::onRotate(const VfxScreenRotateParam &param)
{
    VfxAppScr::onRotate(param);
    statusBar->setSize(getSize().width,statusBar->getSize().height);
}

void VappLaunchAfterConfirmScr::onQueryRotateEx(VfxScreenRotateParam &param)
{
    param.rotateTo = rotateType;
}

void VappLaunchAfterConfirmScr::onEnter(VfxBool isBackward)
{
    VfxRenderer *renderer = VFX_OBJ_GET_INSTANCE(VfxRenderer);
    rotateType = renderer->getPreScreenRotateType();
    renderer->setScreenRotateType(rotateType);
}

void VappLaunchAfterConfirmScr::launchAfterInstall(VfxObject *obj, VfxId id)
{

    if (id == VCP_CONFIRM_POPUP_BUTTON_USER_1)
    {
        kal_trace(JAM_JAVAAGENCY_GROUP,VAPP_JAVA_LAUNCH_AFTER_INSTALL_HANDLER,0);
        mmi_java_set_allow_push_install(MMI_TRUE);
        vfxPostInvoke0(&vappjavaHelper,&VappJavaHelper::launchJavaApp);
    }
    else
    {
        kal_trace(JAM_JAVAAGENCY_GROUP,VAPP_JAVA_LAUNCH_AFTER_INSTALL_HANDLER,1);
        mmi_java_set_allow_push_install(MMI_TRUE);
        vfxPostInvoke0(&vappjavaHelper,&VappJavaHelper::closeJavaApp);    
    }
}


VFX_IMPLEMENT_CLASS("VappJavaStopPopup",VappJavaStopPopup,VcpConfirmPopup);
void VappJavaStopPopup::onExit()
{
    VcpConfirmPopup::onExit();
    if (g_java.screen_after_terminate == TER_ENTRY_INSTALL_JAVA)
    {
        vfxPostInvoke0(&vappjavaHelper,&VappJavaHelper::reEntryInstall);
    }
    g_java.screen_after_terminate = TER_ENTRY_NONE;
    vfxPostInvoke0(&vappjavaHelper,&VappJavaHelper::closeJavaApp);
}

void VappJavaStopPopup::onInit()
{
    VcpConfirmPopup::onInit();
}


VFX_IMPLEMENT_CLASS("VappJavaAgency",VappJavaAgency,VfxApp);
VappJavaAgency* VappJavaAgency::g_vappJavaAgency = NULL;
vapp_java_operation_item_enum VappJavaAgency::g_vappJavaOpType = VAPP_MAX_OP;
void VappJavaAgency::selectOpEntry(vapp_java_operation_item_enum type)
{
    kal_trace(JAM_JAVAAGENCY_GROUP,VAPP_JAVA_SELECT_OP_ENTRY,type);    
    VFX_ASSERT(type < VAPP_MAX_OP);
    switch(type)
    {
#if !(defined(J2ME_SLIM_MEMORY_SUPPORT) && defined(__COSMOS_MMI_PACKAGE__))
        case VJAVA_INDICATING:
            VappJavaPopup * JavaPopup;     
            VcpIndicatorPopup * indacatorppPopup;            
            if(jam_mvm_get_vm_state(0) != JVM_TERMINATE_STATE)
            {                
                VFX_OBJ_CREATE(JavaPopup, VappJavaPopup, this);
                JavaPopup->show();
                VFX_OBJ_CREATE(indacatorppPopup,VcpIndicatorPopup,JavaPopup);
                indacatorppPopup->setInfoType(VCP_INDICATOR_POPUP_STYLE_ACTIVITY);
                indacatorppPopup->setText(STR_ID_VAPP_JAVA_VM_TERMINATING);
                indacatorppPopup->setAutoDestory(VFX_TRUE);
                indacatorppPopup->show(VFX_TRUE);   
            }
            else
            {
                terminate();
            }
            break;
        case VJAVA_SCREEN_SWITCH:
            g_vjava_screen_switch = getGroupId();
            VappJavaScreenSwitchScr *screenSwitchScr;
            VFX_OBJ_CREATE(screenSwitchScr, VappJavaScreenSwitchScr, this);
            screenSwitchScr->show();
            break;
        case VJAVA_PERMISSION_DIALOG:
            VappJavaPermissionDialogScr * perDialogScr;
            VFX_OBJ_CREATE(perDialogScr,VappJavaPermissionDialogScr,this);
            perDialogScr->show();
            break;
        #endif    
        case VJAVA_ALWAYS_ASK:
            g_mmi_java_nw_cntx.sg_id_parent = getGroupId();
            VappJavaAlwaysAskScr *alwaysAskScr;
            VFX_OBJ_CREATE(alwaysAskScr, VappJavaAlwaysAskScr, this);
            break;

		#ifndef J2ME_SLIM_MEMORY_SUPPORT
        case VJAVA_MID_STOP_RUNNING:
            {
                VappJavaMidStopScreen *stopScr;
                VFX_OBJ_CREATE(stopScr, VappJavaMidStopScreen, this);
                stopScr->showStopConfirmDialog();
            }

            break;    
		#endif
        case VJAVA_INSTALL:
            {
                VappJavaMidInstallScreen *installScr;
                VFX_OBJ_CREATE(installScr, VappJavaMidInstallScreen, this);
                VappJavaAgency::getInstance()->set_install_screen(installScr);
                installScr->JavaInstallStart();
            }
            break;
        case VJAVA_PUSH_INSTALL:
            {
                VappJavaMidInstallScreen *installScr;
                VFX_OBJ_CREATE(installScr, VappJavaMidInstallScreen, this);
                VappJavaAgency::getInstance()->set_install_screen(installScr);
                installScr->showPushInstallDialog();
            }
            break;
        case VJAVA_DM_INSTALL:
            #ifdef __DM_SCOMO_SUPPORT__
            {
                VappJavaMidInstallScreen *installScr;
                VFX_OBJ_CREATE(installScr, VappJavaMidInstallScreen, this);
                VappJavaAgency::getInstance()->set_install_screen(installScr);
                installScr->showDMInstallDialog();
            }
            #endif
            break;     
        case VJAVA_MID_SELECT:
            VappJavaMidletSelectScr * MidSelectSrc;
            VFX_OBJ_CREATE(MidSelectSrc, VappJavaMidletSelectScr, this);
            MidSelectSrc->show();
            break;
#if !((defined(J2ME_SLIM_MEMORY_SUPPORT))&&(MAX_VM_INSTANCE_NUM == 1))
        case VJAVA_TASK_MANAGER:
            VappJavaTaskManagerScr * taskMgrScr;
            VFX_OBJ_CREATE(taskMgrScr, VappJavaTaskManagerScr, this);
            taskMgrScr->show();
            break;
#endif            
        case VJAVA_LAUNCH_AFTER_INSTALL:
            VappLaunchAfterConfirmScr * launchAfterInstall;
            VFX_OBJ_CREATE(launchAfterInstall, VappLaunchAfterConfirmScr, this);
            launchAfterInstall->show();
            break;
        default:
            break;
    }
}

void VappJavaAgency::onInit()
{
/*20110303*/
    mmi_frm_asm_property_struct p;
    VfxApp::onInit();
    if(g_vappJavaAgency)
        VappJavaAgency::terminate();
    g_vappJavaAgency = this;
    
/*20110303*/
    mmi_frm_asm_get_property(VAPP_JAVA, &p);
#ifndef J2ME_SLIM_MEMORY_SUPPORT
    p.f_hide_in_oom = 1;   
    mmi_frm_asm_set_property(VAPP_JAVA, &p);
    if(!g_jam_mvm_little_mem_space_oom)
        g_jam_mvm_little_mem_space_oom = (long*)applib_mem_ap_alloc(APPLIB_MEM_AP_ID_JAVA, 1);
#else
    p.f_hide_in_oom = 0;   
    mmi_frm_asm_set_property(VAPP_JAVA, &p);
#endif


}


void VappJavaAgency::onDeinit()
{
    VfxApp::onDeinit();
    g_vappJavaAgency = NULL;
    
#ifndef J2ME_SLIM_MEMORY_SUPPORT
    if(g_jam_mvm_little_mem_space_oom && !g_jam_mvm_whole_heap_space)
    {
        applib_mem_ap_free((void*)g_jam_mvm_little_mem_space_oom);
        g_jam_mvm_little_mem_space_oom = NULL;
        //applib_mem_ap_notify_stop_finished(APPLIB_MEM_AP_ID_JAVA, KAL_TRUE);
    }
#endif
    if(g_vjava_screen_switch!= GRP_ID_INVALID)
        g_vjava_screen_switch = GRP_ID_INVALID;
    if(g_vjava_is_select_screen_active)
        g_vjava_is_select_screen_active = KAL_FALSE;
}
VfxAppCloseAnswerEnum VappJavaAgency::onProcessClose(VfxAppCloseOption options)
{
    if(VappJavaAgency::getInstance()!= NULL && VappJavaAgency::getInstance()->get_install_screen()!= NULL)
    {
        VappJavaAgency::getInstance()->get_install_screen()->onProcessClose();
    }
    return VFX_APP_CLOSE_ANSWER_YES;
}

void VappJavaAgency::terminate()
{        
    if(g_vappJavaAgency!= NULL)
    {
        VfxAppLauncher::terminate(g_vappJavaAgency->getGroupId());
        g_vappJavaAgency = NULL;
    }
}

void VappJavaAgency::onRun(void * args, VfxU32 argSize)
{
    VfxApp::onRun(args, argSize);
    selectOpEntry(VappJavaAgency::getOpType());
}


mmi_ret VappJavaAgency::onProc(mmi_event_struct *evt)
{
    vcui_evt_cbm_bearer_select_struct *event_internal;
    MMI_TRACE(MMI_TRACE_FUNC, FUNC_MMI_JAVA_NW_ALWAYS_ASK_BEARER_FALLBACK_CUI_PROC, evt->evt_id);
    
    event_internal = (vcui_evt_cbm_bearer_select_struct *)evt;
    switch(evt->evt_id)
    {
        case EVT_ID_CUI_VAPP_CBM_OK:
            vapp_java_close_venus_screen();
            break;
        /* error occus or cancel */
        case EVT_ID_CUI_VAPP_CBM_FAIL:
            vapp_java_close_venus_screen();
            break;
        case EVT_ID_CUI_VAPP_CBM_CANCEL:
            vapp_java_close_venus_screen();
            break;
    }
    return MMI_RET_OK;
}


/*****************************************************************************
* FUNCTION 
* vapp_java_catscr_close_cb
* DESCRIPTION
* 
* PARAMETERS
* mmi_event_struct *evt
* RETURNS 
*  mmi_ret 
*modify/add date: 2012-11-19
*modify/add time: 9:26:53
*****************************************************************************/
 mmi_ret vapp_java_catscr_close_cb(mmi_event_struct *evt)
{
    kal_trace(JAM_JAVAAGENCY_GROUP,VAPP_JAVA_CATSCR_CLOSE_CB);    
    vapp_java_catscr_close();
    return MMI_RET_OK;


}

VFX_IMPLEMENT_CLASS("VappJavaIndicatingCatScr",VappJavaIndicatingCatScr,VfxAppCatScr);

/*****************************************************************************
* FUNCTION 
* VappJavaIndicatingCatScr.onInit
* DESCRIPTION
* 
* PARAMETERS
* RETURNS 
* void 
*modify/add date: 2012-11-19
*modify/add time: 9:27:7
*****************************************************************************/
void VappJavaIndicatingCatScr::onInit()
{
    VfxAppCatScr::onInit();
    VFX_OBJ_CREATE(indacatorppPopup,VcpIndicatorPopup,this);
    indacatorppPopup->setInfoType(VCP_INDICATOR_POPUP_STYLE_ACTIVITY);
    indacatorppPopup->setText(STR_ID_VAPP_JAVA_VM_TERMINATING);
    indacatorppPopup->setAutoDestory(VFX_TRUE);
    indacatorppPopup->show(VFX_TRUE); 
}


/*****************************************************************************
* FUNCTION 
* VappJavaIndicatingCatScr.onDeinit
* DESCRIPTION
* 
* PARAMETERS
* RETURNS 
* void 
*modify/add date: 2012-11-19
*modify/add time: 9:27:11
*****************************************************************************/
void VappJavaIndicatingCatScr::onDeinit()
{
    VfxAppCatScr::onDeinit();
}


VFX_IMPLEMENT_CLASS("VappJavaPermissionDialogCatScr",VappJavaPermissionDialogCatScr,VfxAppCatScr);

/*****************************************************************************
* FUNCTION 
* VappJavaPermissionDialogCatScr.onInit
* DESCRIPTION
* 
* PARAMETERS
* RETURNS 
* void 
*modify/add date: 2012-11-19
*modify/add time: 9:27:17
*****************************************************************************/
void VappJavaPermissionDialogCatScr::onInit()
{
    VfxAppCatScr::onInit();
    scr_width = getSize().width; 
    scr_height = getSize().height;

    // create status bar
    VFX_OBJ_CREATE(m_statusBar, VcpStatusIconBar, this);
    m_statusBar->setAutoAnimate(VFX_TRUE);
    m_statusBar->setPos(0, 0);
    VfxS32 statusHeight = m_statusBar->getSize().height;
    m_statusBar->setSize(scr_width, statusHeight);
   
    
    VFX_OBJ_CREATE(title,VcpTitleBar, this);
    title->setPos(0, statusHeight);
    VfxS32 titleHeight = title->getSize().height;
    title->setSize(scr_width, titleHeight);
    title->setTitle(g_mmi_vjava_permission_title_id);


    VFX_OBJ_CREATE(toolBar,VcpToolBar,this);
    toolBar->addItem(OPT_OK, STR_GLOBAL_OK,VCP_IMG_TOOL_BAR_COMMON_ITEM_OK);
    toolBar->addItem(OPT_CANCEL, STR_GLOBAL_CANCEL,VCP_IMG_TOOL_BAR_COMMON_ITEM_CANCEL); 
    toolBar->m_signalButtonTap.connect(this, &VappJavaPermissionDialogCatScr::onOptionTBClick);
    VfxS32 toolbarHeight = toolBar->getSize().height;
    toolBar->setPos(0, scr_height - toolbarHeight);
    title->setSize(scr_width, toolbarHeight);
    setBgColor(VRT_COLOR_BLACK);

    VFX_OBJ_CREATE(text, VcpTextView, this);
    text->setText(g_mmi_vjava_permission_text, NULL); 
    text->setLineMode(VCP_TEXT_LINE_MODE_MULTI);
    text->setAlignMode(VCP_TEXT_ALIGN_MODE_LEFT);
    text->setPos(0, statusHeight+titleHeight);
    //text->setColor(VcpTextColorTypeEnum id,const VfxColor & vColor)
    VfxS32 textHeight = text->getSize().height;
    text->setBounds(VfxRect(0, 0, scr_width, scr_height-statusHeight-titleHeight-toolbarHeight)); 
   text->setSize(scr_width, scr_height-statusHeight-titleHeight-toolbarHeight);

    setSelected(VFX_FALSE);
    g_mmi_vjava_permission_is_force_fgmmi = mmi_java_is_permission_force_fgmmi();

}
/*****************************************************************************
* FUNCTION 
* VappJavaPermissionDialogCatScr.onDeinit
* DESCRIPTION
* 
* PARAMETERS
* RETURNS 
* void 
*modify/add date: 2012-11-19
*modify/add time: 9:27:23
*****************************************************************************/
void VappJavaPermissionDialogCatScr::onDeinit()
{
    VfxAppCatScr::onDeinit();
    if(mmi_java_get_permission_index != NULL &&
        ((*mmi_java_get_permission_index) == 255||(*mmi_java_get_permission_index) == -1)&&
        getSelected() == VFX_FALSE)
    {
        (*mmi_java_get_permission_index) = MMI_FALSE;
    }
    g_jam_user_update_setting_exclusive = KAL_FALSE;
    if(g_mmi_java_select_permission_vm_id != -1)
        g_mmi_java_select_permission_vm_id = -1; 

    if(g_mmi_vjava_permission_is_force_fgmmi)
    {
        g_mmi_vjava_permission_is_force_fgmmi = KAL_FALSE;
    }

}
/*****************************************************************************
* FUNCTION 
* VappJavaPermissionDialogCatScr.onOptionTBClick
* DESCRIPTION
* 
* PARAMETERS
* VfxId id
* VfxObject * sender 
* RETURNS 
* void 
*modify/add date: 2012-11-19
*modify/add time: 9:27:29
*****************************************************************************/
void VappJavaPermissionDialogCatScr::onOptionTBClick(VfxObject * sender,VfxId id)
{
    mmi_event_struct evt;

    switch(id)
    {
        case OPT_OK:
            mmi_java_get_permission_res(MMI_TRUE);
            setSelected(VFX_TRUE);
            break;
        case OPT_CANCEL:
            mmi_java_get_permission_res(MMI_FALSE);
            setSelected(VFX_TRUE);
            break;
        default:
            break;
        }   
    if(g_mmi_vjava_permission_is_force_fgmmi)
    {
        g_mmi_vjava_permission_is_force_fgmmi = KAL_FALSE;
    }
    
    if(g_jam_user_update_setting_exclusive)
        vfxPostInvoke0(&vappjavaHelper,&VappJavaHelper::closeMidSettingPage);
   // vapp_java_close_venus_screen();
        MMI_FRM_INIT_EVENT(&evt, 0);
        MMI_FRM_POST_EVENT(&evt, vapp_java_catscr_close_cb, NULL);

}
/*****************************************************************************
* FUNCTION 
* VappJavaPermissionDialogCatScr.onKeyInput
* DESCRIPTION
* 
* PARAMETERS
* VfxKeyEvent &event
* RETURNS 
* VfxBool 
*modify/add date: 2012-12-11
*modify/add time: 14:7:47
*****************************************************************************/
VfxBool VappJavaPermissionDialogCatScr::onKeyInput(VfxKeyEvent &event)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
   mmi_event_struct evt;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    

    if (event.keyCode == VFX_KEY_CODE_BACK && event.type == VFX_KEY_EVENT_TYPE_UP)
        {
        
            vapp_java_catscr_close();

        }

    return VfxAppCatScr::onKeyInput(event);
}

#if 0
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
#endif
VFX_IMPLEMENT_CLASS("VappJavaScreenSwitchCatScr",VappJavaScreenSwitchCatScr,VfxAppCatScr);

/*****************************************************************************
* FUNCTION 
* VappJavaScreenSwitchCatScr.onInit
* DESCRIPTION
* 
* PARAMETERS
* RETURNS 
* void 
*modify/add date: 2012-11-19
*modify/add time: 9:27:51
*****************************************************************************/
void VappJavaScreenSwitchCatScr::onInit()
{
    VfxAppCatScr::onInit(); 
    VFX_OBJ_CREATE(option, VcpCommandPopup, this);
    VFX_OBJ_CREATE(statusIconBar, VcpStatusIconBar, this);
#if defined(__GADGET_SUPPORT__) && !defined(__VM_CONCURRENCE__)
    if (srv_mre_get_bg_app_num() > 0)
    {
        option->setText(STR_ID_VAPP_JAVA_RESOURCE_CONFLICT);
        option->setTextAlignMode(VfxTextFrame::ALIGN_MODE_LEFT);
    }
    else
#endif
    {
        option->setText(jam_mvm_get_vm_mid_name(g_mmi_java_current_selected_vm_id));
        option->setTextAlignMode(VfxTextFrame::ALIGN_MODE_CENTER);
    }
    option->setInfoType(VCP_POPUP_TYPE_QUESTION);
#if defined(__GADGET_SUPPORT__) && !defined(__VM_CONCURRENCE__)
    if (srv_mre_get_bg_app_num() == 0)
#endif
    {
        option->addItem(OPT_MIN, STR_ID_VAPP_JAVA_MINIMIZE);
    }
    option->addItem(OPT_TER, STR_ID_VAPP_JAVA_TERMINATE);
    option->addItem(OPT_CANCEL, STR_GLOBAL_CANCEL,VCP_POPUP_BUTTON_TYPE_CANCEL);
    option->show(VFX_TRUE);
    option->m_signalButtonClicked.connect(this, &VappJavaScreenSwitchCatScr::onOptionClick);
}


/*****************************************************************************
* FUNCTION 
* VappJavaScreenSwitchCatScr.onDeinit
* DESCRIPTION
* 
* PARAMETERS
* RETURNS 
* void 
*modify/add date: 2012-11-19
*modify/add time: 9:27:56
*****************************************************************************/
void VappJavaScreenSwitchCatScr::onDeinit()
{
    VfxAppCatScr::onDeinit();
}

/*****************************************************************************
* FUNCTION 
* VappJavaScreenSwitchCatScr.onOptionClick
* DESCRIPTION
* 
* PARAMETERS
*  VfxId id
* VfxObject *obj 
* RETURNS 
* void 
*modify/add date: 2012-11-19
*modify/add time: 9:27:59
*****************************************************************************/
void VappJavaScreenSwitchCatScr::onOptionClick(VfxObject *obj, VfxId id)
{
    mmi_event_struct evt;

    kal_wchar * mid_name = NULL;
    kal_int32 vm_id = g_mmi_java_current_selected_vm_id;
    
    if(vm_id < 0|| vm_id >= MAX_VM_INSTANCE_NUM)
        vm_id = jam_mvm_get_current_vm_id();
    
    if (id == OPT_MIN)
    {
        if(vm_id >= 0 && vm_id < MAX_VM_INSTANCE_NUM)
        {
            mid_name = jam_mvm_get_vm_mid_name(vm_id);
            mmi_java_ncenter_on_going_cell_add(vm_id);
            jam_enter_minimize_mode(vm_id,KAL_FALSE);
            g_mmi_java_current_selected_vm_id = -1;
        }
        //vapp_java_close_venus_screen();
        MMI_FRM_INIT_EVENT(&evt, 0);
        MMI_FRM_POST_EVENT(&evt, vapp_java_catscr_close_cb, NULL);
    }
    if (id == OPT_TER)
    {
        jam_enter_terminate_mode(vm_id);
        g_mmi_java_current_selected_vm_id = -1;
        if(jam_mvm_get_current_vm_id() == INVALIDE_VM_ID)
        {
            mmi_frm_group_close(GRP_ID_JAVA_APP);
            jam_delete_fg_mmi_screen();
        }
        //vapp_java_close_venus_screen();
         MMI_FRM_INIT_EVENT(&evt, 0);
        MMI_FRM_POST_EVENT(&evt, vapp_java_catscr_close_cb, NULL);
    }
    if(id == OPT_CANCEL)
    {
        g_mmi_java_current_selected_vm_id = -1;
        //vapp_java_close_venus_screen();
         MMI_FRM_INIT_EVENT(&evt, 0);
        MMI_FRM_POST_EVENT(&evt, vapp_java_catscr_close_cb, NULL);
    }
}
/*****************************************************************************
* FUNCTION 
* vapp_java_permissiondialog_catscr_close
* DESCRIPTION
* 
* PARAMETERS
* void
* RETURNS 
* void 
*modify/add date: 2012-11-19
*modify/add time: 9:28:6
*****************************************************************************/
void vapp_java_permissiondialog_catscr_close(void)
{
    kal_trace(JAM_JAVAAGENCY_GROUP,VAPP_JAVA_PERMISSIONDIALOG_CATSCR_CLOSE); 
    if(NULL!=g_vjava_permissiondialog_catscr_ptr)
    {
        VFX_OBJ_CLOSE(g_vjava_permissiondialog_catscr_ptr);
        VfxAppCatScr::deinitalize();
        g_vjava_permissiondialog_catscr_ptr=NULL;
    }
}

/*****************************************************************************
* FUNCTION 
* vapp_java_screenswitch_catscr_close
* DESCRIPTION
* 
* PARAMETERS
* void
* RETURNS 
* void 
*modify/add date: 2012-11-19
*modify/add time: 9:28:10
*****************************************************************************/
void vapp_java_screenswitch_catscr_close(void)
{
    kal_trace(JAM_JAVAAGENCY_GROUP,VAPP_JAVA_SCREENSWITCH_CATSCR_CLOSE); 
    if(NULL!=g_vjava_screenswitch_catscr_ptr)
    {
        VFX_OBJ_CLOSE(g_vjava_screenswitch_catscr_ptr);
        VfxAppCatScr::deinitalize();
        g_vjava_screenswitch_catscr_ptr=NULL;
    }
}

/*****************************************************************************
* FUNCTION 
* vapp_java_indicating_catscr_close
* DESCRIPTION
* 
* PARAMETERS
* void
* RETURNS 
* void 
*modify/add date: 2012-11-19
*modify/add time: 9:28:14
*****************************************************************************/
void vapp_java_indicating_catscr_close(void)
{
    kal_trace(JAM_JAVAAGENCY_GROUP,VAPP_JAVA_INDICATING_CATSCR_CLOSE); 
    if(NULL!=g_vjava_indicating_catscr_ptr)
    {
        VFX_OBJ_CLOSE(g_vjava_indicating_catscr_ptr);
        VfxAppCatScr::deinitalize();
        g_vjava_indicating_catscr_ptr=NULL;
    }
     
}

/*****************************************************************************
* FUNCTION 
* vapp_java_catscr_close
* DESCRIPTION
* 
* PARAMETERS
* RETURNS 
* void 
*modify/add date: 2012-11-19
*modify/add time: 9:28:18
*****************************************************************************/
void vapp_java_catscr_close()
{
    kal_trace(JAM_JAVAAGENCY_GROUP,VAPP_JAVA_CATSCR_CLOSE); 
    vapp_java_permissiondialog_catscr_close();
    vapp_java_screenswitch_catscr_close();
    vapp_java_indicating_catscr_close();
    mmi_frm_scrn_close(GRP_ID_VJAVA_CATEGORY, SCR_VJAVA_CATEGORY_SCREEN);
    mmi_frm_group_close(GRP_ID_VJAVA_CATEGORY);
}

/*****************************************************************************
* FUNCTION 
* vapp_java_catscr_terminateRunning_post_event_cb
* DESCRIPTION
* 
* PARAMETERS
* void
* RETURNS 
* void 
*modify/add date: 2013-1-11
*modify/add time: 15:51:55
*****************************************************************************/
void vapp_java_catscr_terminateRunning_post_event_cb(void)
{
    mmi_java_mids_install_ask_terminate_cb(MMI_TRUE);
}

/*****************************************************************************
* FUNCTION 
* vapp_java_catscr_terminateRunningCB
* DESCRIPTION
* 
* PARAMETERS
*  void *userData
* VfxId id 
* RETURNS 
* void 
*modify/add date: 2012-11-19
*modify/add time: 9:28:24
*****************************************************************************/
void vapp_java_catscr_terminateRunningCB(VfxId id, void *userData)
{
    kal_trace(JAM_JAVAAGENCY_GROUP,VAPP_JAVA_CATSCR_TERMINATERUNNINGCB,id); 

    if (id == VCP_CONFIRM_POPUP_BUTTON_USER_1)
    {
        if(jam_mvm_get_vm_state(g_mmi_java_install_terminate_vm_id) == JVM_TERMINATING_STATE||    
           jam_mvm_get_vm_state(g_mmi_java_install_terminate_vm_id) == JVM_TERMINATE_STATE)
        {
            kal_trace(TRACE_STATE, FUNC_JVM_ENTER_TERMINATE_MODE_TERMINATING);
            return;
        } 
        else if(jam_mvm_get_vm_state(g_mmi_java_install_terminate_vm_id) == JVM_LONG_EVENT_STATE)
        {
            mmi_event_struct evt;
           // vapp_java_indicating_catscr_entry();
            MMI_FRM_INIT_EVENT(&evt, 0);
            MMI_FRM_POST_EVENT(&evt,vapp_java_catscr_terminateRunning_post_event_cb, NULL);
        }
        else
        {
        //mmi_event_struct evt;
            kal_trace(JAM_JAVAAGENCY_GROUP,VAPP_JAVA_TERMINATE_CONFRIM_HANDLER,0);
            mmi_java_mids_install_ask_terminate_cb(MMI_TRUE);
            //vfxPostInvoke0(this,&VappJavaMidStopScreen::showTerminating);
        //  MMI_FRM_INIT_EVENT(&evt, 0);
            // MMI_FRM_POST_EVENT(&evt,vapp_java_indicating_catscr_entry, NULL);
            vapp_java_indicating_catscr_entry();
        }
    }
    else //if(id==VCP_CONFIRM_POPUP_BUTTON_USER_2)
    {
        kal_trace(JAM_JAVAAGENCY_GROUP,VAPP_JAVA_TERMINATE_CONFRIM_HANDLER,1);
        mmi_java_mids_install_ask_terminate_cb(MMI_FALSE);
    }


}
#if 0
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
#endif

/*****************************************************************************
* FUNCTION 
* vapp_java_terminate_catscr_show
* DESCRIPTION
* 
* PARAMETERS
* RETURNS 
* void 
*modify/add date: 2012-11-19
*modify/add time: 9:29:32
*****************************************************************************/
void vapp_java_terminate_catscr_show()
{    
    kal_trace(JAM_JAVAAGENCY_GROUP,VAPP_JAVA_TERMINATE_CATSCR_SHOW); 
    mmi_frm_scrn_close(GRP_ID_VJAVA_CATEGORY, SCR_VJAVA_CATEGORY_SCREEN);
    mmi_frm_group_close(GRP_ID_VJAVA_CATEGORY);

  if(g_vjava_terminate_confirm_popup != VCP_GLOBAL_POPUP_INVALID_HANDLE)
    {
        vcp_global_popup_cancel(g_vjava_terminate_confirm_popup);
        g_vjava_terminate_confirm_popup = VCP_GLOBAL_POPUP_INVALID_HANDLE;
    }  
    g_vjava_terminate_confirm_popup = 
    vcp_global_popup_show_confirm_two_button_id(
                    GRP_ID_ROOT,
                    VCP_POPUP_TYPE_QUESTION,
                    STR_JAVA_NCENTER_TERMINATE_JAVA_GAME,
                    STR_GLOBAL_YES,
                    STR_GLOBAL_CANCEL,
                    VCP_POPUP_BUTTON_TYPE_WARNING,
                    VCP_POPUP_BUTTON_TYPE_CANCEL,
                    &vapp_java_catscr_terminateRunningCB,
                    NULL
                    );
    
}


/*****************************************************************************
* FUNCTION 
* vapp_java_permissiondialog_catscr_show
* DESCRIPTION
* 
* PARAMETERS
* RETURNS 
* void 
*modify/add date: 2012-11-19
*modify/add time: 9:29:36
*****************************************************************************/
void vapp_java_permissiondialog_catscr_show()
{    
    kal_trace(JAM_JAVAAGENCY_GROUP,VAPP_JAVA_PERMISSIONDIALOG_CATSCR_SHOW); 

    VfxAppCatScr::initalize();

    VFX_OBJ_CREATE(
        g_vjava_permissiondialog_catscr_ptr,
        VappJavaPermissionDialogCatScr, 
        VfxAppCatScr::getContext());
    
}

/*****************************************************************************
* FUNCTION 
* vapp_java_screenswitch_catscr_show
* DESCRIPTION
* 
* PARAMETERS
* RETURNS 
* void 
*modify/add date: 2012-11-19
*modify/add time: 9:29:39
*****************************************************************************/
void vapp_java_screenswitch_catscr_show()
{
    kal_trace(JAM_JAVAAGENCY_GROUP,VAPP_JAVA_SCREENSWITCH_CATSCR_SHOW); 
    VfxAppCatScr::initalize();
    VFX_OBJ_CREATE(
        g_vjava_screenswitch_catscr_ptr,
        VappJavaScreenSwitchCatScr, 
        VfxAppCatScr::getContext());
    
}

/*****************************************************************************
* FUNCTION 
* vapp_java_indicating_catscr_show
* DESCRIPTION
* 
* PARAMETERS
* RETURNS 
* void 
*modify/add date: 2012-11-19
*modify/add time: 9:29:43
*****************************************************************************/
void vapp_java_indicating_catscr_show()
{
    kal_trace(JAM_JAVAAGENCY_GROUP,VAPP_JAVA_INDICATING_CATSCR_SHOW); 
    VfxAppCatScr::initalize();
    VFX_OBJ_CREATE(
        g_vjava_indicating_catscr_ptr,
        VappJavaIndicatingCatScr, 
        VfxAppCatScr::getContext());
    
}

/*****************************************************************************
* FUNCTION 
* vapp_java_screen_catscr_exit_proc
* DESCRIPTION
* 
* PARAMETERS
* RETURNS 
* void 
*modify/add date: 2012-11-19
*modify/add time: 9:29:46
*****************************************************************************/
void vapp_java_screen_catscr_exit_proc()
{
    kal_trace(JAM_JAVAAGENCY_GROUP,VAPP_JAVA_SCREEN_CATSCR_EXIT_PROC); 
    vapp_java_permissiondialog_catscr_close();
    vapp_java_screenswitch_catscr_close();
    vapp_java_indicating_catscr_close();
}


/*****************************************************************************
* FUNCTION 
* vapp_java_catscr_proc
* DESCRIPTION
* 
* PARAMETERS
* mmi_event_struct *evt
* RETURNS 
* mmi_ret 
*modify/add date: 2012-11-19
*modify/add time: 9:29:49
*****************************************************************************/
mmi_ret vapp_java_catscr_proc(mmi_event_struct *evt)
{
    kal_trace(JAM_JAVAAGENCY_GROUP,VAPP_JAVA_CATSCR_PROC,evt->evt_id); 
    switch(evt->evt_id)
    {
#ifdef __MMI_NCENTER_SUPPORT__
        case EVT_ID_VAPP_NCENTER_DRAG:
            return MMI_RET_ERR;
#endif
        default:
            break;
    }
    return MMI_RET_OK;
}
/*****************************************************************************
* FUNCTION 
* vapp_java_catscr_leave_proc
* DESCRIPTION
* 
* PARAMETERS
* mmi_event_struct *evt
* RETURNS 
* mmi_ret 
*modify/add date: 2012-11-19
*modify/add time: 9:29:54
*****************************************************************************/
mmi_ret vapp_java_catscr_leave_proc(mmi_event_struct *evt)
{
    kal_trace(JAM_JAVAAGENCY_GROUP,VAPP_JAVA_CATSCR_LEAVE_PROC,evt->evt_id); 
    if (evt->evt_id == EVT_ID_SCRN_DEINIT)
        {
            OslMfree(evt->user_data);
        }
    return  MMI_RET_OK;

}

/*****************************************************************************
* FUNCTION 
* vapp_java_show_catscr_entry
* DESCRIPTION
* 
* PARAMETERS
* mmi_scrn_essential_struct *arg
* RETURNS 
* void 
*modify/add date: 2012-11-19
*modify/add time: 9:29:57
*****************************************************************************/
void vapp_java_show_catscr_entry(mmi_scrn_essential_struct *arg)
{
    S32*type=(S32*)arg->user_data;
    kal_trace(JAM_JAVAAGENCY_GROUP,VAPP_JAVA_SHOW_CATSCR_ENTRY,*type); 
    if (!mmi_frm_scrn_enter(GRP_ID_VJAVA_CATEGORY, SCR_VJAVA_CATEGORY_SCREEN, vapp_java_screen_catscr_exit_proc, (FuncPtr)vapp_java_show_catscr_entry, MMI_FRM_FULL_SCRN))
    {
        return;
    }
        mmi_frm_scrn_set_leave_proc(GRP_ID_VJAVA_CATEGORY, SCR_VJAVA_CATEGORY_SCREEN, vapp_java_catscr_leave_proc);
      
    switch((vapp_java_operation_item_enum)(*type))
    {
        case VJAVA_INDICATING:
        {//TODO:need to add a if to judge the midlet is terminated.
             if(jam_mvm_get_vm_state(0) != JVM_TERMINATE_STATE)
             {
                 vapp_java_indicating_catscr_show();
             }
             else
             {
                 vapp_java_catscr_close();
             }
             break;
        }
        case VJAVA_SCREEN_SWITCH:
        {
            set_small_screen();
            vapp_java_screenswitch_catscr_show();
            break;
        }
        case VJAVA_PERMISSION_DIALOG:
        {
            vapp_java_permissiondialog_catscr_show();
            break;
        }
        case VJAVA_MID_STOP_RUNNING:
        {
            set_small_screen();
            vapp_java_terminate_catscr_show();
            break;
        }
        default:break;
    
    }


}


/*****************************************************************************
* FUNCTION 
* vapp_java_catscr_entry_nmgr_cb
* DESCRIPTION
* 
* PARAMETERS
*  void *arg
* mmi_scenario_id scen_id 
* RETURNS 
* MMI_BOOL 
*modify/add date: 2012-11-19
*modify/add time: 9:30:9
*****************************************************************************/
MMI_BOOL vapp_java_catscr_entry_nmgr_cb(mmi_scenario_id scen_id, void *arg)
{
     /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
     
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    ASSERT(arg != NULL);
    kal_trace(JAM_JAVAAGENCY_GROUP,VAPP_JAVA_CATSCR_ENTRY_NMGR_CB); 
    vapp_java_catscr_close();
    mmi_frm_group_create_ex(
            GRP_ID_ROOT,
            GRP_ID_VJAVA_CATEGORY,
            vapp_java_catscr_proc,
            NULL,
            MMI_FRM_NODE_SMART_CLOSE_FLAG);
    mmi_frm_scrn_first_enter(GRP_ID_VJAVA_CATEGORY, SCR_VJAVA_CATEGORY_SCREEN, (FuncPtr)vapp_java_show_catscr_entry,arg);

    return MMI_TRUE;
}


/*****************************************************************************
* FUNCTION 
* vapp_java_catscr_entry
* DESCRIPTION
* 
* PARAMETERS
* vapp_java_operation_item_enum type
* RETURNS 
* void 
*modify/add date: 2012-11-19
*modify/add time: 9:30:13
*****************************************************************************/
void vapp_java_catscr_entry(vapp_java_operation_item_enum type)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32*  param = (S32*)OslMalloc(sizeof(S32));
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    ASSERT(param!=NULL);
    kal_trace(JAM_JAVAAGENCY_GROUP,VAPP_JAVA_CATSCR_ENTRY,type); 
    *param =type; 
    mmi_frm_nmgr_notify_by_app(
        MMI_SCENARIO_ID_DEFAULT, 
        MMI_EVENT_NON_TONE,
        vapp_java_catscr_entry_nmgr_cb,
        (void *)param);
}


/*****************************************************************************
* FUNCTION 
* vapp_java_indicating_catscr_entry
* DESCRIPTION
* 
* PARAMETERS
* void
* RETURNS 
* extern "C" void 
*modify/add date: 2012-11-19
*modify/add time: 9:30:18
*****************************************************************************/
extern "C" void vapp_java_indicating_catscr_entry(void)
{
    kal_trace(JAM_JAVAAGENCY_GROUP,VAPP_JAVA_INDICATING_CATSCR_ENTRY); 
    vapp_java_catscr_entry(VJAVA_INDICATING);
}

/*****************************************************************************
* FUNCTION 
* vapp_java_screenswitch_catscr_entry
* DESCRIPTION
* 
* PARAMETERS
* void
* RETURNS 
* extern "C" void 
*modify/add date: 2012-11-19
*modify/add time: 9:30:21
*****************************************************************************/
extern "C" void vapp_java_screenswitch_catscr_entry(void)
{
    kal_trace(JAM_JAVAAGENCY_GROUP,VAPP_JAVA_PERMISSIONDIALOG_CATSCR_ENTRY); 

    vapp_java_catscr_entry(VJAVA_SCREEN_SWITCH);
}
/*****************************************************************************
* FUNCTION 
* vapp_java_permissiondialog_catscr_entry
* DESCRIPTION
* 
* PARAMETERS
* void
* RETURNS 
* extern "C" void 
*modify/add date: 2012-11-19
*modify/add time: 9:30:24
*****************************************************************************/
extern "C" void vapp_java_permissiondialog_catscr_entry(void)
{
    kal_trace(JAM_JAVAAGENCY_GROUP,VAPP_JAVA_PERMISSIONDIALOG_CATSCR_ENTRY); 
    vapp_java_catscr_entry(VJAVA_PERMISSION_DIALOG);
}

/*****************************************************************************
* FUNCTION 
* vapp_java_terminate_catscr_entry
* DESCRIPTION
* 
* PARAMETERS
* void
* RETURNS 
* extern "C" void 
*modify/add date: 2012-11-19
*modify/add time: 9:30:27
*****************************************************************************/
extern "C" void vapp_java_terminate_catscr_entry(void)
{
    kal_trace(JAM_JAVAAGENCY_GROUP,VAPP_JAVA_TERMINATE_CATSCR_ENTRY); 
    
    vapp_java_catscr_entry(VJAVA_MID_STOP_RUNNING);  

}

/*===========================================*/
MMI_BOOL vapp_java_entry_nmgr_cb(mmi_scenario_id scen_id, void *arg)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32* param = (S32*)arg;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    ASSERT(param != NULL);
    VappJavaAgency::setOpType((vapp_java_operation_item_enum)(*param));
    VfxAppLauncher::launch( 
        VAPP_JAVA,
        VFX_OBJ_CLASS_INFO(VappJavaAgency),
        GRP_ID_ROOT);
    OslMfree(param);
    return MMI_TRUE;
}

extern "C" void vapp_java_entry(vapp_java_operation_item_enum type)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32*  param = (S32*)OslMalloc(sizeof(S32));
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    ASSERT(param!=NULL);
    *param =type; 
    mmi_frm_nmgr_notify_by_app(
        MMI_SCENARIO_ID_DEFAULT, 
        MMI_EVENT_NON_TONE,
        vapp_java_entry_nmgr_cb,
        (void *)param);

}
extern "C" void vapp_java_close_venus_screen(void)
{
    kal_trace(JAM_JAVAAGENCY_GROUP,VAPP_JAVA_CLOSE_VENUS_SCREEN);
    VappJavaAgency::terminate();
#if defined(J2ME_SLIM_MEMORY_SUPPORT)
        vapp_java_catscr_close();
#endif
}
extern "C" void vapp_java_close_MIDelt_screen(void)
{
    mmi_java_close_MIDlet_screen();
    vapp_java_close_venus_screen();
}
extern "C" void vapp_java_screen_switch_entry(void)
{  
    
#if defined(J2ME_SLIM_MEMORY_SUPPORT) 
            vapp_java_catscr_entry(VJAVA_SCREEN_SWITCH);
#else
    vapp_java_entry(VJAVA_SCREEN_SWITCH);
#endif
    
}

extern "C" void vapp_java_launch_after_install_entry(void)
{  
    vapp_java_entry(VJAVA_LAUNCH_AFTER_INSTALL);
}

extern "C" void vapp_java_always_ask_entry(void)
{  
    vapp_java_entry(VJAVA_ALWAYS_ASK);   
}


extern "C" void vapp_java_mid_select_entry(void)
{
    g_vjava_is_select_screen_active = KAL_TRUE;
    vapp_java_entry(VJAVA_MID_SELECT); 
}

extern "C" void vapp_java_get_permission_entry(void)
{
    CHAR* confirmStr;
    U16  title;
    if (vapp_java_ui_is_option_menu_existed())
    {
         vapp_java_ui_option_menu_hide(KAL_TRUE);
    }
    mmi_java_get_permission_info(&confirmStr,&title);
    g_mmi_vjava_permission_text = (kal_wchar*)confirmStr;
    g_mmi_vjava_permission_title_id = title;
    g_mmi_vjava_permission_is_force_fgmmi = mmi_java_is_permission_force_fgmmi();
    
#if defined(J2ME_SLIM_MEMORY_SUPPORT)
            vapp_java_catscr_entry(VJAVA_PERMISSION_DIALOG);
#else
    vapp_java_entry(VJAVA_PERMISSION_DIALOG); 
#endif
     
}


extern "C"  void vapp_java_task_manager_entry(kal_bool is_push)
{
    if((!is_push && running_count == 0) ||
       (is_push && g_mmi_java_push_cntx.running_mid_count == 0))
    {
        vapp_java_display_popup(STR_GLOBAL_EMPTY,VJAVA_POPUP_INFO,VAPP_JAVA_ENTRY_NONE);
        return;
    }

    g_mmi_vjava_task_manager_is_push = is_push;
    
    vapp_java_entry(VJAVA_TASK_MANAGER); 
}


extern "C"  void vapp_java_indicating_entry(void)
{
    if(!vapp_screen_lock_is_locked())
    {
        
#if defined(J2ME_SLIM_MEMORY_SUPPORT)
        vapp_java_catscr_entry(VJAVA_INDICATING);
#else
        vapp_java_entry(VJAVA_INDICATING);
#endif
        
    }
}

extern "C" void vapp_java_refreash_setting_page(void)
{
    if(SettingPage!=NULL)
        SettingPage->getListMenu()->resetAllItems(VFX_TRUE);
}

extern "C" void vapp_java_entry_force_resume_dialog(void)
{
    kal_int32 state = jam_mvm_get_vm_state(g_mmi_java_current_selected_vm_id);
    if(JVM_TERMINATE_STATE == state ||JVM_TERMINATING_STATE == state ||
        g_vjava_force_resume_global_popup != GRP_ID_INVALID)
    {
        return;
    }    
    vcp_global_popup_cancel(g_vjava_force_resume_global_popup);
    g_vjava_force_resume_global_popup = vapp_nmgr_global_popup_show_confirm_two_button_id(
                    MMI_SCENARIO_ID_DEFAULT,
                    VCP_POPUP_TYPE_QUESTION,
                    STR_GLOBAL_RESUME,
                    STR_GLOBAL_YES,
                    STR_GLOBAL_CANCEL,
                    VCP_POPUP_BUTTON_TYPE_NORMAL,
                    VCP_POPUP_BUTTON_TYPE_CANCEL,
                    &VappJavaHelper::onResumeConfirm,
                    NULL
                    );    
}


MMI_BOOL vapp_java_entry_force_resume_dialog_nmgr(mmi_scenario_id scen_id, void *arg)
{
    vapp_java_entry_force_resume_dialog();
    return MMI_TRUE; 
}

extern "C" kal_bool vapp_java_is_in_low_battery(void)
{
    return (kal_bool) vapp_charger_low_pwr_popup_exist();
}

extern "C" mmi_ret forceResumeProc(mmi_event_struct *evt)   
{
    if(jam_mvm_get_vm_state(g_mmi_java_current_selected_vm_id)!=JVM_TERMINATE_STATE &&
       jam_mvm_get_vm_state(g_mmi_java_current_selected_vm_id)!=JVM_TERMINATING_STATE)
    {
        mmi_java_update_mids_runtime_setting(g_mmi_java_current_selected_vm_id);
        jam_resume_screen();
    }
    return MMI_TRUE;
}

extern "C" kal_bool vapp_java_is_in_task_manager(void)
{
    if(VappJavaAgency::getInstance()!= NULL &&
       VappJavaAgency::getOpType() == VJAVA_TASK_MANAGER)
        {
            return KAL_TRUE;
        }
    else
        return KAL_FALSE;
}


extern "C" kal_bool vapp_java_is_in_per_dialog(void)
{
    if(VappJavaAgency::getInstance()!= NULL &&
       VappJavaAgency::getOpType() == VJAVA_PERMISSION_DIALOG
       #ifdef J2ME_SLIM_MEMORY_SUPPORT    
       ||NULL!=g_vjava_permissiondialog_catscr_ptr
       #endif
       )
        {
            return KAL_TRUE;
        }
    else
        return KAL_FALSE;
}

extern "C" void vapp_java_entry_terminate_dialog(void)
{
    if(g_vjava_terminate_confirm_global_popup != VCP_GLOBAL_POPUP_INVALID_HANDLE)
    {
        vcp_global_popup_cancel(g_vjava_terminate_confirm_global_popup);
        g_vjava_terminate_confirm_global_popup = VCP_GLOBAL_POPUP_INVALID_HANDLE;
    }  
    g_vjava_terminate_confirm_global_popup = 
    vcp_global_popup_show_confirm_two_button_id(
                    GRP_ID_ROOT,
                    VCP_POPUP_TYPE_QUESTION,
                    STR_JAVA_NCENTER_TERMINATE_JAVA_GAME,
                    STR_GLOBAL_YES,
                    STR_GLOBAL_CANCEL,
                    VCP_POPUP_BUTTON_TYPE_WARNING,
                    VCP_POPUP_BUTTON_TYPE_CANCEL,
                    &VappJavaHelper::terminateRunningCB,
                    NULL
                    );
}


extern "C" kal_bool vapp_java_is_permission_force_fgmmi(void)
{
    if(g_mmi_vjava_permission_is_force_fgmmi)
    {
        return KAL_TRUE;
    }
    else
    {
        return KAL_FALSE;
    }
}


#endif
