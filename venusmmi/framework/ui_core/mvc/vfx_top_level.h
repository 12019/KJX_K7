/*****************************************************************************
*  Copyright Statement:
*  --------------------
*  This software is protected by Copyright and the information contained
*  herein is confidential. The software may not be copied and the information
*  contained herein may not be used or disclosed except with the written
*  permission of MediaTek Inc. (C) 2008
*
*  BY OPENING THIS FILE, BUYER HEREBY UNEQUIVOCALLY ACKNOWLEDGES AND AGREES
*  THAT THE SOFTWARE/FIRMWARE AND ITS DOCUMENTATIONS ("MEDIATEK SOFTWARE")
*  RECEIVED FROM MEDIATEK AND/OR ITS REPRESENTATIVES ARE PROVIDED TO BUYER ON
*  AN "AS-IS" BASIS ONLY. MEDIATEK EXPRESSLY DISCLAIMS ANY AND ALL WARRANTIES,
*  EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE IMPLIED WARRANTIES OF
*  MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE OR NONINFRINGEMENT.
*  NEITHER DOES MEDIATEK PROVIDE ANY WARRANTY WHATSOEVER WITH RESPECT TO THE
*  SOFTWARE OF ANY THIRD PARTY WHICH MAY BE USED BY, INCORPORATED IN, OR
*  SUPPLIED WITH THE MEDIATEK SOFTWARE, AND BUYER AGREES TO LOOK ONLY TO SUCH
*  THIRD PARTY FOR ANY WARRANTY CLAIM RELATING THERETO. MEDIATEK SHALL ALSO
*  NOT BE RESPONSIBLE FOR ANY MEDIATEK SOFTWARE RELEASES MADE TO BUYER'S
*  SPECIFICATION OR TO CONFORM TO A PARTICULAR STANDARD OR OPEN FORUM.
*
*  BUYER'S SOLE AND EXCLUSIVE REMEDY AND MEDIATEK'S ENTIRE AND CUMULATIVE
*  LIABILITY WITH RESPECT TO THE MEDIATEK SOFTWARE RELEASED HEREUNDER WILL BE,
*  AT MEDIATEK'S OPTION, TO REVISE OR REPLACE THE MEDIATEK SOFTWARE AT ISSUE,
*  OR REFUND ANY SOFTWARE LICENSE FEES OR SERVICE CHARGE PAID BY BUYER TO
*  MEDIATEK FOR SUCH MEDIATEK SOFTWARE AT ISSUE. 
*
*  THE TRANSACTION CONTEMPLATED HEREUNDER SHALL BE CONSTRUED IN ACCORDANCE
*  WITH THE LAWS OF THE STATE OF CALIFORNIA, USA, EXCLUDING ITS CONFLICT OF
*  LAWS PRINCIPLES. ANY DISPUTES, CONTROVERSIES OR CLAIMS ARISING THEREOF AND
*  RELATED THERETO SHALL BE SETTLED BY ARBITRATION IN SAN FRANCISCO, CA, UNDER
*  THE RULES OF THE INTERNATIONAL CHAMBER OF COMMERCE (ICC).
*
*****************************************************************************/

/*******************************************************************************
 * Filename:
 * ---------
 *  vfx_top_level.h
 *
 * Project:
 * --------
 *  Venus UI Core
 *
 * Description:
 * ------------
 *  Description
 *
 * Author:
 * -------
 * -------
 *
 *============================================================================
 *             HISTORY
 * Below this line, this part is controlled by PVCS VM. DO NOT MODIFY!!
 *------------------------------------------------------------------------------
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 *
 *------------------------------------------------------------------------------
 * Upper this line, this part is controlled by PVCS VM. DO NOT MODIFY!!
 *============================================================================
 ****************************************************************************/
#ifndef __VFX_TOP_LEVEL_H__
#define __VFX_TOP_LEVEL_H__


/***************************************************************************** 
 * Include
 *****************************************************************************/

// For VfxControl
#include "vfx_control.h"

#include "vfx_object.h"
#include "vfx_class_info.h"
#include "vfx_datatype.h"
#include "vfx_screen.h"
#include "vfx_cpp_base.h"
#include "vfx_input_event.h"
#include "vfx_context.h"
#include "vfx_weak_ptr.h"


/***************************************************************************** 
 * Define
 *****************************************************************************/

// The VfxTopLevel registered name
#define VFX_TOP_LEVEL_CLASS_NAME        "TopLevel"

// Active screen state
enum VfxTopLevelActiveScreenStateEnum
{
    VFX_TOP_LEVEL_ACTIVE_SCREEN_STATE_UNKNOWN = 0,
    VFX_TOP_LEVEL_ACTIVE_SCREEN_STATE_ENTERING,
    VFX_TOP_LEVEL_ACTIVE_SCREEN_STATE_ENTERED,
    VFX_TOP_LEVEL_ACTIVE_SCREEN_STATE_EXITING,
    VFX_TOP_LEVEL_ACTIVE_SCREEN_STATE_EXITED,
    VFX_TOP_LEVEL_ACTIVE_SCREEN_END_OF_ENUM
};


/***************************************************************************** 
 * Predeclaration
 *****************************************************************************/

class VfxBasePopup;
class VfxDebugPanel;
class VfxProfilingPanel;
class VfxShelter;


/***************************************************************************** 
 * Class VfxMainBaseLayer
 *****************************************************************************/

// Internal Class.
class VfxMainBaseLayer : public VfxFrame
{
    VFX_DECLARE_CLASS(VfxMainBaseLayer);
    
public:
    VfxMainBaseLayer();

    VfxScrRotateTypeEnum getRotateType() const
    {
        return m_rotateType;
    }

protected:
    virtual void onInit();

private:
    VfxScrRotateTypeEnum m_rotateType;
};


/***************************************************************************** 
 * Class VfxTopLevel
 *****************************************************************************/

/*
 * A singleton class. VfxTopLevel is a control of top level.
 *
 * By addChildFrame(), anyone can attach frame to top level. 
 * VfxTopLevel will enable Z-sort by default, so these frams can adjust own 
 * display order by setPosZ(), following are Z values of pre-defined frames:
 * (PS. frame with small Z will be in front of frame with bigger Z)
 * - Popup      :  5000.0
 * - Shelter    :  7500.0 (it is popup's shadow)
 * - Screen     : 10000.0
 * - Background : 11000.0 
 * Default Z of any frame is 0, so it will be above these pre-define frames.
 */
class VfxTopLevel : public VfxControl
{
    VFX_DECLARE_CLASS(VfxTopLevel);
    VFX_OBJ_DECLARE_SINGLETON_CLASS(VfxTopLevel);

// Constructor / Destructor
public:
    // Default constructor
    VfxTopLevel();

// Method
public:
    // Return the active screen
    // RETURNS: The active screen. Return NULL if there is no active screen.
    VfxScreen *getActiveScr() const
    {
        return m_activeScrPtr.get();
    }

    // Switch the given screen to the active screen.
    void enterToScreen(
        VfxScreen *screen,          // [IN] The screen to switch to active screen.
        VfxBool isBackward = VFX_FALSE // [IN] direction of this entering.
    );

    // Let top level keep focus on childFrame
    void captureFocus(
        VfxFrame* childFrame        // [IN] The child frame want to be focused
    );

    // Let top level restore focus
    void releaseFocus(
        VfxFrame* childFrame        // [IN] The child frame that captured focus
    );

    // Return active screen state
    VfxTopLevelActiveScreenStateEnum getActiveScreenState()
    {
        return m_activeScrState;
    }

// Signal
public:
    VfxSignal1 <VfxScreenRotateParam> m_signalBeforeRotate;                 // Signal for screen rotation
    VfxSignal1 <VfxScreenRotateParam> m_signalRotated;                      // Signal for screen rotation

    VfxSignal1 <VfxWeakPtr<VfxScreen> > m_signalActiveScreenBeforeEnter;    // Signal for active screen enter (after)
    VfxSignal1 <VfxWeakPtr<VfxScreen> > m_signalActiveScreenEnter;          // Signal for active screen enter (after)
    VfxSignal1 <VfxWeakPtr<VfxScreen> > m_signalActiveScreenEntered;        // Signal for active screen enter (after)
    VfxSignal1 <VfxWeakPtr<VfxScreen> > m_signalActiveScreenExit;           // Signal for active screen exit (before)

    VfxSignal1 <VfxWeakPtr<VfxBasePopup> > m_signalActivePopupEnter;        // Signal for active popup enter (after)
    VfxSignal1 <VfxWeakPtr<VfxBasePopup> > m_signalActivePopupExit;         // Signal for active popup exit (before)

    VfxSignal1 <VfxBool> m_signalShelterExist; 

// Framework method, internal used
public:
    // Setup frame size to fit with screen size and bind it to renderer as root frame.
    void startup();
    // Unbind root frame from renderer.
    void shutdown();

    // Internal used
    void setNextScreenIsVenus();
    
    // Internal used
    VfxBool isActiveScreenCustomRotate();

    // Internal used
    void processActiveScreenExit(VfxBool isBackward);
    // Internal used
    void processActiveScreenAfterExit(VfxBool isBackward);

    // Internal used
    void processScreenBeforeEnter(VfxScreen *screen, VfxBool isBackward);
    // Internal used
    void processScreenEnter(VfxScreen *screen, VfxBool isBackward);
    // Internal used
    void processScreenAfterEnter(VfxScreen *screen, VfxBool isBackward);
    // Internal used
    void processScreenRotate(VfxScrRotateTypeEnum newRotateType, VfxBool noAnimation);
    // Internal used
    void processScreenAfterRotate();    
    
    // This method is called by popup when show a popup.
    void showPopup(
        VfxBasePopup *popup,        // [IN] current popup
        VfxBool isAnim              // [IN] show animation or not
    );
    // This method is called by popup when a popup is leaving
    void leavePopup(
        VfxBasePopup *popup,        // [IN] the popup to be leave
        VfxBool isAnim,              // [IN] show animation or not
        VfxBool changeFocus = VFX_TRUE // [IN] if change focus after leave the popup
    );

    VfxBasePopup *getActivePopup() const
    {
        return m_activePopupPtr.get();
    }
    
    void showBackground();
    void exitBackground();
    void rotateBackground(VfxScrRotateTypeEnum rotateType, VfxMsec time);

    // show a transparent shelter to block pen event on Screen.
    void showShelter(VfxFrame *frame, VfxBool isAnim = VFX_TRUE, VfxBool isStatic = VFX_FALSE);
    void hideShelter(VfxBool isAnim = VFX_TRUE);
    // exit the shelter
    void exitShelter();    

    void setScreenRotateType(VfxScrRotateTypeEnum newRotateType, VfxBool noAnimation = VFX_FALSE);

    VfxScrRotateTypeEnum getScreenRotateType() const;

// Framework method, internal used for IME layout
public:
    // While IME becomes active, it notifies top level to adjust layout to fit input area
    void setIMElayout(
        VfxRect &imeRect,       // [IN] IME area
        VfxFrame *imeOwner      // [IN] The owner who creates IME
    );

    // While IME becomes inactive, it notifies to reset the layout
    void resetIMElayout();

// Override
protected:
    virtual vrt_allocator_handle getAllocator();
    virtual void onInit();
    virtual VfxBool onPreviewPenInput(VfxPenEvent &event);
    virtual VfxBool onPenInput(VfxPenEvent &event);
    VfxBool queryFocusChange(VfxFrame *childFrame);
    virtual void onObjectNotify(VfxId eventId, void *userData);

// Override
public:
    virtual VfxBool processFocusKey(VfxKeyEvent &event);
    
// Implementation
private:
    // Save enter screen level (for debug)
    VfxS32              m_enterScreenLevel; 

    // Main Base Layer
    VfxMainBaseLayer *m_backgroundFrame;
    VfxFrame         *m_bgContainerFrame;

    // Debug panel
    VfxDebugPanel      *m_debugFrame;    
    VfxProfilingPanel  *m_profilingFrame;
    
    VfxWeakPtr <VfxScreen> m_activeScrPtr;
    VfxShelter         *m_shelter;
    VfxCacheModeEnum    m_activeScrCacheMode;

    //popup
    VfxWeakPtr <VfxBasePopup> m_activePopupPtr;

    // IME
    VfxWeakPtr <VfxFrame> m_activeImeScr;

    // Focus
    VfxBool         m_focusCaptured;
    VfxFrameWeakPtr m_prevFocusFrame;
    VfxObjList      m_captureFocusFrames;

    VfxTopLevelActiveScreenStateEnum m_activeScrState;
};

#endif /* __VFX_TOP_LEVEL_H__ */

