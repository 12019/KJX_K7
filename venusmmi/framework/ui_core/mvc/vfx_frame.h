/*****************************************************************************
*  Copyright Statement:
*  --------------------
*  This software is protected by Copyright and the information contained
*  herein is confidential. The software may not be copied and the information
*  contained herein may not be used or disclosed except with the written
*  permission of MediaTek Inc. (C) 2008
*
*  BY OPENING THIS FILE, BUYER HEREBY UNEQUIVOCALLY ACKNOWLEDGES AND AGREES
*  THAT THE SOFTWARE/FIRMWARE AND ITS DOCUMENTATIONS ("MEDIATEK SOFTWARE")
*  RECEIVED FROM MEDIATEK AND/OR ITS REPRESENTATIVES ARE PROVIDED TO BUYER ON
*  AN "AS-IS" BASIS ONLY. MEDIATEK EXPRESSLY DISCLAIMS ANY AND ALL WARRANTIES,
*  EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE IMPLIED WARRANTIES OF
*  MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE OR NONINFRINGEMENT.
*  NEITHER DOES MEDIATEK PROVIDE ANY WARRANTY WHATSOEVER WITH RESPECT TO THE
*  SOFTWARE OF ANY THIRD PARTY WHICH MAY BE USED BY, INCORPORATED IN, OR
*  SUPPLIED WITH THE MEDIATEK SOFTWARE, AND BUYER AGREES TO LOOK ONLY TO SUCH
*  THIRD PARTY FOR ANY WARRANTY CLAIM RELATING THERETO. MEDIATEK SHALL ALSO
*  NOT BE RESPONSIBLE FOR ANY MEDIATEK SOFTWARE RELEASES MADE TO BUYER'S
*  SPECIFICATION OR TO CONFORM TO A PARTICULAR STANDARD OR OPEN FORUM.
*
*  BUYER'S SOLE AND EXCLUSIVE REMEDY AND MEDIATEK'S ENTIRE AND CUMULATIVE
*  LIABILITY WITH RESPECT TO THE MEDIATEK SOFTWARE RELEASED HEREUNDER WILL BE,
*  AT MEDIATEK'S OPTION, TO REVISE OR REPLACE THE MEDIATEK SOFTWARE AT ISSUE,
*  OR REFUND ANY SOFTWARE LICENSE FEES OR SERVICE CHARGE PAID BY BUYER TO
*  MEDIATEK FOR SUCH MEDIATEK SOFTWARE AT ISSUE. 
*
*  THE TRANSACTION CONTEMPLATED HEREUNDER SHALL BE CONSTRUED IN ACCORDANCE
*  WITH THE LAWS OF THE STATE OF CALIFORNIA, USA, EXCLUDING ITS CONFLICT OF
*  LAWS PRINCIPLES. ANY DISPUTES, CONTROVERSIES OR CLAIMS ARISING THEREOF AND
*  RELATED THERETO SHALL BE SETTLED BY ARBITRATION IN SAN FRANCISCO, CA, UNDER
*  THE RULES OF THE INTERNATIONAL CHAMBER OF COMMERCE (ICC).
*
*****************************************************************************/

/*******************************************************************************
 * Filename:
 * ---------
 *  vfx_frame.h
 *
 * Project:
 * --------
 *  Venus UI Core
 *
 * Description:
 * ------------
 *  Description
 *
 * Author:
 * -------
 * -------
 *
 *============================================================================
 *             HISTORY
 * Below this line, this part is controlled by PVCS VM. DO NOT MODIFY!!
 *------------------------------------------------------------------------------
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 *------------------------------------------------------------------------------
 * Upper this line, this part is controlled by PVCS VM. DO NOT MODIFY!!
 *============================================================================
 ****************************************************************************/

#ifndef __VFX_FRAME_H__
#define __VFX_FRAME_H__


/***************************************************************************** 
 * Include
 *****************************************************************************/

// For VfxObject
#include "vfx_animatable.h"

#include "vfx_datatype.h"
#include "vfx_cpp_base.h"
#include "vfx_class_info.h"
#include "vfx_basic_type.h"
#include "vfx_transform.h"
#include "vrt_canvas.h"
#include "vrt_datatype.h"
#include "vfx_signal.h"
#include "vfx_auto_animate.h"
#include "vfx_renderer.h"
#include "vfx_animation.h"
#include "vfx_object_list.h"
#include "vfx_input_event.h"
// For VfxFrameAlignerSideEnum, VfxFrameAlignerModeEnum
#include "vfx_frame_aligner.h"


/***************************************************************************** 
 * Define
 *****************************************************************************/
 
// The VfxFrame registered name
#define VFX_FRAME_CLASS_NAME           "Frame"



#define VFX_FRAME_MAX_WIDTH     GDI_LAYER_MAX_WIDTH
#define VFX_FRAME_MAX_HEIGHT    GDI_LAYER_MAX_HEIGHT

// The VfxFrame broadcast event
#define VFX_FRAME_BROADCAST_EVENT_BEFOR_ENTER   (1 << 0)
#define VFX_FRAME_BROADCAST_EVENT_AFTER_ENTER   (1 << 1)
#define VFX_FRAME_BROADCAST_EVENT_BEFORE_EXIT   (1 << 2)
#define VFX_FRAME_BROADCAST_EVENT_AFTER_EXIT    (1 << 3)


/***************************************************************************** 
 * Typedef
 *****************************************************************************/
 
// Predefine Classes
class VfxImageSrc;
class VfxDrawContext;
class VfxBaseTimeline;
class VfxFrameFilter;
class VfxOwnerDraw;
class VfxFrame;
class VfxMaterial;
class VfxWorld;

// IME adjust mode
enum VfxFrameImeModeEnum
{
    VFX_FRAME_IME_MODE_NONE,        // Do not adjust while IME is active
    VFX_FRAME_IME_MODE_SHIFT,       // Shift the frame
    VFX_FRAME_IME_MODE_RESIZE,      // Resize the frame
    VFX_FRAME_IME_MODE_CUSTOM,      // Adjust the frame by yourself
    VFX_FRAME_IME_MODE_END_OF_ENUM
};

// SEE ALSO: VFX_FRAME_NOTIFY_ID_BROADCAST
struct VfxFrameBroadcastData
{
    VfxU32 eventId;
    VfxFrame *sender;
    void *eventData;
};

// SEE ALSO: VFX_FRAME_NOTIFY_ID_QUERY_FOCUS_CHANGE
struct VfxFrameQueryFocusChangeData
{
    VfxFrame *childFrame;
    VfxBool ret;
};


// SEE ALSO: VFX_FRAME_NOTIFY_ID_ADJUST_IME_SHIFT
struct VfxFrameAdjustImeShiftData
{
    VfxPoint pos;
    VfxFrame *focusFrame;
};


// SEE ALSO: VFX_FRAME_NOTIFY_ID_ADJUST_IME_RESIZE
struct VfxFrameAdjustImeResizeData
{
    VfxSize size;
    VfxFrame *focusFrame;
};


// SEE ALSO: VFX_FRAME_NOTIFY_ID_UPDATE_VIEW_FOR_IME
struct VfxFrameUpdateViewForImeData
{
    VfxFrame *focusFrame;
    VfxBool ret;
};


/***************************************************************************** 
 * Class VfxFrame
 *****************************************************************************/

class VfxFrameAlignStruct : public VfxBase
{
public:
    VfxFrameAlignerModeEnum modeLeft;   // mode for left side
    VfxFrameAlignerModeEnum modeTop;    // mode for top side
    VfxFrameAlignerModeEnum modeRight;  // mode for right side
    VfxFrameAlignerModeEnum modeBottom; // mode for bottom side
};

/*
 * VfxFrame is the base unit of scene graph.
 */
class VfxFrame : public VfxAnimatable
{
    VFX_DECLARE_CLASS(VfxFrame);

// Constructor / Destructor
public:
    // Default constructor
    VfxFrame();
    // Destructor
    virtual ~VfxFrame();

// Animatable property
public:
    // The frame position in it's parent frame coordinate system. Animatable. 
    //
    // NOTE: The default value is (0, 0).
    const VfxPoint &getPos() const;
    // The z-position of the frame. Animatable.
    //
    // NOTE: The default value is 0.0.
    VfxFloat getPosZ() const;
    // The bounds rectangle of the frame. Animatable. 
    //
    // NOTE: The defualt value is (0, 0, 0, 0).
    virtual const VfxRect &getBounds() const;
    // The Anchor point of the bounds rectangle. Animatable.
    //
    // NOTE: The default value is (0, 0).
    const VfxFPoint &getAnchor() const;
    // The background color of the frame. Animatable.
    //
    // NOTE: The default value is VFX_COLOR_TRANSPARENT.
    const VfxColor &getBgColor() const;
    // The opacity of the frmae. Animatable.
    //
    // NOTE: The defualt value is 1.0.
    VfxFloat getOpacity() const;
    // The trasform of the frame, relative to the anchor point. Animatable.
    //
    // NOTE: The default value is a identy transfrom.
    const VfxTransform &getTransform() const;
    // The color of frame border. Animatable.
    //
    // NOTE: The default value is VFX_COLOR_WHITE.
    virtual const VfxColor &getBorderColor() const;
    // The width of frame border. Animatable.
    //
    // NOTE: The border is drawn inside from the frame bounds. 
    //  The default value is 0.
    VfxS32 getBorderWidth() const;
    // The image that provides the frame content.
    //
    // NOTE: The default value is NULL Image Source.
    const VfxImageSrc &getImgContent() const;
    // The image content placement rule in the frame bounds.
    //
    // NOTE: The default value is VFX_FRAME_CONTENT_PLACEMENT_TYPE_CENTER.
    VfxFrameContentPlacementTypeEnum getContentPlacement() const;
    // The filter apply to the frame.
    //
    // NOTE: The default value is NULL.
    VfxFrameFilter *getFilter() const;    
    // The owner draw apply to the frame.
    //
    // NOTE: The default value is NULL.
    VfxOwnerDraw *getOwnerDraw() const;
    // The filter timing. Animatable.
    //
    // NOTE: The default value is 0.0.
    VfxFloat getFilterTiming() const;
    // The FPE user property 0. Animatable.
    //
    // NOTE: The default value is 0.0.
    VfxFloat getFpeUser0() const;
    // Whether the frame is hidden.
    //
    // NOTE: The default value is VFX_FALSE.
    VfxBool getHidden() const;
    // Whether the frame is unhittable
    //
    // NOTE: The default value is VFX_FALSE.
    VfxBool getIsUnhittable() const;
    // A hint marking that the frame has no alpha channel
    //
    // NOTE: The default value is VFX_FALSE.
    virtual VfxBool getIsOpaque() const;
    // A hint marking that the frame rendering quality.
    //
    // NOTE: The hint is applied when the transform is not identity.
    //  The default value is VFX_FALSE.
    VfxRenderQualityEnum getQuality() const;
    // A hint marking that the frame could be cached.
    //
    // NOTE: The default value is VFX_FALSE.
    VfxBool getIsCached() const;
    // A hint marking that the frame cache mode.
    //
    // NOTE: The default value is VFX_CACHE_MODE_AUTO.
    VfxCacheModeEnum getCacheMode() const;
    // The opaque mode of the frame.
    //
    // SEE ALSO: VfxFrameOpaqueModeEnum
    VfxFrameOpaqueModeEnum getOpaqueMode() const;
    // The culling type of the frame.
    //
    // SEE ALSO: VfxFrameCullingTypeEnum
    VfxFrameCullingTypeEnum getCullingType() const;
    // Whether the frame sort child frames by z-position.
    //
    // NOTE: The default value is VFX_FALSE.
    VfxBool getIsZSortChild() const;
    // The hints of the frame.
    //
    // SEE ALSO: VfxFrameCullingTypeEnum
    VfxFrameHintsEnum getHints() const;

    // Set frame position.
    virtual void setPos(const VfxPoint &value);
    // Set frame z order.
    virtual void setPosZ(VfxFloat value);
    // Set frame bounds.
    virtual void setBounds(const VfxRect &value);
    // Set frame anchor.
    void setAnchor(const VfxFPoint &value);
    // Set background color of the frame.
    virtual void setBgColor(const VfxColor &value);
    // Set opacity of the frame. Opacity value is from 0 to 1.0.
    virtual void setOpacity(VfxFloat value);
    // Set frame transform.
    virtual void setTransform(const VfxTransform &value);
    // Set color of frame border.
    virtual void setBorderColor(const VfxColor &value);
    // Set width of frame border.
    void setBorderWidth(VfxS32 value);
    // Set image source of frame.
    virtual void setImgContent(const VfxImageSrc &value);
    // Set placement of frame content.
    void setContentPlacement(
        VfxFrameContentPlacementTypeEnum value  // [IN] Content placement.
    );
    // Set frame filter.
    virtual void setFilter(
        VfxFrameFilter *value   // [IN] Frame filter object.
    );
    // Set owner draw.
    void setOwnerDraw(
        VfxOwnerDraw *value     // [IN] Owner draw object.
    );
    // Set filter timing.
    //
    // SEE ALSO: VfxFrameFilter::onProcess
    void setFilterTiming(VfxFloat value);
    // Set FPE user property 0
    void setFpeUser0(VfxFloat value);
    // Set frame visibility.
    virtual void setHidden(VfxBool value);
    // Set frame to be hittable or not.
    virtual void setIsUnhittable(VfxBool value);
    // Set frame to opaque so that VRT can optimize more.
    void setIsOpaque(VfxBool value);
    // Set frame quality.
    void setQuality(
        VfxRenderQualityEnum value      // [IN] Frame quality type.
    );
    // Enable frame cache or not.
    void setIsCached(VfxBool value);
    // Set cache mode.
    void setCacheMode(VfxCacheModeEnum value);    
    // Set opaque mode.
    void setOpaqueMode(
        VfxFrameOpaqueModeEnum value   // [IN] Frame opaque mode.
    );
    // Set culling mode.
    void setCullingType(
        VfxFrameCullingTypeEnum value   // [IN] Frame culling mode.
    );
    // Set whether sort children frame by z order.
    void setIsZSortChild(VfxBool value);

    // Set hints
    void setHints(
        VfxFrameHintsEnum value         // [IN] Frame hints
    );
    // Set hints helper function
    void setHintFlag(
        VfxFrameHintsEnum flags         // [IN] Frame hint flags to set (can be more than one)
    );
    // Clear hints helper function
    void clearHintFlag(
        VfxFrameHintsEnum flags         // [IN] Frame hint flags to clear (can be more than one)
    );

    // Set fallback image resource id
	void setFallbackImage(VfxResId resId);
    // Return the fallback image resource id.
    //
    // RETURNS: The fallback image resource id. Return 0 if the frame has no fallback image.
	VfxResId getFallbackImage() const;

// Misc property
public:
    // A hint marking that the frame has animation content
    //
    // NOTE: The default value is VFX_FALSE.
    virtual VfxBool getHasAnimateImage() const;

// VRT method
public:  
    // Create the frame handle and setup the frame property.
    virtual void processCreateHandle();
    // Release the frame handle.
    virtual void processReleaseHandle();

// Frame parent-child hierarchy method
public:
    // Return the parent frame.
    //
    // RETURNS: The parent frame. Return NULL if the frame has no parent frame.
    VfxFrame *getParentFrame() const;
    // Return the first child frame.
    //
    // RETURNS: The first child frame. Return NULL if the frame has no child frame.
    VfxFrame *getFirstChildFrame() const;
    // Return the last child frame.
    //
    // RETURNS: The last child frame. Return NULL if the frame has no child frame.
    VfxFrame *getLastChildFrame() const;
    // Return the next frame.
    //
    // RETURNS: The next frame. Return NULL if the frame has no next frame.
    VfxFrame *getNextFrame() const;
    // Return the previois frame.
    //
    // RETURNS: The previois frame. Return NULL if the frame has no previois frame.
    VfxFrame *getPrevFrame() const;
    // Return the focus child frame.
    //
    // RETURNS: The focused child frame. Return NULL if the frame has no focused child frame.
    VfxFrame *getFocusChildFrame() const;

    // add a child frame into the frame
    void addChildFrame(
        VfxFrame *newFrame          // [IN] The frame to add
    );
    
    // Remove the frame from it's parent frame
    void removeFromParentFrame();
    
    // Insert a frame after a child frame
    void insertChildFrameAfter(
        VfxFrame *childFrame,       // [IN] The child frame to add
        VfxFrame *newFrame          // [IN] The frame to insert
    );
    
    // Insert a frame bofore a child frame
    void insertChildFrameBefore(
        VfxFrame *childFrame,       // [IN] The child frame to add
        VfxFrame *newFrame          // [IN] The frame to insert
    );
    
    // Replace a child frame with a given frame
    void replaceChildFrameWith(
        VfxFrame *oldFrame,         // [IN] The child frame to be replace
        VfxFrame *newFrame          // [IN] The frame to replace
    );

    // Change the frame to the last one of parent's child frame.
    void bringToFront();
    // Change the frame to the first one of parent's child frame.
    void sendToBack();


// Input method
protected:
    // Set the frame is focused
    virtual void setFocused(
        VfxBool value   // [IN] VFX_TRUE means this frame will get focus
    );

    // Check focus state of this frame
    VfxBool getFocused();

    // Check if the focus can be changed to the specified child frame
    VfxBool queryFocusChange(VfxFrame *childFrame);

    // Make no child is focused
    void resetFocusChild();

    // Override to handle the key input event.
    // This function will be called when your frame is focused or 
    // the frame register access key handler.
    //
    // NOTE: The default behavior is doing nothing and return VFX_FALSE.
    //
    // RETURNS: Return VFX_TRUE if the event has been handled. 
    //  Otherwise return VFX_FALSE.
    //
    // SEE ALSO: VfxKeyEvent
    virtual VfxBool onKeyInput(
        VfxKeyEvent &event          // [IN] The key event to be handled
    );

public:
    // Routing the key event to focus child.
    // RETURNS: VFX_TRUE means the control has processed this key and don't need to route
    virtual VfxBool processFocusKey(VfxKeyEvent &event);

    // Routing the access key event. 
    // RETURNS: VFX_TRUE means the control has processed this key and don't need to route
    virtual VfxBool processAccessKey(VfxKeyEvent &event);

 // Hit testing method
public:
    // Returns the frame contains the specified point, including this frame.
    // RETURNS:
    //  The frame that is located at the given position.
    VfxFrame *hitTest(
        const VfxPoint &point,                  // [IN] The point in the coordinate of the frame
        const VfxBool  transform = VFX_FALSE    // [IN] Support transform or not
    ) const;

    // Test if the frame contains the specified point
    // RETURNS:
    //  Return VFX_TRUE if the clip bound of the frame contains the point
    VfxBool containPoint(
        const VfxPoint &point,              // [IN] The point in the coordinate of the frame
        const VfxBool isFuzzy = VFX_FALSE   // [IN] Fuzzy test or not
    ) const;

    // Set if this frame has fuzzy area
    void setFuzzy(VfxBool value);

// Frame geometry method
public:

    // Set the frame position in it's parent frame coordinate system. 
    void setPos(
        VfxS32 x,                   // [IN] The x coordinate to set
        VfxS32 y                    // [IN] The y coordinate to set
    )
    {
        setPos(VfxPoint(x, y));
    }
    
    // Set the bounds rectangle of the frame
    void setBounds(
        VfxS32 x,                   // [IN] The x coordinate to set
        VfxS32 y,                   // [IN] The y coordinate to set
        VfxS32 width,               // [IN] The width to set
        VfxS32 height               // [IN] The height to set
    )
    {
        setBounds(VfxRect(x, y, width, height));
    }

    // Set the Anchor point of the bounds rectangle.
    void setAnchor(
        VfxFloat x,                 // [IN] The x coordinate to set
        VfxFloat y                  // [IN] The y coordinate to set
    )
    {
        setAnchor(VfxFPoint(x, y));
    }
    
    // Return the frame bounds size
    //
    // RETURNS: The frame bounds size
    const VfxSize &getSize() const
    {

        return getBounds().size;
    }

    // Set the frame bounds size
    void setSize(
        const VfxSize &value        // [IN] The size to set
    )
    {
        setBounds(VfxRect(getBounds().origin, value));
    }

    // Set the frame bounds size
    void setSize(
        VfxS32 width,               // [IN] The width to set
        VfxS32 height               // [IN] The height to set
    )
    {
        setSize(VfxSize(width, height));
    }

    // Return the frame coverage rectangle in its parent frame coordinate system.
    //
    // RETURNS: The frame coverage rectangle.
    VfxRect getRect() const;
    
    // Set the frame coverage rectangle in its parent frame coordinate system.
    void setRect(
        const VfxRect &rect         // [IN] The rectangle to set
    );

    // Set the frame coverage rectangle in its parent frame coordinate system
    void setRect(
        VfxS32 x,                   // [IN] The x coordinate to set
        VfxS32 y,                   // [IN] The y coordinate to set
        VfxS32 width,               // [IN] The width to set
        VfxS32 height               // [IN] The height to set
    )
    {
        setRect(VfxRect(x, y, width, height));
    }

#ifdef __VENUS_3D_UI_ENGINE__
    // Return the 3D material of the frame
    VfxMaterial *getMaterial() const
    {
        return m_material.get();
    }

    // Set the frame 3D material
    void setMaterial(VfxMaterial *material);

    // Return the 3D world ptr of the frame
    VfxWorld *getWorld() const
    {
        return m_world.get();
    }

    // Set the frame 3D world
    void setWorld(VfxWorld *world);
#endif

// Helper method
public:
    // Set color and width of the frame border.
    void setBorder(
        const VfxColor &borderColor,    // [IN] The border color to set
        VfxS32 borderWidth = 1          // [IN] The border width to set
    )
    {
        setBorderColor(borderColor);
        setBorderWidth(borderWidth);
    }

// Coordinate convert method
public:
    // Convert the given point from a given frame coordinate system to this frame
    // coordinate system.
    //
    // NOTE: The given frame and this frame must have a same parent frame.
    //
    // RETURNS: The point converted to this frame coordinate system
    //
    // SEE ALSO: convertPointTo
    VfxPoint convertPointFrom(
        const VfxPoint &point,                  // [IN] A point in the coordinate system of given frame
        const VfxFrame *frame,                  // [IN] The frame that the given point be converted from
        const VfxBool  transform = VFX_FALSE    // [IN] Support transform or not
    ) const;
    
    // Convert the given point from a this frame coordinate system to the given frame
    // coordinate system.
    //
    // NOTE: The given frame and this frame must have a same parent frame.
    //
    // RETURNS: The point converted to the given frame coordinate system
    //
    // SEE ALSO: convertPointFrom
    VfxPoint convertPointTo(
        const VfxPoint &point,                  // [IN] A point in the coordinate system of this frame
        const VfxFrame *frame,                  // [IN] The frame that the given point be converted to
        const VfxBool  transform = VFX_FALSE    // [IN] Support transform or not
    ) const;
    
    // Convert the given rectangle from a given frame coordinate system to this frame
    // coordinate system.
    //
    // NOTE: The given frame and this frame must have a same parent frame.
    //
    // RETURNS: The rectangle converted to this frame coordinate system
    //
    // SEE ALSO: convertRectTo
    VfxRect convertRectFrom(
        const VfxRect &rect,        // [IN] A rectangle in the coordinate system of given frame
        const VfxFrame *frame       // [IN] The frame that the given rectangle be converted from
    ) const;
    
    // Convert the given rectangle from a this frame coordinate system to the given frame
    // coordinate system.
    //
    // NOTE: The given frame and this frame must have a same parent frame.
    //
    // RETURNS: The rectangle converted to the given frame coordinate system
    //
    // SEE ALSO: convertRectFrom
    VfxRect convertRectTo(
        const VfxRect &rect,        // [IN] A rectangle in the coordinate system of this frame
        const VfxFrame *frame       // [IN] The frame that the given rectangle be converted to
    ) const;

// Updating display method
public:
    // Mark that the frame needs redraw in next committing.
    //
    // SEE ALSO: onDraw
    void invalidate();

    // Mark that the frame's content is dirty without triggering onDraw in next committing.
    void setContentDirty();

    // Try to precache this frame
    void preCache();

    // Try to precache all child frames
    void preCacheChildren();

// ***Experimental method
public:
    // Force VRT to update frame position immediately.
    void forcePos(
        const VfxPoint &pos     // [IN] Frame position.
    );

    // Force VRT to update frame image content immediately.
    //  Only support image source type is image buffer.
    void forceImgContent(
        const VfxImageSrc &value // [IN] New image content
    );

    // Force to get VRT frame position immediately.
    VfxPoint forceGetPos() const;
    // Force to get VRT frame bounds immediately.
    VfxRect forceGetBounds() const;
    // Force to get VRT frame opacity immediately.
    VfxFloat forceGetOpacity() const;
    // Force to get VRT frame anchor immediately.
    VfxFPoint forceGetAnchor() const;
    // Force to get VRT frame transform immediately.
    VfxTransform forceGetTransform() const;
    // Force to get VRT frame bg color immediately.
    VfxColor forceGetBgColor() const;
    // Force to get VRT frame border color immediately.
    VfxColor forceGetBorderColor() const;
    // Force to get VRT frame border width immediately.
    VfxS32 forceGetBorderWidth() const;
    // Force to get VRT frame filter timing immediately.
    VfxFloat forceGetFilterTiming() const;
    // Force to get VRT FPE user property immediately.
    VfxFloat forceGetFpeUser0() const;
    
    // Set property effect.
    void setPropertyEffectCallback(
        VfxFrame *watchFrame,                               // [IN] Watched frame.
        vrt_frame_property_effect_funcptr_type callback,    // [IN] Callback funtion to update frame property.
        void *userData,                                     // [IN] User data.
        VfxU32 userDataSize,                                // [IN] Size of user data.
        vrt_frame_property_effect_trigger_type_enum trigger_type = VRT_FPE_TRIGGER_TYPE_DIRTY);  // [IN] Type of triggering callback function

    // Get the user data pointer of frame property effect callback
    //
    // NOTE: The return data pointer may not same as the setting one
    void *getPropertyEffectCallbackUserDataPtr() const;

    // Get the data size of frame property effect callback
    VfxU32 getPropertyEffectCallbackUserDataSize() const; 

    // Set property monitor.
    void setPropertyMonitorCallback(
        vrt_frame_property_monitor_funcptr_type callback,    // [IN] Callback funtion to update frame property.
        void *userData,                                     // [IN] User data.
        VfxU32 userDataSize);                                // [IN] Size of user data.

    // Get the user data pointer of frame property monitor callback
    //
    // NOTE: The return data pointer may not same as the setting one
    void *getPropertyMonitorCallbackUserDataPtr() const;

    // Get the data size of frame property monitor callback
    VfxU32 getPropertyMonitorCallbackUserDataSize() const; 

// Alignment method
public:
    // Set alignment information
    void setAlignParent(
        VfxFrameAlignerSideEnum side,   // side
        VfxFrameAlignerModeEnum mode    // mode
    );

    // Set alignment information
    void setAlignParent(
        VfxFrameAlignerModeEnum modeLeft,   // mode for left side
        VfxFrameAlignerModeEnum modeTop,    // mode for top side
        VfxFrameAlignerModeEnum modeRight,  // mode for right side
        VfxFrameAlignerModeEnum modeBottom  // mode for bottom side
    );

    // Set alignment information at once
    void setAlignParentEx(
        const VfxFrameAlignStruct& modes    // mode for 4 sides
    );

    // Reset alignment information
    void resetAlignParent();

    // Adjust position or size to align parent
    void alignParent();

    // Get aligner
    VfxFrameAligner* getAligner() const;

// For framework method
public:
    // Create all handle for this frame, includeing child frames
    VfxBool prepareHandle();
    // Free all handle for this frame, including child frames
    void disposeHandle();

    // Update the content of the frame
    void processDraw(VfxDrawContext &dc);

    VfxBool hasChildDirty();
    VfxBool isNeedUpdate();
    void clearHasChildDirtyFlag()
    {
        VFX_FLAG_CLEAR(m_flags, FLAGS_HAS_CHILD_DIRTY);
    }
    void clearNeedUpdate()
    {
        VFX_FLAG_CLEAR(m_flags, FLAGS_CONTENT_DIRTY | FLAGS_NEED_UPDATE_CMDS);
    }


// Signal
public:
    VfxSignal2 <VfxFrame *, const VfxRect &> m_signalBoundsChanged;     // Siganl for bounds changed.

// Overridable
protected:
    // Experimental virtual function.
    // Override to handle the parent frame has been changed
    //
    // origParentFrame is NULL if there is no original parent frame.
    // Default behavior is doing nothing
    void onParentFrameChanged(
        VfxFrame *origParentFrame   // The original parent frame
    );

    // Overrde to provide the content of the frame.
    virtual void onDraw(
        VfxDrawContext &dc          // The draw context to draw in
    );
    
    // Test if the frame contains the specified point
    // RETURNS:
    //  Return VFX_TRUE if the clip bound of the frame contains the point
    virtual VfxBool onContainPoint(
        const VfxPoint &point       // [IN] the point in the coordinate of the frame
    ) const;

    // Test if the frame or fuzzy region of the frame contains the specified point
    // RETURNS:
    //  Return VFX_TRUE if the clip bound of the frame contains the point
    virtual VfxBool onContainPointFuzzy(
        const VfxPoint &point       // [IN] the point in the coordinate of the frame
    ) const;


// Overridable: for IME layout
public:
    // Get the IME adjust mode
    // RETURNS: Return the enum of IME adjust mode
    VfxFrameImeModeEnum getImeMode() {return VFX_FRAME_IME_MODE_NONE;}

    // IME layout: adjust function for VFX_FRAME_IME_MODE_SHIFT
    void adjustImeShift(
        const VfxPoint &pos,        // [IN] suggested position of this frame
        VfxFrame *focusFrame        // [IN] editor frame which launches IME
    )
    {
        VFX_UNUSED(focusFrame);
        setPos(pos);
    }

    // IME layout: adjust function for VFX_FRAME_IME_MODE_RESIZE
    void adjustImeResize(
        const VfxSize &size,        // [IN] suggested size of this frame
        VfxFrame *focusFrame        // [IN] editor frame which launches IME
    )
    {
        VFX_UNUSED(focusFrame);
        setSize(size);
    }

    // IME layou: update viewport if necessary after adjustImeResize
    // RETURNS: whether to update view port, if true, it will not rount to child frames
    VfxBool updateViewForIme(
        VfxFrame *focusFrame        // [IN] editor frame which launches IME
    )
    {
        return VFX_FALSE;
    }

// Framework method
public:
    VfxFrameImeModeEnum processGetImeMode();

    // IME layout: adjust function for VFX_FRAME_IME_MODE_SHIFT
    void processAdjustImeShift(
        const VfxPoint &pos,        // [IN] suggested position of this frame
        VfxFrame *focusFrame        // [IN] editor frame which launches IME
    );

    // IME layout: adjust function for VFX_FRAME_IME_MODE_RESIZE
    void processAdjustImeResize(
        const VfxSize &size,        // [IN] suggested size of this frame
        VfxFrame *focusFrame        // [IN] editor frame which launches IME
    );

    // IME layou: update viewport if necessary after adjustImeResize
    // RETURNS: whether to update view port, if true, it will not rount to child frames
    VfxBool processUpdateViewForIme(
        VfxFrame *focusFrame        // [IN] editor frame which launches IME
    );


// Framework method
protected:
    // Register which frame borad events the frame want
    void registerBroadcastEvent(VfxFlag events);
    // Fire frame a broadcast event
    void broadcastEvent(VfxU32 eventId, void *eventData = NULL);
    
// Override
protected:
    virtual void onInit();
    virtual void onDeinit();

    void onBeforeDeinit();
    void onAfterDeinit();
    void onAddChild(VfxObject *objChild);
    void onRemoveChild(VfxObject *objChild);
    virtual void onObjectNotify(VfxId eventId, void *userData);

    // Notifies that the focus of frame is changed.
    void onFocusChanged(
        VfxBool focused     // Frame is focused or not after changing focus.
    );

// Implementation
private:
    friend class VfxAutoAnimate;
    friend class VfxRenderer;
    friend class VfxBaseTimeline;
    friend class VfxTopLevel;

    enum
    {
        // The frame content is invalidate and need to redraw
        FLAGS_CONTENT_DIRTY           = 1 << 0,
        // The frame is hidden
        FLAGS_HIDDEN                  = 1 << 1,
        // The frame is not hittable (always return false on containPoint())
        FLAGS_UNHITTABLE              = 1 << 2,
        // Cache hint
        FLAGS_CACHED                  = 1 << 3,
        // Enable sorting children by Z position.
        FLAGS_Z_SORT_CHILD            = 1 << 4,
        // The frame need fuzzy hit test
        FLAGS_FUZZY                   = 1 << 5,
        // The frame has fuzzy child frame
        FLAGS_CHILD_FUZZY             = 1 << 6,
        // The frame need to prepare handle in next commit
        FLAGS_NEED_PREPARE            = 1 << 7,
        // Performance optimize for VfxFrame::getAligner()
        FLAGS_HAS_ALIGNER             = 1 << 8,
        // Performance optimize for VfxFrame::getFilter()
        FLAGS_HAS_OWNER_DRAW          = 1 << 9,
        // Performance optimize for VfxFrame::getOwnerDraw()
        FLAGS_HAS_FILTER              = 1 << 10,
        // Performance optimize for VfxFrame::getContentPlacement()
        FLAGS_HAS_CONTENT_PLACEMENT   = 1 << 11,
        // The frame has fallback image id
        FLAGS_HAS_FALLBACK_IMAGE      = 1 << 12,
        // The parent frame is changed
        FLAGS_HAS_PARENT_CHANGED = 1 << 13,
        //has a Child dirty
        FLAGS_HAS_CHILD_DIRTY      = 1 << 14,
        FLAGS_NEED_UPDATE_CMDS     = 1 << 15,
        FLAGS_UPDATE_ALWAYS     = 1 << 16
    };

    // (Member data order is optimized for commiting)
    
    // Flags to save frame status.
    VfxFlag  m_flags; 
    // Frame tree relation data
    VfxFrame *m_nextFrame;          // Next frame.
    VfxFrame *m_firstChildFrame;    // First child frame.
    
    VfxImageSrc m_imgContent;       // Image content
    VfxU32 m_imgContentCommandIndex;
    VfxU32 m_imgContentCommitCounter;

    VfxFrame *m_prevFrame;          // Previous frame.
    VfxFrame *m_lastChildFrame;     // Last child frame.
    VfxFrame *m_parentFrame;        // Parent frame.

    VfxU32 m_lastParentFrameNum;	// The frame is the last parent frame after parent changed

// Implementation
protected:
    // Property    
    VfxPoint        m_pos;          // Position.
    //VfxFloat        m_posZ;         // Z position.
    VfxRect         m_bounds;       // Bounds.
    VfxFPoint       m_anchor;       // Anchor.
    //VfxColor        m_bgColor;      // Background color.
    //VfxFloat        m_opacity;      // Opacity.
    //VfxTransform    m_transform;    // Transform.
    //VfxColor        m_borderColor;  // Border color.
    //VfxS32          m_borderWidth;  // Border width.
    // TODO: VfxImage ready phase-out, replace by VfxImageSrc
    //VfxImage       *m_content;      // Image content.
    //VfxFrameFilter *m_filter;       // Filter effect.
    //VfxFloat        m_filterTiming; // Timing parameter for frame filter.
    //VfxFloat        m_fpeUser0;     // FPE user property 0
    //VfxOwnerDraw   *m_ownerDraw;    // Owner draw.

#ifdef __VENUS_3D_UI_ENGINE__
    VfxWeakPtr<VfxMaterial> m_material;     // Material
    VfxWeakPtr<VfxWorld>    m_world;        // World
#endif

    //VfxFrameContentPlacementTypeEnum    m_contentPlacement; // Content placement.
    //VfxRenderQualityEnum                m_quality;          // Sampling quality.
    //VfxCacheModeEnum                    m_cacheMode;        // Cache mode.
    //VfxFrameOpaqueModeEnum              m_opaqueMode;       // Opaque mode.
    //VfxFrameCullingTypeEnum             m_cullingType;      // Culling mode.
    //VfxFrameHintsEnum                   m_frameHints;       // Frame hints.

    //VfxFrame *m_propertyEffectWatchFrame;   // Wached frame used in frame property effect.
    //vrt_frame_property_effect_callback_struct *m_propertyEffectCallback;    // Frame property callback function.

    //VfxFrameAligner *m_aligner;     // Frame aligner.
    
    //VfxU32          m_layerHandle;  // layer handle
    
    void setLayerHandle(VfxU32 value);
    VfxU32 getLayerHandle() const;

// Implementation
private:
    // For null parent list of VfxRenderer
    VfxObjListEntry *m_nullParentListEntry;

    // Return VFX_TRUE if the frame is not in the scene
    VfxBool isNullParent() const
    {
        return m_nullParentListEntry != NULL;
    }

    // Remove the parent frame, and return the original parent frame.
    // If there is no original parent frame, it will do nothing and return NULL.
    VfxFrame *processRemoveFromParentFrame();

    // Process all needed handling on parent frame changed.
    // Include onParentFrameChanged callback.
    void processParentFrameChanged(VfxFrame *origParentFrame);

    // Set current frame Need Prepare flag and Parent Frame Child Need Prepare Flag.
    void setNeedPrepare();
    
    // Mark the frame content is dirty and need to redraw.
    void setDirty();
    
    void clearChildFrames();
    void markNeedUpdateCmds();
    
    void convertPointFromParent(VfxPoint &point, VfxBool transform = VFX_FALSE) const;
    void convertPointToParent(VfxPoint &point, VfxBool transform = VFX_FALSE) const;
    void convertRectFromParent(VfxRect &rect) const;
    void convertRectToParent(VfxRect &rect) const;

    // Focus
    VfxFrame *m_focusChildFrame;
    
    VfxBool setFocusHelper(VfxFrame* focusChild);

    // Reset property value to VRT
    virtual void resetProperty(vrt_object_property_id_enum propertyId);


    // Helper functions for hit test
    VfxFrame* hitTestHelper1(const VfxPoint &point, const VfxRect &rect, const VfxBool transform = VFX_FALSE) const;
    VfxFrame* hitTestHelper2(const VfxPoint &point, const VfxRect &rect, const VfxBool isFuzzy, const VfxBool transform = VFX_FALSE) const;

    void processOnFocusChanged(VfxBool focused);

private:
    typedef struct 
    {
        VfxFrame *frame;
        vrt_frame_property_effect_callback_struct *callback;
    } propEffectCallback;

    propEffectCallback &getPropertyEffectCallback(void) const;

    typedef struct 
    {
        vrt_frame_property_monitor_callback_struct *callback;
    } propMonitorCallback;

    propMonitorCallback &getPropertyMonitorCallback(void) const;

private:
    /*
     * Boradcast support
     */
    // The filter of the frame needed broadcast events
    VfxFlag m_needBroadcastEvents;
    // The filter of child frames needed broadcast events
    VfxFlag m_childBroadcastEvents;

    // Update broadcast events to this frame and all parent frames
    void infectBroadcastEvent(VfxFlag infectEvents);    
    void processBroadcastEvent(VfxFrameBroadcastData &param);
};

inline
VfxFrame *VfxFrame::getParentFrame() const
{
    return m_parentFrame;
}

inline
VfxFrame *VfxFrame::getFirstChildFrame() const
{
    return m_firstChildFrame;
}

inline
VfxFrame *VfxFrame::getLastChildFrame() const
{
    return m_lastChildFrame;
}

inline
VfxFrame *VfxFrame::getNextFrame() const
{
    return m_nextFrame;
}

inline
VfxFrame *VfxFrame::getPrevFrame() const
{
    return m_prevFrame;
}

inline 
VfxFrame *VfxFrame::getFocusChildFrame() const
{
    return m_focusChildFrame;
}

inline
VfxBool VfxFrame::getHidden() const
{
    return VFX_FLAG_HAS(m_flags, FLAGS_HIDDEN);
}

inline
const VfxImageSrc &VfxFrame::getImgContent() const
{
    return m_imgContent;
}

inline
void VfxFrame::invalidate()
{
    setDirty();
}

// Weak Pointer to VfxFrame
typedef VfxWeakPtr <VfxFrame> VfxFrameWeakPtr;

#endif /* __VFX_FRAME_H__ */

